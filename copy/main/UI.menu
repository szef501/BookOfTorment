`
--reload language
if(uiTranslationFile) then
	Infinity_DoFile("L_" .. uiTranslationFile)
else
	Infinity_DoFile("L_en_us")
end
listMetaInfo = {}


currentPanelID = 0

platformWindows = 0
platformMacOSX = 1
platformAndroid = 2
platformLinux = 3
platformiPhoneOS = 4


function displayTHAC()
	thactxt = ''
	thactxt =  characters[currentID].THAC0.current

	if (characters[currentID].THAC0.offhand ) then
		thactxt = thactxt .. '\n' .. characters[currentID].THAC0.offhand
	end

	return thactxt
	
	end
function updateAttrTable()
	--Our character changed, most of the data will update automatically as it
	--reads straight from the characters table, but the help string needs to be poked.
	resetRecordHelpString()
end

function displaySTRNoFormatting()
	strtxt = characters[currentID].attr.str.current

	if (characters[currentID].attr.str.current == 18 and characters[currentID].attr.str.extra > 0) then
		if (characters[currentID].attr.str.extra == 100) then
			strtxt = strtxt .. '/00'
		elseif (characters[currentID].attr.str.extra < 10) then
			strtxt = strtxt .. '/0' .. characters[currentID].attr.str.extra
		else
			strtxt = strtxt .. '/' .. characters[currentID].attr.str.extra
		end
	end
	return strtxt
end

function displaySTR()
	strtxt = displaySTRNoFormatting()

	if(characters[currentID].attr.str.current > characters[currentID].attr.str.base or characters[currentID].attr.str.extra > characters[currentID].attr.str.extraBase) then
		strtxt = '^G' .. strtxt .. '^-'
	end
	if(characters[currentID].attr.str.current < characters[currentID].attr.str.base or characters[currentID].attr.str.extra < characters[currentID].attr.str.extraBase) then
		strtxt = '^R' .. strtxt .. '^-'
	end
	return strtxt
end

characters = {}
statusEffects = { }

currentID = 16974083

function trunc(str, len)
	if str:len() < len then
		return str
	else
		return str:sub(1,len) .. "..."
	end
end

function isStatModified(index)
	if (index == "str" ) then
		--strength
		return (characters[currentID].attr.str.current ~= characters[currentID].attr.str.base or characters[currentID].attr.str.extra ~= characters[currentID].attr.str.extraBase)
	else
		return characters[currentID].attr[index].current ~= characters[currentID].attr[index].base
	end
end

function displayAttr(index)
	str = 0
	if (index == "str" ) then
		str = displaySTR()
	else
		str = displayBuff( characters[currentID].attr[index].current, characters[currentID].attr[index].base, 1)
	end
	return str
end

function getPercent(first, second)
	tempNumber = ( first/second ) *100
	return tempNumber
end

function displayBuff( current, base, highisbetter)
	
	tmpstr = ''	
	--Infinity_Log( current .. ' - '.. base )
	if(highisbetter) then
		if(current > base) then
			tmpstr	= '^G' .. current .. '^-'
		elseif (current < base) then
			tmpstr	= '^R' .. current .. '^-'			
		end
	else
		if(current > base) then
			tmpstr	= '^R' .. current .. '^-'
		elseif (current < base) then
			tmpstr	= '^G' .. current .. '^-'			
		end
	end
	if(current == base) then
		tmpstr = current		
	end
	return tmpstr
end

function resetRecordHelpString()
	recordHelpString = characters[currentID].proficiencies.pstDetails
end

currentFaction = 1
function getFactionFrame()
	local current = characters[currentID].factions.current
	return characters[currentID].factions.joinedFactions[current].frame
end
function getFactionTooltip()
	if(#characters[currentID].factions.joinedFactions > 1) then
		return t("FACTION_TOOLTIP")
	else
		return nil
	end
end
characterAttrStrings =
{
	str = function()
		recordHelpString = getStrengthHelpText(displaySTRNoFormatting()) --use displaySTRNoFormatting so we don't get inline color
		recordHelpString = Infinity_FetchString(chargen.ability[1].desc) .. '\n\n' .. Infinity_FetchString(recordHelpString)
	end,
	
	int = function()
		recordHelpString = getIntelligenceHelpText(characters[currentID].attr['int'].current)
		recordHelpString = Infinity_FetchString(chargen.ability[4].desc) .. '\n\n' .. Infinity_FetchString(recordHelpString)
	end,
	
	wis = function()
		recordHelpString = getWisdomHelpText(characters[currentID].attr['wis'].current)
		recordHelpString = Infinity_FetchString(chargen.ability[5].desc) .. '\n\n' .. Infinity_FetchString(recordHelpString)
	end,
	
	dex = function()
		recordHelpString = getDexterityHelpText(characters[currentID].attr['dex'].current)
		recordHelpString = Infinity_FetchString(chargen.ability[2].desc) .. '\n\n' .. Infinity_FetchString(recordHelpString)
	end,
	
	con = function()
		recordHelpString = getConstitutionHelpText(characters[currentID].attr['con'].current)
		recordHelpString = Infinity_FetchString(chargen.ability[3].desc) .. '\n\n' .. Infinity_FetchString(recordHelpString)
	end,
	
	cha = function()
		recordHelpString = getCharismaHelpText(characters[currentID].attr['cha'].current)
		recordHelpString = Infinity_FetchString(chargen.ability[6].desc) .. '\n\n' .. Infinity_FetchString(recordHelpString)
	end,
}
function setFactionHelp()
	local current = characters[currentID].factions.current
	recordHelpString = t('FACTION_GENERAL_DESCRIPTION') .. '\n\n'
	recordHelpString = recordHelpString .. Infinity_FetchString(characters[currentID].factions.joinedFactions[current].description)
end
function setAlignmentHelp()
	recordHelpString = Infinity_FetchString(20105) ..'\n\n' .. Infinity_FetchString(33033) .. '\n' .. Infinity_FetchString(characters[currentID].alignmentHelp)
end

`
menu
{
	name	'CHARACTER'
	align center center
	ignoreEsc
	size 1024 768
	onopen
	"	
		pushSidebars()
		resetRecordHelpString()
		Infinity_SetBackground('BACKGROUND_RECORD')
		showButton = false
	"
	onclose
	"
		popSidebars()
	"

	text
	{
		area 121 159 51 29
		text style	"label"
		text lua  "displayAttr('str')"
		text shadow lua "isStatModified('str')"
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.str()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.str()
		"
	}
	text
	{
		area 50 291 53 30
		text style	"label"
		text lua  "displayAttr('int')"
		text shadow lua "isStatModified('int')"
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.int()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.int()
		"
	}
	text
	{
		area 64 426 51 30
		text style	"label"
		text lua  "displayAttr('wis')"
		text shadow lua "isStatModified('wis')"
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.wis()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.wis()
		"
	}
	text
	{
		area 160 540 52 31
		text style	"label"
		text lua  "displayAttr('dex')"
		text shadow lua "isStatModified('dex')"
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.dex()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.dex()
		"
	}
	text
	{
		area 283 586 52 31
		text style	"label"
		text lua  "displayAttr('con')"
		text shadow lua "isStatModified('con')"
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.con()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.con()
		"
	}
	text
	{
		area 411 544 53 32
		text style	"label"
		text lua  "displayAttr('cha')"
		text shadow lua "isStatModified('cha')"
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.cha()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.cha()
		"
	}
	text
	{
		area 541 479 123 122
		bam "STFCTION"
		frame lua "getFactionFrame()"
		tooltip lua "getFactionTooltip()"
		ignoreFocus lua "getFactionTooltip() == nil"
		actionEnter
		"
			setFactionHelp()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			local factionCount = #characters[currentID].factions.joinedFactions
			local current = characters[currentID].factions.current
			if(factionCount > 1) then
				Infinity_PlaySound('int_10')
				if(current < factionCount) then
					characters[currentID].factions.current = current + 1
				else
					characters[currentID].factions.current = 1
				end
			end
			
			setFactionHelp()
		"
	}
	text
	{
		area 460 352 82 82
		bam STALIGN
		frame lua "characters[currentID].alignmentFrame"
		ignoreFocus 1
		actionEnter
		"
			setAlignmentHelp()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			setAlignmentHelp()
		"
	}
	label
	{
		area 597 307 52 75
		mosaic "icHPMan"
	}
	text
	{
		area 594 317 60 27
		text lua "characters[currentID].HP.current"
		text style "label"
		tooltip "CURRENT_HP_TOOLTIP"
		ignoreFocus 1
		actionEnter
		"
			recordHelpString = Infinity_FetchString(18494)
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			recordHelpString = Infinity_FetchString(18494)
		"
	}
	text
	{
		area 594 344 60 27
		text lua "characters[currentID].HP.max"
		text style "label"
		tooltip "MAX_HP_TOOLTIP"
		ignoreFocus 1
		actionEnter
		"
			recordHelpString = Infinity_FetchString(18494)
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			recordHelpString = Infinity_FetchString(18494)
		"
	}
	text
	{
		area 515 239 56 35
		text "AC_LABEL"
		text style "label_parchment"
		text font "EXOCET"
		text point 26
		text shadow 1
		tooltip "ARMOR_CLASS_TOOLTIP"
		ignoreFocus 1
		actionEnter
		"
			recordHelpString = Infinity_FetchString(18493)
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			recordHelpString = Infinity_FetchString(18493)
		"
	}
	text
	{
		area 529 273 31 20
		text lua "characters[currentID].AC.current"
		text style "label"
		tooltip "ARMOR_CLASS_TOOLTIP"
		ignoreFocus 1
		actionEnter
		"
			recordHelpString = Infinity_FetchString(18493)
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			recordHelpString = Infinity_FetchString(18493)
		"
	}
	text
	{
		area 744 58 218 421
		text lua "recordHelpString"
		text style "normal_parchment"
		scrollbar	'cgscrl1'
	}
	text
	{
		area 95 86 108 35
		text 4718
		text style "label_parchment"
		text font "EXOCET"
		text point 28
		text shadow 1
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.str()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.str()
		"
	}
	text
	{
		area 22 219 108 35
		text 5020
		text style "label_parchment"
		text font "EXOCET"
		text point 28
		text shadow 1
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.int()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.int()
		"
	}
	text
	{
		area 37 353 103 35
		text 5021
		text style "label_parchment"
		text font "EXOCET"
		text point 28
		text shadow 1
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.wis()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.wis()
		"
	}
	text
	{
		area 135 465 100 35
		text 5022
		text style "label_parchment"
		text font "EXOCET"
		text point 28
		text shadow 1
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.dex()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.dex()
		"
	}
	text
	{
		area 256 514 106 35
		text 5023
		text style "label_parchment"
		text font "EXOCET"
		text point 28
		text shadow 1
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.con()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.con()
		"
	}
	text
	{
		area 383 471 107 35
		text 5024
		text style "label_parchment"
		text font "EXOCET"
		text point 28
		text shadow 1
		ignoreFocus 1
		actionEnter
		"
			characterAttrStrings.cha()
		"
		actionExit
		"
			resetRecordHelpString()
		"
		action
		"
			characterAttrStrings.cha()
		"
	}

	
	label
	{
		area		234 36 170 34
		text		lua "characters[currentID].name"
		text style  	'title'
		text align	center center
	}
	label
	{
		area		234 86 170 33
		text		lua "characters[currentID].class"
		text style  	'title'
		text align	center center
	}
	
	label
	{
		area		467 72 119 32
		text		lua "Infinity_FetchString(characters[currentID].race)"
		text style  	'label_parchment'
		text align	center center
	}
	
	label
	{
		area		467 128 115 34
		text		lua "Infinity_FetchString(characters[currentID].gender)"
		text style  	'label_parchment'
		text align	center center
	}
	
	button
	{
		area		713 525 138 56
		text		"INFORMATION_BUTTON"
		text style "button"
		bam normbutt
		action "Infinity_PushMenu('CHARACTER_INFORMATION')"
	}
	button
	{
		clickable	lua "characterScreen:IsReformPartyButtonClickable()"
		area		860 525 138 56
		text		"REFORM_PARTY_BUTTON"
		text style "button"
		bam normbutt
		action		"reformFromRecord = 1; characterScreen:OnReformPartyButtonClick();"
	}
	button
	{
		area		860 590 138 56
		text		"LEVEL_UP_BUTTON"
		text style "button"
		bam normbutt
		clickable	lua "characterScreen:IsLevelUpButtonClickable()"
		pulse		lua "characterScreen:IsLevelUpButtonClickable()"
		action		"characterScreen:OnLevelUpButtonClick();"
	}
	button
	{
		area		713 590 138 56
		text		"BIOGRAPHY_BUTTON"
		text style "button"
		bam normbutt
		action		"Infinity_PushMenu('CHARACTER_BIOGRAPHY')"
	}
	label
	{
		area 192 191 236 235
		mosaic lua "characters[currentID].pstPortrait"
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
}
menu
{
	name 'CHARACTER_BIOGRAPHY'
	align center center
	popupSound 1
	modal
	label
	{
		area 0 0 766 593
		mosaic popup4
	}
	label
	{
		area 106 94 158 170
		bam "POPUPIMG"
		sequence 0
	}
	label
	{
		area 294 80 428 44
		text "BIOGRAPHY_TITLE"
		text style "title"
		text font "EXOCET"
		text shadow 1
	}
	text
	{
		area 302 144 420 342
		text lua "Infinity_FetchString(characters[currentID].biography)"
		text style "normal_parchment"
		scrollbar	'cgscrl1'
	}
		button
	{
		area		588 508 138 56
		text		"DONE_BUTTON"
		text style "button"
		bam normbutt
		action		"Infinity_PopMenu('CHARACTER_BIOGRAPHY')"
	}
}
`
--Label stringref, var for value, percent flag
characterInformationString = { 
	{39596, "bestenemy"},
	{41278, "timespent"},
	{41279, "favspell"},
	{41280, "favweapon"},
}
characterInformationDisplayCategories = { 
	{41308, "partygamexp", 1},
	{41307, "partygamekills", 1},
	{825,	"gamexpvalue"},
	{41281, "gamekills"},
}
function formatCharacterInformationStr()
	local str = ""
	local tab = characters[currentID].Stats
	for k,v in pairs(characterInformationString) do
		str = str .. "^N" .. Infinity_FetchString(v[1]) .. "^-" .. "\n" .. tab[v[2]].current .. "\n\n"
	end
	return str
end
function getCharacterInformationValue(row)
	local str = characters[currentID].Stats[characterInformationDisplayCategories[rowNumber][2]].current
	if(characterInformationDisplayCategories[rowNumber][3] == 1) then
		str = str .. "%"
	end
	return str
end
`
menu
{
	name 'CHARACTER_INFORMATION'
	align center center
	modal
	popupSound 1
	onOpen
	"
		characterInformationDisplayStr = formatCharacterInformationStr()
	"
	label
	{
		area 0 0 766 593
		mosaic popup4
	}
	label
	{
		area		300 78 410 22
		text		lua "characters[currentID].name"
		text style  	'title'
		text align	center center
	}
	label
	{
		area		300 100 410 22
		text		lua "characters[currentID].class"
		text style  	'title'
		text align	center center
	}
	label
	{
		area 104 95 162 174
		bam "POPUPIMG"
		sequence 1
	}
	text
	{
		area 300 158 414 206
		text style "normal_parchment"
		text align center top
		text lua "characterInformationDisplayStr"
		text point 16
		text useFontZoom 0
	}
	list
	{
		column
		{
			width 50
			label
			{
				area 0 0 -1 -1
				text style "normal_parchment"
				text align right top
				text lua "'^N' .. Infinity_FetchString(characterInformationDisplayCategories[rowNumber][1]) .. '^-'"
				text highlight 1
				text point 16
				text useFontZoom 0
			}
		}
		column
		{
			width 50
			label
			{
				area 20 0 -1 -1
				text style "normal_parchment"
				text align left top
				text lua "getCharacterInformationValue(rowNumber)"
				text highlight 1
				text point 16
				text useFontZoom 0
			}
		}
		area 358 364 316 94
		rowheight dynamic
		ignoreFocus 1
		table "characterInformationDisplayCategories"
		var "currentInfoLine"
		scrollbar 'CGSCRL1'
		hidehighlight

	}
	button
	{
		area		588 508 138 56
		text		"DONE_BUTTON"
		text style "button"
		bam normbutt
		action		"Infinity_PopMenu('CHARACTER_INFORMATION')"
	}
}
`
function toggleFrame(curFrame)
	if curFrame == 0 then 
		Infinity_PlaySound("int_01")
		return 2
	else
		Infinity_PlaySound("int_02")
		return 0
	end 
end
function getSelected(cur, my)
	if cur == my then 
		return 1
	else 
		return 0
	end 
end
function GetDifficultyLabel()
	return t('DIFFICULTY_LABEL')..': '..(difficultySLDR+1)
end
function IsFramerateSliderEnabled(touch)
	local ret = true
	if touch == true and CPlatform:GetPlatformType() == platformiPhoneOS then
		ret = false
	elseif touch == true and not e:IsTouchUI() then
		ret = false
	elseif touch == false and e:IsTouchUI() then
		ret = false
	end
	return ret
end

toggleTitles = {
{"GORE_LABEL",							"GORE_DESCRIPTION", 					19, 0, 0},
{"HEAL_ON_REST_LABEL",					"HEAL_ON_REST_DESCRIPTION", 			50, 0, 0},
{"MAX_HP_ON_LEVEL_LABEL",				"MAX_HP_ON_LEVEL_DESCRIPTION", 			55, 0, 0},
{"ALWAYS_RUN_LABEL",					"ALWAYS_RUN_DESCRIPTION", 				69, 0, 0},
{"SMOOTH_AREA_TRANSITIONS_LABEL",		"SMOOTH_AREA_TRANSITIONS_DESCRIPTION",	70, 0, 0},
{"SHOW_ENEMY_HEALTH_LABEL",				"SHOW_ENEMY_HEALTH_DESCRIPTION",		72, 0, 0},
}

selectedOpt = 0
helpString = 0

ttDelaySLDR = 0
keyboardSLDR = 0
mouseSLDR = 0
difficultySLDR = 0
framerateSLDR = 0

panelID = 8

`

menu
{
	name	'OPTIONS_GAMEPLAY'
	align center center
	modal
	popupSound 1
	onOpen
	"
		if(addedCloudOption == nil and (not e:IsTouchUI()) and CPlatform:IsPlatformServiceConnected()) then
			table.insert(toggleTitles,{'ENABLE_CLOUD_LABEL', 'ENABLE_CLOUD_DESCRIPTION', 60, 0, 0})
			addedCloudOption = true
		end
		
		panelID = 8
		helpString = 'GAMEPLAY_DESCRIPTION'
		selectedOpt = 0
		selectedSL = 0

		ttDelaySLDR = Infinity_GetOption(1, panelID)
		keyboardSLDR = Infinity_GetOption(3, panelID)
		mouseSLDR = Infinity_GetOption(2, panelID)
		difficultySLDR = Infinity_GetOption(12, panelID)
		framerateSLDR = Infinity_GetOption(71, panelID)
		
		for index, var in pairs(toggleTitles) do
			var[5] = Infinity_GetOption(var[3], panelID)
			if var[5] == 0 then
				var[4] = 0
			else
				var[4] = 2
 			end
		end
	"

	label
	{
		area	0 0 905 667
		mosaic	OPTPOP4
	}
	label
	{
		area 72 88 170 170
		bam "POPUPIMG"
		sequence 3
	}
	label
	{
		area		362 84 458 44
		text		"GAMEPLAY_TITLE"
		text style	title
		text font "EXOCET"
		text shadow 1
	}
	button
	{
		area	0 0 905 667
		ignoreFocus 1
		sound ""
		action
		"
			helpString = 'GAMEPLAY_DESCRIPTION'
			selectedOpt = 0
			selectedSL = 0
		"
	}
	text
	{
		area		360 168 469 140
		text		lua "t(helpString)"
		text style	normal
		scrollbar	'CGSCRL1'
	}
	list
	{
		
		column 
		{ 
			width 90
			label
			{
				area 10 0 -1 -1
				text lua "t( toggleTitles[rowNumber][1])"
				text style "list"
				text highlight 1
			}
		}
		column 
		{ 
			width 10
			label
			{
				area		4 7 24 24
				bam			checkbut
				frame		lua "toggleTitles[rowNumber][4]"
			}
		}

		area 479 344 348 195
		
		rowheight	38
		table		"toggleTitles"
		var		selectedOpt
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action		
		"
			panelID = 8
			selectedSL = 0
			helpString = toggleTitles[selectedOpt][2]

			if(cellNumber == 2) then
				Infinity_PlaySound('GAM_09')

				toggleTitles[selectedOpt][4] = toggleFrame(toggleTitles[selectedOpt][4])

				if toggleTitles[selectedOpt][4] == 0 then
					toggleTitles[selectedOpt][5] = 0
				else 
					toggleTitles[selectedOpt][5] = 1
				end
			end
		"
	}

	text
	{
		area		111 336 206 35
		text lua	"GetDifficultyLabel()"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(4)"
		enabled 	"e:IsTouchUI()"
		action 
		"
			helpString = 'DIFFICULTY_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 4
		" 
	}
	slider
	{
		area 326 339 105 27
		position "difficultySLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	5
		enabled 	"e:IsTouchUI()"
		action 
		"
			helpString = 'DIFFICULTY_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 4
		" 
	}
	text
	{
		area		111 336 206 35
		text		"TOOLTIP_DELAY_LABEL"
		text style	"normal_parchment"
		text usefontzoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(1)"
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'TOOLTIP_DELAY_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 1
		" 
	}
	slider
	{
		area 326 339 105 27
		position "ttDelaySLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	40
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'TOOLTIP_DELAY_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 1
		" 
	}

	text
	{
		area		111 378 206 35	
		text		"FRAMERATE_LABEL"
		text style	"normal_parchment"
		text usefontzoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(5)"
		enabled 	"IsFramerateSliderEnabled(true)"
		action 
		"
			helpString = 'FRAMERATE_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 5
		" 
	}
	slider
	{
		area 326 382 105 27
		position "framerateSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	3
		enabled 	"IsFramerateSliderEnabled(true)"
		action 
		"
			helpString = 'FRAMERATE_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 5
		" 
	}

	text
	{
		area		111 378 206 35	
		text		"KEYBOARD_SCRLSPEED_LABEL"
		text style	"normal_parchment"
		text usefontzoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(2)"
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'KEYBOARD_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 2
		" 
	}
	slider
	{
		area 326 382 105 27
		position "keyboardSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	40
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'KEYBOARD_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 2
		" 
	}

	text
	{
		area		111 422 206 36	
		text		"MOUSE_SCRLSPEED_LABEL"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(3)"
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'MOUSE_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 3
		" 
	}
	slider
	{
		area 326 427 105 27
		position "mouseSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	40
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'MOUSE_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 3
		" 
	}

	text
	{
		area		111 468 206 36
		text lua	"GetDifficultyLabel()"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(4)"
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'DIFFICULTY_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 4
		" 
	}
	slider
	{
		area 326 473 105 27
		position "difficultySLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	5
		enabled 	"not e:IsTouchUI()"
		action 
		"
			helpString = 'DIFFICULTY_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 4
		" 
	}

	text
	{
		area		111 511 206 35	
		text		"FRAMERATE_LABEL"
		text style	"normal_parchment"
		text usefontzoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(5)"
		enabled 	"IsFramerateSliderEnabled(false)"
		action 
		"
			helpString = 'FRAMERATE_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 5
		" 
	}
	slider
	{
		area 326 516 105 27
		position "framerateSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	3
		enabled 	"IsFramerateSliderEnabled(false)"
		action 
		"
			helpString = 'FRAMERATE_SCRLSPEED_DESCRIPTION' 
			selectedOpt = 0
			selectedSL = 5
		" 
	}
	
	button
	{
		enabled 	"not e:IsTouchUI()"
		bam			NORMBUTT
		sequence	0
		area		243 566 138 56
		text		"ASSIGN_KEYS_BUTTON"
		text style	"button"
		action
		"
			Infinity_PushMenu( 'OPTIONS_KEYBINDINGS' );
			selectedOpt = 0
		"
	}
	button
	{
		enabled 	"e:IsTouchUI()" --feedback use assign keys position in touch ui mode.
		area		243 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"FEEDBACK_BUTTON"
		text style	"button"
		action
		"

			Infinity_PushMenu( 'OPTIONS_FEEDBACK' );
			selectedOpt = 0
		"
	}
	button
	{
		enabled 	"not e:IsTouchUI()"
		area		388 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"FEEDBACK_BUTTON"
		text style	"button"
		action
		"

			Infinity_PushMenu( 'OPTIONS_FEEDBACK' );
			selectedOpt = 0
		"
	}
	button
	{
		area		99 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"AUTO_PAUSE_BUTTON"
		text style	"button"
		action
		"
			selectedOpt = 0
			Infinity_PushMenu( 'OPTIONS_AUTOPAUSE' );
		"
	}
	button
	{
		area		552 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"CANCEL_BUTTON"
		text style	"button"
		action
		"			
			Infinity_PopMenu()
		"
	}
	button
	{
		area		698 566 138 56		
		bam			NORMBUTT
		sequence	2
		text 		"DONE_BUTTON" -- Done
		text style	"button"
		action
		"
			panelID = 8
			Infinity_ChangeOption( 1, ttDelaySLDR, panelID)
			Infinity_ChangeOption( 3, keyboardSLDR, panelID )
			Infinity_ChangeOption( 2, mouseSLDR, panelID )
			Infinity_ChangeOption( 12, difficultySLDR + 1, panelID) -- cannot set story mode through slider
			Infinity_ChangeOption( 71, framerateSLDR, panelID) -- cannot set story mode through slider

			selectedOpt = 0
			selectedSL = 0

			for index, var in pairs(toggleTitles) do
				
				Infinity_ChangeOption( var[3], var[5], panelID)
						
			end

			panelID = 8
			Infinity_PopMenu()
		"
	}

}

`
autoPauseToggles = { 
{'WEAPON_UNUSABLE_LABEL',37692, 5 , 0, 0},
{'END_OF_ROUND_LABEL',37694, 25, 0, 0},
{'ENEMY_SIGHTED_LABEL',68760, 26, 0, 0},
{'SPELL_CAST_LABEL',68761, 31, 0, 0},
{'TRAP_FOUND_LABEL',68762, 34, 0, 0}
}

characterPauseToggles = { 
{'CENTER_MEMBER_LABEL',68753, 37, 0, 0},
{'CHARACTER_HIT_LABEL',37688, 1 , 0, 0},
{'CHARACTER_INJURED_LABEL',37689, 2 , 0, 0},
{'CHARACTER_DEATH_LABEL',37690, 3 , 0, 0},
{'CHARACTER_ATTACKED_LABEL',37691, 4 , 0, 0},
{'CHARACTER_TARGET_DESTROYED',37693, 13, 0, 0},
}

selOptAP = 0

`

menu
{
	name	'OPTIONS_AUTOPAUSE'
	modal
	align center center
	popupSound 1
	onOpen
	"
		panelID = 10
		selOptAP = 0
		autopauseString = 37687
		
		for index, var in pairs(autoPauseToggles) do
				var[5] = Infinity_GetOption(var[3], panelID)
				if var[5] == 0 then
					var[4] = 0
				else
					var[4] = 2
				end
			end
		for index, var in pairs(characterPauseToggles) do
				var[5] = Infinity_GetOption(var[3], panelID)
				if var[5] == 0 then
					var[4] = 0
				else
					var[4] = 2
				end
			end
	"

	label
	{
		area	0 0 905 667
		mosaic	OPTPOP1
	}
	label
	{
		area 47 38 214 229
		bam "POPUPIMG"
		sequence 0
	}
	label
	{
		area		370 80 458 44
		text		"AUTO_PAUSE_TITLE"
		text style	title
		text font "EXOCET"
		text shadow 1
	}
	button
	{
		area	0 0 905 667
		ignoreFocus 1
		sound ""
		action
		"
			autopauseString = 37687
			selOptAP = 0
		"
	}
	text
	{
		area		374 166 458 132
		text		lua "Infinity_FetchString(autopauseString)"
		text style	normal
		scrollbar	'CGSCRL1'
	}
	list
	{
		
		column 
		{ 
			width 90 
			label
			{
				area 10 0 -1 -1
				text lua "t( autoPauseToggles[rowNumber][1])"
				text style "list"
				text highlight 1
			}
		}
		column 
		{ 
			width 10 
			label
			{
				area		4 4 24 24
				bam			checkbut
				frame		lua "autoPauseToggles[rowNumber][4]"
			}
		}

		area 488 350 348 156
		
		rowheight	30
		table		"autoPauseToggles"
		var		selOptAP
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action		
		"
			selOptAPC = 0
			autopauseString = autoPauseToggles[selOptAP][2]

			if(cellNumber == 2) then
				Infinity_PlaySound('GAM_09')

				autoPauseToggles[selOptAP][4] = toggleFrame(autoPauseToggles[selOptAP][4])

				if autoPauseToggles[selOptAP][4] == 0 then
					autoPauseToggles[selOptAP][5] = 0
				else 
					autoPauseToggles[selOptAP][5] = 1
				end
			end
		"
	}
	list
	{
	
		column 
		{ 
			width 90 
			label
			{
				area 10 0 -1 -1
				text lua "t( characterPauseToggles[rowNumber][1])"
				text style "list"
				text highlight 1
			}
		}
		column 
		{ 
			width 10 
			label
			{
				area		4 4 24 24
				bam			checkbut
				frame		lua "characterPauseToggles[rowNumber][4]"
			}
		}

		area 118 336 330 186
		
		rowheight	30
		table		"characterPauseToggles"
		var		selOptAPC
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action		
		"
			selOptAP = 0
			autopauseString = characterPauseToggles[selOptAPC][2]

			if(cellNumber == 2) then
				Infinity_PlaySound('GAM_09')

				characterPauseToggles[selOptAPC][4] = toggleFrame(characterPauseToggles[selOptAPC][4])

				if characterPauseToggles[selOptAPC][4] == 0 then
					characterPauseToggles[selOptAPC][5] = 0
				else 
					characterPauseToggles[selOptAPC][5] = 1
				end

				--Infinity_ChangeOption(characterPauseToggles[selOptAPC][3], characterPauseToggles[selOptAPC][5], panelID )
			end
		"
	}


	button
	{
		area		552 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"CANCEL_BUTTON"
		text style	"button"
		action
		"
			panelID = 8
			helpString = 'GAMEPLAY_DESCRIPTION'
			Infinity_PopMenu()
		"
	}
	button
	{
		area		698 566 138 56		
		bam			NORMBUTT
		sequence	2
		text 		"DONE_BUTTON" --Done
		text style	"button"
		action
		"
			panelID = 10

			for index, var in pairs(autoPauseToggles) do
				
				Infinity_ChangeOption( var[3], var[5], panelID)
						
			end
			
			for index, var in pairs(characterPauseToggles) do	
			
				Infinity_ChangeOption( var[3], var[5], panelID)
						
			end

			panelID = 8
			Infinity_PopMenu()
		"
	}	
}

`
graphicsToggles = {
{'FULL_SCREEN_LABEL',68827, 9 , 0, 0, 0},
{'HARDWARE_CURSOR_LABEL',68839, 13, 0, 0, 0},
{'ZOOM_LOCK_LABEL',106612, 36, 0, 0, 0},
{'SPRITE_OUTLINE_LABEL',106613, 15, 0, 0, 0},
{'GREYSCALE_ON_PAUSE_LABEL',106614, 66, 0, 0, 0},
{'HIGHLIGHT_SPRITE_LABEL',106615, 67, 0, 0, 0},
{'DITHER_ALWAYS_LABEL',106616, 52, 0, 0, 0},
{'NEAREST_NEIGHBOUR_LABEL','NEAREST_NEIGHBOUR_DESCRIPTION', 70, 0, 0, 0},
{'GAMEWORLD_SCALING_LABEL','GAMEWORLD_SCALING_DESCRIPTION', 74, 0, 0, 0},
{'USE_TOUCH_UI_LABEL','USE_TOUCH_UI_DESCRIPTION', 75, 0, 0, 0},
}
addedDirectx = false
function appendDirectXOption()
	if addedDirectx == false then
		dxOption = {'DIRECTX_LABEL', 106621, 68, 0, 0, 0}
		table.insert(graphicsToggles, dxOption)
		addedDirectx = true
	end
end

addedDblSizeCursor = false
function addDblSizeCursorOption()
	if addedDblSizeCursor == false then
		dblSizeCursorOption = {'DOUBLE_SIZE_CURSORS_LABEL','DOUBLE_SIZE_CURSORS_DESCRIPTION', 73, 0, 0, 0}
		table.insert(graphicsToggles, dblSizeCursorOption)
		addedDblSizeCursor = true
	end
end
function removeNonTouchGraphicsOptions()
	local tempTable = {}
	for k,v in pairs(graphicsToggles) do
		Infinity_Log(v[1].." "..k)
		if 	v[1] ~= 'FULL_SCREEN_LABEL' and 
			v[1] ~= 'HARDWARE_CURSOR_LABEL' and 
			v[1] ~= 'HIGHLIGHT_SPRITE_LABEL' and 
			v[1] ~= 'GAMEWORLD_SCALING_LABEL' and 
			v[1] ~= 'DOUBLE_SIZE_CURSORS_LABEL' and 
			v[1] ~= 'USE_TOUCH_UI_LABEL' then
			table.insert(tempTable, v)
		end
	end
	graphicsToggles = tempTable
end

--szef_graphics

selectedGraphicOpt = 0

fontSizeSLDR = 0
fontSizeCancel = 0
gammaSLDR = 0
gammaCancel = 0
brightnessSLDR = 0
brightnessCancel = 0
function formatGraphicsInfoString()
	return options['Graphics']['version'] .. "\nrunning on " .. options['Graphics']['renderer'] .. "\ndriver provided by " .. options['Graphics']['vendor']
end
`

menu
{
	name	'OPTIONS_GRAPHICS'
	modal
	align center center
	popupSound 1
	onOpen
	"
		if e:HasDirectX() then
			appendDirectXOption()
		end
		if e:SupportsDblSizeCursor() then
			addDblSizeCursorOption()
		end
		if e:IsTouchUI() then
			removeNonTouchGraphicsOptions()
		end
		panelID = 6
		helpString = 31052
		selectedGraphicOpt = 0
		selectedSL = 0
		fontSizeSLDR = Infinity_GetOption(22, panelID)
		fontSizeCancel = Infinity_GetOption(22, panelID)
		
		gammaSLDR = Infinity_GetOption(71, panelID)
		gammaCancel = Infinity_GetOption(71, panelID)
		
		brightnessSLDR = Infinity_GetOption(72, panelID)
		brightnessCancel = Infinity_GetOption(72, panelID)
		
		for index, var in pairs(graphicsToggles) do
			var[5] = Infinity_GetOption(var[3], panelID)
			var[6] = 0
			if var[5] == 0 then
				var[4] = 0
			else
				var[4] = 2
			end
		end
	"


	label
	{
		area 0 0 905 667
		mosaic	OPTPOP1
	}
	label
	{
		area 47 38 214 229
		bam "POPUPIMG"
		sequence 0
	}

	label
	{
		area		366 70 460 64
		text		"GRAPHICS_TITLE"
		text style	title
		text font "exocet"
		text shadow 1
	}

	label
	{
		area		108 462 328 74
		text		lua "formatGraphicsInfoString()"
		text style	normal
		text align	center center
		text useFontZoom 1
	}
	button
	{
		area 0 0 905 667
		ignoreFocus 1
		sound ""
		action
		"
			helpString = 31052
			selectedSL = 0
		"
	}
	text
	{
		area		372 164 460 136
		text		lua "getStringFromAmbiguousSource(helpString)"
		text style	normal
		scrollbar	'CGSCRL1'
	}
	
	
	list
	{
		
		column 
		{ 
			width 90
			label
			{
				area 0 0 -1 -1
				text lua "t( graphicsToggles[rowNumber][1])"
				text style "list"
				text highlight 1
			}
		}
		column 
		{ 
			width 10 
			label
			{
				area		4 7 24 24
				bam			checkbut
				frame		lua "graphicsToggles[rowNumber][4]"
			}
		}

		area 492 326 344 216
		
		rowheight	38
		table		"graphicsToggles"
		var		selectedGraphicOpt
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action		
		"
			panelID = 6
			helpString = graphicsToggles[selectedGraphicOpt][2]
			selectedSL = 0
			if(cellNumber == 2) then
				Infinity_PlaySound('GAM_09')
				graphicsToggles[selectedGraphicOpt][4] = toggleFrame(graphicsToggles[selectedGraphicOpt][4])

				if graphicsToggles[selectedGraphicOpt][4] == 0 then
					graphicsToggles[selectedGraphicOpt][5] = 0
				else 
					graphicsToggles[selectedGraphicOpt][5] = 1
				end
				graphicsToggles[selectedGraphicOpt][6] = 1
				--Infinity_ChangeOption(graphicsToggles[selectedGraphicOpt][3], graphicsToggles[selectedGraphicOpt][5], panelID )
			end
		"
	}

	text
	{
		area		108 332 178 36
		text		"FONT_SIZE_LABEL"
		text style	"normal_parchment"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
		text color lua "getLabelColor(1)"
		action 
		"
			helpString = 68783 
			selectedGraphicOpt = 0
			selectedSL = 1
		" 
	}
	slider
	{
		area 322 336 105 27
		position "fontSizeSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	7
		--pad 8 0 10 0
		action
		"
			Infinity_ChangeOption( 22, fontSizeSLDR, 6)
			helpString = 68783
			selectedGraphicOpt = 0
			selectedSL = 1
		"
	}
	
	text
	{
		area		108 374 178 36
		text		"GAMMA_LABEL"
		text style	"normal_parchment"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
		text color lua "getLabelColor(2)"
		action 
		"
			helpString = 31459 
			selectedGraphicOpt = 0
			selectedSL = 2
		" 
	}
	slider
	{
		area 322 378 105 27
		position "gammaSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		-- These settings get multiplied by 10 and then added to 60 to get the gamma percentage.
		-- So the valid range is 60-190.  This was chosen because anything below 60 is ridiculously 
		-- dark, and increasing beyond 200 puts our gamma past the hack we had to throw into the
		-- shaders to make sure that pure black would get whitened at very high gamma levels. -JK
		settings	14
		--pad 8 0 10 0
		action
		"
			Infinity_ChangeOption( 71, gammaSLDR, 6)
			helpString = 31459
			selectedGraphicOpt = 0
			selectedSL = 2
		"
	}
	
	text
	{
		area		108 418 178 36
		text		"BRIGHTNESS_LABEL"
		text style	"normal_parchment"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
		text color lua "getLabelColor(3)"
		action 
		"
			helpString = 31431 
			selectedGraphicOpt = 0
			selectedSL = 3
		" 
	}
	slider
	{
		area 322 422 105 27
		position "brightnessSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	6
		--pad 8 0 10 0
		action
		"
			Infinity_ChangeOption( 72, brightnessSLDR, 6)
			helpString = 31431
			selectedGraphicOpt = 0
			selectedSL = 3
		"
	}

	
	button
	{
		area		552 566 138 56
		bam			NORMBUTT
		text 		"CANCEL_BUTTON"
		text style	"button"
		action
		"
			panelID = 6
			Infinity_ChangeOption( 22, fontSizeCancel, panelID)
			Infinity_ChangeOption( 71, gammaCancel, panelID)
			Infinity_ChangeOption( 72, brightnessCancel, panelID)

			selectedSL = 0
			Infinity_PopMenu()
		"
	}
	button
	{
		area		698 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"DONE_BUTTON" --Done
		text style	"button"
		action
		"
			panelID = 6
			Infinity_ChangeOption( 22, fontSizeSLDR, panelID)

			for index, var in pairs(graphicsToggles) do
				
				if ( var[6] == 1 ) then
					Infinity_ChangeOption( var[3], var[5], panelID)
				end				
			end

			selectedSL = 0
			Infinity_PopMenu()
		"
	}
	button
	{
		area		92 572 178 36
		bam			NORMBUTT
		sequence	2
		text 		"Book of Torment"
		text style	"button"
		action
		"
		Infinity_PushMenu('SKINS')
		"
	}
}
--`
--ImgString = 0
--`
menu 
{
	name 'SKINS'
	modal
	align center center
	popupSound 1
	onOpen
	"
		currentGraphicsIdx = 0
		currentGraphicsSL = 0
		
		for index, var in pairs(graphicsToggles) do
			var[5] = Infinity_GetOption(var[3], panelID)
			var[6] = 0
			if var[5] == 0 then
				var[4] = 0
			else
				var[4] = 2
			
			end
		end
		
		for index, var in ipairs(SkinsOptionsSliders) do
			var[6] = SkinsGetSliderOption(index)
			var[1] = 0
			if var[3] == 0 then
				var[5] = 0
			else
				var[5] = 2
 			end
		end
		
		
	"
	label
	{
		area 0 0 1366 768
		mosaic	'g-btlin'
	}
	label
	{
		area 1108 38 214 229
		bam "POPUPIMG"
		sequence 0
	}
	label
	{
		area		72 176 324 64
		text		"Book of Torment"
		text style	title
		text font "exocet"
		text shadow 1
	}

	
	text
	{
		area		464 148 410 126
		text		lua "getStringFromAmbiguousSource(helpString)"
		text style	normal
		text align center center
		scrollbar	'CGSCRL1'
	}
	--text
	--{
		--area		532 250 768 462
		--mosaic		lua "getStringFromAmbiguousSource(ImgString)"
	--}
	text
	{
		area		64 350 346 195
		mosaic		lua "GetDboxImgString()"
	}
	text
	{
		area		64 350 346 195
		mosaic		lua "GetDboxImgString()"
		action
		"
		Infinity_PushMenu('DBOX_IMG_FULL')
		"
		actionExit
		"
		Infinity_PopMenu('DBOX_IMG_FULL')
		"
	}
	text
	{
		area		488 350 346 195
		mosaic		lua "GetInvImgString()"
	}
	text
	{
		area		488 350 346 195
		mosaic		lua "GetInvImgString()"
		action
		"
		Infinity_PushMenu('INV_IMG_FULL')
		"
		actionExit
		"
		Infinity_PopMenu('INV_IMG_FULL')
		"
	}
	text
	{
		area		916 350 346 195
		mosaic		lua "GetJournalImgString()"
	}
	text
	{
		area		916 350 346 195
		mosaic		lua "GetJournalImgString()"
		action
		"
		Infinity_PushMenu('JOURNAL_IMG_FULL')
		"
		actionExit
		"
		Infinity_PopMenu('JOURNAL_IMG_FULL')
		"
	}
	
	text
	{
		area		42 596 178 36
		text "Dialogue Box:"
		text style	"button"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
		text color lua "getLabelColor(4)"
		action 
		"
			helpString = GetdboxDescString() 
			selectedGraphicOpt = 0
			selectedSL = 4
		" 
	}
	slider
	{
		area 300 596 110 36
		position "SkinsOptionsSliders[1][6]"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	lua "SkinsOptionsSliders[1][3]"
		--pad 8 0 10 0
		action 
		"
			currentGraphicsSL = 1
			helpString = GetdboxString()
			--ImgString = GetImgString(1)
			currentGraphicsIdx = 0
			selectedGraphicOpt = 0
			selectedSL = 4
		" 
	}
	text
	{
		area		198 596 88 36
		text lua "GetdboxSliderString()"
		text style	"button"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
	}
	
	text
	{
		area		470 596 178 36
		text "Inventory Layout:"
		text style	"button"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
		text color lua "getLabelColor(5)"
		action 
		" 	
			helpString = GetInvDescString()				
			selectedGraphicOpt = 0
			selectedSL = 5	
		"
	}
	slider
	{
		area 724 596 110 36
		position "SkinsOptionsSliders[2][6]"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	lua "SkinsOptionsSliders[2][3]"
		--pad 8 0 10 0
		action 
		"
			currentGraphicsSL = 1
			helpString = GetInvString()
			--ImgString = GetImgString(2)			
			currentGraphicsIdx = 0
			selectedGraphicOpt = 0
			selectedSL = 5
		" 
	}
	text
	{
		area		634 596 68 36
		text lua "GetInvSliderString()"
		text style	"button"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
	}
	
	text
	{
		area		894 596 178 36
		text "Journal Screen:"
		text style	"button"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
		text color lua "getLabelColor(6)"
		action 
		" 	
			helpString = GetJournalDescString()
			
			selectedGraphicOpt = 0
			selectedSL = 6	
		"
	}
	slider
	{
		area 1146 596 110 36
		position "SkinsOptionsSliders[3][6]"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	lua "SkinsOptionsSliders[3][3]"
		--pad 8 0 10 0
		action 
		"
			currentGraphicsSL = 1
			helpString = GetJournalString()
			--ImgString = GetImgString(3)
			currentGraphicsIdx = 0
			selectedGraphicOpt = 0
			selectedSL = 6
		" 
	}
	text
	{
		area		1052 596 68 36
		text lua "GetJournalSliderString()"
		text style	"button"
		text align left center
		text useFontZoom 0
		focus color 255 255 255 255
	}

	
	button
	{
		area		500 674 138 56
		bam			NORMBUTT
		text 		"CANCEL_BUTTON"
		text style	"button"
		action
		" 
			panelID = 6
			Infinity_ChangeOption( 22, fontSizeCancel, panelID)
			Infinity_ChangeOption( 71, gammaCancel, panelID)
			Infinity_ChangeOption( 72, brightnessCancel, panelID)
			
			selectedSL = 0
			Infinity_PopMenu()
		"
	}
	
	button
	{
		area		680 674 138 56
		bam			NORMBUTT
		sequence	2
		text 		"DONE_BUTTON" --Done
		text style	"button"
		action
		"
			panelID = 6
			Infinity_ChangeOption( 22, fontSizeSLDR, panelID)

			for index, var in pairs(graphicsToggles) do
				
				if ( var[6] == 1 ) then
					Infinity_ChangeOption( var[3], var[5], panelID)
				end				
			end
			
			for index, var in ipairs(SkinsOptionsSliders) do
				SkinsSaveSliderOption(index)
			end
			
			Infinity_SetINIValue('Graphics','Dialogue Box Skin',SkinsOptionsSliders[1][6])
			Infinity_SetINIValue('Graphics','Inventory Skin',SkinsOptionsSliders[2][6])
			Infinity_SetINIValue('Graphics','Journal Screen',SkinsOptionsSliders[3][6])

			
			selectedSL = 0
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'DBOX_IMG_FULL'
	align center center
	onOpen
	"
	if SkinsOptionsSliders[1][6] == 0 then
    Infinity_PushMenu('DBOX_IMG1') 
    elseif SkinsOptionsSliders[1][6] == 1 then
    Infinity_PushMenu('DBOX_IMG2') 
    elseif SkinsOptionsSliders[1][6] == 2 then
    Infinity_PushMenu('DBOX_IMG3') 
	else
	Infinity_PushMenu('DBOX_IMG4')
    end
	"
	button
	{
		area		0 0 0 0
	}
	}
	menu
	{
	name 'DBOX_IMG1'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btcla"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'DBOX_IMG2'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btpor"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'DBOX_IMG3'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btsd1"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'DBOX_IMG4'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btttn"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'INV_IMG_FULL'
	align center center
	onOpen
	"
	if SkinsOptionsSliders[2][6] == 0 then
    Infinity_PushMenu('INV_IMG1') 
    elseif SkinsOptionsSliders[2][6] == 1 then
    Infinity_PushMenu('INV_IMG2') 
    else
    Infinity_PushMenu('INV_IMG3')
    end
	"
	button
	{
		area		0 0 0 0
	}
	}
	menu
	{
	name 'INV_IMG1'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btdef"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'INV_IMG2'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btsh1"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
		menu
	{
	name 'INV_IMG3'
	label
	{
		area 0 0 1366 768
		mosaic	"inv-iw"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'JOURNAL_IMG_FULL'
	align center center
	onOpen
	"
	if SkinsOptionsSliders[3][6] == 0 then
    Infinity_PushMenu('JOURNAL_IMG1') 
    else
    Infinity_PushMenu('JOURNAL_IMG2') 
    end
	"
	button
	{
		area		0 0 0 0
	}
	}
	menu
	{
	name 'JOURNAL_IMG1'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btjol"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	menu
	{
	name 'JOURNAL_IMG2'
	label
	{
		area 0 0 1366 768
		mosaic	"g-btjnw"
	}
	button
	{
		area		1288 36 50 50
		bam			"XBUTT"
		action
		"
			Infinity_PopMenu()
		"
	}
	}
	
`
selectedsoundOpt = 0
command = {
{'ALWAYS_LABEL',0, 8, 0, 0},
{'SELDOM_LABEL',0, 9, 0, 0},
{'NEVER_LABEL',0, 10, 0, 0}
}
commandSel = 0
selectOpt = {
{'ALWAYS_LABEL',0, 58, 0, 0},
{'SELDOM_LABEL',0, 59, 0, 0},
{'NEVER_LABEL',0, 60, 0, 0}
}
selectSel = 0
ambientSLDR = 0
sfxSLDR = 0
voiceSLDR = 0
musicSLDR = 0
movieSLDR = 0

`

menu
{
	name	'OPTIONS_SOUND'
	align center center
	modal
	popupSound 1
	onOpen
	"
		panelID = 7
		helpString = 31210
		selectedsoundOpt = 0
		selectedSL = 0

		ambientSLDR = Infinity_GetOption(1, panelID)
		sfxSLDR = Infinity_GetOption(2, panelID)
		voiceSLDR = Infinity_GetOption(3, panelID)
		musicSLDR = Infinity_GetOption(4, panelID)
		musicCancel = Infinity_GetOption(4, panelID)
		movieSLDR = Infinity_GetOption(22, panelID)

		for index, var in pairs(command) do
				var[5] = Infinity_GetOption(var[3], panelID)
				if var[5] == 0 then
					var[4] = 0
				else
					var[4] = 2
					commandSel = index
				end
			end
		for index, var in pairs(selectOpt) do
			var[5] = Infinity_GetOption(var[3], panelID)
			if var[5] == 0 then
				var[4] = 0
			else
				var[4] = 2
				selectSel = index
			end
		end
	"
	
	label
	{
		area	0 0 905 667
		mosaic	OPTPOP1
	}
	label
	{
		area 47 38 214 229
		bam "POPUPIMG"
		sequence 0
	}
	label
	{
		area		368 78 456 44
		text		"SOUND_TITLE"
		text style	title
		text font "exocet"
		text shadow 1
	}

	button
	{
		area	0 0 905 667
		ignoreFocus 1
		sound ""
		action
		"
			helpString = 31210
		"
	}
	text
	{
		area		370 164 454 132
		text		lua "Infinity_FetchString(helpString)"
		text style	normal
		scrollbar	'CGSCRL1'
	}
	
	text
	{
		area		488 342 162 44
		text		"COMMAND_SOUNDS_BUTTON"
		text style	"label_parchment"
		text point 16
		text highlight lua "getSelected(selectedSL, 1)"
		action 
		"
			helpString = 68906 
			selectedsoundOpt = 0
			selectedSL = 1
		"
	}
	list
	{
		
		column 
		{ 
			width 50 
			label
			{
				area 10 0 -1 -1
				text lua "t( command[rowNumber][1])"
				text style	"list"
				text align right center
				text highlight 1
			}
		}
		column 
		{ 
			width 50
			label
			{
				area		8 7 24 24
				bam			checkbut
				frame		lua "command[rowNumber][4]"
			}
		}

		area 504 386 134 145
		
		rowheight	38
		table		"command"
		var		commandSel
		hidehighlight

		action		
		"
			panelID = 7
			helpString = 68906 
			selectedSL = 1
			selectedsoundOpt = 0
			opt = commandSel
			command[1][4] = 0
			command[2][4] = 0
			command[3][4] = 0
			
			Infinity_PlaySound('int_01')
			command[opt][4] = 2
		"
	}

	text
	{
		area		666 342 162 44
		text		"SELECTION_BUTTON"
		text style	"label_parchment"
		text point 16
		text highlight lua "getSelected(selectedSL, 2)"
		action 
		"
			helpString = 68909 
			selectedsoundOpt = 0
			selectedSL = 2
		"
	}

	list
	{
		
		column 
		{ 
			width 50
			label
			{
				area 10 0 -1 -1
				text lua "t( selectOpt[rowNumber][1])"
				text style	"list"
				text align right center
				text highlight 1
			}
		}
		column 
		{ 
			width 50
			label
			{
				area		8 7 24 24
				bam			checkbut
				frame		lua "selectOpt[rowNumber][4]"
			}
		}

		area 680 386 134 145
		
		rowheight	38
		table		"selectOpt"
		var		selectSel
		hidehighlight

		action		
		"
			panelID = 7
			helpString = 68909 
			selectedSL = 2
			opt = selectSel
			selectOpt[1][4] = 0
			selectOpt[2][4] = 0
			selectOpt[3][4] = 0
			selectedsoundOpt = 0
			
			Infinity_PlaySound('int_01')
			selectOpt[opt][4] = 2
		"
	}
	
	text
	{
		area		106 330 192 36
		text		"AMBIENT_VOLUME_LABEL"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(4)"
		action 
		"
			helpString = 68921 
			selectedsoundOpt = 0
			selectedSL = 4
		"
	}
	slider
	{
		area 319 334 105 27
		position "ambientSLDR"
		mosaic sliderbg
		bam	 'SLDRSTAR'
		settings	40
		action 
		"
			helpString = 68921 
			selectedsoundOpt = 0
			selectedSL = 4
		"
	}

	text
	{
		area		106 370 192 36	
		text		"SFX_VOLUME_LABEL"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(5)"
		action 
		"
			helpString = 68924 
			selectedsoundOpt = 0
			selectedSL = 5
		"
		
	}
	slider
	{
		area 319 375 105 27
		mosaic sliderbg
		position "sfxSLDR"
		bam	 'SLDRSTAR'
		settings	40
		action 
		"
			helpString = 68924 
			selectedsoundOpt = 0
			selectedSL = 5
		"
	}

	text
	{
		area		106 411 192 36	
		text		"VOICE_VOLUME_LABEL"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(6)"
		action 
		"
			helpString = 68925 
			selectedsoundOpt = 0
			selectedSL = 6
		"
	}
	slider
	{
		area 319 416 105 27
		position "voiceSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	40
		action 
		"
			helpString = 68925
			selectedsoundOpt = 0
			selectedSL = 6
		"
	}

	text
	{
		area		106 453 192 36	
		text		"MUSIC_VOLUME_LABEL"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(7)"
		action 
		"
			helpString = 68923 
			selectedsoundOpt = 0
			selectedSL = 7
		"
		
	}
	slider
	{
		area 319 457 105 27
		position "musicSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	40
		action 
		"
			Infinity_ChangeOption( 4, musicSLDR, panelID)
			helpString = 68923 
			selectedsoundOpt = 0
			selectedSL = 7
		"
	}

	text
	{
		area		106 494 192 40	
		text		"MOVIE_VOLUME_LABEL"
		text style	"normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(8)"
		action 
		"
			helpString = 68922
			selectedsoundOpt = 0
			selectedSL = 8
		"
	}
	slider
	{
		area 319 502 105 27
		position "movieSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	40
		action 
		"
			helpString = 68922
			selectedsoundOpt = 0
			selectedSL = 8
		"
	}

	button
	{
		area		552 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"CANCEL_BUTTON"
		text style	"button"
		action
		"
			selectedSL = 0
			panelID = 7
			Infinity_ChangeOption( 4, musicCancel, panelID)
			Infinity_PopMenu()
		"
	}
	button
	{
		area		698 566 138 56
		bam			NORMBUTT
		sequence	2
		text 		"DONE_BUTTON"
		text style	"button"
		action
		"
			panelID = 7
			
			for index, var in pairs(command) do
				if var[4] == 2 then
					Infinity_ChangeOption( var[3], 1, panelID)
				end
			end
			for index, var in pairs(selectOpt) do
				if var[4] == 2 then
					Infinity_ChangeOption( var[3], 1, panelID)	
				end	
			end
			Infinity_ChangeOption( 1, ambientSLDR, panelID)
			Infinity_ChangeOption( 2, sfxSLDR, panelID )
			Infinity_ChangeOption( 3, voiceSLDR, panelID )
			Infinity_ChangeOption( 4, musicSLDR, panelID)
			Infinity_ChangeOption( 22, movieSLDR, panelID)

			selectedOpt = 0
			selectedSL = 0

			panelID = 8
			Infinity_PopMenu()
		"
	}
}


`

feedbackToggles = {
{'ENABLE_CONFIRMATION_LABEL',32296, 41, 0, 0},
{'DISABLE_COSMETIC_ATTACKS_LABEL',66655, 43, 0, 0}
}

messagesToggles = { 
{'STATE_CHANGES_LABEL',37460, 13, 0, 0},
{'MISC_LABEL',37462, 15, 0, 0},
{'TO_HIT_ROLLS_LABEL',37453, 10, 0, 0},
{'COMBAT_INFO_LABEL',37457, 11, 0, 0},
{'SPELLCASTING_LABEL', 37458, 12, 0, 0},
}

selFeedOpt = 0
selMessageOpt = 0
helpString = 0

markerFeedSLDR = 0
locatorFeedSLDR = 0

function getFrequency(d)
	strref = 0
	if ( d ==0 ) then
		strref = 106637
	end
	if (d == 1) then
		strref = 106638
	end
	if (d == 2) then
		strref = 106639
	end
	if (d == 3) then
		strref = 106640
	end
	if (d == 4) then
		strref = 106641
	end
	return Infinity_FetchString(strref)
end
function getLabelColor(label)
	local c = 0
	if(selectedSL == label) then
		return 0x00FFFFFF
	else
		return 	bit32.band(tonumber(fontcolors['Y'],16),0x00FFFFFF)
	end
end
`

menu
{
	name	'OPTIONS_FEEDBACK'
	align center center
	modal
	popupSound 1
	onOpen
	"
		panelID = 9

		helpString = 37410
		selFeedOpt = 0
		selMessageOpt = 0
		selectedSL = 0

		markerFeedSLDR = Infinity_GetOption(8, panelID)
		locatorFeedSLDR = Infinity_GetOption(9, panelID)
		
		for index, var in pairs(feedbackToggles) do
				var[5] = Infinity_GetOption(var[3], panelID)
				if var[5] == 0 then
					var[4] = 0
				else
					var[4] = 2
				end
			end

		for index, var in pairs(messagesToggles) do
			var[5] = Infinity_GetOption(var[3], panelID)
			if var[5] == 0 then
				var[4] = 0
			else
				var[4] = 2
			end
		end

	"

	label
	{
		area	0 0 905 667
		mosaic	OPTPOP1
	}
	label
	{
		area 47 38 214 229
		bam "POPUPIMG"
		sequence 0
	}
	label
	{
		area		366 76 462 52
		text		"FEEDBACK_TITLE"
		text style	title
		text font "EXOCET"
		text shadow 1
	}
	label
	{
		area		318 368 104 26
		text		lua "getFrequency(markerFeedSLDR)"
		text style	"normal"
		text useFontZoom 0
		text align	center center
	}
	label
	{
		area		318 440 104 26
		text		lua "getFrequency(locatorFeedSLDR)"
		text style	"normal"	
		text useFontZoom 0
		text align	center center
	}
	button
	{
		area	0 0 905 667
		ignoreFocus 1
		sound ""
		action
		"
			helpString = 37410
			selFeedOpt = 0
			selMessageOpt = 0
			selectedSL = 0
		"
	}
	text
	{
		area		371 165 461 127
		text		lua "Infinity_FetchString(helpString)"
		text style	normal
		scrollbar	'CGSCRL1'
	}

	list
	{
		
		column 
		{ 
			width 90
			label
			{
				area 10 0 -1 -1
				text lua "t( messagesToggles[rowNumber][1])"
				text style "list"
				text highlight 1
			}
		}
		column 
		{ 
			width 10
			label
			{
				area		4 7 24 24
				bam			checkbut
				frame		lua "messagesToggles[rowNumber][4]"
			}
		}

		area 488 332 344 196
		
		rowheight	38
		table		"messagesToggles"
		var		selMessageOpt
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action		
		"

			helpString = messagesToggles[selMessageOpt][2]
			selectedSL = 0
			selFeedOpt = 0

			if(cellNumber == 2) then
				Infinity_PlaySound('GAM_09')
				messagesToggles[selMessageOpt][4] = toggleFrame(messagesToggles[selMessageOpt][4])

				if messagesToggles[selMessageOpt][4] == 0 then
					messagesToggles[selMessageOpt][5] = 0
				else 
					messagesToggles[selMessageOpt][5] = 1
				end
			end
		"
	}

	text 
	{
		area		111 332 192 36
		text		"MARKER_FEEDBACK_LABEL"
		text style "normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(1)"
		action 
		"
			helpString = 37411
			selFeedOpt = 0
			selMessageOpt = 0
			selectedSL = 1
		"
		
	}
	slider
	{
		area		318 336 105 27
		position "markerFeedSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	5
		action 
		"
			helpString = 37411
			selFeedOpt = 0
			selMessageOpt = 0
			selectedSL = 1
		"
	}

	text
	{
		area		111 404 192 36	
		text		"LOCATOR_FEEDBACK_LABEL"
		text style "normal_parchment"
		text useFontZoom 0
		text align	left center
		focus color 255 255 255 255
		text color lua "getLabelColor(2)"
		action 
		"
			helpString = 106684
			selFeedOpt = 0
			selMessageOpt = 0
			selectedSL = 2
		"
	}
	slider
	{
		area 318 408 105 27
		position "locatorFeedSLDR"
		bam	 'SLDRSTAR'
		mosaic sliderbg
		settings	4
		action 
		"
			helpString = 106684
			selFeedOpt = 0
			selMessageOpt = 0
			selectedSL = 2
		"
	}
	button
	{
		area		552 566 138 56
		on escape
		bam			NORMBUTT
		sequence	2
		text 		"CANCEL_BUTTON"
		text style	"button"
		action
		"
			helpString = 'GAMEPLAY_DESCRIPTION'
			selectedSL = 0
			panelID = 8
			Infinity_PopMenu()
		"
	}
	button
	{
		area		698 566 138 56	
		bam			NORMBUTT
		sequence	2
		text 		"DONE_BUTTON" --Done
		text style	"button"
		action
		"
			helpString = 'GAMEPLAY_DESCRIPTION'
			panelID = 9
			Infinity_ChangeOption( 8, markerFeedSLDR, panelID)
			Infinity_ChangeOption( 9, locatorFeedSLDR, panelID )

			selectedOpt = 0
			selectedSL = 0

			for index, var in pairs(messagesToggles) do
				
				Infinity_ChangeOption( var[3], var[5], panelID)
						
			end

			for index, var in pairs(feedbackToggles) do
				
				Infinity_ChangeOption( var[3], var[5], panelID)
						
			end
			Infinity_PopMenu()
		"
	}
}

`

keyCategory = 1
key = 0

function displayHelp()
	if not (key == 0) then
		return 106646
	end
	return 0
end
function getHotkeyName(category,number)
	local ret = ""
	if category < 5 then
		ret = t(keybindings[category][number][4])
	else
		ret = Infinity_FetchString(keybindings[category][number][4])
	end
	return ret
end
function getHotkeyText(row)
	if(Infinity_InKeybind() and row == key) then
		local lambda = (math.sin(Infinity_GetClockTicks()/100)+1)/2 --sin wave between 0 and 1
		local color = bit32.lshift(0xFF,24) + bit32.lshift(0x10 * lambda,16) + bit32.lshift(0xcd * lambda,8) + 0xe5 * lambda --interpolate between yellow and black 
		local character = Infinity_GetKeyName(oldKey)
		local str = string.format('^0x%x%s^-', color, character)
		return str
	else
		return Infinity_GetKeyName(keybindings[keyCategory][rowNumber][6])
	end
end
`
menu
{
	name	'OPTIONS_KEYBINDINGS'
	modal
	align center center
	popupSound 1
	onOpen
	"
		oldKeybindings = deepcopy(keybindings)
	"
	
	label -- Background
	{
		area 0 0 907 669
		mosaic OPTPOP2 
		ignoreFocus 1
		sound ""
	}
	label
	{
		area 114 100 101 118
		bam "POPUPIMG"
		sequence 4
	}
	
	label -- Title
	{
		area 368 68 458 38
		text  "ASSIGN_KEYS_TITLE" 
		text style	"title"
		text font "EXOCET"
		text shadow 1
	}
	
	label -- Instruction
	{
		area 368 106 458 28
		text  "ASSIGN_KEYS_SUBTITLE" 
		text style	"label"
	}
	label -- Contextual instruction
	{
		area 358 154 468 32
		text lua "Infinity_FetchString(displayHelp())"
		text style	"label"
	}

	list -- Key categories
	{
		column 
		{ 
			width 100 
			label
			{
				area 0 0 -1 -1
				text lua "t(keycategories[rowNumber][2])"
				text style	"normal"
				text useFontZoom 0
				text align	center center 
				text highlight 1
			}
		}
		area 108 232 374 301
		
		rowheight	24
		table		"keycategories"
		var			keyCategory
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action
		"
			Infinity_StopKeybind()
			key = 0
		"
	}

	
	list -- Key bindings
	{
		column 
		{ 
			width 90 
			label
			{
				area 0 0 -1 -1
				text lua "getHotkeyName(keyCategory,rowNumber)"
				text style	"list"
				text highlight 1
			}
		}
		column 
		{ 
			width 10
			label
			{
				area 0 0 -1 -1
				text lua "getHotkeyText(rowNumber)"
				text style	"normal"
				--text upper
				text align center center 
				text highlight 1
				text useFontZoom 0
			}
		}
		
		area 516 232 316 301
		rowheight	24
		table		"keybindings[keyCategory]"
		var			key
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action
		"
		if(key > 0) then
			Infinity_StartKeybind(key);
			oldKey = keybindings[keyCategory][key][6]
			keybindings[keyCategory][key][6] = 0
		end
		"
	}
	
	button
	{
		area		406 566 138 56
		bam			NORMBUTT
		text		"CANCEL_BUTTON"
		text style	"button"
		on escape
		action
		"
			setKeymap(oldKeybindings)
			Infinity_StopKeybind()
			key = 0
			Infinity_PopMenu();
		"	
	}
	button
	{
		area		552 566 138 56
		bam			NORMBUTT
		text		"DEFAULT_BUTTON"
		text style	"button"
		
		action
		"
			revertKeymap();
		"	
	}
	button
	{
		area		698 566 138 56
		bam			NORMBUTT
		text		"DONE_BUTTON"
		text style	"button"
		action
		"
			Infinity_StopKeybind()
			key = 0
			Infinity_PopMenu();
		"	
	}
}

`
language = 0
showsubtitles = 0
function languageDetails()
	if languages[language] ~= nil then
		return Infinity_FetchString(languages[language][2]) .. '\n'  .. Infinity_FetchString(languages[language][3])
	else
		return ""
	end
end
function findCurrentLanguage()
	local lang = Infinity_GetINIString('Language', 'Text', '')
	for k,v in pairs(languages) do
		if v[1] == lang then
			language = k
  		end
	end
end
languageToggles =
{
	{'SHOW_SUBTITLES_LABEL',0, 34, 0, 0}
}
	
`
menu
{
	name	'OPTIONS_LANGUAGE'
	modal
	align center center
	popupSound 1
	onOpen
	"
		languageToggles[1][5] = Infinity_GetINIValue('Program Options', 'Display Subtitles', 1)
		
		if(languageToggles[1][5] == 1) then
			languageToggles[1][4] = 2
		else
			languageToggles[1][4] = 0
		end
		
		findCurrentLanguage()
	"
	
	label
	{
		area 0 0 766 593
		mosaic popup4
	}
	label
	{
		area 104 95 162 174
		bam "POPUPIMG"
		sequence 1
	}
	
	label
	{
		area 296 79 422 46
		text "LANGUAGE_TITLE"
		text style "title"
		text font "EXOCET"
		text shadow 1
	}
	list
	{
		column { 
			width 100
			label
			{
				area 0 0 -1 -1
				text lua "languages[rowNumber][4]"
				text style	"list"
				text align center center 
				text highlight 1
			}
		}
	
		area 296 138 422 344
		rowheight	24
		table		"languages"
		var			language
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}
	
	button
	{
		area 426 508 138 56
		bam			NORMBUTT
		text	"CANCEL_BUTTON"
		text style	"button"
		sequence 1
		action
		"
			-- cancel
			for index, var in pairs(languages) do
				Infinity_Log(var[3])
			end
			Infinity_PopMenu();
		"
	}
	
	button
	{
		area 588 508 138 56
		bam			NORMBUTT
		text 		"DONE_BUTTON"
		text style	"button"
		action
		"
			-- done
			Infinity_SetLanguage(languages[language][1],languageToggles[1][5])
			Infinity_PopMenu()
		"
	}
	
}
menu
{
	name 'QuitMenu'
	modal
	ignoreEsc
	align center center
	popupSound 1
	label -- Background
	{
		area 0 0 923 396
		mosaic POPUP2
	}
	label
	{
		area 93 96 186 186
		bam "POPUPIMG"
		sequence 2
	}
	label --Title
	{
		area 336 85 540 224
		text  20582
		text style	"label_parchment"
	}
	button
	{
		area		522 320 170 54
		bam		widebutt
		sequence	0
		text  "NO_BUTTON"
		text style	"button"
		on 			escape
		action
		"
			Infinity_SetOverlay(nil)
			e:RestoreHidden()
		"	
	}
	button
	{
		area		706 320 170 54
		bam		widebutt
		sequence	0
		text  "YES_BUTTON"
		text style	"button"
		on 			return
		action
		"
			Infinity_SetOverlay(nil)
			Infinity_ShutdownGame()
		"	
	}
}

`
selectedSlot = nil
itemRequestAmt = 0

function showItemAmountRequester(slotName)
	local slot = characters[id].equipment[slotName]
	if(slot.item.count > 1) then
		selectedSlot = slotName
		popupRequester(slot.item.count, inventorySplitStack, false, slot.item)
	end
end
function inventorySplitStack(cnt)
	Infinity_SplitItemStack(characters[id].equipment[selectedSlot].id, cnt,'slot_inv_' .. characters[id].equipment[selectedSlot].id)
end

function GetAbilityIdentifyString()
	if(characters[id].equipment[selectedSlot].item.identified == 0) then
		return t("IDENTIFY_BUTTON")
	end
	
	if(characters[id].equipment[selectedSlot].abilityMode == 1) then
		return t("ABILITIES_BUTTON")
	end
	
	return ""
end
function itemRequesterDoneClickable()
	local cnt = tonumber(itemRequestAmt)
	return (cnt and  cnt <= requester.requesterMax)
end

requester = {}
requester.requesterMax = 0
requester.requesterFunc = nil
requester.selling = false
requester.item = nil
`
menu
{
	name 'POPUP_REQUESTER'
	align center center
	modal
	popupSound 1
	onOpen
	"
		if requester.selling == false then
			itemRequestAmt = 1
		else
			itemRequestAmt = requester.requesterMax
		end
		
		ticksPassed = 0
	"
	
	label
	{
		area 0 0 684 393
		mosaic POPUP7
	}
	label
	{
		area 316 99 302 43
		text "CHOOSE_AMOUNT_LABEL"
		text style "label"
	}
	label
	{
		area 439 180 55 34
		fill 0 0 0 200
	}
	edit
	{
		area		442 188 49 21
		var			itemRequestAmt
		text style	"edit"
		align center top
		maxlines	1
		action
		"
			-- only permit numbers as letters.
			-- character limit of 4
			if((tonumber(letter_pressed) ~= nil or not letter_pressed) and #tostring(itemRequestAmt) < 4) or key_pressed == 8 then
				return 1
			else
				return 0
			end
		"
	}
	button
	{
		bam			WIDEBUTT
		area		290 310 170 54
		text  "CANCEL_BUTTON"
		text style	"button"
		action
		"
			Infinity_PopMenu()
		"
	}	
	button
	{
		bam			WIDEBUTT
		area		474 310 170 54
		text  "DONE_BUTTON"
		text style	"button"
		clickable lua "itemRequesterDoneClickable()"
		action
		"
			local cnt = tonumber(itemRequestAmt)
			Infinity_PopMenu()
			if(cnt and cnt > 0 and cnt <= requester.requesterMax) then
				requester.requesterFunc(cnt)
			end
		"
	}
	button
	{
		bam "cgplus"
		area 510 172 52 42
		sequence 2
		action
		"
			local amt = tonumber(itemRequestAmt)
			if(amt < requester.requesterMax) then
				itemRequestAmt = amt + 1
			end
		"
		actionHold 
		"
			local amt = tonumber(itemRequestAmt)
			ticksPassed = ticksPassed + 1
			if (ticksPassed > 2 and amt < requester.requesterMax) then
				itemRequestAmt = amt + 1
				ticksPassed = 0
			end
		"  
	}
	button
	{
		bam "cgminus"
		area 373 173 52 42
		sequence 2
		action
		"
			local amt = tonumber(itemRequestAmt)
			if(amt > 0) then
				itemRequestAmt = amt - 1
			end
		"
		actionHold 
		"
			local amt = tonumber(itemRequestAmt)
			ticksPassed = ticksPassed + 1
			if (ticksPassed > 2 and amt > 0) then
				itemRequestAmt = amt - 1
				ticksPassed = 0
			end
		"  
	}
	label
	{
		area 126 142 86 90
		icon lua "requester.item.icon"
	}
}
`
selectedAbility = -1
function initAbilities()
	--initialize selected ability
	local i = 1
	while ( i < 4 ) do
		local ability = characters[id].equipment[selectedSlot].abilities[i]
		if(ability ~= nil) then
			if(ability.selected == 1) then
				selectedAbility = i
				return
			end
		end
		i = i + 1
	end
end
function getAbilitiesRowBackground(row)
	if(selectedAbility == row) then
		return "ABLROWB"
	else
		return "ABLROW"
	end
end
`
menu
{
	name 'ITEM_ABILITIES'
	align center center
	onOpen "initAbilities()"
	popupSound 1
	
	label
	{
		area 0 0 750 587
		mosaic popup6
	}
	label
	{
		area 283 80 427 44
		text "ITEM_ABILITIES_TITLE"
		text style	"title"
	}

	list
	{
		column 
		{ 
			width 100 
			label
			{
				area 0 0 379 55
				mosaic lua "getAbilitiesRowBackground(rowNumber)"
			}
			label
			{
				area 5 5 45 45
				bam lua "characters[id].equipment[selectedSlot].abilities[rowNumber].icon"
				enabled "characters[id].equipment[selectedSlot].abilities[rowNumber] ~= nil"
			}
			label
			{
				area 56 5 316 45
				enabled "characters[id].equipment[selectedSlot].abilities[rowNumber] ~= nil"
				text lua "characters[id].equipment[selectedSlot].abilities[rowNumber].text"
				text style "label_parchment"
				text highlight 1
			}
		}
		area 306 222 398 256
		
		rowheight	65
		table		"characters[id].equipment[selectedSlot].abilities"
		var			selectedAbility
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255
	}
	
	label
	{
		area 292 136 408 62
		text 52733
		text style "normal"
		text color 'B'
		text align center center
	}
	button
	{
		bam			NORMBUTT
		area		566 502 138 56
		text  "DONE_BUTTON"
		text style "button"
		action
		"
			local itemNum = characters[id].equipment[selectedSlot].abilities[selectedAbility].itemNum
			Infinity_SelectItemAbility(selectedAbility-1, itemNum, characters[id].equipment[selectedSlot].id)
			Infinity_PopMenu()
		"
	}
	button
	{
		bam			NORMBUTT
		area		292 502 138 56
		text "CANCEL_BUTTON"
		text style "button"
		action
		"
			Infinity_PopMenu()
		"
	}

}
`
TEXT_popup_info = 0
`
menu
{
	name 'POPUP_INFO'
	align center center
	modal
	popupSound 1
	label -- Background
	{
		area 0 0 923 396
		mosaic POPUP2
	}
	label
	{
		area 81 65 204 220
		bam "POPUPIMG"
		sequence 1
	}
	label --Title
	{
		area 336 85 540 224
		text lua "Infinity_FetchString(TEXT_popup_info)"
		text style	"label_parchment"
	}
	button
	{
		area		706 320 170 54
		bam		widebutt
		text "DONE_BUTTON"
		text style	"button"
		action 
		"
			Infinity_PopMenu()
		"
	}
}
menu
{
	name 'POPUP_TWOBUTTON'
	align center center
	modal
	popupSound 1
	label -- Background
	{
		area 0 0 917 393
		mosaic POPUP2
	}
	label
	{
		area 81 65 204 220
		bam "POPUPIMG"
		sequence 1
	}
	label --Title
	{
		area 334 82 540 224
		text lua "Infinity_FetchString(Popup2Button.info)"
		text style	"label_parchment"
	}
	button
	{
		area		522 320 170 54
		bam		widebutt
		text lua "t(Popup2Button.cancelText or 'CANCEL_BUTTON')"
		text style	"button"
		action 
		"
			Infinity_PopMenu('POPUP_TWOBUTTON')
			if (Popup2Button.cancelFunc) then
				Popup2Button.cancelFunc()
			end
		"
	}
	button
	{
		area		706 320 170 54
		bam		widebutt
		text style	"button"
		text lua "t(Popup2Button.okText or 'DONE_BUTTON')"
		action 
		"
			Infinity_PopMenu('POPUP_TWOBUTTON')
			if (Popup2Button.okFunc) then
				Popup2Button.okFunc()
			end
		"
	}
}

menu
{
	name 'POPUP_THREEBUTTON'
	align center center
	modal
	popupSound 1
	label -- Background
	{
		area 0 0 923 396
		mosaic POPUP2
	}
	label
	{
		area 93 96 186 186
		bam "POPUPIMG"
		sequence 2
	}
	label --Title
	{
		area 334 82 540 224
		text lua "Infinity_FetchString(Popup3Button.info)"
		text style	"label_parchment"
	}
	button
	{
		area		706 320 170 54
		bam		widebutt
		text lua "t(Popup3Button.rightText)"
		text style	"button"
		action 
		"
			Infinity_PopMenu('POPUP_THREEBUTTON')
			if (Popup3Button.rightFunc) then
				Popup3Button.rightFunc()
			end
		"
	}
	button
	{
		area		522 320 170 54
		bam		widebutt
		text lua "t(Popup3Button.midText)"
		text style "button"
		action 
		"
			Infinity_PopMenu('POPUP_THREEBUTTON')
			if (Popup3Button.midFunc) then
				Popup3Button.midFunc()
			end
		"
	}
	button
	{
		area 337 320 170 54
		bam widebutt
		text style	"button"
		text lua "t(Popup3Button.leftText)"
		text style "button"
		action 
		"
			Infinity_PopMenu('POPUP_THREEBUTTON')
			if (Popup3Button.leftFunc) then
				Popup3Button.leftFunc()
			end
		"
	}
}

menu
{
	name 'ITEM_IDENTIFY'
	align center center
	popupSound 1
	modal
	label -- Background
	{
		area 0 0 923 396
		mosaic POPUP2
	}
	label
	{
		area 81 65 204 220
		bam "POPUPIMG"
		sequence 0
	}
	text 
	{
		area 336 85 540 224
		text 4258
		text style "label_parchment"
	}
	button
	{
		area		706 320 170 54
		bam		widebutt
		text style "button"
		text "SPELL_BUTTON"
		
		clickable lua "Infinity_GetSpellIdentifyEnabled(characters[id].equipment[selectedSlot].id)"
		action 
		"
			Infinity_OnSpellIdentify(characters[id].equipment[selectedSlot].id); 
			Infinity_PopMenu()
			itemDesc.item = characters[id].equipment[selectedSlot].item --update itemDesc item
		"
	}
	button
	{
		area	522 320 170 54
		bam		widebutt
		text style "button"
		text "CANCEL_BUTTON"
		action
		"
			Infinity_PopMenu()
		"
	}
	button
	{
		area 337 320 170 54
		bam widebutt
		text style "button"
		text "SCROLL_BUTTON"
		
		clickable lua "Infinity_GetScrollIdentifyEnabled(characters[id].equipment[selectedSlot].id)"
		action 
		"
			Infinity_OnScrollIdentify(characters[id].equipment[selectedSlot].id)
			Infinity_PopMenu()
			itemDesc.item = characters[id].equipment[selectedSlot].item --update itemDesc item
		"
	}
	
	
}
`
function showItemDescriptionInventory(slotName)
	if(characters[id].equipment[slotName].empty ~= 0) then
		return
	end
	
	selectedSlot = slotName
	
	Infinity_CheckItemIdentify(characters[id].equipment[slotName].id)
	showItemDescription(characters[id].equipment[slotName].item, 0)
end

itemDesc = {}
function showItemDescription(item, mode)
	itemDesc.item = item
	itemDesc.mode = mode
	Infinity_PushMenu('ITEM_DESCRIPTION',0,0)
end

function itemDescLeftButtonEnabled()
	if(itemDesc.mode == 0) then
		return GetAbilityIdentifyString() ~= ""
	else
		return itemDesc.item.isBag
	end
	return 0
end
function itemDescLeftButtonText()
	if(itemDesc.mode == 0) then
		return GetAbilityIdentifyString()
	else
		return t('OPEN_CONTAINER_BUTTON')
	end
	return ""
end
function itemDescLeftButtonAction()
	if(itemDesc.mode == 0) then
		if(characters[id].equipment[selectedSlot].item.identified == 0) then
			Infinity_PushMenu('ITEM_IDENTIFY',0,0)
		else
			Infinity_PushMenu('ITEM_ABILITIES',0,0)
		end
	else 
		storeScreen:OpenBag(itemDesc.item.res)
		Infinity_PopMenu()
	end
end

function itemDescRightButtonEnabled()
	if(itemDesc.mode == 0) then
		return characters[id].equipment[selectedSlot].useMode ~= -1
	else
		return 0
	end
end
function itemDescRightButtonText()
	return Infinity_GetUseButtonText(characters[id].equipment[selectedSlot].id, characters[id].equipment[selectedSlot].useMode)
end
function itemDescRightButtonAction()
	Infinity_PopMenu()
	Infinity_OnUseButtonClick(characters[id].equipment[selectedSlot].id, characters[id].equipment[selectedSlot].useMode)
end
function itemDescCycle(incr)
	--lua iterator order seems as good as anything else.
	--just dump it in an array to make life easy.
	local prevSlot = nil
	local equipArray = {}
	local idx = 1
	local selectedIdx = nil
	local newIdx = nil
	for k,v in pairs(characters[id].equipment) do
		if(v.empty == 0) then --skip empty slots
			equipArray[idx] = v
			if(k == selectedSlot) then
				selectedIdx = idx
			end
			idx = idx + 1
		end
	end
	newIdx = selectedIdx + incr
	if(newIdx > #equipArray) then -- wrap around if over or under.
		newIdx = 1
	end
	if(newIdx < 1) then
		newIdx = #equipArray
	end
	playDescPopupSound = nil --suppress the popup sound since we're just changing pages.
	Infinity_PopMenu('ITEM_DESCRIPTION')
	showItemDescriptionInventory(equipArray[newIdx].slotName) --open description to the new slot.
	playDescPopupSound = 1
end
playDescPopupSound = 1
`
menu
{
	name 'ITEM_DESCRIPTION'
	align center center
	modal
	popupSound lua "playDescPopupSound"
	onOpen
	"
		if(e:GetActiveEngine() == worldScreen) then
			worldScreenWasPaused = worldScreen:CheckIfPaused()
			if worldScreenWasPaused == false then
				worldScreen:TogglePauseGame(true)
			end
		end
	"
	onClose
	"
		if(e:GetActiveEngine() == worldScreen) then
			if worldScreenWasPaused == false then
				worldScreen:TogglePauseGame(true)
			end
			worldScreenWasPaused = false
		end
	"
	label
	{
		area 0 0 750 580
		mosaic popup1
	}
	button
	{
		enabled "e:GetActiveEngine() == e:GetEngineInventory()"
		area 557 82 34 34
		bam "ARROBUTT"
		sequence 0
		action "itemDescCycle(-1)"
	}
	button
	{
		enabled "e:GetActiveEngine() == e:GetEngineInventory()"
		area 671 82 34 34
		bam "ARROBUTT"
		sequence 1
		action "itemDescCycle(1)"
	}
	label
	{
		area 140 136 88 88
		icon lua "itemDesc.item.icon"
	}
	label
	{
		area 612 79 41 41
		icon lua "itemDesc.item.icon"
	}
	label
	{
		area 284 79 266 42
		text lua "itemDesc.item.name"
		text align center center
		text style "label"
	}
	text
	{
		area 294 140 412 336
		text lua "itemDesc.item.description"
		scrollbar 'CGSCRL1'
		text style "normal_parchment"
	}
	--Note that left/right button are no longer actually left/right for PST. This refers to their positions in the BG games.
	button
	{
		bam			NORMBUTT
		area		427 497 138 56
		enabled "itemDescLeftButtonEnabled()"
		text lua "itemDescLeftButtonText()"
		text style "button"
		action
		"
			itemDescLeftButtonAction()
		"
	}
	button
	{
		bam			NORMBUTT
		area		577 497 138 56
		text  "DONE_BUTTON"
		text style "button"
		action
		"
			Infinity_PopMenu( );
		"
	}
	button
	{
		bam			NORMBUTT
		area		277 497 138 56
		enabled "itemDescRightButtonEnabled()"
		text lua "itemDescRightButtonText()"
		text style "button"
		action
		"
			itemDescRightButtonAction()
		"
	}
}

`
--not implemented in PST
sidebarVisible = 
{
	LEFT = 1,
	RIGHT = 1
}
function toggleSidebar(side)
	--not implemented in pst
end

	TEXT_inventoryError = ""

function resetStatsDisplay()
	tempStats = {}
end
function getTempDamage()
	local str = ""
	local dmgMinTemp = getTempStat(characters[id].damage.min,'dmgMin',1)
	local dmgMaxTemp = getTempStat(characters[id].damage.max,'dmgMax',1)
	if(dmgMinTemp == "" and dmgMaxTemp == "") then
		return str
	end
	if(dmgMinTemp == "") then
		str = str .. characters[id].damage.min
	else
		str = str .. dmgMinTemp
	end
	str = str .. " - "
	if(dmgMaxTemp == "") then
		str = str .. characters[id].damage.max
	else
		str = str .. dmgMaxTemp
	end

	return str
end
function getStat(old, newName, coeff)
	return old
end
function getTempStat(old, newName, coeff)
	if(tempStats[id] == nil) then
		return ""
	end
	local new = tempStats[id][newName]
	local score = coeff * (new - old)
	if(score == 0) then
		return ""
	end
	if(score < 0) then
		return "^R" .. new .. "^-"
	end
	if(score > 0) then
		return "^G" .. new .. "^-"
	end
end
function getStatsTitle()
	if(tempStats[id] ~= nil) then
		return tempStats[id].tempItem
	else
		return ""
	end
end
function slotDoubleClick(slotName, force)
	local slot = characters[id].equipment[slotName]
	
	if(string.sub(slotName,1,6) == "ground" and force == nil) then
		--this hack is needed because the unlike other slots, ground item add/remove is a message (doesnt get executed immediately)
		--since the double click removes the item before re-adding it, we need to wait for that re-add to complete before continuing.
		doubleClickEventScheduled = slotName
		return
	end
	
	if(slot ~= nil) then
		if(slot.item.isBag ~= 0) then
			Infinity_OpenInventoryContainer(slot.item.res)
		else
			showItemAmountRequester(slotName)
		end
	end
end
function checkDoubleClickScheduled(slotName)
	if(doubleClickEventScheduled == slotName) then
		slotDoubleClick(doubleClickEventScheduled, true)
		doubleClickEventScheduled = nil
	end
end
function getTempHP()
	local maxHP = getTempStat(characters[id].HP.max,'maxHP',1)
	local currentHP = getTempStat(characters[id].HP.current, 'currentHP',1)
	if(maxHP == "" and currentHP == "") then
		--nothing changed.
		return ""
	end
	if(maxHP == "") then
		--only current HP changed.
		maxHP = characters[id].HP.max
	end
	if(currentHP == "") then
		--only max HP changed.
		currentHP = characters[id].HP.current
	end
	
	return currentHP .. '/' .. maxHP
end
itemPlaceholderMappings =
{
	IVIARW = "SLOTARW",
	IVISWRD = "SLOTSWRD",
	IVQIITM = "SLOTITM",
	IVPIBOW = "SLOTWEAP",
	IVPITETH = "SLOTWEAP",
}

function getInventoryBam(slot)
	if(slot.placeholder and slot.empty ~= 0) then
		return slot.placeholder
	else
		if(itemPlaceholderMappings[slot.placeholder]) then
			return itemPlaceholderMappings[slot.placeholder]
		else
			return "IVSLOT"
		end
	end
end
function getEncumbranceColor()
	local carried = game:GetSelectedCarried()
	local maxEnc = game:GetSelectedMaxEncumbrance()
	local color = nil
	if(maxEnc <= 0 or carried <= maxEnc * 0.8) then
		color = fontcolors['B']
	else
		if(carried < maxEnc) then
			color = fontcolors['Y']
		else
			color = fontcolors['R']
		end
	end
	color = tonumber(color,16)
	return bit32.band(color,0x00FFFFFF)
end

--szef_inv_func

function dragIWY(newY)
		setIWY(newY)
	end
	
	function clampIWHeight(hNew, hOld)
			if(hNew <= 100) then
				--lower bound on height, sliced rects can't get too small and we don't want to make the message box invisible.
				return hOld - 100
			end
			if(hNew >= 768) then
				--also don't go too high because it looks bad.
				return hOld - 768
			end
			return hOld - hNew
	end
	
	function setIWY(newY)
			local x,y,w,hOld = Infinity_GetArea('IWBackground')
			h = hOld - newY
			newY = clampIWHeight(h,hOld)
			
			
		adjustItemGroup({"IWHandleDrag","IWBackground","QUIVER_IN_WORLD","IWACCurr","IWACLabel","IWcharId","IWContback","IWCurrHP","IWError","IWGetMaxEncumb","IWGetSelCarried","IWGold","IWGroundP","IWMaxHP","IWSwapWithAppearance","IWpickup","IWEXITBTN","IWGP-1","IWGP1","JW","IWProfinciencies","st01","st02","st03","st04","st05","st06","st07","st08","st09","st10","st11","st12"},0,newY,0,0)
		
		adjustItemGroup({"slot_inv_w_1","slot_inv_w_2","slot_inv_w_3","slot_inv_w_4","slot_inv_w_5","slot_inv_w_6","slot_inv_w_7","slot_inv_w_8","slot_inv_w_9","slot_inv_w_11","slot_inv_w_12","slot_inv_w_13","slot_inv_w_14","slot_inv_w_15","slot_inv_w_16","slot_inv_w_17","slot_inv_w_18","slot_inv_w_19"},0,newY,0,0)
		
		adjustItemGroup({"slot_inv_w_21","slot_inv_w_22","slot_inv_w_23","slot_inv_w_24","slot_inv_w_25","slot_inv_w_26","slot_inv_w_30","slot_inv_w_31","slot_inv_w_32","slot_inv_w_33","slot_inv_w_34","slot_inv_w_35","slot_inv_w_36","slot_inv_w_37","slot_inv_w_38","slot_inv_w_39","slot_inv_w_40","slot_inv_w_41","slot_inv_w_42"},0,newY,0,0)
	
		adjustItemGroup({"slot_inv_w_43","slot_inv_w_44","slot_inv_w_45","slot_inv_w_46","slot_inv_w_47","slot_inv_w_48","slot_inv_w_49","slot_inv_w_68","slot_inv_w_69","slot_inv_w_70","slot_inv_w_71","slot_inv_w_72","slot_inv_w_73","slot_inv_w_74","slot_inv_w_75","slot_inv_w_76","slot_inv_w_77"},0,newY,0,0)
		
		
	end


function dragIWX(newX)
		--do a quick bounds check.
		local screenWidth, screenHeight = Infinity_GetScreenSize()
		local area = {Infinity_GetArea("IWBackground")}
		local area = {Infinity_GetArea("QUIVER_IN_WORLD")}
		
		if(area[1] + newX) < -1366 then
			newX = 0 - area[1]
		end	
			
		adjustItemGroup({"IWHandleDrag","IWBackground","QUIVER_IN_WORLD","IWACCurr","IWACLabel","IWcharId","IWContback","IWCurrHP","IWError","IWGetMaxEncumb","IWGetSelCarried","IWGold","IWGroundP","IWMaxHP","IWSwapWithAppearance","IWpickup","IWEXITBTN","IWGP-1","IWGP1","JW","IWProfinciencies","st01","st02","st03","st04","st05","st06","st07","st08","st09","st10","st11","st12"},newX,0,0,0)
		
		adjustItemGroup({"slot_inv_w_1","slot_inv_w_2","slot_inv_w_3","slot_inv_w_4","slot_inv_w_5","slot_inv_w_6","slot_inv_w_7","slot_inv_w_8","slot_inv_w_9","slot_inv_w_11","slot_inv_w_12","slot_inv_w_13","slot_inv_w_14","slot_inv_w_15","slot_inv_w_16","slot_inv_w_17","slot_inv_w_18","slot_inv_w_19"}, newX, 0, 0, 0)
		
		adjustItemGroup({"slot_inv_w_21","slot_inv_w_22","slot_inv_w_23","slot_inv_w_24","slot_inv_w_25","slot_inv_w_26","slot_inv_w_30","slot_inv_w_31","slot_inv_w_32","slot_inv_w_33","slot_inv_w_34","slot_inv_w_35","slot_inv_w_36","slot_inv_w_37","slot_inv_w_38","slot_inv_w_39","slot_inv_w_40","slot_inv_w_41","slot_inv_w_42"}, newX, 0, 0, 0)
	
		adjustItemGroup({"slot_inv_w_43","slot_inv_w_44","slot_inv_w_45","slot_inv_w_46","slot_inv_w_47","slot_inv_w_48","slot_inv_w_49","slot_inv_w_68","slot_inv_w_69","slot_inv_w_70","slot_inv_w_71","slot_inv_w_72","slot_inv_w_73","slot_inv_w_74","slot_inv_w_75","slot_inv_w_76","slot_inv_w_77"}, newX, 0, 0, 0)
	
	
	end
	
	
	
	function dragJIWY(newY)
		setJIWY(newY)
	end

function clampJIWHeight(hNew, hOld)
			if(hNew <= 100) then
				--lower bound on height, sliced rects can't get too small and we don't want to make the message box invisible.
				return hOld - 100
			end
			if(hNew >= 1000) then
				--also don't go too high because it looks bad.
				return hOld - 1000
			end
			return hOld - hNew
			

	end
	
	function setJIWY(newY)
			local x,y,w,hOld = Infinity_GetArea('JOURNAL_IW')
			local x,y,w,hOld = Infinity_GetArea('JOURNAL_IW_MODE')
			local x,y,w,hOld = Infinity_GetArea('JOURNAL_IW_BESTIARY')
			h = hOld - newY
			newY = clampJIWHeight(h,hOld)
			
		adjustItemGroup({"JOURNAL_IW","JOURNAL_IW_MODE","JOURNAL_IW_BESTIARY","JIWHandleDrag"},0,newY,0,0)


end
function dragJIWX(newX)
		--do a quick bounds check.
		local screenWidth, screenHeight = Infinity_GetScreenSize()
		local area = {Infinity_GetArea("JOURNAL_IW")}
		local area = {Infinity_GetArea("JOURNAL_IW_MODE")}
		local area = {Infinity_GetArea("JOURNAL_IW_BESTIARY")}

		
		if(area[1] + newX) < -1366 then
			newX = 0 - area[1]
		end	
			
		
		adjustItemGroup({"JOURNAL_IW","JOURNAL_IW_MODE","JOURNAL_IW_BESTIARY","JIWHandleDrag"},newX,0,0,0)

end

function dragSIWY(newY)
		setSIWY(newY)
	end

function clampSIWHeight(hNew, hOld)
			if(hNew <= 200) then
				--lower bound on height, sliced rects can't get too small and we don't want to make the message box invisible.
				return hOld - 200
			end
			if(hNew >= 1000) then
				--also don't go too high because it looks bad.
				return hOld - 1000
			end
			return hOld - hNew
			

	end
	
	function setSIWY(newY)
			local x,y,w,hOld = Infinity_GetArea('STATS')
			h = hOld - newY
			newY = clampSIWHeight(h,hOld)
			
		adjustItemGroup({"STATS"},0,newY,0,0)


end
function dragSIWX(newX)
		--do a quick bounds check.
		local screenWidth, screenHeight = Infinity_GetScreenSize()
		local area = {Infinity_GetArea("STATS")}
	

		
		if(area[1] + newX) < -1366 then
			newX = 0 - area[1]
		end	
			
		
		adjustItemGroup({"STATS"},newX,0,0,0)

end

	--function restoreIWPosition()
		--local x = Infinity_GetINIValue("Game Options", "IWX")
		--local y = Infinity_GetINIValue("Game Options", "IWY")
		--local w = Infinity_GetINIValue("Game Options", "IWW")
		--local h = Infinity_GetINIValue("Game Options", "IWH")
		--local sw, sh = Infinity_GetScreenSize()
		--x = clamp(x, 0, 0)
		--y = clamp(y, 0, sh - 94)
		--w = clamp(w, 71, sw - 4)
		--h = clamp(h, 94, sh - 96)


		--Infinity_SetArea("INVENTORY_WORLD", x, y, w, h)
	--end
	--function saveIWPosition()
		--local x, y, w, h = Infinity_GetArea("INVENTORY_WORLD")
		--Infinity_SetINIValue("Game Options", "IWX", x)
		--Infinity_SetINIValue("Game Options", "IWY", y)
		--Infinity_SetINIValue("Game Options", "IWW", w)
		--Infinity_SetINIValue("Game Options", "IWH", h)
	--end
	
	--function restoreJIWPosition()
		--local x = Infinity_GetINIValue("Game Options", "JIWX")
		--local y = Infinity_GetINIValue("Game Options", "JIWY")
		--local w = Infinity_GetINIValue("Game Options", "JIWW")
		--local screenWidth, screenHeight = Infinity_GetScreenSize()
		--x = x
		--y = y
		--w = w

		--Infinity_SetArea("JOURNAL_IW", x, y, w, nil)
		--Infinity_SetArea("JOURNAL_IW_MODE", x, y, w, nil)
		--Infinity_SetArea("JOURNAL_IW_BESTIARY", x, y, w, nil)
	--end
	--function saveJIWPosition()
		--local x, y, w, _ = Infinity_GetArea("JOURNAL_IW")
		--local x, y, w, _ = Infinity_GetArea("JOURNAL_IW_MODE")
		--local x, y, w, _ = Infinity_GetArea("JOURNAL_IW_BESTIARY")
		--Infinity_SetINIValue("Game Options", "JIWX", x)
		--Infinity_SetINIValue("Game Options", "JIWY", y)
		--Infinity_SetINIValue("Game Options", "JIWW", w)
	--end

function updateSlots()
	charTable = {}
	local curCharId = id

	Infinity_OnPortraitLClick(0)
	local CharId1 = id
	Infinity_UpdateLuaStats()
	table.insert(charTable, CharId1)
	Infinity_OnPortraitLClick(1)
	local CharId2 = id
	Infinity_UpdateLuaStats()
	if Infinity_GetNumCharacters() > 1 then
	table.insert(charTable, CharId2)
	end
	Infinity_OnPortraitLClick(2)
	local CharId3 = id
	Infinity_UpdateLuaStats()
	if Infinity_GetNumCharacters() > 2 then
	table.insert(charTable, CharId3)
	end
	Infinity_OnPortraitLClick(3)
	local CharId4 = id
	Infinity_UpdateLuaStats()
	if Infinity_GetNumCharacters() > 3 then
	table.insert(charTable, CharId4)
	end
	Infinity_OnPortraitLClick(4)
	local CharId5 = id
	Infinity_UpdateLuaStats()
	if Infinity_GetNumCharacters() > 4 then
	table.insert(charTable, CharId5)
	end
	Infinity_OnPortraitLClick(5)
	local CharId6 = id
	Infinity_UpdateLuaStats()
	if Infinity_GetNumCharacters() > 5 then
	table.insert(charTable, CharId6)
	end

end

function rgGetSlotVisibility()
    if rgInventoryMode == 0 then
		Infinity_SetArea("slot_inv_30", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_31", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_32", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_33", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_34", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_35", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_36", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_37", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_38", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_39", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_40", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_41", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_42", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_43", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_44", nil ,nil ,0,0)
		Infinity_SetArea("slot_inv_45", nil ,nil ,0,0)
	else
		Infinity_SetArea("slot_inv_30", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_31", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_32", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_33", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_34", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_35", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_36", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_37", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_38", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_39", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_40", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_41", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_42", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_43", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_44", nil ,nil ,58,58)
		Infinity_SetArea("slot_inv_45", nil ,nil ,58,58)
	end
end

function rgUpdateSlotsOnExit(recId)
    local curCharId = id

	Infinity_OnPortraitLClick(recId)
    Infinity_UpdateLuaStats()

    --Infinity_OnPortraitLClick(0)
    --Infinity_UpdateLuaStats()
    --Infinity_OnPortraitLClick(1)
    --Infinity_UpdateLuaStats()
    --Infinity_OnPortraitLClick(2)
    --Infinity_UpdateLuaStats()
    --Infinity_OnPortraitLClick(3)
    --Infinity_UpdateLuaStats()
    --Infinity_OnPortraitLClick(4)
    --Infinity_UpdateLuaStats()
    --Infinity_OnPortraitLClick(5)
    --Infinity_UpdateLuaStats()

    if curCharId == charTable[1] then Infinity_OnPortraitLClick(0)
    elseif curCharId == charTable[2] then Infinity_OnPortraitLClick(1)
    elseif curCharId == charTable[3] then Infinity_OnPortraitLClick(2)
    elseif curCharId == charTable[4] then Infinity_OnPortraitLClick(3)
    elseif curCharId == charTable[5] then Infinity_OnPortraitLClick(4)
    elseif curCharId == charTable[6] then Infinity_OnPortraitLClick(5)
    end
end


function rgGetSelectedCharacter()
	--local cid = '1'
    if RgInvPartyModeHover == 0 and rgInventoryMode == 0 then

		--for i=1,#charTable,1 do
		--	if charTable[i] == rgInvId  then
		--		cid = i
		--		break
		--	end
		--end
		if rgCurChar ~= rgInvChar then
			rgCurChar = rgInvChar
			Infinity_PressKeyboardButton(rgInvChar)

		end
		rgPaperdollSwap = 1
	end
end


function rgOnPartyModeHover(char)
	if rgCurChar ~= char then --rgUnlockInvId()
		rgCurChar = char
		Infinity_PressKeyboardButton(char)
	end
end
rgInvId = 0
rgInvChar = ''
rgCurChar = ''
rgPaperdollSwap = 0
RgInvPartyModeHover = 1

`
menu
{
	name 'INVENTORY'
	align center center
	ignoreEsc
	size 1024 768
	 
	onOpen 
	"	
		
		Infinity_ActivateInventory()
		pushSidebars()
		doubleClickEventScheduled = nil
		updateSlots()
		
		if SkinsOptionsSliders[2][6] == 0 then
		Infinity_PushMenu('INVENTORY_CLASSIC')
		elseif SkinsOptionsSliders[2][6] then
		Infinity_PushMenu('INVENTORY_SHARED')
		--else
		--Infinity_PushMenu('INVENTORY_WORLD')
		end
		
		showButton = false
	"
	onClose 
	"
		Infinity_PopMenu('INVENTORY_CLASSIC')
		Infinity_PopMenu('INVENTORY_SHARED')
		Infinity_PopMenu('INVENTORY_SHARED2')
		Infinity_PopMenu('INVENTORY_WORLD')
		
		Infinity_PopMenu('QUIVER')
		Infinity_PopMenu('PERSONAL')
		Infinity_PopMenu('GROUND')
		
		Infinity_PopMenu('JOURNAL_NEW')
		Infinity_PopMenu('JOURNAL_NEW_MODE')
		Infinity_PopMenu('JOURNAL_NEW_BESTIARY')
		Infinity_PopMenu('JOURNAL_NEW_ORIGINAL')
		
		Infinity_PopMenu('JOURNAL_IW')
		Infinity_PopMenu('JOURNAL_IW_MODE')
		Infinity_PopMenu('JOURNAL_IW_BESTIARY')
		Infinity_PopMenu('STATS')
		
		popSidebars()
	
	"
	button
	{
		area 0 0 0 0
		bam ""
		sequence 0
	}
}

menu
{
	name 'WORLD_LEVEL_UP_BUTTONS'
	align right top
	offset -65 0
	ignoreesc
	enabled "0" --disable this menu for now.
	button
	{
		enabled "Infinity_CanLevelUp(0)"
		bam GUIOSW
		area 0 14 44 44
		sequence 0
		action "Infinity_ActivateRecord(0)"
		pulse 1
	}
	button
	{
		enabled "Infinity_CanLevelUp(1)"
		bam GUIOSW
		area 0 106 44 44
		sequence 0
		action "Infinity_ActivateRecord(1)"
		pulse 1
	}
	button
	{
		enabled "Infinity_CanLevelUp(2)"
		bam GUIOSW
		area 0 198 44 44
		sequence 0
		action "Infinity_ActivateRecord(2)"
		pulse 1
	}
	button
	{
		enabled "Infinity_CanLevelUp(3)"
		bam GUIOSW
		area 0 290 44 44
		sequence 0
		action "Infinity_ActivateRecord(3)"
		pulse 1
	}
	button
	{
		enabled "Infinity_CanLevelUp(4)"
		bam GUIOSW
		area 0 382 44 44
		sequence 0
		action "Infinity_ActivateRecord(4)"
		pulse 1
	}
	button
	{
		enabled "Infinity_CanLevelUp(5)"
		bam GUIOSW
		area 0 474 44 44
		sequence 0
		action "Infinity_ActivateRecord(5)"
		pulse 1
	}
	
}

`
luaEdit = ""
luaEditDebugDump = 0
luaEditHistory = {}
luaEditMaxHistory = 10
luaEditHistoryIndex = 0
luaEditShowHistoryList = 0
luaEditHistoryListSelected = 0
function updateLuaHistory()
	local i = 2
	local tempTab = {}
	tempTab[1] = luaEdit
	while ( i <= luaEditMaxHistory ) do
		tempTab[i] = luaEditHistory[i-1]
		i = i + 1
	end
	luaEditHistory = tempTab
end
function loadLuaHistory()
	local i = 1
	while (i <= luaEditMaxHistory ) do
		luaEditHistory[i] = Infinity_GetINIString("Lua Edit","String"..i-1, "")
		i = i + 1
	end
end
function saveLuaHistory()
	local i = 1
	while (i <= luaEditMaxHistory ) do
		Infinity_SetINIValue("Lua Edit","String"..i-1, luaEditHistory[i])
		i = i + 1
	end
end
function luaEditHistoryUp()
	if(luaEditHistoryIndex <= 1) then return end
	luaEditHistoryIndex = luaEditHistoryIndex - 1
	luaEdit = luaEditHistory[luaEditHistoryIndex]
end
function luaEditHistoryDown()
	if(luaEditHistoryIndex == luaEditMaxHistory) then return end
	if(luaEditHistory[luaEditHistoryIndex + 1] == "") then return end
	luaEditHistoryIndex = luaEditHistoryIndex + 1
	luaEdit = luaEditHistory[luaEditHistoryIndex]
end

cheatGoldAmt = 1000000
cheatXpAmt = 500000

function chatboxScrollCheat(top, height, contentHeight)
	if(chatboxScrollToBottom and contentHeight > height) then
		chatboxScrollToBottom = nil
		return height-contentHeight
	else
		--defer to default
		return nil
	end
end

cheatMenuCollapsed = nil

`
menu
{
	name 'cheatMenu'
	ignoreEsc
	ignoreNav 1
	label
	{
		enabled "cheatMenuCollapsed ~= nil"
		area 100 0 822 298
		mosaic 'CHEATBG0'	
	}
	list
	{
		column 
		{ 
			width 20 
			label
			{
				area 0 0 -1 -1
				text lua "cheatAreas[rowNumber][1]"
				text style "list"
				text highlight 1
			}
		}
		column 
		{ 
			width 80 
			label
			{
				area 0 0 -1 -1
				text lua "Infinity_FetchString(cheatAreas[rowNumber][2])"
				text style "list"
				text highlight 1
			}
		}
		enabled "cheatMenuCollapsed ~= nil"
		area 122 6 480 234
		
		rowheight	18
		table		"cheatAreas"
		var		cheatTeleportArea
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}
	button
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		122 240 113 46
		bam			NORMBUTT
		text		"TRAVEL_BUTTON"
		text style	"button"
		action 		"C:MoveToArea(cheatAreas[cheatTeleportArea][1])"
	}
	button
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		610 58 138 56
		bam			NORMBUTT
		text			"GODBOW_LABEL"
		text style	"button"
		action		"C:CreateItem('EVISCERA')"
	}
	button
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		610 126 138 56
		bam			NORMBUTT
		text			"GIVE_GOLD_LABEL"
		text style	"button"
		action		"C:AddGold(cheatGoldAmt)"
	}
	edit
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		760 136 130 24
		var		cheatGoldAmt
		scrollbar	'CGSCRL1'
		text style	"edit"
		maxlines	1
	}

	button
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		610 198 138 56
		bam			NORMBUTT
		text			"GIVE_XP_LABEL"
		text style	"button"
		action		"C:SetCurrentXP(cheatXpAmt)"
	}
	edit
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		760 204 128 24
		var		cheatXpAmt
		scrollbar	'CGSCRL1'
		text style	"edit"
		maxlines	1
	}

	button
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		760 58 138 56
		bam			NORMBUTT
		text			"EXPLORE_LABEL"
		text style	"button"
		action		"C:ExploreArea()"
	}
	
	button
	{
		enabled "cheatMenuCollapsed ~= nil"
		area		458 240 113 46
		bam			NORMBUTT
		text		"HIDE_CHEATS_BUTTON"
		text style	"button"
		action "cheatMenuCollapsed = nil"
	}
	button
	{
		enabled "cheatMenuCollapsed == nil"
		area		462 6 138 56
		bam			NORMBUTT
		text		"SHOW_CHEATS_BUTTON"
		text style	"button"
		action "cheatMenuCollapsed = 1"
	}
}
menu
{
	name "luaHistoryMenu"
	offset 0 0 
	align right bottom
	label
	{
		area 0 0 250 210
		mosaic 'CHEATBG2'
	}
	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 -1 -1
				text lua "luaEditHistory[rowNumber]"
				text style	"list"
				text highlight 1
			}
		}
		area 10 8 230 192
		rowheight	24
		var luaEditHistoryListSelected
		table		"luaEditHistory"
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action
		"
			luaEdit = luaEditHistory[luaEditHistoryListSelected]
		"
	}
}
menu
{
	name 'cheatConsole'
	align center bottom
	ignoreEsc

	onOpen 
	"
		toolbarTop = 50
		Infinity_PushMenu('cheatMenu', 0, 0);
		Infinity_FocusTextEdit('luaEditArea'); 
		luaEdit = trim(luaEdit)
		loadLuaHistory()
		
		--responses from last conversation might not have been cleared yet.
		clearDialogResponses()
	"
	onClose 
	"
		Infinity_PopMenu('cheatMenu', 0, 0);
		Infinity_PopMenu('luaHistoryMenu', 0, 0);
	"
		label
	{
		area 0 0 809 246
		mosaic 'CHEATBG1'
	}
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getDialogEntryText(rowNumber)"
				text style "normal"
				text highlight 1
				indent 1
			}
		}
		name "worldPlayerDialogChoicesList"
		area 18 16 780 165
		rowheight dynamic
		table "dialogTable"
		var "worldPlayerDialogSelection"
		scrollbar	'CGSCRL1'
		scrollbar func "chatboxScrollCheat"
		hideHighlight
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}
	

	edit
	{
		name		"luaEditArea"
		area		12 202 790 24
		var			luaEdit
		scrollbar	'CGSCRL1'
		text style	"edit"
		action
		"
			--if key_pressed is return
			if (key_pressed == 13 or key_pressed == 1073741912) then
				updateLuaHistory()
				saveLuaHistory()
				Infinity_LuaConsoleInput(luaEditObjectId,luaEditDebugDump)
				return -1
			end
			if (key_pressed == 27) then
				return 0
			end
			return 1
		"
	}
	button
	{
		area		816 6 32 32
		bam			checkbut
		toggle		luaEditShowHistoryList
		action
		"
			if(luaEditShowHistoryList == 0) then
				Infinity_PopMenu('luaHistoryMenu',0,0)
			else
				Infinity_PushMenu('luaHistoryMenu',0,0)
			end
		"
	}

	button
	{
		on up
		action
		"
			luaEditHistoryUp()
		"
	}
	button
	{
		on down
		action
		"
			luaEditHistoryDown()
		"
	}

}
`
cloudLoadState=0
function CheckCloudSaveStatus()
	Infinity_UpdateCloudSaveState()
	if(cloudLoadState == 0) then
		Infinity_PopMenu()
	end
	return GetCloudLoadingText()
end
function GetCloudLoadingText()
	if(cloudLoadState == 1 or cloudLoadState == 0) then
		return 'Downloading save file updates.'
	end
	if(cloudLoadState == 2) then
		return 'Searching for save file updates.'
	end
	return 'Undefined cloud save download state'
end
`
menu
{
	name 'CloudSaveUpdateMenu'
	modal
	label -- Background
	{
		area 174 267 677 234
		mosaic GUIERR6 
	}
	label
	{
		area 214 287 600 120
		text lua "CheckCloudSaveStatus()"
		text style "label"
	}
	button
	{
		area		544 437 232 44
		bam			GUIOSTUR
		sequence	0
		text		"SKIP_BUTTON"
		text style	"button"
		on 			escape
		action
		"
			Infinity_PopMenu()
		"	
	}
}
`
messageBoxCurMessage = nil
messageBoxMessages = {}
function initMessageBox(message)
	messageBoxMessages[message] = 1
	if(messageBoxCurMessage ~= nil) then
		--message box already active
		return
	end
	getNextMessage()
	Infinity_PushMenu('LuaMessageBox',0,0)
end

function getNextMessage()
	i = 1
	while ( i <= messageBoxMessageCount ) do
		showMessage = messageBoxMessages[i]
		if ( showMessage ~= nil ) then
			messageBoxCurMessage = i
			return 1
		end
		i = i + 1
	end
	--whole table scanned, all messages have been displayed
	return 0
end
`
menu
{
	name 'LuaMessageBox'
	align center center
	modal
	label
	{
		area 0 0 657 234
		mosaic GUIERR6
	}
	label
	{
		area 29 21 580 126
		text lua "messages[messageBoxCurMessage]"
		text style	"label"
	}
	button
	{
		area 213 170 230 44
		bam GUIBUTNT
		text "DONE_BUTTON"
		text style	"button"
		action
		"
			messageBoxMessages[messageBoxCurMessage] = nil
			if(getNextMessage() == 0) then
				messageBoxCurMessage = nil
				Infinity_PopMenu()
			end
		"	
	}
}

`
	highlightBG = false
	highlightSOD = false
	highlightBP = false

	function startThreeBookHighlight(book)
		if book == 1 and highlightBG == true then
			return 1
		elseif book == 2 and highlightSOD == true then
			return 1
		elseif book == 3 and highlightBP == true then
			return 1
		else
			return 0
		end
	end
`
menu
{
	name 'START'
	panel 0
	state 0
	align center center
	ignoreEsc
	onOpen "
		e:GetObjectGame():SetCampaign('PST')
		Infinity_PushMenu('START_MAIN')
		Infinity_SetBackground('BACKGROUND_START')
		SkinsOptionsSliders[1][6] = Infinity_GetINIValue('Graphics','Dialogue Box Skin',0)
		SkinsOptionsSliders[2][6] = Infinity_GetINIValue('Graphics','Inventory Skin',0)
		SkinsOptionsSliders[3][6] = Infinity_GetINIValue('Graphics','Journal Screen',0)
		
	"
	onClose "
		Infinity_PopMenu('START_MAIN')		
	"
	label
	{
		area 0 0 0 0
	}
}

menu
{
	name 'START_MAIN'
	panel 0
	state 0
	align center center
	ignoreEsc

	onOpen	"
		canContinue = startEngine:HasGameToContinue()
		e:CheckGUISong()
		hasSaveGames = game:HasSaveGames()
	"

	label
	{
		area 0 0 1024 768
	}
	label
	{
		area 914 730 67 31
		mosaic "VERPLATE"
	}
	label
	{
		area 918 736 58 20
		text lua "versionString"
		text style	"label"
		text point	10
	} 

	label
	{
		name "START_TOOLTIP_TARGET"
		area 434 722 170 38
	}
	button
	{
		bam "STARTBUT"
		sequence 0
		area 406 246 226 72
		tooltip "NEW_GAME_TOOLTIP"
		tooltip target "START_TOOLTIP_TARGET"
		action 
		"
			Infinity_PopMenu('START_MAIN')
			startEngine:SetEngineState(0)
			startEngine:OnNewGameButtonClick()
		"
		boundingPoints	0,30 --1
						50,0 --2
						160,0 --3
						226,30 --4
						221,50 --5
						201,72 --6
						151,55 --6
						75,55 --7
						25,72 --7
						5,50 --8
	}
	button
	{
		bam "STARTBUT"
		sequence 4
		area 344 374 134 214
		tooltip "LOAD_GAME_TOOLTIP"
		tooltip target "START_TOOLTIP_TARGET"
		clickable lua "hasSaveGames"
		action "
			Infinity_PopMenu() 
			startEngine:OnLoadGameButtonClick()
		"
		boundingPoints	  0,  0 --1
						 50, 20 --2
						 70,100 --3
						134,174 --4
						134,214 --5
						110,210 --6
						 60,180 --7
						 10,110 --8
	}
	button
	{
		enabled "not e:IsTouchUI()"
		bam "STARTBUT"
		sequence 2
		area 634 513 164 176
		tooltip "OPTIONS_TOOLTIP"
		tooltip target "START_TOOLTIP_TARGET"
		action
		"
			Infinity_PushMenu('ESC_MENU')
			optionsScreen:SetEngineState(1)
			startEngine:OnOptionsButtonClick()
		"
		boundingPoints	130,  0 --1
						164,  0 --2
						154, 70 --3
						 99,131 --4
						 15,176 --5
						  0,146 --6
						 80, 90 --7
	}
	button
	{
		enabled "e:IsTouchUI()"
		bam "STARTBUT"
		sequence 3
		area 400 648 226 78
		tooltip "OPTIONS_TOOLTIP"
		tooltip target "START_TOOLTIP_TARGET"
		action
		"
			Infinity_PushMenu('ESC_MENU')
			optionsScreen:SetEngineState(1)
			startEngine:OnOptionsButtonClick()
		"
		boundingPoints 	 20,10 --1
						 70,20 --2
						140,20 --3
						226, 0 --4
						221,40 --5
						186,68 --6
						113,78 --7
						 40,67 --8
						 10,55 --9
						  0,35 --10
	}
	button
	{
		bam "STARTBUT"
		sequence 1
		area 558 374 134 214
		tooltip "CONTINUE_GAME_TOOLTIP"
		tooltip target "START_TOOLTIP_TARGET"
		clickable lua "canContinue"
		action "startEngine:OnContinueGame()"
		boundingPoints 	 85, 15 --1
						134,  0 --2
						124,100 --3
						100,150 --4
						 60,194 --5
						 20,214 --6
						 10,209 --7
						  0,169 --8
						 70, 99 --9
	}
	button
	{
		on escape
		enabled "not e:IsTouchUI()"
		bam "STARTBUT"
		sequence 5
		area 225 509 176 182
		tooltip "QUIT_GAME_TOOLTIP"
		tooltip target "START_TOOLTIP_TARGET"
		action "startEngine:OnQuitButtonClick()"
		boundingPoints 	  0,  0 --1
						 40,  0 --2
						 95, 87 --3
						176,152 --4
						176,182 --5
						136,182 --6
						 35,117 --7
						 10, 50 --8
	}
}

`
function makeBlankTable(num)
	local out = {}
	for i = 1,num do
		table.insert(out, {})
	end
	return out
end

placeholderSpell =
{
	icon = "",
	name = "",
	isPlaceholder = 1
}
function filterMemorizedMageSpells()
	local out = {}
	
	--Copy in the spells.
	for k,v in pairs(characters[id].mageSpells[currentSpellLevel]) do
		for i=v.memorizedCount, 1, -1 do
			local spell = deepcopy(v)
			if(i <= v.castableCount) then
				spell.castable = 1
			else
				spell.castable = 0
			end
			spell.memorizedDisplayIdx = #out + 1
			table.insert(out, spell)
		end
	end
	
	--Copy in placeholders for empty slots.
	i = #out
	while(i < characters[id].mageDetails[currentSpellLevel].maxMemorized) do
		table.insert(out,placeholderSpell)
		i = i + 1
	end
	
	return out
end

function findFirstDifferenceInSpellList(oldList, newList)
	local ret = -1
	local spellIndex = 1

	if oldList ~= nil and newList ~= nil then
		while oldList[spellIndex] ~= nil do
			if newList[spellIndex] == nil then
				print("New list empty at point "..spellIndex)
				ret = spellIndex
				break
			end
			if oldList[spellIndex].icon ~= newList[spellIndex].icon then
				print("Lists differ at point "..spellIndex.." "..oldList[spellIndex].icon.." vs "..newList[spellIndex].icon)
				ret = spellIndex
				break
			end
			spellIndex = spellIndex + 1
		end
		if oldList[spellIndex] == nil and newList[spellIndex] ~= nil then
			print("New list has a new spell at point "..spellIndex)
			ret = spellIndex
		end
	end

	return ret
end

showMageMemorizationFlash = false

function refreshMageBook()
	currentSpellLevel = mageScreen:GetSpellLevel()+1

	if characters[id].hasMageBook then
		bookSpells = characters[id].mageSpells[currentSpellLevel]
		newBottomSpells = filterMemorizedMageSpells()
		bottomSpells = newBottomSpells
		bottomSpellsPlaceHolder = makeBlankTable(characters[id].mageDetails[currentSpellLevel].maxMemorized) 
	else
		bookSpells = characters[id].mageSpells[currentSpellLevel]
		bottomSpells = {}
		bottomSpellsPlaceHolder = {}
	end
end


function filterMemorizedPriestSpells()
	local out = {}
	for k,v in pairs(characters[id].priestSpells[currentSpellLevel]) do
		for i=v.memorizedCount, 1, -1 do
			local spell = deepcopy(v)
			if(i <= v.castableCount) then
				spell.castable = 1
			else
				spell.castable = 0
			end
			spell.memorizedDisplayIdx = #out + 1
			table.insert(out, spell)
		end
	end
	
	--Copy in placeholders for empty slots.
	i = #out
	while(i < characters[id].priestDetails[currentSpellLevel].maxMemorized) do
		table.insert(out,placeholderSpell)
		i = i + 1
	end
	
	return out
end


showPriestMemorizationFlash = false

function refreshPriestBook()
	currentSpellLevel = priestScreen:GetSpellLevel()+1
	
	if characters[id].hasClericBook then
		bookSpells = characters[id].priestSpells[currentSpellLevel]
		newBottomSpells = filterMemorizedPriestSpells()
		bottomSpells = newBottomSpells
		bottomSpellsPlaceHolder = makeBlankTable(characters[id].priestDetails[currentSpellLevel].maxMemorized) 
	else
		bookSpells = {}
		bottomSpells = {}
		bottomSpellsPlaceHolder = {}
	end
end


function incrPriestBookLevel(num)
	local newLevel = priestScreen:GetSpellLevel() + num
	priestScreen:SetSpellLevel(newLevel)
	currentBookSpell = 0
	currentSpellLevel = priestScreen:GetSpellLevel()+1
	refreshPriestBook()
	if(currentSpellLevel-1 == newLevel) then
		Infinity_PlaySound('int_06')
	end
end

function incrMageBookLevel(num)
	local newLevel = mageScreen:GetSpellLevel() + num
	mageScreen:SetSpellLevel(newLevel)
	currentBookSpell = 0
	currentSpellLevel = mageScreen:GetSpellLevel()+1
	refreshMageBook()
	if(currentSpellLevel-1 == newLevel) then
		Infinity_PlaySound('int_05')
	end
end

currentAnimationID = 1
updateCounterMemorizationSparkles = 1

function updateMemorizationSparkles()
	local sparkleNumber = 1
	updateCounterMemorizationSparkles = updateCounterMemorizationSparkles + 1
	if updateCounterMemorizationSparkles > 2 then
		updateCounterMemorizationSparkles = 1
		for sparkleNumber = 1, #(memorizationFlashes), 1 do
			if memorizationFlashes[sparkleNumber][1] == true then
				memorizationFlashes[sparkleNumber][2] = memorizationFlashes[sparkleNumber][2] + 1
				if memorizationFlashes[sparkleNumber][2] > 7 then
					memorizationFlashes[sparkleNumber][1] = false
					memorizationFlashes[sparkleNumber][2] = 0
					memorizationFlashes[sparkleNumber][3] = true
				end
			end
		end
	end
end

function destroyMemorizationSparkle(instanceId)
	local ret = memorizationFlashes[instanceId][3]
	memorizationFlashes[instanceId][3] = false
	return ret
end

function showMemorizationSparkle(instanceId)
	updateMemorizationSparkles()
	return memorizationFlashes[instanceId][1]
end

function createMemorizationSparkle(idx)
	x,y,w,h = Infinity_GetArea("BUTTON_MEMORIZEDSPELL_" .. idx)
	Infinity_InstanceAtPoint("TEMPLATE_mageMemorizationSparkle",currentAnimationID,x,y)
	memorizationFlashes[currentAnimationID][1] = true
	memorizationFlashes[currentAnimationID][3] = false
	currentAnimationID = currentAnimationID + 1
	if currentAnimationID > #(memorizationFlashes) then
		currentAnimationID = 1
	end
end

function unmemorizingMageSpell(resref)
	--not used in pst
end
function unmemorizingPriestSpell(resref)
	--not used in pst
end

memorizationFlashes = 
{
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false},
	{false, 0, false}
}
function memorizeSpell(spell)
	local success = false
	if(isWizSpellMode()) then
		success = mageScreen:MemorizeSpell( spell.level, spell.index )
	else
		success = priestScreen:MemorizeSpell(spell.level, spell.index)
	end
	if(success == true) then
		--show the sparkle on the last of this set
		local index = 0
		for k,v in pairs(bottomSpells) do
			if(v.icon == spell.icon) then
				index = k + v.memorizedCount - v.castableCount - 1
				break
			end
		end
		createMemorizationSparkle(index)
		Infinity_PlaySound('IDENT03')
		showMageMemorizationFlash = true	
	end
end
function unmemorizeSpell(spell)
	if(spell.isPlaceholder) then return end
	showMageMemorizationFlash = false
	if(spell.castableCount >= spell.memorizedCount) then
		--Unmemorizing a castable spell.
		popup2Button(50450, 'REMOVE_BUTTON', function() finishUnmemorizeSpell(spell) end)
	else
		finishUnmemorizeSpell(spell)
	end

end
function finishUnmemorizeSpell(spell)
	local success = false
	if(isWizSpellMode()) then
		success = mageScreen:UnmemorizeSpell( spell.level, spell.memorizedIndex )
	else
		success = priestScreen:UnmemorizeSpell(spell.level,spell.memorizedIndex)
	end
	if(success == true) then
		createMemorizationSparkle(spell.memorizedDisplayIdx)
	end
	Infinity_PlaySound('GAM_44')
end
function showSpellDetails(spell)
	if(spell.isPlaceholder) then
		return
	end
	currentSpell = spell
	Infinity_PushMenu("SPELL_DESCRIPTION")
end
function getSpellEnabled(spell)

end
function isWizSpellMode()
	return e:GetActiveEngine() == e:GetEngineWizSpell()
 end
function getMageBookEnabled()
	if(Infinity_IsMenuOnStack("SPELLS_HELP")) then
		return true
	else
		if(isWizSpellMode()) then
				return mageBookEnabled == true
		else
			return priestBookEnabled == true
		end
	end
end
function getSpellLevelString()
	game:SetToken("LEVEL",currentSpellLevel)
	return Infinity_FetchString(19672)
end
function getMemorizedTooltip()
	if(isWizSpellMode()) then
		return t("MAGE_SPELL_MEMORIZED_TOOLTIP")
	else
		return t("PRIEST_SPELL_MEMORIZED_TOOLTIP")
	end
end
function getKnownTooltip()
	if(isWizSpellMode()) then
		return t("MAGE_SPELL_KNOWN_TOOLTIP")
	else
		return t("PRIEST_SPELL_KNOWN_TOOLTIP")
	end
end
`


menu
{
	--menu to sit on top of spells so that the X button doesn't get greyed/disabled.
	name 'SPELLS_X'
	align center center
	size 1024 768
	ignoreEsc
	
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		on escape
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
}
menu
{
	name 'SPELLS'
	align center center
	greyscale lua "not getMageBookEnabled()"
	interactable lua "getMageBookEnabled()"
	modal lua "bookMode == 1"
	ignoreEsc
	size 1024 768
	onopen "
		showMageMemorizationFlash = false
		mgpage = nil
		
		bookSpells = {}
		bottomSpells = {}

		currentBookSpell = 0		
		if(e:GetActiveEngine() == e:GetEngineWizSpell()) then
			refreshMageBook()
		else
			refreshPriestBook()
		end
		
		currentAnimationID = 1
		updateCounterMemorizationSparkles = 1
		pushSidebars()
		Infinity_SetBackground('BACKGROUND_SPELLS')
		Infinity_PushMenu('SPELLS_X')
		showButton = false
		"
	onclose "
		Infinity_SetBackground(nil)
		popSidebars()
		Infinity_PopMenu('SPELLS_X')
	"

	button
	{
		on escape
		action
		"
			--Return to world screen on escape 
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}

	template
	{
		label
		{
			enabled "showMemorizationSparkle(instanceId)"
			ignoreEvents
			area 0 0 40 39
			bam "FLASH"
			usealpha lua "true"
			frame lua "memorizationFlashes[instanceId][2]"
			align center center
		}
		name "TEMPLATE_mageMemorizationSparkle"
	}
	label
	{
		area 362 86 297 34
		text lua "characters[id].name"
		text style "label"
	}
	button
	{
		area 396 512 40 39
		bam "ARROBUTT"
		sequence 0
		action
		"
			if(isWizSpellMode()) then
				incrMageBookLevel(-1)
			else
				incrPriestBookLevel(-1)
			end
		"
	}
	button
	{
		area 584 512 40 39
		bam "ARROBUTT"
		sequence 1
		action
		"
			if(isWizSpellMode()) then
				incrMageBookLevel(1)
			else
				incrPriestBookLevel(1)
			end
		"
	}
	text
	{
		area 320 146 96 42
		tooltip lua "getMemorizedTooltip()"
	}
	text
	{
		area 596 146 96 42
		tooltip lua "getKnownTooltip()"
	}
	label
	{
		area 454 494 112 111
		text style "label_parchment"
		text lua "getSpellLevelString()"
	}
	label
	{
		enabled "isWizSpellMode()"
		area 479 141 57 64
		mosaic "ICMAGE"
	}
	label
	{
		enabled "not isWizSpellMode()"
		area 479 142 60 62
		mosaic "ICPRIEST"
	}
	button {area 560 209 41 40	sequence 0 name "BUTTON_BOOKSPELL_1"	spellinfo "bookSpells[1]"}
	button {area 613 210 41 40	sequence 1	name "BUTTON_BOOKSPELL_2"	spellinfo "bookSpells[2]"}
	button {area 665 209 41 40	sequence 2	name "BUTTON_BOOKSPELL_3"	spellinfo "bookSpells[3]"}
	button {area 717 210 41 40	sequence 3	name "BUTTON_BOOKSPELL_4"	spellinfo "bookSpells[4]"}
	button {area 577 268 41 40	sequence 4	name "BUTTON_BOOKSPELL_5"	spellinfo "bookSpells[5]"}
	button {area 629 268 41 40	sequence 5	name "BUTTON_BOOKSPELL_6"	spellinfo "bookSpells[6]"}
	button {area 682 268 41 40	sequence 6	name "BUTTON_BOOKSPELL_7"	spellinfo "bookSpells[7]"}
	button {area 734 268 41 40	sequence 7	name "BUTTON_BOOKSPELL_8"	spellinfo "bookSpells[8]"}
	button {area 559 328 41 40	sequence 8	name "BUTTON_BOOKSPELL_9"	spellinfo "bookSpells[9]"}
	button {area 611 328 41 40	sequence 9	name "BUTTON_BOOKSPELL_10"	spellinfo "bookSpells[10]"}
	button {area 665 328 41 40	sequence 0	name "BUTTON_BOOKSPELL_11"	spellinfo "bookSpells[11]"}
	button {area 716 328 41 40	sequence 1	name "BUTTON_BOOKSPELL_12"	spellinfo "bookSpells[12]"}
	button {area 576 389 41 40	sequence 2	name "BUTTON_BOOKSPELL_13"	spellinfo "bookSpells[13]"}
	button {area 628 389 41 40	sequence 3	name "BUTTON_BOOKSPELL_14"	spellinfo "bookSpells[14]"}
	button {area 681 389 41 40	sequence 4	name "BUTTON_BOOKSPELL_15"	spellinfo "bookSpells[15]"}
	button {area 734 389 41 40	sequence 5	name "BUTTON_BOOKSPELL_16"	spellinfo "bookSpells[16]"}
	button {area 560 449 41 40	sequence 6	name "BUTTON_BOOKSPELL_17"	spellinfo "bookSpells[17]"}
	button {area 611 449 41 40	sequence 7	name "BUTTON_BOOKSPELL_18"	spellinfo "bookSpells[18]"}
	button {area 663 449 41 40	sequence 8	name "BUTTON_BOOKSPELL_19"	spellinfo "bookSpells[19]"}
	button {area 716 449 41 40	sequence 9	name "BUTTON_BOOKSPELL_20"	spellinfo "bookSpells[20]"}

	button {area 257 210 41 40	sequence 0	name "BUTTON_MEMORIZEDSPELL_1"	memorizedspellinfo "bottomSpells[1]"}
	button {area 310 210 41 40	sequence 1	name "BUTTON_MEMORIZEDSPELL_2"	memorizedspellinfo "bottomSpells[2]"}
	button {area 363 210 41 40	sequence 2	name "BUTTON_MEMORIZEDSPELL_3"	memorizedspellinfo "bottomSpells[3]"}
	button {area 415 210 41 40	sequence 3	name "BUTTON_MEMORIZEDSPELL_4"	memorizedspellinfo "bottomSpells[4]"}
	button {area 240 268 41 40	sequence 4	name "BUTTON_MEMORIZEDSPELL_5"	memorizedspellinfo "bottomSpells[5]"}
	button {area 293 268 41 40	sequence 5	name "BUTTON_MEMORIZEDSPELL_6"	memorizedspellinfo "bottomSpells[6]"}
	button {area 346 268 41 40	sequence 6	name "BUTTON_MEMORIZEDSPELL_7"	memorizedspellinfo "bottomSpells[7]"}
	button {area 399 268 41 40	sequence 7	name "BUTTON_MEMORIZEDSPELL_8"	memorizedspellinfo "bottomSpells[8]"}
	button {area 259 328 41 40	sequence 8	name "BUTTON_MEMORIZEDSPELL_9"	memorizedspellinfo "bottomSpells[9]"}
	button {area 311 328 41 40	sequence 9	name "BUTTON_MEMORIZEDSPELL_10"	memorizedspellinfo "bottomSpells[10]"}
	button {area 364 328 41 40	sequence 0	name "BUTTON_MEMORIZEDSPELL_11"	memorizedspellinfo "bottomSpells[11]"}
	button {area 416 328 41 40	sequence 1	name "BUTTON_MEMORIZEDSPELL_12"	memorizedspellinfo "bottomSpells[12]"}
	button {area 241 389 41 40	sequence 2	name "BUTTON_MEMORIZEDSPELL_13"	memorizedspellinfo "bottomSpells[13]"}
	button {area 293 389 41 40	sequence 3	name "BUTTON_MEMORIZEDSPELL_14"	memorizedspellinfo "bottomSpells[14]"}
	button {area 346 389 41 40	sequence 4	name "BUTTON_MEMORIZEDSPELL_15"	memorizedspellinfo "bottomSpells[15]"}
	button {area 399 389 41 40	sequence 5	name "BUTTON_MEMORIZEDSPELL_16"	memorizedspellinfo "bottomSpells[16]"}
	button {area 259 448 41 40	sequence 6	name "BUTTON_MEMORIZEDSPELL_17"	memorizedspellinfo "bottomSpells[17]"}
	button {area 311 448 41 40	sequence 7	name "BUTTON_MEMORIZEDSPELL_18"	memorizedspellinfo "bottomSpells[18]"}
	button {area 363 448 41 40	sequence 8	name "BUTTON_MEMORIZEDSPELL_19"	memorizedspellinfo "bottomSpells[19]"}
	button {area 415 448 41 40	sequence 9	name "BUTTON_MEMORIZEDSPELL_20"	memorizedspellinfo "bottomSpells[20]"}
	
}
`
	function incrSpellDescriptionKnown(incr)
		local nextSpell = bookSpells[currentSpell.index + incr + 1]
		
		if(nextSpell ~= nil) then
			currentSpell = nextSpell
			return
		end
		
		if(incr > 0) then
			currentSpell = bookSpells[1]
		else
			currentSpell = bookSpells[#bookSpells]
		end
	end
	function getNextDifferentMemorizedSpell(incr, startIdx, matchIdx)
		local k = startIdx
		while ( k > 0 and k <= #bottomSpells) do
			local v = bottomSpells[k]
			if(v.memorizedIndex ~= matchIdx and not v.isPlaceholder) then
				return v
			end
			k = k + incr
		end
		return nil
	end
	function incrSpellDescriptionMemorized(incr)
		local nextSpell = getNextDifferentMemorizedSpell(incr, currentSpell.memorizedDisplayIdx, currentSpell.memorizedIndex)
		
		if(nextSpell ~= nil) then
			currentSpell = nextSpell
			return
		end
		
		if(incr > 0) then
			currentSpell = getNextDifferentMemorizedSpell(incr, 1, -1)
		else
			currentSpell = getNextDifferentMemorizedSpell(incr, #bottomSpells, -1)
		end
	end
	function incrSpellDescription(incr)
		if(currentSpell.memorizedDisplayIdx == nil) then
			incrSpellDescriptionKnown(incr)
		else
			incrSpellDescriptionMemorized(incr)
		end
	end
	function inSpellBook()
		return e:GetActiveEngine() == e:GetEngineWizSpell() or e:GetActiveEngine() == e:GetEnginePriestSpell()
	end
`

menu                            
{                               
	name "SPELL_DESCRIPTION"
	align center center
	modal
	popupSound 1	
	onOpen
	"
		if(e:GetActiveEngine() == worldScreen) then
			worldScreenWasPaused = worldScreen:CheckIfPaused()
			if worldScreenWasPaused == false then
				worldScreen:TogglePauseGame(true)
			end
		end
	"
	onClose
	"
		if(e:GetActiveEngine() == worldScreen) then
			if worldScreenWasPaused == false then
				worldScreen:TogglePauseGame(true)
			end
			worldScreenWasPaused = false
		end
	"
	label
	{
		area 0 0 750 580
		mosaic popup1
	}
	button
	{
		enabled "inSpellBook()"
		area 557 82 34 34
		bam "ARROBUTT"
		sequence 0
		action
		"
			incrSpellDescription(-1)
		"
	}
	button
	{
		enabled "inSpellBook()"
		area 671 82 34 34
		bam "ARROBUTT"
		sequence 1
		action
		"
			incrSpellDescription(1)
		"
	}
	label
	{
		area 140 136 88 88
		icon lua "currentSpell.icon"
	}
	label
	{
		area 137 132 94 98
		mosaic "ITMVIG"
	}
	label
	{
		area 606 74 51 50
		mosaic "ITMVIGSM"
	}
	label
	{
		area 609 77 46 46
		icon lua "currentSpell.icon"
	}
	label
	{
		area 284 79 266 42
		text lua "Infinity_FetchString(currentSpell.name)"
		text style "label"
	}
	text
	{
		area 294 140 412 336
		text lua "Infinity_FetchString(currentSpell.description)"
		text style "normal_parchment"
		scrollbar	'cgscrl1'
	}
		button
	{
		on escape
		area		577 497 138 56
		text		"DONE_BUTTON"
		text style "button"
		bam normbutt
		action		"Infinity_PopMenu('SPELL_DESCRIPTION')"
	}
}
`
	versionString = ""
	function optionsFromStart()
		return optionsScreen:GetEngineState() == 1
	end
`
menu
{
	name "ESC_MENU"
	ignoreesc
	align center center
	size 1024 768
	onOpen "
		versionString = CBaldurChitin:GetVersionString()
		popSidebars()
		Infinity_SetBackground('BACKGROUND_OPTIONS')
	"
	onClose 
	" 
		Infinity_SetBackground(nil)
	"

	label
	{
		area 914 730 67 31
		mosaic "VERPLATE"
	}
	label
	{
		area 918 736 58 20
		text lua "versionString"
		text style	"label"
		text point	10
	} 
	button
	{
		name 		"GAMEPLAY_BUTTON"
		area		465 38 104 102
		bam		OPTBUTT
		sequence	0
		text 		"GAMEPLAY_BUTTON"
		text style	"button"
		text point	16
		pad 16 16 16 16
		navdown 	"GRAPHICS_BUTTON"
		action
		"
			Infinity_PushMenu( 'OPTIONS_GAMEPLAY' )

		"
	}
	button
	{
		name 		"GRAPHICS_BUTTON"
		area		269 121 103 102
		bam		OPTBUTT
		sequence	0
		text 		"GRAPHICS_BUTTON"
		text style	"button"
		text point	16
		pad 16 16 16 16
		
		action
		"
			Infinity_PushMenu( 'OPTIONS_GRAPHICS' )

		"
	}
	button
	{
		name 		"SOUND_BUTTON"
		area		184 322 103 102
		bam		OPTBUTT
		sequence	0
		text 		"SOUND_BUTTON"
		text style	"button"
		text point	16
		pad 16 16 16 16
		
		action
		"
			Infinity_PushMenu( 'OPTIONS_SOUND' )

		"
	}
	button
	{
		name "BACK_BUTTON"
		area		670 523 104 102
		bam		OPTBUTT
		text "BACK_BUTTON"
		text style "button"
		text point	16
		pad 16 16 16 16
		
		action
		"
			if(not optionsFromStart()) then
				e:GetActiveEngine():SelectEngine( worldScreen );
			else
				Infinity_PopMenu('ESC_MENU')
				e:GetActiveEngine():SelectEngine( startEngine )
			end
		"
	}
	button
	{
		name "LOAD_GAME_BUTTON"
		area		754 323 103 104
		clickable lua "not optionsFromStart()"
		bam		OPTBUTT
		text style "button"
		text point	16
		pad 16 16 16 16
		text "LOAD_GAME_BUTTON"
		action
		"
			if(not optionsFromStart()) then
				popup2Button(39432, 'LOAD_BUTTON', function() optionsScreen:LoadGame() end)
			else
				optionsScreen:LoadGame() --no need for confirm if coming from start.
				Infinity_PopMenu('ESC_MENU') --this won't close automatically because we're from start
			end
		"
	}
	button
	{
		name "QUIT_GAME_BUTTON"
		enabled "not optionsFromStart()"
		area		469 599 101 101
		bam		OPTBUTT
		text style "button"
		text point	16
		pad 16 16 16 16
		text "QUIT_GAME_BUTTON"
		action
		"
			popup3Button(69333, 
			'CANCEL_BUTTON', nil, 
			'QUIT_BUTTON', function() optionsScreen:QuitGame() end, 
			'SAVE_BUTTON', function() optionsScreen:SaveGame(0) end
			) 
		"
	}
	button
	{
		name "LANGUAGE_BUTTON"
		enabled "optionsFromStart()"
		area		467 598 103 103
		bam		OPTBUTT
		text style "button"
		text point	16
		pad 16 16 16 16
		text "LANGUAGE_BUTTON"
		navup "MOVIES_BUTTON"
		action
		"
			Infinity_PushMenu('OPTIONS_LANGUAGE')
		"
	}
	button
	{
		name "SAVE_GAME_BUTTON"
		clickable lua "not optionsFromStart()"
		area		668 119 105 104
		bam		OPTBUTT
		text style "button"
		text point	16
		pad 16 16 16 16
		text "SAVE_GAME_BUTTON"
		action
		"
			optionsScreen:SaveGame(0)
		"
	}

	button -- 9 MOVIES
	{
		name	"MOVIES_BUTTON"
		bam		OPTBUTT
		area		268 520 103 100
		text		"MOVIES_BUTTON"
		text style	"button"
		text point	16
		pad 16 16 16 16
		text align	center center
		action
		"
			e:GetActiveEngine():SelectEngine(moviesScreen)
		"
	}
}

`
OptionsButtons = 
{
	{text = "CREDITS_BUTTON", menu = "CREDITS", sequence = 0}, 
	{text = "GAMEPLAY_BUTTON", menu = "OPTIONS_GAMEPLAY", sequence = 0}, 
	{text = "GRAPHICS_BUTTON", menu = "OPTIONS_GRAPHICS", sequence = 1}, 
	{text = "LANGUAGE_BUTTON", menu = "OPTIONS_LANGUAGE", sequence = 0}, 
	{text = "MOVIES_BUTTON", menu = "", sequence = 2}, 
	{text = "SOUND_BUTTON", menu = "OPTIONS_SOUND", sequence = 1}, 
}
`
menu
{
	name 'START_OPTIONS'
	align center center
	ignoreEsc
	onopen "Infinity_PlayMovie('flames','flames3')"

	label
	{
		area 0 0 1024 768
		mosaic 'START3EE'
	}
	label
	{
		area 90 226 298 410
		mosaic 'GUICONTB'
	}

	label
	{
		area 280 20 464 168	
		bam 'TITLE'
		sequence 0
		frame 1
	}

	list
	{
		
		column 
		{ 
			width 100
			label
	{
				area 0 0 -1 -1
				text lua "t( OptionsButtons[rowNumber].text )"
		text style "button"
		bam GENBUT1
				sequence lua "OptionsButtons[rowNumber].sequence"
				frame lua "selectedMenuOpt == rowNumber"
				align center center
				text highlight 1
	}
	}

		area 120 250 246 320
		
		rowheight	46
		table		"OptionsButtons"
		var			selectedMenuOpt
		scrollbar	'CGSCRL1'
		hidehighlight
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255


		action		
		"
			Infinity_PlaySound('GAM_09')
			if OptionsButtons[selectedMenuOpt].menu ~= '' then
				Infinity_PushMenu( OptionsButtons[selectedMenuOpt].menu )
			else
				e:GetActiveEngine():SelectEngine(moviesScreen)
			end
			selectedMenuOpt = NIL
		"
	}
	button
	{
		on escape
		sequence 1
		area 120 570 230 44
		bam GENBUT1
		pad 10 8 10 8
		text style "button"
		text "BACK_BUTTON"
		action
		"
			Infinity_PopMenu()
			e:GetActiveEngine():SelectEngine(startEngine)
		"
	}
	movie
	{
		name "flames3"
		area 512 256 512 512
		loop
	}
}
`
mapnoteSettings = {}
showNotes = 1
function showNote(instanceId)
	if((mapScreen:IsNoteVisible(mapnoteSettings[instanceId].worldCoord.x, mapnoteSettings[instanceId].worldCoord.y)
	and mapnoteSettings[instanceId].screenCoord.x >= 0
	and mapnoteSettings[instanceId].screenCoord.y >= 0
	and not worldScreen:IsAutoZooming()
	) or mapnoteSettings[instanceId].sequence == 1) then
		return showNotes
	else
		return false
	end
end
notesAlpha = 0
function getAndIncrementNotesAlpha()
	if(notesAlpha < .99) then
		notesAlpha = notesAlpha + 0.075
	end
	if(notesAlpha > 1) then
		notesAlpha = 1
	end
	return notesAlpha
end
function getDisplayExploredMapFrame()
	if(mapScreen:DisplayExploredMap()) then
		return 2
	else
		return 0
	end
end
forcedTooltips = {}
`
menu
{
	name 'AREA_MAP'
	align center center
	ignoreesc
	size 1024 768
	onOpen "pushSidebars(); notesAlpha = 0; Infinity_SetBackground('BACKGROUND_MAP')"
	onClose "popSidebars(); mapScreen:ExitNotePlacementMode()"
	
	button
	{
		area 902 440 106 106
		bam "mapbutt"
		sequence 1
		text "ADD_NOTE_BUTTON"
		text style "button"
		pad 16 16 16 16
		action
		"
			if(not mapScreen:InNotePlacementMode()) then
				mapScreen:EnterNotePlacementMode()
			else
				mapScreen:ExitNotePlacementMode()
			end
		"
	}
	button
	{
		area 872 43 115 115
		bam "mapbutt"
		sequence 0
		text "WORLD_MAP_BUTTON"
		text style "button"
		pad 16 16 16 16
		action
		"	
			worldMapScreen:StartWorldMap(0)
			e:GetActiveEngine():SelectEngine(worldMapScreen)
			
			mapScreen:ExitNotePlacementMode()
		"
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
	label
	{
		area 308 46 259 30
		text lua "Infinity_FetchString(mapScreen:GetMapName())"
		text style "label"
	}
	label
	{
		area 887 214 111 38
		text "SHOW_MAP_NOTES_LABEL"
		text style "label"
	}
	button
	{
		area 861 223 20 20
		bam			checkbut
		toggle showNotes
		sound ""
		ignoreFocus 1
		action
		"
			mapScreen:ExitNotePlacementMode()
			
			if(showNotes == 1) then
				Infinity_PlaySound('int_01')
			else
				Infinity_PlaySound('int_02')
			end
		"
	}
	label
	{
		area 887 279 111 38
		text "SHOW_WALKABLE_LABEL"
		text style "label"
	}
	button
	{
		area 861 289 20 20
		bam			checkbut
		frame lua "getDisplayExploredMapFrame()"
		sound ""
		ignoreFocus 1
		action 
		"
			mapScreen:ExitNotePlacementMode()
			
			mapScreen:ToggleDisplayExploredMap()
			if(getDisplayExploredMapFrame() == 2) then
				Infinity_PlaySound('int_01')
			else
				Infinity_PlaySound('int_02')
			end
		"
		
	}

	template
	{
		button
		{
			enabled "showNote(instanceId)"
			area 0 0 38 42
			bam "FLAG1"
			sequence lua "mapnoteSettings[instanceId].sequence"
			tooltip force lua "forcedTooltips[instanceId]"
			tooltip lua "Infinity_FetchString(mapnoteSettings[instanceId].text)"
			tooltip constrainTo "AREA_MAP_TARGET"
			actionAlt
			"
				mapScreen:OnUserNoteClick(instanceId, mapnoteSettings[instanceId].worldCoord.x, mapnoteSettings[instanceId].worldCoord.y)
				Infinity_PushMenu('NOTE_ADD',0,0)
			"
			action
			"
				if(forcedTooltips[instanceId] == const.MAPNOTE_TOOLTIP_CLICK) then 
					forcedTooltips[instanceId] = nil
				else 
					forcedTooltips[instanceId] = const.MAPNOTE_TOOLTIP_CLICK
				end
			"
			actionEnter "if (forcedTooltips[instanceId] == nil) then forcedTooltips[instanceId] = const.MAPNOTE_TOOLTIP_HOVER end"
			actionExit "if (forcedTooltips[instanceId] == const.MAPNOTE_TOOLTIP_HOVER) then forcedTooltips[instanceId] = nil end"
		}
		name "TEMPLATE_mapnote"
	}
	label
	{
		name "AREA_MAP_TARGET"
		area 58 104 754 536
		ignoreEvents
	}
}
`
	colorChoice = nil
`
menu
{
	name 'NOTE_ADD'
	align center center
	modal
	popupSound 1
	onOpen
	"
		mapScreen:OnColorChoice(1) --always blue! always blue!
	"
	label -- Background
	{
		area 0 0 923 396
		mosaic POPUP2
	}
	label
	{
		area 93 96 186 186
		bam "POPUPIMG"
		sequence 2
	}
	label
	{
		area 337 112 541 38
		text "MAP_NOTE_TITLE"
		text style "label_parchment"
		text font "exocet"
		text shadow 1
	}
	label
	{
		area	 364 180 480 30
		fill 0 0 0 200
	}
	edit
	{
		name 		"mapNoteEditArea"
		area		370 188 468 20
		var			mapNoteEdit
		scrollbar	'CGSCRL1'
		text style	"edit"
		maxlines 1
	}
	button
	{
		area		706 320 170 54
		bam		widebutt
		text style "button"
		text "DONE_BUTTON"
		action
		"
			mapScreen:OnUserNoteDoneButtonClick()
			Infinity_PopMenu('NOTE_ADD',0,0)
		"
	}
	button
	{
		area	522 320 170 54
		bam		widebutt
		text style "button"
		text "CANCEL_BUTTON"
		action
		"
			Infinity_PopMenu('NOTE_ADD',0,0)
		"
	}
	button
	{
		area 337 320 170 54
		bam widebutt
		text style "button"
		text "DELETE_BUTTON"
		action
		"
			mapScreen:OnUserNoteDeleteButtonClick()
			Infinity_PopMenu('NOTE_ADD',0,0)
		"
	}
}
menu
{
	name "WORLD_MAP"
	align center center
	modal
	label
	{
		area 0 0 823 648
		mosaic "WMAPBG"
	}
	map
	{
		name "WORLD_MAP_AREA"
		area 53 86 726 486
		worldmap
		action
		"
			worldMapScreen:OnMapMouseDown(eventXCoord,eventYCoord)
		"
	}
	button
	{
		area 342 587 138 56
		bam NORMBUTT
		enabled "worldMapScreen:IsTravelButtonVisible()"
		text "TRAVEL_BUTTON"
		text style "button"
		clickable lua "worldMapScreen:IsTravelButtonClickable()"
		action "
			worldMapScreen:TravelToSelected()
		"	
	}
	label
	{
		area 33 70 762 503
		mosaic "MAPCLIPS"
		ignoreEvents
	}
	button
	{
		area 736 73 50 50
		bam "XBUTT"
		on escape
		action
		"
			worldMapScreen:StopWorldMap(false)
		"
	}
}
`
store = {}
storeGroupItemsVar = 0
storeItemsVar = 0
function getStoreSlotHighlight(highlight)
	if(highlight == 0) then 
		return 0
	else
		return 1 
	end
end
function storeSplitStack(count)
	storeScreen:SelectStoreItem(storeItemsVar-1, true);
	storeScreen:SetStoreItemCount(storeItemsVar-1, count);
end
function groupSplitStack(count)
	storeScreen:SelectGroupItem(storeGroupItemsVar-1, true);
	storeScreen:SetGroupItemCount(storeGroupItemsVar-1, count);
end
function checkContainerText(normalStr, containerStr)
	if(storeScreen:IsContainer()) then
		return t(containerStr)
	else
		return t(normalStr)
	end
end
function getStoreItemCount(row)
	local count = store.storeItems[rowNumber].item.count
	if(count ~= 0xFFFF)  then 
		return count
	else
		-- maxword, infinite count.
		return nil
	end
end
function getWeightVolumeText()
	local str = t("STORE_WEIGHT_LABEL").." " .. store.currentEncumbrance .. "/" .. store.maxEncumbrance .. "\n"
	if(store.currentVolume ~= store.maxVolume) then
		str = str .. t("STORE_SLOTS_LABEL").." " .. store.currentVolume .. "/" .. store.maxVolume
	else
		--show the slots in red if full.
		str = str .. t("STORE_SLOTS_LABEL").." " .. "^R" .. store.currentVolume .. "/" .. store.maxVolume .. "^-"
	end
	return str
end
`
menu
{
	name 'STORE_BUYSELL'
	align center center
	onOpen "
		storeScreen:UpdateBuySellPanel()
		Infinity_SetBackground('BACKGROUND_STORE')
		currentStoreMenuName = 'STORE_BUYSELL'
		showSuccessfulStealFeedback = nil
	"
	onClose "Infinity_SetBackground(nil)"
	size 1024 768
	ignoreEsc
	
	label
	{
		area 78 54 258 29
		text lua "Infinity_FetchString(storeScreen:GetStoreName())"
		text style "title"
		text font "exocet"
		text shadow 1
	}
	label
	{
		area 398 54 172 29
		text lua "storeScreen:GetCharacterName()"
		text style "label_parchment"
	}
	label
	{
		area 818 76 60 20
		text lua "game:GetPartyGold()"
		text style "gold"
		align right center
	}
	label
	{
		area 811 40 54 46
		mosaic icgold
	}
	label
	{
		area 446 482 42 23
		enabled "not storeScreen:IsContainer() and not stealMode"
		text lua "storeScreen:GetStoreCost()"
		text style "gold"
		text useFontZoom 0
		align right center
	}
	label
	{
		area 844 482 47 23
		enabled "not storeScreen:IsContainer() and not stealMode"
		text lua "storeScreen:GetGroupCost()"
		text style "gold"
		text useFontZoom 0
		align right center
	}
	
	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 296 54
				mosaic "STRROW"
				respectClipping
			}
			label
			{
				area 6 6 42 42
				bam "IVSLOT"
				highlight lua "getStoreSlotHighlight(store.storeItems[rowNumber].highlight)"
				icon lua "store.storeItems[rowNumber].item.icon"
				tint lua "store.storeItems[rowNumber].item.tint"
				usages lua "store.storeItems[rowNumber].amountSelected" --how many selected
				count lua "store.storeItems[rowNumber].item.stackSize" --How many to a stack
				glow lua "store.storeItems[rowNumber].highlight"
			}
			label
			{
				area 56 5 195 44
				text lua "store.storeItems[rowNumber].label"
				text style "normal"
				text useFontZoom 0
				text align left center
				text highlight 1
			}
			label
			{
				area 240 6 53 44
				enabled "not storeScreen:IsContainer() and not stealMode"
				text lua "store.storeItems[rowNumber].value"
				text style "gold"
			}
			label
			{
				enabled "store.storeItems[rowNumber].valid == 0 and store.storeItems[rowNumber].highlight == 0"
				area 0 0 314 54
				rectangle 1
				rectangle opacity 150
			}
		}
		area 176 126 320 322
		hidehighlight
		rowheight	54
		table		"store.storeItems"
		var			"storeItemsVar"
		noBorder
		scrollbar 'cgscrl1'
		hidehighlight
		focus color 255 255 255 255

		action
		"
			if not storeScreen:IsCloseBagButtonClickable() or store.storeItems[storeItemsVar].valid == 1 then
				local highlight = true
				if(store.storeItems[storeItemsVar].highlight == 1) then highlight = false end
				storeScreen:SelectStoreItem( storeItemsVar - 1,  highlight)
				Infinity_PlaySound('int_10')
			end
		"
		actionalt
		"
			showItemDescription(store.storeItems[storeItemsVar].item, 1)
		"
		actionDbl
		"
			if not storeScreen:IsCloseBagButtonClickable() or store.storeItems[storeItemsVar].valid == 1 then
				local maxCount = store.storeItems[storeItemsVar].maxCount
				if(maxCount > 1) then
					popupRequester(maxCount, storeSplitStack, false, store.storeItems[storeItemsVar].item)
				end
			end
		"
	}
	
	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 296 54
				mosaic "STRROW"
				respectClipping
			}
			label
			{
				area 6 6 42 42
				bam "IVSLOT"
				highlight lua "getStoreSlotHighlight(store.groupItems[rowNumber].highlight)"
				icon lua "store.groupItems[rowNumber].item.icon"
				tint lua "store.groupItems[rowNumber].item.tint"
				count lua "store.groupItems[rowNumber].count"
				usages lua "store.groupItems[rowNumber].item.usages"
				glow lua "store.groupItems[rowNumber].highlight"
			}
			label
			{
				area 56 5 195 44
				text lua "store.groupItems[rowNumber].label"
				text style "list"
				text highlight 1
			}
			label
			{
				area 240 6 53 44
				enabled "not storeScreen:IsContainer() and not stealMode"
				text lua "store.groupItems[rowNumber].value"
				text style "gold"
			}
			label
			{
				--#21242 We don't grey out bags, even though they're not selectable, because we can open them.
				enabled "store.groupItems[rowNumber].valid == 0  and store.groupItems[rowNumber].item.isBag ~= 1"
				area 0 0 296 54
				rectangle 1
				rectangle opacity 150
			}
		}
		area 578 126 322 322
		enabled "not storeScreen:IsCloseBagButtonClickable()"
		hidehighlight
		rowheight	54
		table		"store.groupItems"
		var			"storeGroupItemsVar"
		noBorder
		scrollbar 'cgscrl1'
		hidehighlight
		focus color 255 255 255 255

		action
		"
			if store.groupItems[storeGroupItemsVar].valid ~= 0 then
				local selected = true
				if(store.groupItems[storeGroupItemsVar].highlight == 1) then selected = false end
				storeScreen:SelectGroupItem( storeGroupItemsVar - 1,  selected)
				Infinity_PlaySound('int_10')
			end
		"
		actionalt
		"
			showItemDescription(store.groupItems[storeGroupItemsVar].item, 1)
		"
		actionDbl
		"
		if(store.groupItems[storeGroupItemsVar].item.isBag == 1) then
			showItemDescription(store.groupItems[storeGroupItemsVar].item, 1)
			itemDescLeftButtonAction()
		else
			if store.groupItems[storeGroupItemsVar].valid ~= 0 then
				local count = store.groupItems[storeGroupItemsVar].item.count
				local stock = store.groupItems[storeGroupItemsVar].numInStock
				if(count > 1) then
					popupRequester(count, groupSplitStack, true, store.groupItems[storeGroupItemsVar].item)
				elseif stock > 1 then
					popupRequester(stock, groupSplitStack, true, store.groupItems[storeGroupItemsVar].item)
				end	
			end
		end
		"
	}

	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 296 54
				mosaic "STRROW"
				respectClipping
			}
			label
			{
				area 6 6 42 42
				bam ivslot
				highlight lua "getStoreSlotHighlight(store.groupItems[rowNumber].highlight)"
				tint lua "store.groupItems[rowNumber].item.tint"
				icon lua "store.groupItems[rowNumber].item.icon"
				count lua "store.groupItems[rowNumber].item.count"
				usages lua "store.groupItems[rowNumber].count"
				glow lua "store.groupItems[rowNumber].highlight"
			}
			label
			{
				area 56 5 195 44
				text lua "store.groupItems[rowNumber].label"
				text style "list"
				text highlight 1
			}
			label
			{
				area 240 6 53 44
				enabled "not storeScreen:IsContainer()"
				text lua "store.groupItems[rowNumber].value"
				text style "gold"
			}
			label
			{
				enabled "store.groupItems[rowNumber].valid == 0"
				area 0 0 296 54
				rectangle 1
				rectangle opacity 150
			}
		}
		area 578 126 322 322
		enabled "storeScreen:IsCloseBagButtonClickable()"
		hidehighlight
		hidehighlight
		focus color 255 255 255 255

		rowheight	54
		table		"store.groupItems"
		var			"storeGroupItemsVar"
		noBorder
		scrollbar 'cgscrl1'
		action
		"
			if store.groupItems[storeGroupItemsVar].valid ~= 0 then
				local selected = true
				if(store.groupItems[storeGroupItemsVar].highlight == 1) then selected = false end
				storeScreen:SelectGroupItem( storeGroupItemsVar - 1,  selected)
				Infinity_PlaySound('int_10')
			end
		"
		actionalt
		"
			showItemDescription(store.groupItems[storeGroupItemsVar].item, 1)
		"
		actionDbl
		"
			if store.groupItems[storeGroupItemsVar].valid ~= 0 then
				local count = store.groupItems[storeGroupItemsVar].item.count
				local stock = store.groupItems[storeGroupItemsVar].numInStock
				if(count > 1) then
					popupRequester(count, groupSplitStack, true, store.groupItems[storeGroupItemsVar].item)
				elseif stock > 1 then
					popupRequester(stock, groupSplitStack, true, store.groupItems[storeGroupItemsVar].item)
				end	
			end
		"
	}
	
	
	button
	{
		enabled "not stealMode"
		area 191 464 94 58
		bam STRBUTT
		text lua "checkContainerText('BUY_BUTTON', 'TO_BACKPACK_BUTTON')"
		text style "button"
		clickable lua "storeScreen:IsBuyItemButtonClickable()"
		action
		"
			storeScreen:OnBuyItemButtonClick()
		"
	}
	button
	{
		enabled "not stealMode"
		area 594 464 94 58
		bam STRBUTT
		text lua "checkContainerText('SELL_BUTTON','TO_CONTAINER_BUTTON')"
		text style "button"
		clickable lua "storeScreen:IsSellItemButtonClickable()"
		action
		"
			storeScreen:OnSellItemButtonClick()
		"
	}
	button
	{
		enabled "stealMode"
		area 191 464 94 58
		bam STRBUTT
		text "STEAL_BUTTON"
		text style "button"
		clickable lua "storeScreen:IsStealItemButtonClickable()"
		action
		"
			storeScreen:OnStealItemButtonClick()
		"
	}
	text
	{
		area 690 43 98 50
		text lua "getWeightVolumeText()"
		text style "label"
		text point 14
	}
	button
	{
		area 740 560 94 58
		enabled "storeScreen:IsCloseBagButtonClickable()"
		bam STRBUTT
		text "CLOSE_CONTAINER_BUTTON"
		text style "button"
		action
		"
			storeScreen:OnCloseBagButtonClick()
		"
	}
	label
	{
		enabled "showSuccessfulStealFeedback"
		area 470 560 262 58
		text "STEAL_SUCCESSFUL_LABEL"
		text style "label"
	}
	label
	{
		area 610 46 45 46
		bam "contback"
	}

}
`
	identifyItemsVar = 0
`
menu
{
	name 'STORE_IDENTIFY'
	align center center
	size 1024 768
	onOpen
	"
		storeScreen:UpdateIdentifyPanel()
		store.identifyText = ''
		Infinity_SetBackground('BACKGROUND_STORE_2')
		currentStoreMenuName = 'STORE_IDENTIFY'
	"
	onClose "Infinity_SetBackground(nil)"
	
	ignoreEsc
	label
	{
		area 78 54 258 29
		text lua "Infinity_FetchString(storeScreen:GetStoreName())"
		text style "title"
		text font "exocet"
		text shadow 1
	}
	label
	{
		area 398 54 172 29
		text lua "storeScreen:GetCharacterName()"
		text style "label_parchment"
	}
	text
	{
		area 690 43 98 50
		text lua "getWeightVolumeText()"
		text style "label"
		text point 14
	}
	label
	{
		area 610 46 45 46
		bam "contback"
	}
	label
	{
		area 818 76 60 20
		enabled "not storeScreen:IsContainer()"
		text lua "game:GetPartyGold()"
		text style "gold"
		align right center
	}
	label
	{
		area 811 40 54 46
		mosaic icgold
	}
	label
	{
		area 446 482 42 23
		text lua "storeScreen:GetIdentifyCost()"
		text style "gold"
		text useFontZoom 0
		align right center
	}
	label
	{
		enabled "#(store.identifyItems) == 0"
		area 178 126 324 324
		text "NO_ITEMS_IDENTIFY_LABEL"
		text style "label"
	}
	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 296 54
				mosaic "STRROW"
				respectClipping
			}
			label
			{
				area 8 7 40 40
				bam "IVSLOT"
				highlight lua "getStoreSlotHighlight(store.identifyItems[rowNumber].highlight)"
				icon lua "store.identifyItems[rowNumber].item.icon"
				tint lua "store.identifyItems[rowNumber].item.tint"
				align center center
			}
			label
			{
				area 56 5 195 44
				text lua "store.identifyItems[rowNumber].label"
				text style "list"
				text highlight 1
			}
			label
			{
				area 240 6 53 44
				text lua "store.identifyItems[rowNumber].value"
				text style "gold"
			}
			label
			{
				enabled "store.identifyItems[rowNumber].valid == 0 and store.identifyItems[rowNumber].highlight == 0"
				area 0 0 296 54
				rectangle 1
				rectangle opacity 150
			}
		}
		area 176 126 320 322
		hidehighlight
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		rowheight	54
		table		"store.identifyItems"
		var			"identifyItemsVar"
		noBorder
		scrollbar 'CGSCRL1'
		action
		"
			local highlight = true
			if(store.identifyItems[identifyItemsVar].highlight == 1) then highlight = false end
			if(highlight == true and store.identifyItems[identifyItemsVar].valid == 0) then return end
			storeScreen:SelectIdentifyItem( identifyItemsVar - 1,  highlight)
			Infinity_PlaySound('int_10')
		"
	}
	button
	{
		area 191 464 94 58
		bam STRBUTT
		text "IDENTIFY_BUTTON"
		text style "button"
		clickable lua "storeScreen:IsIdentifyItemButtonClickable()"
		action
		"
			storeScreen:OnIdentifyItemButtonClick()
		"
	}
	text
	{
		area 590 136 310 312
		text lua "store.identifyText"
		text style "normal_parchment"
		scrollbar 'CGSCRL1'
	}
}
`
	function storeRest()
		storeScreen:RestParty()
	end
	
	rooms = 
	{
		{"PEASANT_BUTTON",0},
		{"MERCHANT_BUTTON",1},
		{"NOBLE_BUTTON",2},
		{"ROYAL_BUTTON",3},
	}
`
menu
{
	name 'STORE_ROOMS'
	align center center
	size 1024 768
	onOpen 
	"
		storeScreen:SetRoomType(0)
		storeScreen:UpdateRentRoomPanel()
		Infinity_SetBackground('BACKGROUND_STORE_2')
		currentStoreMenuName = 'STORE_ROOMS'
		rentVar = nil
		store.roomText = ''
	"
	onClose
	"
		Infinity_SetBackground(nil)
	"
	ignoreEsc
	
	label
	{
		area 78 54 258 29
		text lua "Infinity_FetchString(storeScreen:GetStoreName())"
		text style "title"
		text font "exocet"
		text shadow 1
	}
	label
	{
		area 398 54 172 29
		text lua "storeScreen:GetCharacterName()"
		text style "label_parchment"
	}
	text
	{
		area 690 43 98 50
		text lua "getWeightVolumeText()"
		text style "label"
		text point 14
	}
	label
	{
		area 610 46 45 46
		bam "contback"
	}
	label
	{
		area 446 482 42 23
		text lua "storeScreen:GetRoomCost()"
		text style "gold"
		text useFontZoom 0
		align right center
	}
	list
	{
		column
		{
			width 100
			label
			{
				enabled "storeScreen:IsRoomTypeClickable(rowNumber)"
				area 0 0 296 54
				mosaic "STRROW"
				respectClipping
			}
			label
			{
				enabled "storeScreen:IsRoomTypeClickable(rowNumber)"
				area 6 6 42 42
				bam "ROOMBUTT"
				sequence lua "rooms[rowNumber][2]"
			}
			label
			{
				enabled "storeScreen:IsRoomTypeClickable(rowNumber)"
				area 64 5 195 44
				text lua "t(rooms[rowNumber][1])"
				text style "label"
				align left center
				text highlight 1
				
			}
		}
		area 182 136 316 306
		rowheight dynamic
		var			"rentVar"
		table 		"rooms"
		scrollbar 'CGSCRL1'
		hidehighlight
		highlight color "Y"
		focus color "Y"

		action
		"
			storeScreen:SetRoomType(rentVar)
			Infinity_PlaySound('int_10')
		"
	}
	text
	{
		area 590 136 310 312
		text lua "store.roomText"
		text style "normal"
	}
		label
	{
		area 818 76 60 20
		enabled "not storeScreen:IsContainer()"
		text lua "game:GetPartyGold()"
		text style "gold"
		align right center
	}
	label
	{
		area 811 40 54 46
		mosaic icgold
	}
	button
	{
		area 191 464 94 58
		bam STRBUTT
		text "RENT_BUTTON"
		text style "button"
		clickable lua "rentVar"
		action
		"
			storeScreen:OnRentRoomButtonClick()
			rentVar = nil
		"
	}
}
`
function isSelectedHealingSpellBuyable()
	return store.healingSpells[healingSpellsVar] and store.healingSpells[healingSpellsVar].valid ~= 0
end
`
menu
{
	name 'STORE_HEALING'
	align center center
	onOpen "storeScreen:UpdateBuySpellPanel();Infinity_SetBackground('BACKGROUND_STORE_2');currentStoreMenuName = 'STORE_HEALING';"
	onClose "Infinity_SetBackground(nil)"
	size 1024 768
	ignoreEsc
	label
	{
		area 78 54 258 29
		text lua "Infinity_FetchString(storeScreen:GetStoreName())"
		text style "title"
		text font "exocet"
		text shadow 1
	}
	label
	{
		area 398 54 172 29
		text lua "storeScreen:GetCharacterName()"
		text style "label_parchment"
	}
	label
	{
		area 818 76 60 20
		enabled "not storeScreen:IsContainer()"
		text lua "game:GetPartyGold()"
		text style "gold"
		align right center
	}
	text
	{
		area 690 43 98 50
		text lua "getWeightVolumeText()"
		text style "label"
		text point 14
	}
	label
	{
		area 610 46 45 46
		bam "contback"
	}
	label
	{
		area 811 40 54 46
		mosaic icgold
	}
	label
	{
		area 446 482 42 23
		text lua "storeScreen:GetSpellCost()"
		text style "gold"
		text useFontZoom 0
		align right center
	}
	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 296 54
				mosaic "STRROW"
				respectClipping
			}
			label
			{
				area 8 7 40 40
				bam "IVSLOT"
				highlight lua "getStoreSlotHighlight(store.healingSpells[rowNumber].highlight)"
				icon lua "store.healingSpells[rowNumber].icon"
				tint lua "store.healingSpells[rowNumber].tint"
			}
			label
			{
				area 56 5 195 44
				text lua "store.healingSpells[rowNumber].label"
				text style "normal"
				text useFontZoom 0
				text align left center
				text highlight 1
			}
			label
			{
				area 240 6 53 44
				text lua "store.healingSpells[rowNumber].value"
				text style "gold"
			}
			label
			{
				enabled "store.healingSpells[rowNumber].valid == 0"
				area 0 0 296 54
				rectangle 1
				rectangle opacity 150
			}
		}
		area 176 126 320 322
		hidehighlight
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		rowheight	54
		table		"store.healingSpells"
		var			"healingSpellsVar"
		scrollbar 'CGSCRL1'
		noBorder
		action
		"
			local highlight = true
			if(store.healingSpells[healingSpellsVar].highlight == 1) then highlight = false end
			--if(highlight == true and store.healingSpells[healingSpellsVar].valid == 0) then return end
			storeScreen:SelectSpellItem( healingSpellsVar - 1,  highlight)
			Infinity_PlaySound('int_10')
		"
		actionAlt
		"
			local spell = store.healingSpells[healingSpellsVar]
			showSpellDetails(spell)
		"
	}
	button
	{
		area 191 464 94 58
		bam STRBUTT
		text "BUY_BUTTON"
		text style "button"
		clickable lua "isSelectedHealingSpellBuyable()"
		action
		"
			storeScreen:OnBuySpellButtonClick()
		"
	}
	text
	{
		area 590 136 310 312
		text lua "store.spellText"
		text style "normal_parchment"
		scrollbar	'CGSCRL1'
	}
}

`
storeButtonTypes =
{
	buysell = 	{menu = "STORE_BUYSELL", tooltip = 44970, sequence = 0},
	steal = 	{menu = "STORE_BUYSELL", tooltip = 44972, sequence = 2, steal = 1},
	identify = 	{menu = "STORE_IDENTIFY", tooltip = 44971, sequence = 1},
	buyspell = 	{menu = "STORE_HEALING", tooltip = 67294, sequence = 4},
	rentroom = 	{menu = "STORE_ROOMS", tooltip = 45120, sequence = 6},
	buydrink = 	{menu = "STORE_DRINKS", tooltip = 45119, sequence = 5},
	donate = 	{menu = "STORE_DONATE", tooltip = 45121, sequence = 3},
	bag = 		{menu = "STORE_BUYSELL", tooltip = 106755, sequence = 7},
}
storeChooserButtons={}
function isStoreChooserButtonHighlighted(idx)
	local menuName = storeButtonTypes[storeChooserButtons[idx]].menu
	local steal = storeButtonTypes[storeChooserButtons[idx]].steal
	if (Infinity_IsMenuOnStack(menuName) and steal == stealMode) then
			return 1
	else
		return 0
	end
end
function getStoreChooserSequence(idx)
	return storeButtonTypes[storeChooserButtons[idx]].sequence
end
function getStoreChooserTooltip(idx)
	return Infinity_FetchString(storeButtonTypes[storeChooserButtons[idx]].tooltip)
end
function setStoreMainPanel(idx)
	local menu = storeButtonTypes[storeChooserButtons[idx]].menu
	local steal = storeButtonTypes[storeChooserButtons[idx]].steal
	
	Infinity_PopMenu(currentStoreMenuName)
	Infinity_PushMenu(storeButtonTypes[storeChooserButtons[idx]].menu)
	
	stealMode = steal
end
`
menu
{
	name 'STORE_CHOOSER'
	align center center
	offset 0 210
	size 864 94
	onOpen
	"
		local menuName = storeButtonTypes[storeDefaultMenu].menu
		Infinity_PushMenu(menuName)
		pushSidebars()
		
	"
	onClose 
	"
		Infinity_PopMenu(currentStoreMenuName)
		stealMode = nil
		popSidebars()
		storeChooserButtons = {}
	"
	ignoreEsc
	
	label
	{
		area 22 6 80 70
		bam lua "store.icon"
	}
	button
	{
		area 806 13 94 58
		bam STRBUTT
		text "DONE_BUTTON"
		text style "button"
		on "escape"
		action
		"
			storeScreen:OnMainDoneButtonClick()
		"
	}
	button
	{
		area 108 10 62 64
		enabled "storeChooserButtons[1] ~= nil"
		bam "STRCHOOS"
		frame lua "isStoreChooserButtonHighlighted(1)"
		sequence lua "getStoreChooserSequence(1)"
		tooltip lua "getStoreChooserTooltip(1)"
		action
		"
			setStoreMainPanel(1)
		"
	}
	button
	{
		area 180 10 62 64
		enabled "storeChooserButtons[2] ~= nil"
		bam "STRCHOOS"
		frame lua "isStoreChooserButtonHighlighted(2)"
		sequence lua "getStoreChooserSequence(2)"
		tooltip lua "getStoreChooserTooltip(2)"
		action
		"
			setStoreMainPanel(2)
		"
	}
	button
	{
		area 252 10 62 64
		enabled "storeChooserButtons[3] ~= nil"
		bam "STRCHOOS"
		frame lua "isStoreChooserButtonHighlighted(3)"
		sequence lua "getStoreChooserSequence(3)"
		tooltip lua "getStoreChooserTooltip(3)"
		action
		"
			setStoreMainPanel(3)
		"
	}
	button
	{
		area 320 10 62 64
		enabled "storeChooserButtons[4] ~= nil"
		bam "STRCHOOS"
		frame lua "isStoreChooserButtonHighlighted(4)"
		sequence lua "getStoreChooserSequence(4)"
		tooltip lua "getStoreChooserTooltip(4)"
		action
		"
			setStoreMainPanel(4)
		"
	}

}
`
	function worldDeathLoadClickable()
		if(e:IsMultiplayer() and e:IsHosting()) then
			return false
		end
		return not worldScreen:GetHardPaused()
	end
	function worldDeathQuitClickable()
		return not worldScreen:GetHardPaused()
	end
	function worldDeathText()
		if(e:IsMultiplayer()) then
			if(e:IsHosting()) then
				return Infinity_FetchString(19377)
			else
				return Infinity_FetchString(11331)
			end
		else
			if(worldDeathStr == 0xffffffff) then --MAXDWORD, NOSTRREF
				return Infinity_FetchString(16498)
			else
				return Infinity_FetchString(worldDeathStr)
			end
		end
	end
	function worldDeathQuitText()
		if(e:IsMultiplayer()) then
			return t('LOGOUT_BUTTON')
		else
			return t('QUIT_BUTTON')
		end
	end
	groundItemsButtonToggle = 0
	worldChatEdit = ""
`
menu
{
	name "WORLD_DEATH"
	align center center
	ignoreEsc
	modal
	popupSound 1
	label -- Background
	{
		area 0 0 923 396
		mosaic POPUP2
	}
	label
	{
		area 93 96 186 186
		bam "POPUPIMG"
		sequence 2
	}
	label
	{
		area 336 92 540 217
		text lua "worldDeathText()"
		text style	"label"
		text align center center
	}
	button
	{
		area 522 320 170 54
		bam	widebutt
		text "LOAD_BUTTON"
		text style	"button"
		clickable lua "worldDeathLoadClickable()"
		action 
		"
			Infinity_PopMenu('WORLD_DEATH')
			worldScreen:OnDeathLoad()
		"
	}
	button
	{
		area 706 320 170 54
		bam	widebutt
		text style	"button"
		text lua "worldDeathQuitText()"
		clickable lua "worldDeathQuitClickable()"
		action 
		"
			Infinity_PopMenu('WORLD_DEATH')
			worldScreen:OnDeathQuit()
		"
	}
}
`
actionBarTooltip = {}
contextBarState = nil

function toggleContextBar(state)
	if(Infinity_IsMenuOnStack('WORLD_CONTEXT_BAR')) then
		Infinity_PopMenu('WORLD_CONTEXT_BAR')
	else
		contextBarState = state
		Infinity_PushMenu('WORLD_CONTEXT_BAR')
	end
end
function showContextMenu(state)
	lastShownContextMenu = state
	game:GetButtonArray():SetState(state)
	if(contextBarState == state) then
		toggleContextBar()
	else
		contextBarState = state
		Infinity_PushMenu('WORLD_CONTEXT_BAR')
	end
end
portraitNoBackgrounds =
{
	"prtrtno0",
	"prtrtno1",
	"prtrtno0",
	"prtrtno1",
	"prtrtno1",
	"prtrtno0",
}
function getPortraitBg(num)
	if(game:GetNumCharacters() <= num) then
		return portraitNoBackgrounds[num]
	else
		return "prtrtbg"
	end
end
function getPortraitBgTooltip(num)
	if(game:GetNumCharacters() <= num) then
		return Infinity_FetchString(106819)
	else
		return nil
	end
end
mouseOverPortrait = -1
draggedPortrait = nil

function swapPortraits(dest)
	if(not draggedPortrait) then return end
	cursor:SetCursor(0)
	game:SetTempCursor(0)
	worldScreen:SwapPortraits(dest,draggedPortrait)
	draggedPortrait = nil
end
function fullActionbarClickable()
	return (e:GetActiveEngine() == e:GetEngineWorld())
end
function startDraggingPortrait(portraitNum)
	if(e:GetActiveEngine() ~= worldScreen) then return end
	draggedPortrait = portraitNum
	cursor:SetCursor(14)
	game:SetTempCursor(14) --CINFCURSOR_MOVEPORTRAIT
end
function getAIButtonSequence()
	if(game:GetPartyAI()) then
		return 7
	else
		return 6
	end
end
function getLockScrollButtonSequence()
	if(worldScreen:GetScrollLocked()) then
		return 5
	else
		return 4
	end
end
function getCombatLogSequence()
	if(Infinity_IsMenuOnStack("WORLD_COMBATLOG")) then
		return 11
	else
		return 12
	end
end
function getQuickLootSequence()
	if(Infinity_IsMenuOnStack("WORLD_QUICKLOOT")) then
		return 9
	else
		return 13
	end
end
function actionbarResetState()
	if(game:GetIconIndex() ~= 0 and game:GetState() ~= 0) then
		game:SetIconIndex(0)
		game:SetState(0)
	end
end
function getPauseButtonSequence()
	if(e:GetActiveEngine() == worldScreen) then
		return 0
	else
		return 1
	end
end
function getFormationSequence()
	if(Infinity_IsMenuOnStack("WORLD_FORMATION")) then
		return 2
	else
		return 14
	end
end
function getHighlightSequence()
	if(worldScreen:HighlightEnabled()) then
		return 10
	else
		return 15
	end
end
function getReturnToGameTooltip()
	if(e:GetActiveEngine() == worldScreen) then
		return nil
	else
		return t("RETURN_TO_GAME_TOOLTIP")
	end
end
function getPulseHelp()
	return e:GetActiveEngine() == worldScreen and (getSaveOption("Viewed Help", "Viewed Help", 0) == 0)
end
function toggleFormationsMenu()
	if(Infinity_IsMenuOnStack('WORLD_FORMATION')) then
		Infinity_PopMenu('WORLD_FORMATION')
	else
		Infinity_PushMenu('WORLD_FORMATION')
	end
end

hadQuickLoot = 0
hadCombatLog = 0
quickLootToggle = 0
combatLogToggle = 0

function IsQuicklootActive()
	local ret = 0

	if hadQuickLoot == 1 or Infinity_IsMenuOnStack('WORLD_QUICKLOOT') then
		ret = 1
	end

	return ret
end
function IsCombatLogActive()
	local ret = 0

	if hadCombatLog == 1 or Infinity_IsMenuOnStack('WORLD_COMBATLOG') then
		ret = 1
	end

	return ret
end
function openGemMenus(quicklootOnly)
	if e:GetActiveEngine() == worldScreen then
		if(hadQuickLoot == 1) then
			hadQuickLoot = 0
			Infinity_PushMenu('WORLD_QUICKLOOT')
		end
		if(not quicklootOnly and hadCombatLog == 1) then
			hadCombatLog = 0
			Infinity_PushMenu('WORLD_COMBATLOG')
		end
	end
end
function closeGemMenus(quicklootOnly)
	if e:GetActiveEngine() == worldScreen then
		if(Infinity_IsMenuOnStack('WORLD_QUICKLOOT')) then
			hadQuickLoot = 1
			Infinity_PopMenu('WORLD_QUICKLOOT')
		end
		if(not quicklootOnly and Infinity_IsMenuOnStack('WORLD_COMBATLOG')) then
			hadCombatLog = 1
			Infinity_PopMenu('WORLD_COMBATLOG')
		end
	end
end
function isTouchActionbar()
	--Make this read from an option to make it easy to switch out.
	local default = 0
	if(e:IsTouchUI()) then default = 1 end
	local val = Infinity_GetINIValue('Program Options', 'Use Touch Actionbar', default)
	if (val ~= 0) then
		return 1
	else
		return nil
	end
end
`
menu
{
	name "WORLD_ACTIONBAR"
	align center bottom
	size 1024 85
	ignoreEsc
	onOpen
	"
		toolbarTop = 85
		if(isTouchActionbar()) then
			Infinity_PushMenu('WORLD_SIDEBAR_LEFT')
			Infinity_PushMenu('WORLD_SIDEBAR_RIGHT')
			Infinity_PushMenu('WORLD_ACTIONBAR_TOUCH')
			Infinity_PushMenu('WORLD_ACTIONBAR_LEFT_TABLET')
		else
			Infinity_PushMenu('WORLD_ACTIONBAR_LEFT')
		end
		--if(hadContextBar) then
		--	hadContextBar = nil
		--Infinity_PushMenu('WORLD_CONTEXT_BAR')
		--end
		
		
		openGemMenus(false)
	"
	onClose
	"
		Infinity_PopMenu('WORLD_ACTIONBAR_LEFT')
		Infinity_PopMenu('WORLD_ACTIONBAR_LEFT_TABLET')
		Infinity_PopMenu('WORLD_SIDEBAR_LEFT')
		Infinity_PopMenu('WORLD_SIDEBAR_RIGHT')
		Infinity_PopMenu('WORLD_ACTIONBAR_TOUCH')
		
		Infinity_PopMenu('WORLD_FORMATION')
		Infinity_PopMenu('WORLD_BOTTOM_MESSAGE')
		Infinity_PopMenu('WORLD_CONTEXT_BAR')
		Infinity_PopMenu('WORLD_HELP')
		Infinity_PopMenu('WORLD_HELP_TABLET')
		
		Infinity_PopMenu('ITEM_DESCRIPTION')
		Infinity_PopMenu('SPELL_DESCRIPTION')
		
		closeGemMenus(false)
	"
	--PC Version
	label
	{
		enabled "not isTouchActionbar()"
		area 0 0 1024 85
		mosaic "actbg"
	}
	label
	{
		enabled "not isTouchActionbar()"
		area -1371 0 1371 85
		mosaic "mainwing"
	}
	label
	{
		enabled "not isTouchActionbar()"
		area 1024 0 1371 85
		mosaic "mainwing"
	}
}
menu
{
	--This sits on top of actionbar, it needed to be split out so the sidebars could go under it
	name "WORLD_ACTIONBAR_TOUCH"
	align center bottom
	size 1024 85
	ignoreEsc
	label
	{
		enabled "isTouchActionbar()"
		area 0 0 1024 85
		mosaic "actbgtab"
	}
	label
	{
		enabled "isTouchActionbar()"
		area -1371 0 1371 85
		mosaic "mainwing"
	}
	label
	{
		enabled "isTouchActionbar()"
		area 1024 0 1371 85
		mosaic "mainwing"
	}
}
`
forceClockTooltip = false
horribleTimeFrameOffset = 0
function getTimeSequence()
	if(worldScreen:CheckIfPaused()) then
		return 1
	else
		return 0
	end
end
function getTimeFrame()
	local currentTime = timer:GetCurrentTime()
	
	--this is a hack to appease The Ancient Code that decrements time when you pause.
	--Basically just keep track of how out of sync the clock frame has gotten with the actual time and adjust accordingly.
	currentTime = currentTime + horribleTimeFrameOffset
	
	local f = currentTime % 8
	return f
end
function incrementHorribleClockHack()
	horribleTimeFrameOffset = (horribleTimeFrameOffset + 1) % 8
end
function openWhicheverHelpScreenWouldSeemToBeAppropriate()
	local engine = e:GetActiveEngine()
	if(engine == e:GetEngineWorld()) then
		if(Infinity_IsMenuOnStack('WORLD_ACTIONBAR_LEFT')) then
			Infinity_PushMenu('WORLD_HELP')
		else
			Infinity_PushMenu('WORLD_HELP_TABLET')
		end
	end
	
	if(engine == e:GetEngineInventory()) then
		Infinity_PushMenu('INVENTORY_HELP')
	end
	
	if(engine == e:GetEngineCharacter()) then
		Infinity_PushMenu('CHARACTER_HELP')
	end
	
	if(engine == e:GetEngineWizSpell() or engine == e:GetEnginePriestSpell()) then
		Infinity_PushMenu('SPELLS_HELP')
	end
	
	if(engine == e:GetEngineMap()) then
		Infinity_PushMenu('MAP_HELP')
	end
	
end
`
menu
{
	name "WORLD_ACTIONBAR_LEFT"
	align center bottom
	ignoreEsc
	ignoreFocus 1
	size 1024 85
	onOpen "horribleTimeFrameOffset = 0"
	button
	{
		area 84 57 25 24
		enabled "fullActionbarClickable()"
		bam "CIRCBUTT"
		sequence 0
		tooltip "SELECT_ALL_TOOLTIP"
		action
		"
			game:SelectAll()
		"
		actionDbl
		"
			game:CenterOnGroupLeader()
		"
		
	}
	button
	{
		area 84 30 25 24
		enabled "fullActionbarClickable()"
		bam "CIRCBUTT"
		sequence 1
		tooltip "CANCEL_ACTION_TOOLTIP"
		action
		"
			game:CancelCurrentAction()
		"
	}
	button
	{
		area 84 2 25 24
		enabled "fullActionbarClickable()"
		bam "CIRCBUTT"
		sequence lua "getFormationSequence()"
		tooltip "FORMATIONS_TOOLTIP"
		action
		"
			toggleFormationsMenu()
		"
	}
	button
	{
		area 110 0 45 85
		clickable lua "fullActionbarClickable()"
		bam "TACTBUTT"
		sequence 0
		tooltip "ATTACK_TOOLTIP"
		frame lua "getWeaponHighlightFrame()"
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_WEAPONS)
		"
		
	}
	button
	{
		area 156 0 45 85
		bam "TACTBUTT"
		sequence 1
		clickable lua "pst:SpellContextClickable() and fullActionbarClickable()"
		tooltip "SPELLS_TOOLTIP"
		frame lua "getSpellHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (spells are also a mappable key event)
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_SPELLS)
		"
		
	}
	button
	{
		area 202 0 45 85
		clickable lua "fullActionbarClickable()"
		bam "TACTBUTT"
		sequence 2
		tooltip "ITEMS_TOOLTIP"
		frame lua "getItemHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (items are also a mappable key event)
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_ITEMS)
		"
		
	}
	button
	{
		area 248 0 45 85
		bam "TACTBUTT"
		sequence 3
		clickable lua "pst:SpecialAbilitiesContextClickable() and fullActionbarClickable()"
		tooltip "SPECIAL_ABILITIES_TOOLTIP"
		frame lua "getSpecialAbilityHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (special abilities are also a mappable key event)
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_SPECIAL_ABILITES)
		"
		
	}
	button
	{
		area 294 0 45 85
		clickable lua "fullActionbarClickable()"
		bam "TACTBUTT"
		sequence 4
		tooltip "TALK_TOOLTIP"
		frame lua "getDialogHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (since dialog is also a mappable key event)
		action
		"	
			Infinity_PopMenu('WORLD_CONTEXT_BAR')
			
			if(game:GetIconIndex() == 18 and game:GetState() == 2) then
				game:SetState(0)
				game:SetIconIndex(0)
			else
				game:SetState(2)
				game:SetIconIndex(18)
			end
		"
	}

	button
	{
		area 7 7 73 75
		bam "pausbutt"
		--clickable lua "e:GetActiveEngine() ~= worldScreen"
		tooltip lua "getReturnToGameTooltip()"
		action
		"
			if(e:GetActiveEngine() ~= worldScreen) then
				e:GetActiveEngine():SelectEngine(worldScreen)
			else
				if(e:GetActiveEngine() == worldScreen) then
					worldScreen:TogglePauseGame(true)
				end
			end
		"
	}
	text
	{
		area 6 5 74 45
		bam "wmtime"
		tooltip lua "timer:GetCurrentClockTime()"
		tooltip force lua "forceClockTooltip == true"
		sequence lua "getTimeSequence()"
		frame lua "getTimeFrame()"
		action
		"
			if(e:GetActiveEngine() == worldScreen) then
				worldScreen:TogglePauseGame(true)
			end
		"
		actionEnter "forceClockTooltip = true"
		actionExit "forceClockTooltip = false"
		
	}
	text
	{
		area 763 0 85 85
		mosaic lua "getPortraitBg(5)"
		tooltip lua "getPortraitBgTooltip(5)"
	}
	button
	{
		area 769 4 74 58
		portrait 5
		enabled "Infinity_GetNumCharacters() > 5"
		glow lua "draggedPortrait and draggedPortrait ~= 5"
		action "Infinity_OnPortraitLClick(5)"
		actionAlt "Infinity_OnPortraitRClick(5)"
		actionDbl "Infinity_OnPortraitDblClick(5)"
		actiondrag "Infinity_SwapWithPortrait(5)"
		actionEnter "mouseOverPortrait = 5"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(5)"
		actionSimpleDrop "swapPortraits(5)"
		clickable lua "sidebarsGreyed ~= 1"
		
	}
	button
	{
		area 767 64 78 16
		healthbar 5
		action
		"
			game:ToggleHealthbar(5)
		"
	}
	button 
	{
		area 832 67 10 10
		enabled "Infinity_GetNumCharacters() > 5 and Infinity_CanLevelUp(5)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(5)
		"
	}
	text
	{
		area 678 0 85 85
		mosaic lua "getPortraitBg(4)"
		tooltip lua "getPortraitBgTooltip(4)"
	}
	button
	{
		area 684 4 74 58
		portrait 4
		enabled "Infinity_GetNumCharacters() > 4"
		glow lua "draggedPortrait and draggedPortrait ~= 4"
		action "Infinity_OnPortraitLClick(4)"
		actionAlt "Infinity_OnPortraitRClick(4)"
		actionDbl "Infinity_OnPortraitDblClick(4)"
		actiondrag "Infinity_SwapWithPortrait(4)"
		actionEnter "mouseOverPortrait = 4"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(4)"
		actionSimpleDrop "swapPortraits(4)"
		clickable lua "sidebarsGreyed ~= 1"
		
	}
	button
	{
		area 681 64 78 16
		healthbar 4
		action
		"
			game:ToggleHealthbar(4)
		"
	}
	button 
	{
		area 745 67 10 10
		enabled "Infinity_GetNumCharacters() > 4 and Infinity_CanLevelUp(4)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(4)
		"
	}
	text
	{
		area 593 0 85 85
		mosaic lua "getPortraitBg(3)"
		tooltip lua "getPortraitBgTooltip(3)"
	}
	button
	{
		area 599 4 74 58
		portrait 3
		enabled "Infinity_GetNumCharacters() > 3"
		glow lua "draggedPortrait and draggedPortrait ~= 3"
		action "Infinity_OnPortraitLClick(3)"
		actionAlt "Infinity_OnPortraitRClick(3)"
		actionDbl "Infinity_OnPortraitDblClick(3)"
		actiondrag "Infinity_SwapWithPortrait(3)"
		actionEnter "mouseOverPortrait = 3"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(3)"
		actionSimpleDrop "swapPortraits(3)"
		clickable lua "sidebarsGreyed ~= 1"
		
	}
	button
	{
		area 596 64 78 16
		healthbar 3
		action
		"
			game:ToggleHealthbar(3)
		"
	}
	button 
	{
		area 661 67 10 10
		enabled "Infinity_GetNumCharacters() > 3 and Infinity_CanLevelUp(3)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(3)
		"
	}
	text
	{
		area 508 0 85 85
		mosaic lua "getPortraitBg(2)"
		tooltip lua "getPortraitBgTooltip(2)"
	}
	button
	{
		area 514 4 74 58
		portrait 2
		enabled "Infinity_GetNumCharacters() > 2"
		glow lua "draggedPortrait and draggedPortrait ~= 2"
		action "Infinity_OnPortraitLClick(2)"
		actionAlt "Infinity_OnPortraitRClick(2)"
		actionDbl "Infinity_OnPortraitDblClick(2)"
		actiondrag "Infinity_SwapWithPortrait(2)"
		actionEnter "mouseOverPortrait = 2"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(2)"
		actionSimpleDrop "swapPortraits(2)"
		clickable lua "sidebarsGreyed ~= 1"
		
	}
	button
	{
		area 511 64 78 16
		healthbar 2
		action
		"
			game:ToggleHealthbar(2)
		"
	}
	button 
	{
		area 576 67 10 10
		enabled "Infinity_GetNumCharacters() > 2 and Infinity_CanLevelUp(2)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(2)
		"
	}
	text
	{
		area 423 0 85 85
		mosaic lua "getPortraitBg(1)"
		tooltip lua "getPortraitBgTooltip(1)"
	}
	button
	{
		area 429 4 74 58
		portrait 1
		enabled "Infinity_GetNumCharacters() > 1"
		glow lua "draggedPortrait and draggedPortrait ~= 1"
		action "Infinity_OnPortraitLClick(1)"
		actionAlt "Infinity_OnPortraitRClick(1)"
		actionDbl "Infinity_OnPortraitDblClick(1)"
		actiondrag "Infinity_SwapWithPortrait(1)"
		actionEnter "mouseOverPortrait = 1"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(1)"
		actionSimpleDrop "swapPortraits(1)"
		clickable lua "sidebarsGreyed ~= 1"
	}
	button
	{
		area 427 64 78 16
		healthbar 1
		action
		"
			game:ToggleHealthbar(1)
		"
	}
	button 
	{
		area 492 67 10 10
		enabled "Infinity_GetNumCharacters() > 1 and Infinity_CanLevelUp(1)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(1)
		"
	}
	text
	{
		area 338 0 85 85
		mosaic lua "getPortraitBg(0)"
		tooltip lua "getPortraitBgTooltip(0)"
	}
	button
	{
		area 344 4 74 58
		--some of these may be unneeded TODO
		portrait 0
		enabled "Infinity_GetNumCharacters() > 0"
		glow lua "draggedPortrait and draggedPortrait ~= 0"
		action "Infinity_OnPortraitLClick(0)"
		actionAlt "Infinity_OnPortraitRClick(0)"
		actionDbl "Infinity_OnPortraitDblClick(0)"
		actiondrag "Infinity_SwapWithPortrait(0)"
		actionEnter "mouseOverPortrait = 0"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(0)"
		actionSimpleDrop "swapPortraits(0)"
		clickable lua "sidebarsGreyed ~= 1"
	}
	button
	{
		area 342 64 78 16
		healthbar 0
		action
		"
			game:ToggleHealthbar(0)
		"
	}
	button 
	{
		area 407 67 10 10
		enabled "Infinity_GetNumCharacters() > 0 and Infinity_CanLevelUp(0)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(0)
		"
	}
		button
	{
		area 849 2 25 24
		enabled "fullActionbarClickable()"
		sequence 3
		bam "CIRCBUTT"
		tooltip "MESSAGE_LOG_TOOLTIP"
		action
		"
			dialogViewMode = 1
			worldScreen:StartDialogHistory()
		"
	}
	button
	{
		area 849 30 25 24
		enabled "fullActionbarClickable()"
		sequence lua "getLockScrollButtonSequence()"
		bam "CIRCBUTT"
		tooltip "LOCK_SCROLL_TOOLTIP"
		action
		"
			worldScreen:LockScrollSelected()
		"
	}
	button
	{
		area 849 57 25 24
		enabled "fullActionbarClickable()"
		sequence lua "getAIButtonSequence()"
		bam "CIRCBUTT"
		tooltip "TOGGLE_AI_TOOLTIP"
		action 
		"
			game:ToggleAI()
		"
		
	}
	button
	{
		area 880 13 31 29
		bam "RADWEDGE"
		sequence 0
		tooltip "INVENTORY_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(3)
		"
		boundingPoints 	20,  0 --1
						32, 27 --2
						 0, 28 --3
						10,  7 --4
	}
		button
	{
		area 901 4 32 37
		bam "RADWEDGE"
		sequence 1
		tooltip "MAP_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(1)
		"
		boundingPoints 	0,   7 --1
						32,  0 --2
						32, 33 --3
						11, 37 --4
	}
	button
	{
		area 934 4 32 37
		bam "RADWEDGE"
		sequence 2
		tooltip "MAGE_SPELLS_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(5)
		"
		boundingPoints 	 0,  0 --1
						32,  8 --2
						20, 37 --3
						 0, 31 --4
	}
	button
	{
		area 956 13 32 29
		bam "RADWEDGE"
		sequence 3
		tooltip "REST_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnRestButtonClick()
		"
		boundingPoints 	12,  0 --1
						26,  10 --2
						33, 27 --3
						 0, 25 --4
	}
	button
	{
		area 880 43 31 29
		bam "RADWEDGE"
		sequence 4
		tooltip "CHARACTER_RECORD_TOOLTIP"
		pulse lua "worldScreen:SelectedReadyToLevelUp()"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(4)
		"
		boundingPoints 	 0,  0 --1
						32,  2 --2
						21, 28 --3
						 5, 15 --4
	}
	button
	{
		area 901 44 32 36
		bam "RADWEDGE"
		sequence 5
		tooltip "JOURNAL_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
		boundingPoints 	10,  0 --1
						33,  0 --2
						33, 36 --3
						 0, 25 --4
	}
	button
	{
		area 934 44 32 36
		bam "RADWEDGE"
		sequence 6
		tooltip "PRIEST_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(6)
		"
		boundingPoints 	 0,  0 --1
						21,  0 --2
						33, 26 --3
						 0, 36 --4
	}
	button
	{
		area 956 43 32 29
		bam "RADWEDGE"
		sequence 7
		tooltip "OPTIONS_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(7)
		"
		boundingPoints 	 1,  1 --1
						33,  0 --2
						25, 18 --3
						11, 28 --4
	}
	
		
	button
	{
		area 994 2 25 24
		enabled "fullActionbarClickable()"
		tooltip "COMBATLOG_TOOLTIP"
		bam "CIRCBUTT"
		sequence lua "getCombatLogSequence()"
		toggle "combatLogToggle"
		clickable lua "e:GetActiveEngine() == worldScreen"
		action
		"
			if Infinity_IsMenuOnStack('WORLD_COMBATLOG') then
				Infinity_PopMenu('WORLD_COMBATLOG')
			else
				Infinity_PushMenu('WORLD_COMBATLOG')
			end 
		"
	}
	button
	{
		area 994 30 25 24
		enabled "fullActionbarClickable()"
		tooltip "QUICKLOOT_TOOLTIP"
		bam "CIRCBUTT"
		sequence lua "getQuickLootSequence()"
		clickable lua "e:GetActiveEngine() == worldScreen"
		action
		"
			if Infinity_IsMenuOnStack('WORLD_QUICKLOOT') then
				worldScreen:StopGroundItems()
			else
				worldScreen:StartGroundItems()
			end 
		"
		
	}
	button
	{
		area 994 57 25 24
		--enabled "fullActionbarClickable()"
		sequence 8
		bam "CIRCBUTT"
		tooltip "HELP_TOOLTIP"
		action
		"
			openWhicheverHelpScreenWouldSeemToBeAppropriate()
		"
	}

	label
	{
		--area is preset
		enabled "gameOptions.m_bRenderFrameTimes"
		frameTimes
	}
}

`
	function getWeaponHighlightFrame()
		local highlight = (game:GetIconIndex() == 12 or game:GetIconIndex() == 16) and (game:GetState() == 2 or game:GetState() == 3) and (lastShownContextMenu == const.ACTIONBAR_STATE_WEAPONS)
		if(highlight) then
			return 2
		else
			return 0
		end
	end
	function getSpellHighlightFrame()
		local highlight = (game:GetIconIndex() == 20) and (game:GetState() == 2) and (lastShownContextMenu == const.ACTIONBAR_STATE_SPELLS)
		if(highlight) then
			return 2
		else
			return 0
		end
	end
	function getItemHighlightFrame()
		local highlight = (game:GetIconIndex() == 20) and (game:GetState() == 2) and (lastShownContextMenu == const.ACTIONBAR_STATE_ITEMS)
		if(highlight) then
			return 2
		else
			return 0
		end
	end
	function getSpecialAbilityHighlightFrame()
		local highlight = (game:GetIconIndex() == 20 or game:GetIconIndex() == 36) and (game:GetState() == 2) and (lastShownContextMenu == const.ACTIONBAR_STATE_SPECIAL_ABILITES)
		if(highlight) then
			return 2
		else
			return 0
		end
	end
	function getDialogHighlightFrame()
		local highlight = (game:GetIconIndex() == 18) and (game:GetState() == 2)
		if(highlight) then
			return 2
		else
			return 0
		end
	end
	function shouldShowCurrentAction()
		return game:GetState() ~= 0 and game:GetIconIndex() ~= 18
	end
`
menu
{
	name "WORLD_ACTIONBAR_LEFT_TABLET"
	align center bottom
	ignoreEsc
	ignoreFocus 1
	size 1024 85
	label
	{
		area 0 0 1024 85
	}
	label
	{
		area 882 0 143 85
		mosaic "TAB6"
	}
	button
	{
		area 79 0 45 85
		clickable lua "fullActionbarClickable()"
		bam "TACTBUTT"
		sequence 0
		tooltip "ATTACK_TOOLTIP"
		frame lua "getWeaponHighlightFrame()"
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_WEAPONS)
		"
		
	}
	button
	{
		area 125 0 45 85
		bam "TACTBUTT"
		sequence 1
		clickable lua "pst:SpellContextClickable() and fullActionbarClickable()"
		tooltip "SPELLS_TOOLTIP"
		frame lua "getSpellHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (spells are also a mappable key event)
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_SPELLS)
		"
		
	}
	button
	{
		area 171 0 45 85
		clickable lua "fullActionbarClickable()"
		bam "TACTBUTT"
		sequence 2
		tooltip "ITEMS_TOOLTIP"
		frame lua "getItemHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (items are also a mappable key event)
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_ITEMS)
		"
		
	}
	button
	{
		area 217 0 45 85
		bam "TACTBUTT"
		sequence 3
		clickable lua "pst:SpecialAbilitiesContextClickable() and fullActionbarClickable()"
		tooltip "SPECIAL_ABILITIES_TOOLTIP"
		frame lua "getSpecialAbilityHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (special abilities are also a mappable key event)
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_SPECIAL_ABILITES)
		"
		
	}
	button
	{
		area 263 0 45 85
		clickable lua "fullActionbarClickable()"
		bam "TACTBUTT"
		sequence 4
		tooltip "TALK_TOOLTIP"
		frame lua "getDialogHighlightFrame()"
		-- MGB, October 4, 2016 - This action is run in two places; the other is ported in C++ in InfScreenWorld::OnKeyDown (since dialog is also a mappable key event)
		action
		"	
			Infinity_PopMenu('WORLD_CONTEXT_BAR')
			
			if(game:GetIconIndex() == 18 and game:GetState() == 2) then
				game:SetState(0)
				game:SetIconIndex(0)
			else
				game:SetState(2)
				game:SetIconIndex(18)
			end
		"
	}

	label
	{
		area 308 0 67 85
		mosaic 'TABTARG'
	}
	button
	{
		area 316 3 52 52
		actionBar lua "buttonArray:GetLastButtonId()"
		action "worldScreen:CancelPendingAction()"
		actionAlt "buttonArray:OnRButtonPressed(0)"
		enabled "shouldShowCurrentAction()"
	}
	label
	{
		area 312 57 60 22
		enabled "shouldShowCurrentAction()"
		text 106806
		text style 'normal'
		text align center center
	}

	button
	{
		area 4 6 73 75
		bam "pausbutt"
		--clickable lua "e:GetActiveEngine() ~= worldScreen"
		tooltip lua "getReturnToGameTooltip()"
		action
		"
			if(e:GetActiveEngine() ~= worldScreen) then
				e:GetActiveEngine():SelectEngine(worldScreen)
			else
				if(e:GetActiveEngine() == worldScreen) then
					worldScreen:TogglePauseGame(true)
				end
			end
		"
	}
	text
	{
		area 3 5 74 45
		bam "wmtime"
		tooltip lua "timer:GetCurrentClockTime()"
		tooltip force lua "forceClockTooltip == true"
		sequence lua "getTimeSequence()"
		frame lua "getTimeFrame()"
		action
		"
			if(e:GetActiveEngine() == worldScreen) then
				worldScreen:TogglePauseGame(true)
			end
		"
		actionEnter "forceClockTooltip = true"
		actionExit "forceClockTooltip = false"
		
	}
	text
	{
		area 799 0 85 85
		mosaic lua "getPortraitBg(5)"
		tooltip lua "getPortraitBgTooltip(5)"
	}
	button
	{
		area 805 4 74 58
		portrait 5
		enabled "Infinity_GetNumCharacters() > 5"
		glow lua "draggedPortrait and draggedPortrait ~= 5"
		action "Infinity_OnPortraitLClick(5)"
		actionAlt "Infinity_OnPortraitRClick(5)"
		actionDbl "Infinity_OnPortraitDblClick(5)"
		actiondrag "Infinity_SwapWithPortrait(5)"
		actionEnter "mouseOverPortrait = 5"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(5)"
		actionSimpleDrop "swapPortraits(5)"
		clickable lua "sidebarsGreyed ~= 1"
		tooltip lua "Infinity_GetPortraitTooltip(5)"
		
	}
	button
	{
		area 803 65 78 16
		healthbar 5
		action
		"
			game:ToggleHealthbar(5)
		"
	}
	button 
	{
		area 869 68 10 10
		enabled "Infinity_GetNumCharacters() > 5 and Infinity_CanLevelUp(5)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(5)
		"
	}
	text
	{
		area 714 0 85 85
		mosaic lua "getPortraitBg(4)"
		tooltip lua "getPortraitBgTooltip(4)"
	}
	button
	{
		area 720 4 74 58
		portrait 4
		enabled "Infinity_GetNumCharacters() > 4"
		glow lua "draggedPortrait and draggedPortrait ~= 4"
		action "Infinity_OnPortraitLClick(4)"
		actionAlt "Infinity_OnPortraitRClick(4)"
		actionDbl "Infinity_OnPortraitDblClick(4)"
		actiondrag "Infinity_SwapWithPortrait(4)"
		actionEnter "mouseOverPortrait = 4"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(4)"
		actionSimpleDrop "swapPortraits(4)"
		clickable lua "sidebarsGreyed ~= 1"
		tooltip lua "Infinity_GetPortraitTooltip(4)"
		
	}
	button
	{
		area 718 65 78 16
		healthbar 4
		action
		"
			game:ToggleHealthbar(4)
		"
	}
	button 
	{
		area 784 68 10 10
		enabled "Infinity_GetNumCharacters() > 4 and Infinity_CanLevelUp(4)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(4)
		"
	}
	text
	{
		area 629 0 85 85
		mosaic lua "getPortraitBg(3)"
		tooltip lua "getPortraitBgTooltip(3)"
	}
	button
	{
		area 635 4 74 58
		portrait 3
		enabled "Infinity_GetNumCharacters() > 3"
		glow lua "draggedPortrait and draggedPortrait ~= 3"
		action "Infinity_OnPortraitLClick(3)"
		actionAlt "Infinity_OnPortraitRClick(3)"
		actionDbl "Infinity_OnPortraitDblClick(3)"
		actiondrag "Infinity_SwapWithPortrait(3)"
		actionEnter "mouseOverPortrait = 3"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(3)"
		actionSimpleDrop "swapPortraits(3)"
		clickable lua "sidebarsGreyed ~= 1"
		tooltip lua "Infinity_GetPortraitTooltip(3)"
		
	}
	button
	{
		area 633 65 78 16
		healthbar 3
		action
		"
			game:ToggleHealthbar(3)
		"
	}
	button 
	{
		area 699 68 10 10
		enabled "Infinity_GetNumCharacters() > 3 and Infinity_CanLevelUp(3)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(3)
		"
	}
	text
	{
		area 544 0 85 85
		mosaic lua "getPortraitBg(2)"
		tooltip lua "getPortraitBgTooltip(2)"
	}
	button
	{
		area 550 4 74 58
		portrait 2
		enabled "Infinity_GetNumCharacters() > 2"
		glow lua "draggedPortrait and draggedPortrait ~= 2"
		action "Infinity_OnPortraitLClick(2)"
		actionAlt "Infinity_OnPortraitRClick(2)"
		actionDbl "Infinity_OnPortraitDblClick(2)"
		actiondrag "Infinity_SwapWithPortrait(2)"
		actionEnter "mouseOverPortrait = 2"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(2)"
		actionSimpleDrop "swapPortraits(2)"
		clickable lua "sidebarsGreyed ~= 1"
		tooltip lua "Infinity_GetPortraitTooltip(2)"
		
	}
	button
	{
		area 548 65 78 16
		healthbar 2
		action
		"
			game:ToggleHealthbar(2)
		"
	}
	button 
	{
		area 614 68 10 10
		enabled "Infinity_GetNumCharacters() > 2 and Infinity_CanLevelUp(2)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(2)
		"
	}
	text
	{
		area 459 0 85 85
		mosaic lua "getPortraitBg(1)"
		tooltip lua "getPortraitBgTooltip(1)"
	}
	button
	{
		area 465 4 74 58
		portrait 1
		enabled "Infinity_GetNumCharacters() > 1"
		glow lua "draggedPortrait and draggedPortrait ~= 1"
		action "Infinity_OnPortraitLClick(1)"
		actionAlt "Infinity_OnPortraitRClick(1)"
		actionDbl "Infinity_OnPortraitDblClick(1)"
		actiondrag "Infinity_SwapWithPortrait(1)"
		actionEnter "mouseOverPortrait = 1"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(1)"
		actionSimpleDrop "swapPortraits(1)"
		clickable lua "sidebarsGreyed ~= 1"
		tooltip lua "Infinity_GetPortraitTooltip(1)"
	}
	button
	{
		area 463 65 78 16
		healthbar 1
		action
		"
			game:ToggleHealthbar(1)
		"
	}
	button 
	{
		area 529 68 10 10
		enabled "Infinity_GetNumCharacters() > 1 and Infinity_CanLevelUp(1)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(1)
		"
	}
	text
	{
		area 374 0 85 85
		mosaic lua "getPortraitBg(0)"
		tooltip lua "getPortraitBgTooltip(0)"
	}
	button
	{
		area 380 4 74 58
		--some of these may be unneeded TODO
		portrait 0
		enabled "Infinity_GetNumCharacters() > 0"
		glow lua "draggedPortrait and draggedPortrait ~= 0"
		action "Infinity_OnPortraitLClick(0)"
		actionAlt "Infinity_OnPortraitRClick(0)"
		actionDbl "Infinity_OnPortraitDblClick(0)"
		actiondrag "Infinity_SwapWithPortrait(0)"
		actionEnter "mouseOverPortrait = 0"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(0)"
		actionSimpleDrop "swapPortraits(0)"
		clickable lua "sidebarsGreyed ~= 1"
		tooltip lua "Infinity_GetPortraitTooltip(0)"
	}
	button
	{
		area 378 65 78 16
		healthbar 0
		action
		"
			game:ToggleHealthbar(0)
		"
	}
	button 
	{
		area 444 68 10 10
		enabled "Infinity_GetNumCharacters() > 0 and Infinity_CanLevelUp(0)"
		bam "LVLBUTT"
		action
		"
			Infinity_ActivateRecord(0)
		"
	}
	button
	{
		area 973 10 31 31
		enabled "fullActionbarClickable()"
		bam "CIRCBUTT"
		sequence 0
		tooltip "SELECT_ALL_TOOLTIP"
		action
		"
			game:SelectAll()
		"
		actionDbl
		"
			game:CenterOnGroupLeader()
		"
		
	}
	button
	{
		area 938 10 31 31
		enabled "fullActionbarClickable()"
		bam "CIRCBUTT"
		sequence 1
		tooltip "CANCEL_ACTION_TOOLTIP"
		action
		"
			game:CancelCurrentAction()
		"
	}
	button
	{
		area 902 10 31 31
		enabled "fullActionbarClickable()"
		bam "CIRCBUTT"
		sequence lua "getFormationSequence()"
		tooltip "FORMATIONS_TOOLTIP"
		action
		"
			if(Infinity_IsMenuOnStack('WORLD_FORMATION')) then
				Infinity_PopMenu('WORLD_FORMATION')
			else
				Infinity_PushMenu('WORLD_FORMATION')
			end
		"
	}
		button
	{
		area 902 46 31 31
		enabled "fullActionbarClickable()"
		sequence lua "getQuickLootSequence()"
		bam "CIRCBUTT"
		tooltip "QUICKLOOT_TOOLTIP"
		toggle "quickLootToggle"
		clickable lua "e:GetActiveEngine() == worldScreen"
		action
		"
			if Infinity_IsMenuOnStack('WORLD_QUICKLOOT') then
				worldScreen:StopGroundItems()
			else
				worldScreen:StartGroundItems()
			end 
		"
	}
	button
	{
		area 938 46 31 31
		--enabled "fullActionbarClickable()"
		sequence 8
		bam "CIRCBUTT"
		tooltip "HELP_TOOLTIP"
		action
		"
			openWhicheverHelpScreenWouldSeemToBeAppropriate()
		"
	}
	button
	{
		area 973 46 31 31
		enabled "fullActionbarClickable()"
		sequence lua "getHighlightSequence()"
		bam "CIRCBUTT"
		tooltip "HIGHLIGHT_MODE_TOOLTIP"
		action
		"
			worldScreen:SetHighlightEnabled(not worldScreen:HighlightEnabled())
		"
		actionAlt
		"
			worldScreen:GenerateLocationMessage(-1,-1)
		"
		
	}
	button
	{
		enabled "0"
		area		919 4 101 76
		bam			FOOTBALL
		action
		"
			actionbarResetState()
			showContextMenu(const.ACTIONBAR_STATE_PST_TABLET_FOOTBALL)
		"
	}
	label
	{
		--area is preset
		enabled "gameOptions.m_bRenderFrameTimes"
		frameTimes
	}
}
`
	function getRunHighlightFrame()
		if(game:GetAlwaysRun()) then
			return 2
		else
			return 0 --none
		end
	end
	function getCombatLogHighlightFrame()
		if(Infinity_IsMenuOnStack('WORLD_COMBATLOG')) then
			return 2
		else
			return 0 --none
		end
	end
	function getToggleAIHighlightFrame()
		if(game:GetPartyAI()) then
			return 2
		else
			return 0 --none
		end
	end
	function getLockScrollHighlightFrame()
		if(worldScreen:GetScrollLocked()) then
			return 2
		else
			return 0 --none
		end
	end
	function getSelectionModeHighlightFrame()
		if(worldScreen:SelectionModeEnabled()) then
			return 2
		else
			return 0 --none
		end
	end
`
menu
{
	name "WORLD_SIDEBAR_RIGHT_BUTTON"
	enabled "fullActionbarClickable()"
	align right bottom
	size 64 768
	ignoreEsc
	ignoreFocus 1
	button
	{
		area 0 652 64 64
		bam "SIDEHNDL"
		sequence 1
		toggle rightSidebarToggle
		action
		"
			if(rightSidebarToggle == 1) then
				hideSidebar('WORLD_SIDEBAR_RIGHT')
			else
				showSidebar('WORLD_SIDEBAR_RIGHT')
			end
		"
	}
}
menu
{
	name "WORLD_SIDEBAR_RIGHT"
	enabled "fullActionbarClickable()"
	align right bottom
	ignoreEsc
	ignoreFocus 1
	offset 0 0
	onOpen
	"
		Infinity_PushMenu('WORLD_SIDEBAR_RIGHT_BUTTON')
		
		if(rightSidebarToggle == 1) then
			hideSidebar('WORLD_SIDEBAR_RIGHT')
		else
			showSidebar('WORLD_SIDEBAR_RIGHT')
		end
	"
	onClose
	"
		Infinity_PopMenu('WORLD_SIDEBAR_RIGHT_BUTTON')
	"
	label
	{
		area 0 0 64 514
		rectangle 5
	}
	button
	{
		area 6 8 52 52
		bam "TAB0"
		tooltip "QUICK_SAVE_TOOLTIP"
		action "worldScreen:OnQuickSaveButtonClick(false)"
		actionalt "worldScreen:OnQuickSaveButtonClick(true)"
	}
	button
	{
		area 6 64 52 52
		bam "TAB1"
		frame lua "getSelectionModeHighlightFrame()"
		tooltip "SELECTION_MODE_TOOLTIP"
		action "worldScreen:OnSelectionButtonClick()"
	}
	button
	{
		area 6 120 52 52
		bam "TAB3"
		frame lua "getRunHighlightFrame()"
		tooltip "ALWAYS_RUN_TOOLTIP"
		action "game:SetAlwaysRun(not game:GetAlwaysRun())"
	}
	button
	{
		area 6 176 52 52
		bam "TAB5"
		tooltip "COMBATLOG_TOOLTIP"
		frame lua "getCombatLogHighlightFrame()"
		--glow lua "Infinity_IsMenuOnStack('WORLD_COMBATLOG')"
		action
		"
			if Infinity_IsMenuOnStack('WORLD_COMBATLOG') then
				Infinity_PopMenu('WORLD_COMBATLOG')
			else
				Infinity_PushMenu('WORLD_COMBATLOG')
			end 
		"
	}	
	button
	{
		area 6 232 52 52
		bam "TAB6"
		tooltip "TOGGLE_AI_TOOLTIP"
		frame lua "getToggleAIHighlightFrame()"
		--glow lua "game:GetPartyAI()"
		action 
		"
			game:ToggleAI()
		"
	}
	button
	{
		area 6 288 52 52
		bam "TAB8"
		tooltip "LOCK_SCROLL_TOOLTIP"
		frame lua "getLockScrollHighlightFrame()"
		action
		"
			worldScreen:LockScrollSelected()
		"
	}
	button
	{
		area 6 344 52 52
		bam "TAB7"
		tooltip "MESSAGE_LOG_TOOLTIP"
		action
		"
			dialogViewMode = 1
			worldScreen:StartDialogHistory()
		"
	}
}
`
function showSidebar(name)
	Infinity_SetOffset(name,0,0)
end
function hideSidebar(name)
	Infinity_SetOffset(name,0,510)
end
`
menu
{
	name "WORLD_SIDEBAR_LEFT_BUTTON"
	enabled "fullActionbarClickable()"
	align left bottom
	size 64 768
	ignoreEsc
	ignoreFocus 1
	button
	{
		area 0 652 64 64
		bam "SIDEHNDL"
		sequence 1
		toggle leftSidebarToggle
		action
		"
			if(leftSidebarToggle == 1) then
				hideSidebar('WORLD_SIDEBAR_LEFT')
			else
				showSidebar('WORLD_SIDEBAR_LEFT')
			end
		"
	}
}
menu 
{
	name "WORLD_SIDEBAR_LEFT"
	enabled "fullActionbarClickable()"
	align left bottom
	ignoreEsc
	ignoreFocus 1
	offset 0 0
	onOpen
	"
		Infinity_PushMenu('WORLD_SIDEBAR_LEFT_BUTTON')
		
		if(leftSidebarToggle == 1) then
			hideSidebar('WORLD_SIDEBAR_LEFT')
		else
			showSidebar('WORLD_SIDEBAR_LEFT')
		end
	"
	onClose
	"
		Infinity_PopMenu('WORLD_SIDEBAR_LEFT_BUTTON')
	"
	label
	{
		area 0 0 64 570
		rectangle 5
	}
	
	button
	{
		area 6 400 52 52
		bam "FOOT0"
		tooltip "OPTIONS_TOOLTIP"
		action "e:GetActiveEngine():OnLeftPanelButtonClick(7)"
	}
	button
	{
		area 6 344 52 52
		bam "FOOT1"
		tooltip "REST_TOOLTIP"
		action "e:GetActiveEngine():OnRestButtonClick()"
	}
	button
	{
		area 6 288 52 52
		bam "FOOT2"
		tooltip "PRIEST_TOOLTIP"
		action "e:GetActiveEngine():OnLeftPanelButtonClick(6)"
	}
	button
	{
		area 6 176 52 52
		bam "FOOT4"
		tooltip "CHARACTER_RECORD_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(4)
		"
	}
	button
	{
		area 6 232 52 52
		bam "FOOT3"
		tooltip "MAGE_SPELLS_TOOLTIP"
		action 
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(5)
		"
	}

	button
	{
		area 6 64 52 52
		bam "FOOT5"
		tooltip "JOURNAL_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
	button
	{
		area 6 8 52 52
		bam "FOOT6"
		tooltip "MAP_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(1)
		"
	}
	button
	{
		area 6 120 52 52
		bam "FOOT7"
		tooltip "INVENTORY_TOOLTIP"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(3)
		"
	}
}
`
	function resizeContextBar()
		local buttonCount = buttonArray:GetNumberOccupiedSlots()
		local width = 24 + (buttonCount * 56)
		Infinity_SetArea('worldContextBackground',nil,nil,width,nil)
	end
`
menu
{
	name "WORLD_CONTEXT_BAR"
	align center bottom
	popupSound 1
	ignoreEsc
	ignoreFocus 1
	onOpen
	"
		Infinity_PopMenu('WORLD_FORMATION')
		Infinity_SetOffset('WORLD_CONTEXT_BAR',0, -toolbarTop)
		resizeContextBar()
		closeGemMenus(true)
	"
	onClose
	"
		contextBarState = nil
		openGemMenus(true)
	"
	label
	{
		name "worldContextBackground"
		area 0 0 192 66
		rectangle 5
	}
	button
	{
		area 14 6 52 52
		actionBar 0
		enabled "buttonArray:GetButtonEnabled(0)"
		tooltip lua "actionBarTooltip[0]"
		action "buttonArray:OnLButtonPressed(0)"
		actionAlt "buttonArray:OnRButtonPressed(0)"
		bam QUICKSLT
		frame 0
	}
	button
	{
		area 70 6 52 52
		actionBar 1
		enabled "buttonArray:GetButtonEnabled(1)"
		tooltip lua "actionBarTooltip[1]"
		action "buttonArray:OnLButtonPressed(1)"
		actionAlt "buttonArray:OnRButtonPressed(1)"
		bam QUICKSLT
		frame 1
	}
	button
	{
		area 126 6 52 52
		actionBar 2
		enabled "buttonArray:GetButtonEnabled(2)"
		tooltip lua "actionBarTooltip[2]"
		action "buttonArray:OnLButtonPressed(2)"
		actionAlt "buttonArray:OnRButtonPressed(2)"
		bam QUICKSLT
		frame 2
	}
	button
	{
		area 182 6 52 52
		actionBar 3
		enabled "buttonArray:GetButtonEnabled(3)"
		tooltip lua "actionBarTooltip[3]"
		action "buttonArray:OnLButtonPressed(3)"
		actionAlt "buttonArray:OnRButtonPressed(3)"
		bam QUICKSLT
		frame 3
	}
	button
	{
		area 238 6 52 52
		actionBar 4
		enabled "buttonArray:GetButtonEnabled(4)"
		tooltip lua "actionBarTooltip[4]"
		action "buttonArray:OnLButtonPressed(4)"
		actionAlt "buttonArray:OnRButtonPressed(4)"
		bam QUICKSLT
		frame 4
	}
	button
	{
		area 294 6 52 52
		actionBar 5
		enabled "buttonArray:GetButtonEnabled(5)"
		tooltip lua "actionBarTooltip[5]"
		action "buttonArray:OnLButtonPressed(5)"
		actionAlt "buttonArray:OnRButtonPressed(5)"
		bam QUICKSLT
		frame 5
	}
	button
	{
		area 350 6 52 52
		actionBar 6
		enabled "buttonArray:GetButtonEnabled(6)"
		tooltip lua "actionBarTooltip[6]"
		action "buttonArray:OnLButtonPressed(6)"
		actionAlt "buttonArray:OnRButtonPressed(6)"
		bam QUICKSLT
		frame 6
	}
	button
	{
		area 406 6 52 52
		actionBar 7
		enabled "buttonArray:GetButtonEnabled(7)"
		tooltip lua "actionBarTooltip[7]"
		action "buttonArray:OnLButtonPressed(7)"
		actionAlt "buttonArray:OnRButtonPressed(7)"
		bam QUICKSLT
		frame 3
	}
	button
	{
		area 462 6 52 52
		actionBar 8
		enabled "buttonArray:GetButtonEnabled(8)"
		tooltip lua "actionBarTooltip[8]"
		action "buttonArray:OnLButtonPressed(8)"
		actionAlt "buttonArray:OnRButtonPressed(8)"
		bam QUICKSLT
		frame 1
	}
	button
	{
		area 518 6 52 52
		actionBar 9
		enabled "buttonArray:GetButtonEnabled(9)"
		tooltip lua "actionBarTooltip[9]"
		action "buttonArray:OnLButtonPressed(9)"
		actionAlt "buttonArray:OnRButtonPressed(9)"
		bam QUICKSLT
		frame 5
	}
	button
	{
		area 574 6 52 52
		actionBar 10
		enabled "buttonArray:GetButtonEnabled(10)"
		tooltip lua "actionBarTooltip[10]"
		action "buttonArray:OnLButtonPressed(10)"
		actionAlt "buttonArray:OnRButtonPressed(10)"
		bam QUICKSLT
		frame 2
	}
	button
	{
		area 630 6 52 52
		actionBar 11
		enabled "buttonArray:GetButtonEnabled(11)"
		tooltip lua "actionBarTooltip[11]"
		action "buttonArray:OnLButtonPressed(11)"
		actionAlt "buttonArray:OnRButtonPressed(11)"
		bam QUICKSLT
		frame 4
	}
}
menu
{
	name "WORLD_FORMATION"
	align center bottom
	popupSound 1
	ignoreEsc
	ignoreNav 1
	onOpen
	"
		Infinity_PopMenu('WORLD_CONTEXT_BAR')
		Infinity_SetOffset('WORLD_FORMATION',0, -toolbarTop)
		local formation = game:GetFormation()
		selectedFormation = Infinity_FindUIItemByName('FORMATION_BUTTON_' .. formation)
	"
	onClose
	"
		contextBarState = nil
	"
	label
	{
		area 0 0 752 66
		rectangle 5
	}
	label
	{
		area 14 6 52 52
		bam ivslot
		sequence 1
	}
	button
	{
		name "FORMATION_BUTTON_0"
		area 16 8 48 48
		bam "FORM0"
		highlightgroup "selectedFormation"
		action "game:SetFormation(0)"
		on "F1"
		tooltip "FORMATION_FOLLOW"
	}
	button
	{
		area 70 6 52 52
		bam ivslot
		sequence 1
	}
	button
	{
		name "FORMATION_BUTTON_1"
		area 72 8 48 48
		bam "FORM1"
		highlightgroup "selectedFormation"
		action "game:SetFormation(1)"
		on "F2"
		tooltip "FORMATION_T"		
	}
	button
	{
		area 126 6 52 52
		bam ivslot
		sequence 2
	}
	button
	{
		name "FORMATION_BUTTON_2"
		area 128 8 48 48
		bam "FORM2"
		highlightgroup "selectedFormation"
		action "game:SetFormation(2)"
		on "F3"
		tooltip "FORMATION_GATHER"
	}
	button
	{
		area 182 6 52 52
		bam ivslot
		sequence 3
	}
	button
	{
		name "FORMATION_BUTTON_3"
		area 184 8 48 48
		bam "FORM3"
		highlightgroup "selectedFormation"
		action "game:SetFormation(3)"
		on "F4"
		tooltip "FORMATION_4AND2"
	}
	button
	{
		area 238 6 52 52
		bam ivslot
		sequence 4
	}
	button
	{
		name "FORMATION_BUTTON_4"
		area 240 8 48 48
		bam "FORM4"
		highlightgroup "selectedFormation"
		action "game:SetFormation(4)"
		on "F5"
		tooltip "FORMATION_3BY2"
	}
	button
	{
		area 294 6 52 52
		bam ivslot
		sequence 5
	}
	button
	{
		name "FORMATION_BUTTON_5"
		area 296 8 48 48
		bam "FORM5"
		highlightgroup "selectedFormation"
		action "game:SetFormation(5)"
		on "F6"
		tooltip "FORMATION_PROTECT"
	}
	button
	{
		area 350 6 52 52
		bam ivslot
		sequence 6
	}
	button
	{
		name "FORMATION_BUTTON_6"
		area 352 8 48 48
		bam "FORM6"
		highlightgroup "selectedFormation"
		action "game:SetFormation(6)"
		on "F7"
		tooltip "FORMATION_2BY3"
	}
	button
	{
		area 406 6 52 52
		bam ivslot
		sequence 7
	}
	button
	{
		name "FORMATION_BUTTON_7"
		area 408 8 48 48
		bam "FORM7"
		highlightgroup "selectedFormation"
		action "game:SetFormation(7)"
		on "F8"
		tooltip "FORMATION_RANK"
	}
	button
	{
		area 462 6 52 52
		bam ivslot
		sequence 8
	}
	button
	{
		name "FORMATION_BUTTON_8"
		area 464 8 48 48
		bam "FORM8"
		highlightgroup "selectedFormation"
		action "game:SetFormation(8)"
		on "F9"
		tooltip "FORMATION_V"
	}
	button
	{
		area 518 6 52 52
		bam ivslot
		sequence 9
	}
	button
	{
		name "FORMATION_BUTTON_9"
		area 520 8 48 48
		bam "FORM9"
		highlightgroup "selectedFormation"
		action "game:SetFormation(9)"
		on "F10"
		tooltip "FORMATION_WEDGE"
	}
	button
	{
		area 574 6 52 52
		bam ivslot
		sequence 0
	}
	button
	{
		name "FORMATION_BUTTON_10"
		area 576 8 48 48
		bam "FORMA"
		highlightgroup "selectedFormation"
		action "game:SetFormation(10)"
		on "F11"
		tooltip "FORMATION_S"
	}
	button
	{
		area 630 6 52 52
		bam ivslot
		sequence 1
	}
	button
	{
		name "FORMATION_BUTTON_11"
		area 632 8 48 48
		bam "FORMB"
		highlightgroup "selectedFormation"
		action "game:SetFormation(11)"
		on "F12"
		tooltip "FORMATION_LINE"
	}
	
	button
	{
		area 686 6 52 52
		bam ivslot
		sequence 1
	}
	button
	{
		name "FORMATION_BUTTON_12"
		area 688 8 48 48
		bam "FORMC"
		highlightgroup "selectedFormation"
		action "game:SetFormation(12)"
		tooltip "FORMATION_NONE"
	}
}
`
function tabletString(pc,tab)
	if(e:IsTouchUI()) then
		return Infinity_FetchString(tab)
	else
		return Infinity_FetchString(pc)
	end
end
helpPages = 
{
	{"helpbg1", {106758, 106766, 106767, 106768, 106769}, ""},
	{"helpbg2", {106759, 106771, 106772, 106773, 106774, 106775}, ""},
	{"helpbg3", {106760, 106776, 106777, 106778, 106779, 106780, 106781}, ""},
	{"helpbg4", {106761, 106782, 106783, 106784, 106785}, ""}
}
helpPagesTablet = 
{
	--1: background, 2: strings, 3: generated text, 4: sidebar left, 5: sidebar right, 6: show sidebars, 7: show notification help
	{"helpbg1T", {106771, 106772, 106773, 106774, 106775}, ""},
	{"helpbg2T", {106793, 106759, 106770, 106792, 106785, 106794, 106807}, "", "HELPL2T", "HELPR2T"},
	{"", {106783, 106777,106784, 106778, 106782, 106776, 106761, 106760}, "", "HELPL3T", nil, true},
	{"", {106786, 106789, 106791, 106758, 106780, 106781, 106779}, "", nil, "HELPR4T", true},
	{"helpbg5T", {106767, 106768, 106769}, ""},
	{"helpbg6T", {106766, 106795, 106790}, "", nil, nil, nil, true},
}
helpPagesInventory=
{
	{"helpinv1", {106803}}
}
helpPagesRecord=
{
	{"helprec1", {106812}}
}
helpPagesSpells=
{
	{"helpspl1", {106814}}
}
helpPagesMap=
{
	{"", {106809, 106810}}
}
helpPagesMapTablet=
{
	{"", {106809, 106811}}
}
helpPageHeaders =
{
	[106787]=1,
	[106788]=1
}
function checkSidebarHelpState()
	if(helpPagesDisplay[currentHelpPage][6] == true) then
		showSidebar('WORLD_SIDEBAR_RIGHT')
		showSidebar('WORLD_SIDEBAR_LEFT')
		rightSidebarToggle = 0
		leftSidebarToggle = 0
	else
		hideSidebar('WORLD_SIDEBAR_RIGHT')
		hideSidebar('WORLD_SIDEBAR_LEFT')
		rightSidebarToggle = 1
		leftSidebarToggle = 1
	end
	if(helpPagesDisplay[currentHelpPage][7] == true) then
		helpNotificationMode = 1
	else
		helpNotificationMode = nil
	end

	if(currentHelpPage == 4 and isTouchActionbar()) then
		Infinity_SetOffset('WORLD_HELP_TABLET_RIGHT', 0, 50)
	else
		Infinity_SetOffset('WORLD_HELP_TABLET_RIGHT', 0, 0)
	end
end

function showHelpPages()
	return #helpPagesDisplay > 1
end
function getHelpPageDisplay()
	local str = tostring(currentHelpPage) .. ' / ' .. tostring(#helpPagesDisplay)
	if(showHelpPages()) then
		return str
	else
		return "^0xFFAAAAAA" .. str .. "^-" --greyout
	end
end
`
menu
{
	name "WORLD_HELP_DESCRIPTION"
	align center center
	ignoreEsc
	offset 0 -60
	onClose "helpNotificationMode = nil"
	label
	{
		area 0 0 422 496
		rectangle 5
	}
	label
	{
		area 87 10 232 35
		text style "title"
		text font "exocet"
		text shadow 1
		text "HOW_TO_PLAY_TITLE"
	}
	
	button
	{
		area 376 10 35 35
		bam xbutt
		action
		"
			Infinity_PopMenu('WORLD_HELP')
			Infinity_PopMenu('WORLD_HELP_TABLET')
			Infinity_PopMenu('INVENTORY_HELP')
			Infinity_PopMenu('CHARACTER_HELP')
			Infinity_PopMenu('SPELLS_HELP')
			Infinity_PopMenu('MAP_HELP')
		"
	}
	text
	{
		enabled "not helpNotificationMode"
		area 19 52 383 387
		text style "normal"
		text lua "helpPagesDisplay[currentHelpPage][3]"
		scrollbar	'CGSCRL1'
	}
	button
	{
		clickable lua "showHelpPages()"
		area 130 446 40 40
		bam arrobutt
		sequence 0
		action
		"
			if(currentHelpPage > 1) then currentHelpPage = currentHelpPage - 1
			else currentHelpPage = #helpPagesDisplay end
			checkSidebarHelpState()
		"
	}
	button
	{
		clickable lua "showHelpPages()"
		area 256 446 40 40
		bam arrobutt
		sequence 1
		action
		"
			if(currentHelpPage < #helpPagesDisplay) then currentHelpPage = currentHelpPage + 1
			else currentHelpPage = 1 end
			checkSidebarHelpState()
		"
	}
	
	label
	{
		area 180 446 67 40
		text lua "getHelpPageDisplay()"
		text style "normal"
		text align center center
		text useFontZoom 0
	}
	
	
	--Special case formatting for notification tutorial:
	text
	{
		enabled "helpNotificationMode"
		area 19 52 383 168
		text style "normal"
		text lua "helpPagesDisplay[currentHelpPage][3]"
		scrollbar	'CGSCRL1'
	}
	text 
	{
		enabled "helpNotificationMode"
		area 122 224 174 32
		text style "label"
		text 106826
	}
	text
	{
		enabled "helpNotificationMode"
		area 19 256 383 54
		text style "normal"
		text 106827
	}
	text
	{
		enabled "helpNotificationMode"
		area 103 314 299 74
		text style "normal"
		text align left center
		text 106830
	}
	text
	{
		enabled "helpNotificationMode"
		area 103 398 299 34
		text style "normal"
		text align left center
		text 106829
	}
	label
	{
		enabled "helpNotificationMode"
		area 37 398 50 34
		mosaic "legend3"
	}
	label
	{
		enabled "helpNotificationMode"
		area 37 354 50 34
		mosaic "legend2"
	}
	label
	{
		enabled "helpNotificationMode"
		area 37 314 50 34
		mosaic "legend1"
	}
}
`
	function generateHelpStrings(tab)
		--Just go through the strings and fetch them into one big string.
		for k1,v1 in pairs(tab) do
			local str = ""
			for k2,v2 in pairs(v1[2]) do
				if(helpPageHeaders[v2] ~= nil) then
					--header formatting
					str = str .. "\n^N" .. string.upper(Infinity_FetchString(v2)) .. "^-" .. "\n\n" 
				else
					str = str .. Infinity_FetchString(v2) .. "\n\n" 
				end
			end
			v1[3] = str
		end
	end
	function helpOpen(pages)
		worldScreenWasPaused = worldScreen:CheckIfPaused()
		if worldScreenWasPaused == false then
			worldScreen:TogglePauseGame(true)
		end
		
		currentHelpPage = 1
		Infinity_PushMenu('WORLD_HELP_DESCRIPTION')
		generateHelpStrings(pages)
		helpPagesDisplay = pages
	end
	function helpClose()
		if worldScreenWasPaused == false then
			worldScreen:TogglePauseGame(true)
		end
		worldScreenWasPaused = false
		Infinity_PopMenu('WORLD_HELP_DESCRIPTION')
	end
`
menu
{
	name "INVENTORY_HELP"
	align center center
	size 1024 768
	modal
	onOpen
	"
		helpOpen(helpPagesInventory)
	"
	onClose
	"
		helpClose()
	"
	label
	{
		area 0 0 1024 768
		mosaic lua "helpPagesInventory[currentHelpPage][1]"
	}
	label
	{
		area 58 116 124 70
		text style "normal"
		text useFontZoom 0
		align center top
		text lua "tabletString(106800,106801)"
	}
	label
	{
		area 734 320 120 16
		text style "normal"
		text useFontZoom 0
		text "ITEM_DROP_HELP"
	}
}
menu
{
	name "CHARACTER_HELP"
	align center center
	size 1024 768
	modal
	onOpen
	"
		helpOpen(helpPagesRecord)
	"
	onClose
	"
		helpClose()
	"
	label
	{
		area 0 0 1024 768
		mosaic lua "helpPagesRecord[currentHelpPage][1]"
	}
	label
	{
		area 404 12 288 46
		text style "normal"
		text useFontZoom 0
		align right center
		text "CHARACTER_STATS_HELP"
	}
}
menu
{
	name "SPELLS_HELP"
	align center center
	size 1024 768
	modal
	onOpen
	"
		helpOpen(helpPagesSpells)
	"
	onClose
	"
		helpClose()
	"
	label
	{
		area 0 0 1024 768
		mosaic lua "helpPagesSpells[currentHelpPage][1]"
	}
	label
	{
		area 48 80 244 42
		text style "normal"
		text useFontZoom 0
		align center center
		text lua "tabletString(106817,106818)"
	}
	label
	{
		area 756 182 226 26
		text style "normal"
		text useFontZoom 0
		align center center
		text "KNOWN_SPELLS_HELP"
	}
	label
	{
		area 0 268 206 30
		text style "normal"
		text useFontZoom 0
		align center center
		text "MEMORIZED_SPELLS_HELP"
	}
}
menu
{
	name "MAP_HELP"
	align center center
	size 1024 768
	modal
	onOpen
	"
		if(e:IsTouchUI()) then
			helpOpen(helpPagesMapTablet)
		else
			helpOpen(helpPagesMap)
		end
	"
	onClose
	"
		helpClose()
	"
	--doesn't have any notes on it.
	label{area 0 0 0 0}
}

menu
{
	name "WORLD_HELP"
	align center bottom
	size 1024 178
	modal
	onOpen
	"
		helpOpen(helpPages)
	"
	onClose
	"
		helpClose()
	"
	label
	{
		area 0 0 1024 178
		mosaic lua "helpPages[currentHelpPage][1]"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 0 -1 139 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "PAUSE_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 803 -5 143 32
		text style "normal"
		text useFontZoom 0
		text align left center
		text "PARTY_MEMBER_SLOTS_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 156 154 139 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "SELECT_ALL_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 153 98 139 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "FORMATIONS_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 160 132 139 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "CANCEL_ACTION_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 29 55 100 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "ATTACK_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 82 27 100 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "SPELLS_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 175 4 100 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "ITEMS_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 267 25 144 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "SPECIAL_ABILITIES_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 356 52 74 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "TALK_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area 456 154 139 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "HEALTHBAR_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 3"
		area 663 99 166 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "MESSAGE_LOG_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 3"
		area 665 127 166 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "LOCK_SCROLL_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 3"
		area 724 155 100 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "TOGGLE_AI_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area 763 74 118 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "INVENTORY_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area 805 49 100 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "MAP_TOOLTIP"
	}
	label
	{
		area 805 23 129 16
		enabled "currentHelpPage == 4"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "MAGE_SPELLS_TOOLTIP"
	}
	label
	{
		area 856 0 100 16
		enabled "currentHelpPage == 4"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "REST_TOOLTIP"
	}
	label
	{
		area 762 76 118 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "CHARACTER_RECORD_TOOLTIP"
	}
	label
	{
		area 801 49 100 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "JOURNAL_TOOLTIP"
	}
	label
	{
		area 802 24 129 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "PRIEST_TOOLTIP"
	}
	label
	{
		area 861 -2 100 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "OPTIONS_TOOLTIP"
	}
	label
	{
		area 872 95 82 16
		enabled "currentHelpPage == 1"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "COMBATLOG_TOOLTIP"
	}
	label
	{
		area 872 120 82 16
		enabled "currentHelpPage == 1"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "QUICKLOOT_TOOLTIP"
	}
	label
	{
		area 856 148 98 16
		enabled "currentHelpPage == 1"
		text style "normal"
		text useFontZoom 0
		text align right center
		text "HELP_TOOLTIP"
	}
	
}
menu
{
	name "WORLD_HELP_TABLET_LEFT"
	align left bottom
	ignoreEsc
	ignoreFocus 1
	offset 0 0
	label
	{
		enabled "helpPagesTablet[currentHelpPage][4] ~= nil"
		area 0 0 170 768
		mosaic lua "helpPagesTablet[currentHelpPage][4]"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 99 648 94 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "GAME_MENU_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 3"
		area 82 343 118 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "INVENTORY_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 3"
		area 93 220 100 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "MAP_TOOLTIP"
	}
	label
	{
		area 82 458 129 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align left center
		text "MAGE_SPELLS_TOOLTIP"
	}
	label
	{
		area 83 569 100 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align left center
		text "REST_TOOLTIP"
	}
	label
	{
		area 81 402 118 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align left center
		text "CHARACTER_RECORD_TOOLTIP"
	}
	label
	{
		area 82 286 100 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align left center
		text "JOURNAL_TOOLTIP"
	}
	label
	{
		area 83 515 129 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align left center
		text "PRIEST_TOOLTIP"
	}
	label
	{
		area 83 625 100 16
		enabled "currentHelpPage == 3"
		text style "normal"
		text useFontZoom 0
		text align left center
		text "OPTIONS_TOOLTIP"
	}
}
menu
{
	name "WORLD_HELP_TABLET_RIGHT"
	align right bottom
	ignoreEsc
	ignoreFocus 1
	offset 0 0
	size 170 768
	label
	{
		enabled "helpPagesTablet[currentHelpPage][5] ~= nil"
		area 0 0 170 768
		mosaic lua "helpPagesTablet[currentHelpPage][5]"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 28 644 94 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "TABLET_MENU_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -120 230 190 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "QUICK_SAVE_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -140 286 210 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "SELECTION_MODE_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -82 338 152 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "ALWAYS_RUN_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -104 400 174 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "COMBATLOG_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -100 458 170 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "TOGGLE_AI_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -100 516 170 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "LOCK_SCROLL_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 4"
		area -90 574 160 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "MESSAGE_LOG_TOOLTIP"
	}
}
menu
{
	name "WORLD_HELP_TABLET"
	align center bottom
	size 1024 178
	modal
	onOpen
	"
		helpOpen(helpPagesTablet)
		Infinity_PushMenu('WORLD_HELP_TABLET_LEFT')
		Infinity_PushMenu('WORLD_HELP_TABLET_RIGHT')
	"
	onClose
	"
		helpClose()
		Infinity_PopMenu('WORLD_HELP_TABLET_LEFT')
		Infinity_PopMenu('WORLD_HELP_TABLET_RIGHT')
	"
	label
	{
		area 0 0 1024 178
		mosaic lua "helpPagesTablet[currentHelpPage][1]"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 2 31 153 16
		text style "normal"
		text useFontZoom 0
		text align left center
		text "PAUSE_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 154 40 99 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "CURRENT_ACTION_HELP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 111 68 180 32
		text style "normal"
		text useFontZoom 0
		text align left center
		text "RETURN_TO_GAME_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 298 51 127 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "INVENTORY_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 0 52 100 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "ATTACK_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 56 25 100 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "SPELLS_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 146 3 100 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "ITEMS_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 239 25 144 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "SPECIAL_ABILITIES_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 1"
		area 305 49 74 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "TALK_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 2"
		area 443 66 139 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "HEALTHBAR_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 6"
		area 753 43 112 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "HOW_TO_PLAY_TITLE"
	}
	label
	{
		enabled "currentHelpPage == 6"
		area 860 21 162 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "HIGHLIGHT_MODE_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 6"
		area 675 65 100 16
		text style "normal"
		text useFontZoom 0
		text align right center
		text "QUICKLOOT_TOOLTIP"
	}
		label
	{
		enabled "currentHelpPage == 5"
		area 881 3 139 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "SELECT_ALL_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 5"
		area 799 34 139 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "CANCEL_ACTION_TOOLTIP"
	}
	label
	{
		enabled "currentHelpPage == 5"
		area 730 55 78 16
		text style "normal"
		text useFontZoom 0
		text align center center
		text "FORMATIONS_TOOLTIP"
	}
}
`
	function showBottomMessage(text, buttonText, buttonAction)
		bottomMessage = 
		{
			text = text,
			buttonText = buttonText,
			buttonAction = buttonAction
		}
		if(buttonText == nil) then
			bottomMessage.buttonText = t("DONE_BUTTON")
		end
		if(buttonAction == nil) then
			bottomMessage.buttonAction = dismissBottomMessage
		end
		Infinity_PopMenu('WORLD_ACTIONBAR_LEFT')
		Infinity_PopMenu('WORLD_ACTIONBAR_LEFT_TABLET')
		Infinity_PopMenu('WORLD_SIDEBAR_LEFT')
		Infinity_PopMenu('WORLD_SIDEBAR_RIGHT')
		Infinity_PopMenu('WORLD_FORMATION')
		Infinity_PopMenu('WORLD_CONTEXT_BAR')
		
		Infinity_PushMenu('WORLD_BOTTOM_MESSAGE')
		
	end
	function dismissBottomMessage()
		Infinity_PopMenu('WORLD_BOTTOM_MESSAGE')
		if(isTouchActionbar()) then
			Infinity_PushMenu('WORLD_SIDEBAR_LEFT')
			Infinity_PushMenu('WORLD_SIDEBAR_RIGHT')
			Infinity_PushMenu('WORLD_ACTIONBAR_LEFT_TABLET')
		else
			Infinity_PushMenu('WORLD_ACTIONBAR_LEFT')
		end	
	end

	worldScreenWasPaused = FALSE
	
`
menu 
{
	name "WORLD_BOTTOM_MESSAGE"
	align center bottom
	size 1024 85
	ignoreEsc
	popupSound 1
	size 1024 85
	onOpen
	"
		worldScreenWasPaused = worldScreen:CheckIfPaused()
		if worldScreenWasPaused == false then
			worldScreen:TogglePauseGame(true)
		end
		
	"
	onClose
	"
		if worldScreenWasPaused == false then
			worldScreen:TogglePauseGame(true)
		end
		
		worldScreenWasPaused = false
		
		if SkinsOptionsSliders[2][6] == 1 then
		pushSidebars()
		end
	"
	button
	{
		area 706 24 145 39
		bam SHRTBUTT
		text lua "bottomMessage.buttonText"
		text style "button"
		on return
		action
		"
			bottomMessage.buttonAction()
		"
	}
	
	label
	{
		area 133 5 569 76
		mosaic "REFCONF"
	}
	text
	{
		area 138 10 559 68
		text lua "bottomMessage.text"
		text style "normal_parchment"
		align center center
	}
		label
	{
		area 862 0 1371 85
		mosaic "mainwing"
	}
	label
	{
		area -1244 0 1371 85
		mosaic "mainwing"
	}
}
`
	loot = 
	{
		containerItems = {},
		groupItems = {},
		groundItems = {}
	}
	function getContainerItemProperty(index, property)
		local idxScrolled = index + worldScreen:GetTopContainerItem()
		if(loot.containerItems[idxScrolled] == nil or loot.containerItems[idxScrolled].item == nil) then
			return nil
		end
		return loot.containerItems[idxScrolled].item[property]
	end
	function showContainerItemDescription(index)
		local idxScrolled = index + worldScreen:GetTopContainerItem()
		if(loot.containerItems[idxScrolled] == nil or loot.containerItems[idxScrolled].item == nil) then
			return nil
		end
		showItemDescription(loot.containerItems[idxScrolled].item, 1)
	end
	function getGroupItemProperty(index, property)
		if(loot.groupItems[index] == nil or loot.groupItems[index].item == nil) then
			return nil
		end
		return loot.groupItems[index].item[property]
	end
	function showGroupItemDescription(index)
		if(loot.groupItems[index] == nil or loot.groupItems[index].item == nil) then
			return nil
		end
		showItemDescription(loot.groupItems[index].item, 1)
	end
`
menu
{
	name "WORLD_CONTAINER"
	align center bottom
	size 1024 83
	ignoreesc
	popupSound 1
	ignoreNav 1
	label
	{
		--can't use setbackground, need to consume events.
		area -171 0 1366 83
		mosaic CONBG
	}
	label
	{
		area 1051 0 845 83
		mosaic "conwingr"
	}
	label
	{
		area -876 0 854 83
		mosaic "conwingl"
	}
	button
	{
		area 101 8 36 36
		bam IVSLOT
		sequence 0
		tint lua	"getContainerItemProperty(0,'tint')"
		icon lua	"getContainerItemProperty(0,'icon')"
		count lua	"getContainerItemProperty(0,'count')"
		usages lua	"getContainerItemProperty(0,'usages')"
		tooltip lua "getContainerItemProperty(0,'name')"
		action		"worldScreen:OnContainerButtonClick(0)"
		actionAlt	"showContainerItemDescription(0)"
		highlight selected 1
	}
	button
	{
		area 139 8 36 36
		bam IVSLOT
		sequence 1
		tint lua	"getContainerItemProperty(1,'tint')"
		icon lua	"getContainerItemProperty(1,'icon')"
		count lua	"getContainerItemProperty(1,'count')"
		usages lua	"getContainerItemProperty(1,'usages')"
		tooltip lua "getContainerItemProperty(1,'name')"
		action		"worldScreen:OnContainerButtonClick(1)"
		actionAlt	"showContainerItemDescription(1)"
		highlight selected 1
	}
	button
	{
		area 176 8 36 36
		bam IVSLOT
		sequence 2
		tint lua	"getContainerItemProperty(2,'tint')"
		icon lua	"getContainerItemProperty(2,'icon')"
		count lua	"getContainerItemProperty(2,'count')"
		usages lua	"getContainerItemProperty(2,'usages')"
		tooltip lua "getContainerItemProperty(2,'name')"
		action		"worldScreen:OnContainerButtonClick(2)"
		actionAlt	"showContainerItemDescription(2)"
		highlight selected 1
	}
	button
	{
		area 214 8 36 36
		bam IVSLOT
		sequence 4
		tint lua	"getContainerItemProperty(3,'tint')"
		icon lua	"getContainerItemProperty(3,'icon')"
		count lua	"getContainerItemProperty(3,'count')"
		usages lua	"getContainerItemProperty(3,'usages')"
		tooltip lua "getContainerItemProperty(3,'name')"
		action		"worldScreen:OnContainerButtonClick(3)"
		actionAlt	"showContainerItemDescription(3)"
		highlight selected 1
	}
	button
	{
		area 252 8 36 36
		bam IVSLOT
		sequence 5
		tint lua	"getContainerItemProperty(4,'tint')"
		icon lua	"getContainerItemProperty(4,'icon')"
		count lua	"getContainerItemProperty(4,'count')"
		usages lua	"getContainerItemProperty(4,'usages')"
		tooltip lua "getContainerItemProperty(4,'name')"
		action		"worldScreen:OnContainerButtonClick(4)"
		actionAlt	"showContainerItemDescription(4)"
		highlight selected 1
	}
	button
	{
		area 101 46 36 36
		bam IVSLOT
		sequence 6
		tint lua	"getContainerItemProperty(5,'tint')"
		icon lua	"getContainerItemProperty(5,'icon')"
		count lua	"getContainerItemProperty(5,'count')"
		usages lua	"getContainerItemProperty(5,'usages')"
		tooltip lua "getContainerItemProperty(5,'name')"
		action		"worldScreen:OnContainerButtonClick(5)"
		actionAlt	"showContainerItemDescription(5)"
		highlight selected 1
	}
	button
	{
		area 139 46 36 36
		bam IVSLOT
		sequence 7
		tint lua	"getContainerItemProperty(6,'tint')"
		icon lua	"getContainerItemProperty(6,'icon')"
		count lua	"getContainerItemProperty(6,'count')"
		usages lua	"getContainerItemProperty(6,'usages')"
		tooltip lua "getContainerItemProperty(6,'name')"
		action		"worldScreen:OnContainerButtonClick(6)"
		actionAlt	"showContainerItemDescription(6)"
		highlight selected 1
	}
	button
	{
		area 176 46 36 36
		bam IVSLOT
		sequence 8
		tint lua	"getContainerItemProperty(7,'tint')"
		icon lua	"getContainerItemProperty(7,'icon')"
		count lua	"getContainerItemProperty(7,'count')"
		usages lua	"getContainerItemProperty(7,'usages')"
		tooltip lua "getContainerItemProperty(7,'name')"
		action		"worldScreen:OnContainerButtonClick(7)"
		actionAlt	"showContainerItemDescription(7)"
		highlight selected 1
	}
		button
	{
		area 214 46 36 36
		bam IVSLOT
		sequence 9
		tint lua	"getContainerItemProperty(8,'tint')"
		icon lua	"getContainerItemProperty(8,'icon')"
		count lua	"getContainerItemProperty(8,'count')"
		usages lua	"getContainerItemProperty(8,'usages')"
		tooltip lua "getContainerItemProperty(8,'name')"
		action		"worldScreen:OnContainerButtonClick(8)"
		actionAlt	"showContainerItemDescription(8)"
		highlight selected 1
	}
		button
	{
		area 252 46 36 36
		bam IVSLOT
		sequence 0
		tint lua	"getContainerItemProperty(9,'tint')"
		icon lua	"getContainerItemProperty(9,'icon')"
		count lua	"getContainerItemProperty(9,'count')"
		usages lua	"getContainerItemProperty(9,'usages')"
		tooltip lua "getContainerItemProperty(9,'name')"
		action		"worldScreen:OnContainerButtonClick(9)"
		actionAlt	"showContainerItemDescription(9)"
		highlight selected 1
	}
	button
	{
		area 290 14 26 27
		enabled "worldScreen:ContainerScrollEnabled(-1)"
		bam arrobutt
		sequence 2
		action
		"
			worldScreen:OnContainerScroll(-1)
		"
	}
	button
	{
		area 290 52 26 27
		enabled "worldScreen:ContainerScrollEnabled(1)"
		bam arrobutt
		sequence 3
		action
		"
			worldScreen:OnContainerScroll(1)
		"
	}
	label
	{
		area 370 28 34 37
		bam "contback"
	}
	label
	{
		area 358 16 53 13
		text lua "game:GetSelectedCarried() .. 'LB'"
		text style "normal"
		text useFontZoom 0
		text point 12
		text color lua "getEncumbranceColor()"
		align left center
	}
	label
	{
		area 364 62 53 14
		text lua "game:GetSelectedMaxEncumbrance() .. 'LB'"
		text style "normal"
		text useFontZoom 0
		text point 12
		text color lua "getEncumbranceColor()"
		align right center
	}
	--here comes a bunch of slots!
	button
	{
		area 421 8 36 36
		bam IVSLOT
		sequence 0
		tint lua	"getGroupItemProperty(0,'tint')"
		icon lua	"getGroupItemProperty(0,'icon')"
		count lua	"getGroupItemProperty(0,'count')"
		usages lua	"getGroupItemProperty(0,'usages')"
		tooltip lua	"getGroupItemProperty(0,'name')"
		action		"worldScreen:OnContainerButtonClick(10)"
		actionAlt	"showGroupItemDescription(0)"
		highlight selected 1
	}
	button
	{
		area 458 8 36 36
		bam IVSLOT
		sequence 2
		tint lua	"getGroupItemProperty(2,'tint')"
		icon lua	"getGroupItemProperty(2,'icon')"
		count lua	"getGroupItemProperty(2,'count')"
		usages lua	"getGroupItemProperty(2,'usages')"
		tooltip lua	"getGroupItemProperty(2,'name')"
		action		"worldScreen:OnContainerButtonClick(12)"
		actionAlt	"showGroupItemDescription(2)"
		highlight selected 1
	}
	button
	{
		area 496 8 36 36
		bam IVSLOT
		sequence 4
		tint lua	"getGroupItemProperty(4,'tint')"
		icon lua	"getGroupItemProperty(4,'icon')"
		count lua	"getGroupItemProperty(4,'count')"
		usages lua	"getGroupItemProperty(4,'usages')"
		tooltip lua	"getGroupItemProperty(4,'name')"
		action		"worldScreen:OnContainerButtonClick(14)"
		actionAlt	"showGroupItemDescription(4)"
		highlight selected 1
	}
	button
	{
		area 533 8 36 36
		bam IVSLOT
		sequence 6
		tint lua	"getGroupItemProperty(6,'tint')"
		icon lua	"getGroupItemProperty(6,'icon')"
		count lua	"getGroupItemProperty(6,'count')"
		usages lua	"getGroupItemProperty(6,'usages')"
		tooltip lua	"getGroupItemProperty(6,'name')"
		action		"worldScreen:OnContainerButtonClick(16)"
		actionAlt	"showGroupItemDescription(6)"
		highlight selected 1
	}
	button
	{
		area 570 8 36 36
		bam IVSLOT
		sequence 8
		tint lua	"getGroupItemProperty(8,'tint')"
		icon lua	"getGroupItemProperty(8,'icon')"
		count lua	"getGroupItemProperty(8,'count')"
		usages lua	"getGroupItemProperty(8,'usages')"
		tooltip lua	"getGroupItemProperty(8,'name')"
		action		"worldScreen:OnContainerButtonClick(18)"
		actionAlt	"showGroupItemDescription(8)"
		highlight selected 1
	}
	button
	{
		area 607 8 36 36
		bam IVSLOT
		sequence 0
		tint lua	"getGroupItemProperty(10,'tint')"
		icon lua	"getGroupItemProperty(10,'icon')"
		count lua	"getGroupItemProperty(10,'count')"
		usages lua	"getGroupItemProperty(10,'usages')"
		tooltip lua	"getGroupItemProperty(10,'name')"
		action		"worldScreen:OnContainerButtonClick(20)"
		actionAlt	"showGroupItemDescription(10)"
		highlight selected 1
	}
	button
	{
		area 644 8 36 36
		bam IVSLOT
		sequence 2
		tint lua	"getGroupItemProperty(12,'tint')"
		icon lua	"getGroupItemProperty(12,'icon')"
		count lua	"getGroupItemProperty(12,'count')"
		usages lua	"getGroupItemProperty(12,'usages')"
		tooltip lua	"getGroupItemProperty(12,'name')"
		action		"worldScreen:OnContainerButtonClick(22)"
		actionAlt	"showGroupItemDescription(12)"
		highlight selected 1
	}
	button
	{
		area 682 8 36 36
		bam IVSLOT
		sequence 4
		tint lua	"getGroupItemProperty(14,'tint')"
		icon lua	"getGroupItemProperty(14,'icon')"
		count lua	"getGroupItemProperty(14,'count')"
		usages lua	"getGroupItemProperty(14,'usages')"
		tooltip lua	"getGroupItemProperty(14,'name')"
		action		"worldScreen:OnContainerButtonClick(24)"
		actionAlt	"showGroupItemDescription(14)"
		highlight selected 1
	}
	button
	{
		area 720 8 36 36
		bam IVSLOT
		sequence 8
		tint lua	"getGroupItemProperty(16,'tint')"
		icon lua	"getGroupItemProperty(16,'icon')"
		count lua	"getGroupItemProperty(16,'count')"
		usages lua	"getGroupItemProperty(16,'usages')"
		tooltip lua	"getGroupItemProperty(16,'name')"
		action		"worldScreen:OnContainerButtonClick(26)"
		actionAlt	"showGroupItemDescription(16)"
		highlight selected 1
	}
	button
	{
		area 758 8 36 36
		bam IVSLOT
		sequence 0
		tint lua	"getGroupItemProperty(18,'tint')"
		icon lua	"getGroupItemProperty(18,'icon')"
		count lua	"getGroupItemProperty(18,'count')"
		usages lua	"getGroupItemProperty(18,'usages')"
		tooltip lua	"getGroupItemProperty(18,'name')"
		action		"worldScreen:OnContainerButtonClick(28)"
		actionAlt	"showGroupItemDescription(18)"
		highlight selected 1
	}
	button
	{
		area 421 46 36 36
		bam IVSLOT
		sequence 1
		tint lua	"getGroupItemProperty(1,'tint')"
		icon lua	"getGroupItemProperty(1,'icon')"
		count lua	"getGroupItemProperty(1,'count')"
		usages lua	"getGroupItemProperty(1,'usages')"
		tooltip lua	"getGroupItemProperty(1,'name')"
		action		"worldScreen:OnContainerButtonClick(11)"
		actionAlt	"showGroupItemDescription(1)"
		highlight selected 1
	}
	button
	{
		area 458 46 36 36
		bam IVSLOT
		sequence 3
		tint lua	"getGroupItemProperty(3,'tint')"
		icon lua	"getGroupItemProperty(3,'icon')"
		count lua	"getGroupItemProperty(3,'count')"
		usages lua	"getGroupItemProperty(3,'usages')"
		tooltip lua	"getGroupItemProperty(3,'name')"
		action		"worldScreen:OnContainerButtonClick(13)"
		actionAlt	"showGroupItemDescription(3)"
		highlight selected 1
	}
	button
	{
		area 496 46 36 36
		bam IVSLOT
		sequence 5
		tint lua	"getGroupItemProperty(5,'tint')"
		icon lua	"getGroupItemProperty(5,'icon')"
		count lua	"getGroupItemProperty(5,'count')"
		usages lua	"getGroupItemProperty(5,'usages')"
		tooltip lua	"getGroupItemProperty(5,'name')"
		action		"worldScreen:OnContainerButtonClick(15)"
		actionAlt	"showGroupItemDescription(5)"
		highlight selected 1
	}
	button
	{
		area 533 46 36 36
		bam IVSLOT
		sequence 7
		tint lua	"getGroupItemProperty(7,'tint')"
		icon lua	"getGroupItemProperty(7,'icon')"
		count lua	"getGroupItemProperty(7,'count')"
		usages lua	"getGroupItemProperty(7,'usages')"
		tooltip lua	"getGroupItemProperty(7,'name')"
		action		"worldScreen:OnContainerButtonClick(17)"
		actionAlt	"showGroupItemDescription(7)"
		highlight selected 1
	}
	button
	{
		area 570 46 36 36
		bam IVSLOT
		sequence 9
		tint lua	"getGroupItemProperty(9,'tint')"
		icon lua	"getGroupItemProperty(9,'icon')"
		count lua	"getGroupItemProperty(9,'count')"
		usages lua	"getGroupItemProperty(9,'usages')"
		tooltip lua	"getGroupItemProperty(9,'name')"
		action		"worldScreen:OnContainerButtonClick(19)"
		actionAlt	"showGroupItemDescription(9)"
		highlight selected 1
	}
	button
	{
		area 607 46 36 36
		bam IVSLOT
		sequence 3
		tint lua	"getGroupItemProperty(11,'tint')"
		icon lua	"getGroupItemProperty(11,'icon')"
		count lua	"getGroupItemProperty(11,'count')"
		usages lua	"getGroupItemProperty(11,'usages')"
		tooltip lua	"getGroupItemProperty(11,'name')"
		action		"worldScreen:OnContainerButtonClick(21)"
		actionAlt	"showGroupItemDescription(11)"
		highlight selected 1
	}
	button
	{
		area 644 46 36 36
		bam IVSLOT
		sequence 5
		tint lua	"getGroupItemProperty(13,'tint')"
		icon lua	"getGroupItemProperty(13,'icon')"
		count lua	"getGroupItemProperty(13,'count')"
		usages lua	"getGroupItemProperty(13,'usages')"
		tooltip lua	"getGroupItemProperty(13,'name')"
		action		"worldScreen:OnContainerButtonClick(23)"
		actionAlt	"showGroupItemDescription(13)"
		highlight selected 1
	}
	button
	{
		area 682 46 36 36
		bam IVSLOT
		sequence 7
		tint lua	"getGroupItemProperty(15,'tint')"
		icon lua	"getGroupItemProperty(15,'icon')"
		count lua	"getGroupItemProperty(15,'count')"
		usages lua	"getGroupItemProperty(15,'usages')"
		tooltip lua	"getGroupItemProperty(15,'name')"
		action		"worldScreen:OnContainerButtonClick(25)"
		actionAlt	"showGroupItemDescription(15)"
		highlight selected 1
	}
	button
	{
		area 720 46 36 36
		bam IVSLOT
		sequence 9
		tint lua	"getGroupItemProperty(17,'tint')"
		icon lua	"getGroupItemProperty(17,'icon')"
		count lua	"getGroupItemProperty(17,'count')"
		usages lua	"getGroupItemProperty(17,'usages')"
		tooltip lua	"getGroupItemProperty(17,'name')"
		action		"worldScreen:OnContainerButtonClick(27)"
		actionAlt	"showGroupItemDescription(17)"
		highlight selected 1
	}
	button
	{
		area 758 46 36 36
		bam IVSLOT
		sequence 3
		tint lua	"getGroupItemProperty(19,'tint')"
		icon lua	"getGroupItemProperty(19,'icon')"
		count lua	"getGroupItemProperty(19,'count')"
		usages lua	"getGroupItemProperty(19,'usages')"
		tooltip lua	"getGroupItemProperty(19,'name')"
		action		"worldScreen:OnContainerButtonClick(29)"
		actionAlt	"showGroupItemDescription(19)"
		highlight selected 1
	}
	label
	{
		area 812 50 34 12
		text lua "game:GetPartyGold()"
		text style "gold"
	}
	label
	{
		area 802 28 33 27
		mosaic icgold
	}
	label
	{
		area 69 20 22 54
		mosaic icpickup
	}
	button
	{
		area 872 14 138 56
		bam normbutt
		text "DONE_BUTTON"
		text style "button"
		action
		"
			worldScreen:StopContainer()
		"
	}
}
`
	function getSlotContainerId(index)
		local idxScrolled = index + worldScreen:GetTopGroundItem()
		if(loot.groundItems[idxScrolled] == nil) then
			return nil
		end
		return loot.groundItems[idxScrolled].containerId
	end
	function getGroundItemProperty(index, property)
		local idxScrolled = index + worldScreen:GetTopGroundItem()
		if(loot.groundItems[idxScrolled] == nil or loot.groundItems[idxScrolled].item == nil) then
			return nil
		end
		return loot.groundItems[idxScrolled].item[property]
	end
	
	function groundItemClick(slotId)
		local slot = loot.groundItems[slotId + worldScreen:GetTopGroundItem()]
			if(slot and slot.item) then
				worldScreen:OnGroundButtonClick(slot.slotId, slot.containerId, slot.item.res)
		end
	end
	
	function showGroundItemDescription(slotId)
		local slot = loot.groundItems[slotId + worldScreen:GetTopGroundItem()]
			if(slot and slot.item) then
				showItemDescription(slot.item, 1)
		end
	end
`

menu
{
	name 'WORLD_QUICKLOOT'
	align center bottom
	ignoreEsc
	onOpen
	"
		Infinity_SetOffset('WORLD_QUICKLOOT',0, -toolbarTop)
		if Infinity_IsMenuOnStack('WORLD_CONTEXT_BAR') then
			toggleContextBar()
		end
	"
	onClose
	"
		mouseOverQuicklootContainer = nil
	"
	label
	{
		area 0 0 690 66
		rectangle 5
	}
	button
	{
		area 11 5 52 52
		bam QLOOTARW
		sequence 0
		clickable lua "worldScreen:GroundScrollEnabled(-1)"
		action
		"
			worldScreen:OnGroundScroll(-1)
		"
	}
	button
	{
		area 627 5 52 52
		bam QLOOTARW
		sequence 1
		clickable lua "worldScreen:GroundScrollEnabled(1)"
		action
		"
			worldScreen:OnGroundScroll(1)
		"
	}
	button
	{
		area 67 5 52 52
		bam QUICKSLT
		sequence 1
		tint lua	"getGroundItemProperty(0,'tint')"
		icon lua	"getGroundItemProperty(0,'icon')"
		count lua	"getGroundItemProperty(0,'count')"
		usages lua	"getGroundItemProperty(0,'usages')"
		tooltip lua	"getGroundItemProperty(0,'name')"
		action "groundItemClick(0)"
		actionAlt	"showGroundItemDescription(0)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(0,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 123 5 52 52
		bam QUICKSLT
		sequence 2
		tint lua	"getGroundItemProperty(1,'tint')"
		icon lua	"getGroundItemProperty(1,'icon')"
		count lua	"getGroundItemProperty(1,'count')"
		usages lua	"getGroundItemProperty(1,'usages')"
		tooltip lua	"getGroundItemProperty(1,'name')"
		action "groundItemClick(1)"
		actionAlt	"showGroundItemDescription(1)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(1,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 179 5 52 52
		bam QUICKSLT
		sequence 3
		tint lua	"getGroundItemProperty(2,'tint')"
		icon lua	"getGroundItemProperty(2,'icon')"
		count lua	"getGroundItemProperty(2,'count')"
		usages lua	"getGroundItemProperty(2,'usages')"
		tooltip lua	"getGroundItemProperty(2,'name')"
		action "groundItemClick(2)"
		actionAlt	"showGroundItemDescription(2)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(2,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 235 5 52 52
		bam QUICKSLT
		sequence 4
		tint lua	"getGroundItemProperty(3,'tint')"
		icon lua	"getGroundItemProperty(3,'icon')"
		count lua	"getGroundItemProperty(3,'count')"
		usages lua	"getGroundItemProperty(3,'usages')"
		tooltip lua	"getGroundItemProperty(3,'name')"
		action "groundItemClick(3)"
		actionAlt	"showGroundItemDescription(3)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(3,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 291 5 52 52
		bam QUICKSLT
		sequence 5
		tint lua	"getGroundItemProperty(4,'tint')"
		icon lua	"getGroundItemProperty(4,'icon')"
		count lua	"getGroundItemProperty(4,'count')"
		usages lua	"getGroundItemProperty(4,'usages')"
		tooltip lua	"getGroundItemProperty(4,'name')"
		action "groundItemClick(4)"
		actionAlt	"showGroundItemDescription(4)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(4,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 347 5 52 52
		bam QUICKSLT
		sequence 6
		tint lua	"getGroundItemProperty(5,'tint')"
		icon lua	"getGroundItemProperty(5,'icon')"
		count lua	"getGroundItemProperty(5,'count')"
		usages lua	"getGroundItemProperty(5,'usages')"
		tooltip lua	"getGroundItemProperty(5,'name')"
		action "groundItemClick(5)"
		actionAlt	"showGroundItemDescription(5)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(5,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 403 5 52 52
		bam QUICKSLT
		sequence 2
		tint lua	"getGroundItemProperty(6,'tint')"
		icon lua	"getGroundItemProperty(6,'icon')"
		count lua	"getGroundItemProperty(6,'count')"
		usages lua	"getGroundItemProperty(6,'usages')"
		tooltip lua	"getGroundItemProperty(6,'name')"
		action "groundItemClick(6)"
		actionAlt	"showGroundItemDescription(6)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(6,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 459 5 52 52
		bam QUICKSLT
		sequence 4
		tint lua	"getGroundItemProperty(7,'tint')"
		icon lua	"getGroundItemProperty(7,'icon')"
		count lua	"getGroundItemProperty(7,'count')"
		usages lua	"getGroundItemProperty(7,'usages')"
		tooltip lua	"getGroundItemProperty(7,'name')"
		action "groundItemClick(7)"
		actionAlt	"showGroundItemDescription(7)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(7,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 515 5 52 52
		bam QUICKSLT
		sequence 1
		tint lua	"getGroundItemProperty(8,'tint')"
		icon lua	"getGroundItemProperty(8,'icon')"
		count lua	"getGroundItemProperty(8,'count')"
		usages lua	"getGroundItemProperty(8,'usages')"
		tooltip lua	"getGroundItemProperty(8,'name')"
		action "groundItemClick(8)"
		actionAlt	"showGroundItemDescription(8)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(8,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}
	button
	{
		area 571 5 52 52
		bam QUICKSLT
		sequence 5
		tint lua	"getGroundItemProperty(9,'tint')"
		icon lua	"getGroundItemProperty(9,'icon')"
		count lua	"getGroundItemProperty(9,'count')"
		usages lua	"getGroundItemProperty(9,'usages')"
		tooltip lua	"getGroundItemProperty(9,'name')"
		action "groundItemClick(9)"
		actionAlt	"showGroundItemDescription(9)"
		actionEnter "mouseOverQuicklootContainer = getSlotContainerId(9,'containerId')"
		actionExit "mouseOverQuicklootContainer = nil"
	}	
}
`
	combatLog = {}
	combatLogLines = 0
	maxCombatLogLines = 100
	triggerLogScroll = 0

	function addCombatLogLine(line)
		if combatLogLines == maxCombatLogLines then
			for index = 1, maxCombatLogLines - 1, 1 do
				combatLog[index] = combatLog[index + 1]
			end
			combatLogLines = combatLogLines - 1
		end
		combatLogLines = combatLogLines + 1
		combatLog[combatLogLines] = line
		triggerLogScroll = 1
	end

	function getCombatLogText(index)
		return combatLog[index]
	end

	function combatLogScroll(top, height, contentHeight)
		local scrollAmount = nil
		if triggerLogScroll == 1 and contentHeight > height then
			scrollAmount = math.min(contentHeight, height - contentHeight)
		end
		triggerLogScroll = 0
		return scrollAmount
	end

	function clearCombatLog()
		combatLog = {}
		triggerLogScroll = 1
		combatLogLines = 0
	end
	function restoreCombatLogPosition()
		local x = Infinity_GetINIValue("Game Options", "CombatX")
		local y = Infinity_GetINIValue("Game Options", "CombatY")
		local h = Infinity_GetINIValue("Game Options", "CombatH")
		local sw, sh = Infinity_GetScreenSize()
		x = clamp(x, -(sw - 588), 0)
		y = clamp(y, 0, sh - 94)
		h = clamp(h, 94, 500)

		Infinity_SetArea("WORLD_COMBATLOG", x, y, nil, h)
		Infinity_SetArea("worldCombatLog", nil, nil, nil, h - 18)
		Infinity_SetArea("combatLogResizeHandle", nil, h - 2, nil, nil)
		Infinity_SetArea("combatLogRect", nil, nil, nil, h)
	end
	function saveCombatLogPosition()
		local x, y, _, h = Infinity_GetArea("WORLD_COMBATLOG")
		Infinity_SetINIValue("Game Options", "CombatX", x)
		Infinity_SetINIValue("Game Options", "CombatY", y)
		Infinity_SetINIValue("Game Options", "CombatH", h)
	end


	function clamp(v, min, max)
		if (v < min) then
			v = min
		end
		if (v > max) then
			v = max
		end
		return v
	end

	function dragCombatLog(dx, dy)
		local x, y, w, h = Infinity_GetArea("WORLD_COMBATLOG")
		x = x + dx
		y = y + dy
		local sw, sh = Infinity_GetScreenSize()
		x = clamp(x, -(sw - w), 0)
		y = clamp(y, 0, sh - h)
		Infinity_SetOffset("WORLD_COMBATLOG", x, y)
	end

	function resizeCombatLog(dx, dy)
		local _, _, _, h = Infinity_GetArea("WORLD_COMBATLOG")
		
		if (h + dy < 94) then
			dy = 0
		end
		if (h + dy > 500) then
			dy = 0
		end

		adjustItemGroup({"combatLogResizeHandle"}, 0, dy, 0, 0)
		adjustItemGroup({"worldCombatLog", "combatLogRect", "WORLD_COMBATLOG"}, 0, 0, 0, dy)
	end
`
menu
{
	name 'WORLD_COMBATLOG'
	align right top
	ignoreEsc
	onopen 
	"
		triggerLogScroll = 1
		restoreCombatLogPosition()
	"
	onclose "saveCombatLogPosition()"

	label
	{
		name "combatLogRect"
		area 0 5 588 115
		rectangle 5
	}
	handle
	{
		area 269 0 50 16
		mosaic "MOVETAB"
		actionDrag "dragCombatLog(motionX, motionY)"
	}
	handle
	{
		name "combatLogResizeHandle"
		area 276 113 36 16
		mosaic "PULLTAB"
		actionDrag "resizeCombatLog(motionX, motionY)"
	}
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getCombatLogText(rowNumber)"
				text style "normal"
				text highlight 1
				indent 1
			}
		}
		name "worldCombatLog"
		area 8 15 574 97
		rowheight dynamic
		table "combatLog"
		scrollbar	'CGSCRL1'
		scrollbar func "combatLogScroll"
		scrollbar force 1
	}
}
`
	function getPickBackground(num)
		if (worldScreen:GetPickPartyPortrait(num) ~= "") then
			return "prtrttop"
		else
			return "topem"
		end
	end
	function getPickEmptySlotGlow(num)
		local selectedId = worldScreen:GetPickPartyRemoveCharacterId()
		local myId = worldScreen:GetPickPartyCharacterId(num)
		if(myId ~= -1 and selectedId ~= -1) then --invalid index check
			return selectedId == myId
		end
	end
`
menu
{
	name 'WORLD_PICKPARTY'
	align center bottom
	ignoreEsc
	size 1024 85
	popupSound 1
	ignoreNav 1
	onOpen "confirmRemove = nil; Infinity_SetBackground('BACKGROUND_PICKPARTY')"
	onClose "reformFromRecord = nil; confirmRemove = nil; Infinity_SetBackground(nil)"
	label
	{
		area 252 5 80 63
		mosaic lua "getPickBackground(0)"
	}
	button
	{
		area 254 7 76 59
		bam lua "worldScreen:GetPickPartyPortrait(0)"
		glow lua "getPickEmptySlotGlow(0)"
		greyscale lua "worldScreen:IsPickPartySpriteDead(0)"
		action
		"
			worldScreen:OnPickPartyPortraitButtonClick(0)
		"
	}
	label
	{
		area 334 5 80 63
		mosaic lua "getPickBackground(1)"
	}
	button
	{
		area 336 7 76 59
		bam lua "worldScreen:GetPickPartyPortrait(1)"
		glow lua "getPickEmptySlotGlow(1)"
		greyscale lua "worldScreen:IsPickPartySpriteDead(1)"
		action
		"
			worldScreen:OnPickPartyPortraitButtonClick(1)
		"
	}
	label
	{
		area 417 5 80 63
		mosaic lua "getPickBackground(2)"
	}
	button
	{
		area 419 7 76 59
		bam lua "worldScreen:GetPickPartyPortrait(2)"
		glow lua "getPickEmptySlotGlow(2)"
		greyscale lua "worldScreen:IsPickPartySpriteDead(2)"
		action
		"
			worldScreen:OnPickPartyPortraitButtonClick(2)
		"
	}
	label
	{
		area 501 5 80 63
		mosaic lua "getPickBackground(3)"
	}
	button
	{
		area 503 7 76 59
		bam lua "worldScreen:GetPickPartyPortrait(3)"
		glow lua "getPickEmptySlotGlow(3)"
		greyscale lua "worldScreen:IsPickPartySpriteDead(3)"
		action
		"
			worldScreen:OnPickPartyPortraitButtonClick(3)
		"
	}
	label
	{
		area 585 5 80 63
		mosaic lua "getPickBackground(4)"
	}
	button
	{
		area 587 7 76 59
		bam lua "worldScreen:GetPickPartyPortrait(4)"
		glow lua "getPickEmptySlotGlow(4)"
		greyscale lua "worldScreen:IsPickPartySpriteDead(4)"
		action
		"
			worldScreen:OnPickPartyPortraitButtonClick(4)
		"
	}
	label
	{
		area 669 5 80 63
		mosaic lua "getPickBackground(5)"
	}
	button
	{
		area 671 7 76 59
		bam lua "worldScreen:GetPickPartyPortrait(5)"
		glow lua "getPickEmptySlotGlow(5)"
		greyscale lua "worldScreen:IsPickPartySpriteDead(5)"
		action
		"
			worldScreen:OnPickPartyPortraitButtonClick(5)
		"
	}
	button
	{
		enabled "not confirmRemove"
		area 845 3 145 39
		bam SHRTBUTT
		text "REMOVE_BUTTON"
		text style "button"
		clickable lua "worldScreen:IsPickPartyRemoveButtonClickable()"
		action
		"
			confirmRemove = 1
		"
	}
	button
	{
		enabled "not confirmRemove"
		area 845 40 145 39
		bam SHRTBUTT
		text "DONE_BUTTON"
		text style "button"
		clickable lua "worldScreen:IsPickPartyDoneButtonClickable()"
		on escape
		action
		"
			worldScreen:OnPickPartyDoneButtonClick()
		"
	}
	text
	{
		enabled "not reformFromRecord" -- only display the help text when party overflows.
		area 215 72 586 10
		text "REFORM_HELP_NORMAL"
		text style "normal_parchment"
		align center center
		text useFontZoom 0
	}
	
	--confirm mode stuff
	button
	{
		enabled "confirmRemove"
		area 845 3 145 39
		bam SHRTBUTT
		text "YES_BUTTON"
		text style "button"
		action
		"
			worldScreen:RemoveCharacterFromParty()
			confirmRemove = nil
		"
	}
	button
	{
		enabled "confirmRemove"
		area 845 40 145 39
		bam SHRTBUTT
		text "NO_BUTTON"
		text style "button"
		on esc
		action
		"
			confirmRemove = nil
		"
	}
	
	label
	{
		enabled "confirmRemove"
		area 240 1 517 83
		mosaic "REFCONF"
	}
	text
	{
		enabled "confirmRemove"
		area 244 7 508 73
		text "CONFIRM_REMOVE_NORMAL"
		text style "normal_parchment"
		align center center
	}
	
}
`
currentSave = 0
function getSaveBackground(row)
	if(row == currentSave) then
		return "LOADROWC"
	else
		return "LOADROWB"
	end
end
`
menu
{
	name 'LOAD'
	align center center
	ignoreEsc
	popupSound 1
	onOpen
	"
		Infinity_SetBackground('BACKGROUND_SAVELOAD')
	"
	onClose
	"
		Infinity_SetBackground(nil)
	"
	button
	{
		area	0 0 1024 768
		ignoreFocus 1
		sound ""
		action 
		"
			currentSave = nil
		"
	}
	label
	{
		area 361 20 224 32
		text "LOAD_TITLE"
		text style "title"
		text font "exocet"
		text shadow 1
	}
	
	list
	{
		column 
		{ 
			width	100
			label
			{
				area 0 0 964 105
				mosaic lua "getSaveBackground(rowNumber)"
				respectClipping
			}
			label
			{
				area 826 49 44 44
				bam STALIGN
				frame lua "gameSaves.files[rowNumber].alignmentFrame"
			}
			label
			{
				area 887 49 44 44
				bam "STFCTION"
				frame lua "gameSaves.files[rowNumber].factionFrame"
			}
			button
			{
				enabled		"gameSaves.files[rowNumber].hasScreenShot"
				area		224 10 116 83
				bitmap res 	"gameSaves.files[rowNumber].screenshot" 
				align		center center
			}

			label
			{
				area	358 13 430 27
				text	lua "gameSaves.files[rowNumber].slotName"
				text style "label_parchment"
				text highlight 1
				align	left top
			}
			label
			{
				area 358 37 155 20
				text lua "gameSaves.files[rowNumber].time"
				text style "label_parchment"
				text highlight 1
				align left top
			}
			label
			{
				area 525 37 263 20
				text lua "gameSaves.files[rowNumber].areaName"
				text style "label_parchment"
				text highlight 1
				align left top
			}
			label
			{
				area 345 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait0"
				bitmap res "gameSaves.files[rowNumber].portrait0"
				align center center
			}
			label
			{
				area 373 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait1"
				bitmap res "gameSaves.files[rowNumber].portrait1"
				align center center
			}
			label
			{
				area 401 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait2"
				bitmap res "gameSaves.files[rowNumber].portrait2"
				align center center
			}
			label
			{
				area 429 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait3"
				bitmap res "gameSaves.files[rowNumber].portrait3"
				align center center
			}
			label
			{
				area 457 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait4"
				bitmap res "gameSaves.files[rowNumber].portrait4"
				align center center
			}
			label
			{
				area 485 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait5"
				bitmap res "gameSaves.files[rowNumber].portrait5"
				align center center
			}
		}

		actionDbl
		"
			Infinity_PlaySound('GAM_09')
			loadScreen:LoadGame(gameSaves.files[currentSave].fileName)
		"
		
		area -3 80 1024 598
		rowheight	dynamic
		hidehighlight
		table		"gameSaves.files"
		var		currentSave
		scrollbar	'cgscrl1'
		scrollbar speed 3
		on return
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255
	}
	
		button
	{
		area		42 684 170 54
		bam 		widebutt
		text		"BACK_BUTTON"
		text style	"button"
		on escape
		action
		"
			loadScreen:OnMainCancelButtonClick()
		"
	}
	button
	{
		area		421 684 170 54
		bam 		widebutt
		clickable	lua	"currentSave"		
		text		"DELETE_BUTTON"
		text style	"button"
		action
		"
			popup2Button(28639, 'DELETE_BUTTON',
			 function() loadScreen:DeleteGame(gameSaves.files[currentSave].slotIndex) end)
		"
	}
	button
	{
		area		800 684 170 54
		bam 		widebutt
		clickable	lua	"currentSave"
		text		"LOAD_BUTTON"
		text style	"button"
		action
		"
			Infinity_PlaySound('GAM_09')
			loadScreen:LoadGame(gameSaves.files[currentSave].fileName)
		"
	}

}
menu
{
	name 'SAVE'
	align center center
	ignoreEsc
	popupSound 1
	onOpen
	"
		Infinity_SetBackground('BACKGROUND_SAVELOAD')
	"
	onClose
	"
		Infinity_SetBackground(nil)
	"
	label
	{
		area	0 0 1024 768
		ignoreFocus 1
		sound ""
		action 
		"
			currentSave = nil
		"
	}
	label
	{
		area 365 20 218 32
		text "SAVE_TITLE"
		text style "title"
		text font "exocet"
		text shadow 1
	}

	list
	{
		column 
		{ 
			width	100
			label
			{
				area 0 0 964 105
				mosaic lua "getSaveBackground(rowNumber)"
				respectClipping
			}
			label
			{
				area 826 49 44 44
				bam STALIGN
				frame lua "gameSaves.files[rowNumber].alignmentFrame"
			}
			label
			{
				area 887 49 44 44
				bam "STFCTION"
				frame lua "gameSaves.files[rowNumber].factionFrame"
			}
			button
			{
				enabled		"gameSaves.files[rowNumber].hasScreenShot"
				area		224 10 116 83
				bitmap res 	"gameSaves.files[rowNumber].screenshot" 
				align		center center
			}

			label
			{
				area	358 13 430 27
				text	lua "gameSaves.files[rowNumber].slotName"
				text style "label_parchment"
				text highlight 1
				align	left top
			}
			label
			{
				area 358 37 155 20
				text lua "gameSaves.files[rowNumber].time"
				text style "label_parchment"
				text highlight 1
				align left top
			}
			label
			{
				area 525 37 263 20
				text lua "gameSaves.files[rowNumber].areaName"
				text style "label_parchment"
				text highlight 1
				align left top
			}
			label
			{
				area 345 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait0"
				bitmap res "gameSaves.files[rowNumber].portrait0"
				align center center
			}
			label
			{
				area 373 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait1"
				bitmap res "gameSaves.files[rowNumber].portrait1"
				align center center
			}
			label
			{
				area 401 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait2"
				bitmap res "gameSaves.files[rowNumber].portrait2"
				align center center
			}
			label
			{
				area 429 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait3"
				bitmap res "gameSaves.files[rowNumber].portrait3"
				align center center
			}
			label
			{
				area 457 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait4"
				bitmap res "gameSaves.files[rowNumber].portrait4"
				align center center
			}
			label
			{
				area 485 66 27 27
				enabled		 "gameSaves.files[rowNumber].hasPortrait5"
				bitmap res "gameSaves.files[rowNumber].portrait5"
				align center center
			}
		}

		actionDbl
		"
			Infinity_PlaySound('GAM_09')
			Infinity_PushMenu( 'SAVE_NEWSAVE' );
		"
		
		area -3 78 1024 600
		rowheight	dynamic
		hidehighlight
		table		"gameSaves.files"
		var		currentSave
		scrollbar	'cgscrl1'
		scrollbar speed 3
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}
	button
	{
		area		42 684 170 54
		bam 		widebutt
		text		"BACK_BUTTON"
		text style	"button"
		on escape
		action
		"
			saveScreen:OnMainCancelButtonClick()
		"
	}
	button
	{
		area		295 684 170 54
		bam 		widebutt
		text		"SAVE_BUTTON"
		text style	"button"
		clickable lua "currentSave ~= 0"
		action
		"
			--Infinity_PushMenu( 'SAVE_NEWSAVE' );
			popup2Button(106730, 'YES_BUTTON',
			 function() saveScreen:SaveGame(gameSaves.files[currentSave].slotIndex, gameSaves.files[currentSave].slotName) end, 'NO_BUTTON')
		"
	}

	button
	{
		area		548 684 170 54
		bam 		widebutt
		clickable	lua	"currentSave"		
		text		"DELETE_BUTTON"
		text style	"button"
		action
		"
			popup2Button(28639, 'DELETE_BUTTON',
			 function() saveScreen:DeleteGame(gameSaves.files[currentSave].slotIndex) end)
		"
	}
	button
	{
		area		801 684 170 54
		bam 		widebutt
		text		"NEW_SAVE_BUTTON"
		text style	"button"
		action
		"
			currentSave = 0
			Infinity_PushMenu( 'SAVE_NEWSAVE' );
		"
	}
}
`
	newSaveName = ''
	function newSave()
		Infinity_PopMenu('SAVE_NEWSAVE')
		saveScreen:SaveGame(#gameSaves.files, newSaveName)
	end
	function overwritingSave()
		return currentSave ~= 0
	end
	function getNewSaveAlignmentFrame()
		if(overwritingSave()) then
			return gameSaves.files[currentSave].alignmentFrame
		else
			return characters[currentID].alignmentFrame
		end
	end
	function getNewSaveFactionFrame()
		if(overwritingSave()) then
			return gameSaves.files[currentSave].factionFrame
		else
			return getFactionFrame()
		end
	end
	function getDeafultSaveName()
		return defaultSaveName
	end

	defaultSaveName = ""
`
menu
{
	name 'SAVE_NEWSAVE'
	align center center
	modal
	popupSound 1
	onOpen
	"
		newSaveName = ''
		if currentSave ~= 0 then
			newSaveName = gameSaves.files[currentSave].slotName
		end
		saveScreen:SetDefaultSaveName()
		Infinity_FocusTextEdit('newSaveNameArea')

	"
	label
	{
		area 0 0 916 396
		mosaic POPUP5
	}
	label
	{
		area	466 93 300 30
		text	"ENTER_SAVE_LABEL"
		text style "label"
		align left center
	}
	button --button to make the clickable area for the edit box bigger
	{
		area		466 136 304 52
		ignoreFocus 1
		action
		"
			Infinity_FocusTextEdit('newSaveNameArea')
		"
	}
	edit
	{
		name 		"newSaveNameArea"
		area		482 154 274 18
		var			newSaveName	
		placeholder lua "getDeafultSaveName()"
		text style	"edit"
		text point	16
		maxlines	1
		maxchars	31
		action
		"
			--if key_pressed is return
			if (key_pressed == 13 or key_pressed == 1073741912) then
				-- If currentSave is not 0, then we are overwriting a save
				if (currentSave == 0) then
					newSave()
				else
					Infinity_PopMenu('SAVE_NEWSAVE')
					saveScreen:SaveGame(gameSaves.files[currentSave].slotIndex, newSaveName)
				end
				return -1
			else
				return 1
			end
		"
	}
	label
	{
		area	474 194 292 24
		text	lua "gameSaves.currentGameInfo.time"
		text style "label_parchment"
	}
	button
	{
		enabled		 "gameSaves.files[currentSave] and gameSaves.files[currentSave].hasScreenShot"
		area	76 120 212 150
		bitmap res "gameSaves.files[currentSave].screenshot"
		align	center center
	}
	label
	{
		enabled "not gameSaves.files[currentSave]"
		area 123 125 124 144
		bam "POPUPIMG"
		sequence 4
	}
	label
	{
		area 474 218 292 24
		text lua "gameSaves.files[currentSave] and gameSaves.files[currentSave].areaName"
		text style "label_parchment"
	}
	label
	{
		area 474 218 292 24
		text lua "not gameSaves.files[currentSave] and Infinity_FetchString(mapScreen:GetMapName())"
		text style "label_parchment"
	}
	label
	{
		area 732 250 48 48
		bam STALIGN
		frame lua "getNewSaveAlignmentFrame()"
	}
	label
	{
		area 802 250 48 48
		bam "STFCTION"
		frame lua "getNewSaveFactionFrame()"
	}
	button
	{
		enabled "currentSave == 0"
		area		698 322 170 54
		bam		widebutt
		text	"SAVE_BUTTON"
		text style "button"
		on return
		action
		"
			if newSaveName == '' then
				newSaveName = getDeafultSaveName()
			end
			newSave()
		"
	}
	button
	{
		enabled	"currentSave"
		area		702 322 170 54
		bam		widebutt
		text	"OVERWRITE_BUTTON"
		text style "button"
		action
		"
			Infinity_PopMenu('SAVE_NEWSAVE')
			if newSaveName == '' then
				newSaveName = getDeafultSaveName()
			end
			saveScreen:SaveGame(gameSaves.files[currentSave].slotIndex,
			 newSaveName)
		"
	}
	button
	{
		area		486 322 170 54
		bam		widebutt
		text	"CANCEL_BUTTON"
		text style "button"
		action
		"
			Infinity_PopMenu('SAVE_NEWSAVE')			
		"
	}
}
`
	worldNPCDialogText = ""
	worldPlayerDialogChoices = {}				

	dialogTable = {}
	dialogOverflowTable = {}
	glowTest = nil
	hasDialogResponse = nil
	
	chatboxScrollToBottom = nil
	chatboxScrollTimeLast = 0
	chatboxContentHeight = 0
	chatboxOverflowed = nil
	chatboxJumpToBottom = nil
	
	-- The following two values determine how many item entries can exist.  We trim 
	-- the number of entries to numDialogTrimEntries once it has overflowed that value
	-- by numDialogOverflowLimit.
	numDialogTrimEntries = 512
	numDialogOverflowEntries = numDialogTrimEntries + 128
	
	lastTrimmedContentHeight = 0
	
	function getNumDialogTableEntries()
		local count = 0
		for _ in pairs(dialogTable) do count = count + 1 end
		return count
	end
	
	function trimDialogTableSize()
		local  numTableEntries = getNumDialogTableEntries()
		if (numTableEntries > numDialogOverflowEntries) then
			local numEntriesToRemove = numTableEntries - numDialogTrimEntries
			while (numEntriesToRemove > 0) do
				-- Get our table entry and calculate its size
				local tableEntry = dialogTable[1]
				local delta = Infinity_GetContentHeight(styles.normal.font, w, tableEntry.text, styles.normal.point, 1, styles.normal.useFontZoom) --1 for indent.
				chatboxContentHeight = chatboxContentHeight - delta
				lastTrimmedContentHeight = lastTrimmedContentHeight + delta
					
				table.remove(dialogTable, 1)
				numEntriesToRemove = numEntriesToRemove - 1
			end
		end
	end
	
	function buildResponsesList()
		dialogResponses = {}
		for k,v in pairs(dialogTable) do
			if v.marker then
				table.insert(dialogResponses, v)
			end
		end
	end
	function canShowDialogButton(num)
		-- Show the buttons if we have a response, and the dialog button is not enabled
		return dialogResponses and dialogResponses[num] ~= nil and showDialogButtonChoices()
	end
	
	function addDialogMessage(text,marker,makeTop)
		local tab = {}
		tab.text = text
		tab.marker = marker
		if(marker) then 
			dialogViewMode = nil
			if(text == "") then
				--empty markers are a signal, we shouldn't actually display them.
				if(makeTop == true) then
					--we'll ensure the next line is included in the visible content.
					chatboxContentHeight = 0
				end
				return
			else
				hasDialogResponse = 1
			end
		end
		
		--Calculate running total of dialog content height
		local x,y,w,h = Infinity_GetArea("worldPlayerDialogChoicesList")
		w = w - 18 --account for scrollbar influence on width
		local delta = Infinity_GetContentHeight(styles.normal.font, w, text, styles.normal.point, 1, styles.normal.useFontZoom) --1 for indent.
		chatboxContentHeight = chatboxContentHeight + delta
		
		if(marker and chatboxContentHeight > h) then
			--More to display than we have room for, put the responses in overflow and hide them behind button
			table.insert(dialogOverflowTable,tab)
		else
			table.insert(dialogTable,tab)
		end
		
		if(makeTop == true) then
			--we'll ensure the next line is included in the visible content.
			chatboxContentHeight = 0
		end
		
		trimDialogTableSize()
		
		triggerChatboxScroll()
		
		buildResponsesList()
	end
	function clearDialogResponses()
		for k,v in pairs(dialogTable) do
			if(v.marker) then
				table.remove(dialogTable,k)
				clearDialogResponses()
			end
		end
		hasDialogResponse = nil
		chatboxOverflowed = nil
		chatboxContentHeight = 0
		dialogOverflowTable = {}
	end	
		function getDialogEntryText(row)
		local text = dialogTable[row].text
		if (row == worldPlayerDialogSelection) then
			--Color the text white when selected
			text = string.gsub(text, "%^0xff212eff", "^0xFFFFFFFF")
		end
		return text
	end
	
		function getDialogEntryText2(row)
		local text = dialogTable[row].text
	--	local dlgrc = Infinity_GetINIValue('Graphics','Dlg Responses Color',0) and Infinity_GetINIValue('Dlg Color String', tostring(dialogTable[row].text),0)
		if (not getDialogRowClickable(row)) then
			--npc names
			text = string.gsub(text, "%^0xff75a1b8", "^0xFF81c6d9") 
		end
		if (not getDialogHistory) then
			--TNO name
			text = string.gsub(text, "%^0xffd5c885", "^0xFF4e5153")
		end
		if (not getDialogHistory) then
			--TNO txt
			text = string.gsub(text, "%^0xffd7c8a0", "^0xFF4e5153")
		end
		if (not getDialogResponses) then
			--1. 2.
			text = string.gsub(text, "%^0xffcec471", "^0xFF81c6d9")
		end
		if (not getDialogResponses) then
			--responses list
			text = string.gsub(text, "%^0xff212eff", "^0xFF1b20d8")
		end
		if (row == worldPlayerDialogSelection) then
			--Color the text when selected
			text = string.gsub(text, "%^0xFF1b20d8", "^0xffcecec7")
		end
	--	if((dlgrc) == 1) then
			-- text = string.gsub(text, "%^0xFF1b20d8", "^0xff5155d8")
			-- end
		return text
		end

	function setDlgResponsesColor(row)
		Infinity_SetINIValue('Graphics', 'Dlg Responses Color',1)
		Infinity_SetINIValue('Dlg Color String', tostring(dialogTable[row].text),1)
		return text	
		end
			
	function getDialogEntryText3(row)
		local text = dialogTable[row].text
		if (not getDialogRowClickable(row)) then
			text = string.gsub(text, "%^0xff75a1b8", "^0xFF7d94c2")
		end
		if (not getDialogRowClickable(row)) then
			--for dialogue lines
			text = string.gsub(text, "%^0xff7da58c", "^0xFFa1a5a6")
		end
		if (not getDialogHistory) then
			text = string.gsub(text, "%^0xffd5c885", "^0xFF4e5153")
		end
		if (not getDialogHistory) then
			text = string.gsub(text, "%^0xffd7c8a0", "^0xFF4e5153")
		end
		if (not getDialogResponses) then
			text = string.gsub(text, "%^0xffcec471", "^0xFF81c6d9")
		end
		if (not getDialogResponses) then
			text = string.gsub(text, "%^0xff212eff", "^0xFF81c6d9")
		end
		if (row == worldPlayerDialogSelection) then
			--Color the text when selected
			text = string.gsub(text, "%^0xFF81c6d9", "^0xff212eff")
		end
		return text
	end

	function dialogEntrySelectable(row)
		return (dialogTable[row].marker ~= nil)
	end
	function showDialogButtonChoices()
		return not (not hasDialogResponse or dialogViewMode or #dialogOverflowTable > 0)
	end
	function getDialogButtonEnabled()
		return not hasDialogResponse or dialogViewMode or #dialogOverflowTable > 0 or (gameOptions.m_bConfirmDialog == true)
	end
	function getResponsePickable()
		return not hasDialogResponse or dialogViewMode or (gameOptions.m_bConfirmDialog == true)
	end

	function getDialogButtonClickable()
		if(gameOptions.m_bConfirmDialog == true) then
			return not hasDialogResponse or #dialogOverflowTable > 0 or (worldPlayerDialogSelection and worldPlayerDialogSelection > 0) --no choices, or overflowed, or we've selected a choice.
		else
			return true
		end
	end
	function getDialogButtonText()
		if(dialogViewMode) then
			return t("DONE_BUTTON")
		end
		
		if(#dialogOverflowTable > 0) then
			return t("SHOW_MORE_RESPONSES_BUTTON")
		end
		
		if(gameOptions.m_bConfirmDialog == true) then
			return t("CHOOSE_RESPONSE_BUTTON")
		end
		
		return dialogButtonText
	end
	function triggerChatboxScroll()
		chatboxScrollToBottom = 1
		chatboxScrollTimeLast = Infinity_GetClockTicks()
	end
	function chatboxScroll(top, height, contentHeight)
		if(chatboxJumpToBottom and contentHeight > height) then
			chatboxJumpToBottom = nil
			return height-contentHeight
		end
		if(chatboxScrollToBottom == 0) then
			--defer to default scrolling
			return nil
		end
		if(contentHeight < height) then
			--no scrolling required, content fits
			chatboxScrollToBottom = nil
			return nil
		end
		local dT = Infinity_GetClockTicks() - chatboxScrollTimeLast
		chatboxScrollTimeLast = Infinity_GetClockTicks()
		top = top + lastTrimmedContentHeight
		lastTrimmedContentHeight = 0
		local newTop = (dT * -0.25) + top
		if (newTop + contentHeight > height + 200) then
			return (height - contentHeight + 200)
		end
		if(newTop + contentHeight < height) then
			chatboxScrollToBottom = 0
			return height - contentHeight
		end
		return newTop
	end
	
	function chatboxScroll2(top, height, contentHeight)
		if(chatboxJumpToBottom and contentHeight > height) then
			chatboxJumpToBottom = nil
			return height-contentHeight
		end
		if(chatboxScrollToBottom == 0) then
			--defer to default scrolling
			return nil
		end
		if(contentHeight < height) then
			--no scrolling required, content fits
			chatboxScrollToBottom = nil
			return nil
		end
		local dT = Infinity_GetClockTicks() - chatboxScrollTimeLast
		chatboxScrollTimeLast = Infinity_GetClockTicks()
		top = top + lastTrimmedContentHeight
		lastTrimmedContentHeight = 0
		local newTop = (dT * -100) + top
		if (newTop + contentHeight > height + 200) then
			return (height - contentHeight + 200)
		end
		if(newTop + contentHeight < height) then
			chatboxScrollToBottom = 0
			return height - contentHeight
		end
		return newTop
	end
	
	function displayOverflowResponses()
		for k,v in pairs(dialogOverflowTable) do
			table.insert(dialogTable,v)
		end
		dialogOverflowTable = {}
		triggerChatboxScroll()
		buildResponsesList()
	end
	function GetFirstMarkedResponse()
		for k,v in pairs(dialogTable) do
			if v.marker ~= nil then
				return k
			end
		end
		return -1	
	end
	function onDialogButtonClick()
		if(dialogViewMode) then
			--In dialog view mode this button closes the menu.
			worldScreen:StopDialogHistory()
			return
		end
		
		if(#dialogOverflowTable > 0) then
			displayOverflowResponses()
			return
		end

		if(gameOptions.m_bConfirmDialog == true and hasDialogResponse) then
			-- if confirm dialog and choices available.
			worldScreen:OnDialogReplyClick(dialogTable[worldPlayerDialogSelection].marker)
			worldPlayerDialogSelection = 0
			return
		else
			-- no choices, just step.
			worldScreen:StepDialog()
		end
	end
	function getDialogRowClickable(row)
		return dialogTable[row].marker ~= nil
	end
`
menu
{
	name 'WORLD_DIALOG_LEFT'
	align left bottom
	size 80 768
	ignoreEsc
	ignoreFocus 1
	label
	{
		area 0 0 72 496
		rectangle 5
	}
	button
	{
		area 16 18 40 42
		bam CBUTT
		text lua "'...'"
		text style "button"
		pad -1 -5 0 0
		enabled "not showDialogButtonChoices()"
		action
		"
			onDialogButtonClick()
		"
	}

	button
	{
		area 16 18 40 42
		bam CBUTT
		text lua "'1'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(1)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[1].marker)
		"
	}
	button
	{
		area 16 68 40 42
		bam CBUTT
		text lua "'2'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(2)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[2].marker)
		"
	}
	button
	{
		area 16 118 40 42
		bam CBUTT
		text lua "'3'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(3)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[3].marker)
		"
	}
	button
	{
		area 16 168 40 42
		bam CBUTT
		text lua "'4'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(4)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[4].marker)
		"
	}
	button
	{
		area 16 218 40 42
		bam CBUTT
		text lua "'5'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(5)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[5].marker)
		"
	}
	button
	{
		area 16 268 40 42
		bam CBUTT
		text lua "'6'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(6)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[6].marker)
		"
	}
	button
	{
		area 16 318 40 42
		bam CBUTT
		text lua "'7'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(7)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[7].marker)
		"
	}

	button
	{
		area 16 368 40 42
		bam CBUTT
		text lua "'8'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(8)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[8].marker)
		"
	}

	button
	{
		area 16 418 40 42
		bam CBUTT
		text lua "'9'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(9)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[9].marker)
		"
	}
}
menu
{
	name 'WORLD_DIALOG_RIGHT'
	align right bottom
	size 72 768
	ignoreEsc
	ignoreFocus 1
	enabled "canShowDialogButton(10)"
	label
	{
		area 0 0 72 496
		rectangle 5
	}
	button
	{
		area 16 18 40 42
		bam CBUTT
		text lua "'10'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(10)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[10].marker)
		"
	}
	button
	{
		area 16 68 40 42
		bam CBUTT
		text lua "'11'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(11)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[11].marker)
		"
	}
	button
	{
		area 16 118 40 42
		bam CBUTT
		text lua "'12'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(12)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[12].marker)
		"
	}
	button
	{
		area 16 168 40 42
		bam CBUTT
		text lua "'13'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(13)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[13].marker)
		"
	}
	button
	{
		area 16 218 40 42
		bam CBUTT
		text lua "'14'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(14)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[14].marker)
		"
	}
	button
	{
		area 16 268 40 42
		bam CBUTT
		text lua "'15'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(15)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[15].marker)
		"
	}
	button
	{
		area 16 318 40 42
		bam CBUTT
		text lua "'16'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(16)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[16].marker)
		"
	}

	button
	{
		area 16 368 40 42
		bam CBUTT
		text lua "'17'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(17)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[17].marker)
		"
	}

	button
	{
		area 16 418 40 42
		bam CBUTT
		text lua "'18'"
		text style "button"
		pad -1 -5 0 0
		enabled "canShowDialogButton(18)"
		action
		"
			worldScreen:OnDialogReplyClick(dialogResponses[18].marker)
		"
	}
}

--szef_world_dialog

menu 
{
	name 'WORLD_DIALOG'
	offset 0 0
	align center bottom
	ignoreEsc
	exclusiveFocus
	size 1024 297
	onOpen
	"	
		if SkinsOptionsSliders[1][6] == 0 then
		Infinity_PushMenu('BACKGROUND_DIALOG')
		elseif SkinsOptionsSliders[1][6] == 1 then
		Infinity_PushMenu('PORTRAITS_BACKGROUND_DIALOG')
		elseif SkinsOptionsSliders[1][6] == 2 then
		Infinity_PushMenu('SDB_BACKGROUND_DIALOG')
		else
		Infinity_PushMenu('TTON_BACKGROUND_DIALOG')
		end
		
		if(dialogViewMode) then
			--responses from last conversation might not have been cleared yet.
			clearDialogResponses()	
		end
		

		--start the dialog at the current bottom, new responses will scroll in.
		chatboxJumpToBottom = 1
		if(isTouchActionbar() and not dialogViewMode) then
			Infinity_PushMenu('WORLD_DIALOG_LEFT')
			Infinity_PushMenu('WORLD_DIALOG_RIGHT')
		end
		popSidebars()
	
	"
	onClose
	" 	
	
		popSidebars()
		Infinity_PopMenu('BACKGROUND_DIALOG')
		Infinity_PopMenu('PORTRAITS_BACKGROUND_DIALOG')
		Infinity_PopMenu('SDB_BACKGROUND_DIALOG')
		Infinity_PopMenu('TTON_BACKGROUND_DIALOG')
		Infinity_PopMenu('ALT_BOTTOM_BACKGROUND_DIALOG')
		Infinity_SetBackground(nil)
		
		Infinity_PopMenu('WORLD_DIALOG_LEFT')
		Infinity_PopMenu('WORLD_DIALOG_RIGHT')
		
		pushSidebars()
		dialogViewMode = 0
		
	" 
			text
			{
				area 0 0 -1 -1
				text "..."
				text style "normal"
			}
}

`
currentChargenAbility = -1
  chargen = {}
  chargen.ability = {
	{desc = 18489, roll = 9, activeSummary = -1, worst = 33954, couldbeworse = 00000, farbelowavg = 33955, belowavg = 33956, avg = 33079, aboveavg = 33440, wellaboveavg = 33441, exceptional = 33442, heroic = 33443, surpassmortal = 33947, legendary = 33946, bestevar = 33945},          --str
	{desc = 18487, roll = 9, activeSummary = -1, worst = 34250, couldbeworse = 34251, farbelowavg = 34252, belowavg =  3761, avg = 33456, aboveavg = 33457, wellaboveavg = 00000, exceptional = 33458, heroic = 33459, surpassmortal = 33938, legendary = 33937, bestevar = 33936},          --dex
	{desc = 18491, roll = 9, activeSummary = -1, worst = 34253, couldbeworse = 00000, farbelowavg = 34254, belowavg = 34261, avg = 33460, aboveavg = 33461, wellaboveavg = 00000, exceptional = 33462, heroic = 33463, surpassmortal = 33935, legendary = 33934, bestevar = 33933},          --con
	{desc = 18488, roll = 9, activeSummary = -1, worst = 34255, couldbeworse = 00000, farbelowavg = 34256, belowavg = 34257, avg = 33444, aboveavg = 33445, wellaboveavg = 00000, exceptional = 33446, heroic = 33447, surpassmortal = 33944, legendary = 33943, bestevar = 33942},          --int
	{desc = 18490, roll = 9, activeSummary = -1, worst = 34258, couldbeworse = 00000, farbelowavg = 34259, belowavg = 34260, avg = 33452, aboveavg = 33453, wellaboveavg = 00000, exceptional = 33454, heroic = 33455, surpassmortal = 33941, legendary = 33940, bestevar = 33939},          --wis
	{desc =  1903, roll = 9, activeSummary = -1, worst = 34262, couldbeworse = 00000, farbelowavg = 34263, belowavg = 33464, avg = 33465, aboveavg = 33466, wellaboveavg = 00000, exceptional = 33467, heroic = 33468, surpassmortal = 33932, legendary = 33931, bestevar = 33930}           --chr
}
helpSummary = -1
function chargenAcceptOrExport()
	if createCharScreen:GetEngineState() == 4 then
		return t("EXPORT_BUTTON")
	else
		return t("ACCEPT_BUTTON")

	end
end
function showAbilityHelpText(idx)
	helpString = chargen.ability[idx].desc
	helpSummary = chargen.ability[idx].activeSummary
end
function isChargenCancelButtonClickable()
	return chargen.levelingUp == nil or not chargen.levelingUp
end
function cancelChargen()
	createCharScreen:OnMainCancelButtonClick()
	createCharScreen:OnPrerollCancelButtonClick()
end

-----------------------
--Help Text Functions--
-----------------------

function getStrengthHelpText(roll)
	local statIndex = 1
	local statEffect1 = -1
	local statEffect2 = -1
	local statExtraValue = -1
	local text = ""
	if roll == "18/30" then
		statValue = 18
		statExtraValue = 30
	elseif roll == "18/60" then
		statValue = 18
		statExtraValue = 60
	elseif roll == "18/90" then
		statValue = 18
		statExtraValue = 90
	elseif roll == "18/99" then
		statValue = 18
		statExtraValue = 99
	elseif roll == "18/00" then
		statValue = 18
		statExtraValue = 100
	else
		statValue = tonumber(roll)
	end

	if statValue <= 3 then
		text = chargen.ability[statIndex].worst
		statEffect1 = 3
		statEffect2 = 1
	elseif statValue <= 5 then
		text = chargen.ability[statIndex].farbelowavg
		statEffect1 = 2
		statEffect2 = 1
	elseif statValue <= 7 then
		text = chargen.ability[statIndex].belowavg
		statEffect1 = 1
	elseif statValue <= 12 then
		text = chargen.ability[statIndex].avg
	elseif statValue <= 15 then
		text = chargen.ability[statIndex].aboveavg
	elseif statValue <= 16 then
		text = chargen.ability[statIndex].wellaboveavg
		statEffect1 = 1
	elseif statValue <= 17 then
		text = chargen.ability[statIndex].exceptional
		statEffect1 = 1
		statEffect2 = 1
	elseif statValue <= 18 then
		if statExtraValue == -1 then
			text = chargen.ability[statIndex].exceptional
			statEffect1 = 1
			statEffect2 = 2
		elseif statExtraValue <= 30 then --original was 50
			text = chargen.ability[statIndex].exceptional
			statEffect1 = 1
			statEffect2 = 3
		elseif statExtraValue <= 60 then --original was 75
			text = chargen.ability[statIndex].heroic
			statEffect1 = 2
			statEffect2 = 3
		elseif statExtraValue <= 90 then
			text = chargen.ability[statIndex].heroic
			statEffect1 = 2
			statEffect2 = 4
		elseif statExtraValue <= 99 then
			text = chargen.ability[statIndex].heroic
			statEffect1 = 2
			statEffect2 = 5
		elseif statExtraValue <= 100 then
			text = chargen.ability[statIndex].heroic
			statEffect1 = 3
			statEffect2 = 6
		end
	elseif statValue <= 19 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 3
		statEffect2 = 7
	elseif statValue <= 20 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 3
		statEffect2 = 8
	elseif statValue <= 21 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 4
		statEffect2 = 9
	elseif statValue <= 22 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 4
		statEffect2 = 10
	elseif statValue <= 23 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 5
		statEffect2 = 11
	elseif statValue <= 24 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 6
		statEffect2 = 12
	elseif statValue <= 25 then
		text = chargen.ability[statIndex].bestevar
		statEffect1 = 7
		statEffect2 = 14
	end
	if statEffect1 ~= -1 then
		game:SetToken("STAT_STRVAL1",statEffect1)
	end
	if statEffect2 ~= -1 then
		game:SetToken("STAT_STRVAL2",statEffect2)
	end
	return text
end

function getDexterityHelpText(roll)
	local statIndex = 2
	local statEffect1 = -1
	local statValue = tonumber(roll)
	local text = ""
	
	if statValue <= 3 then
		text = chargen.ability[statIndex].worst
		statEffect1 = 4
	elseif statValue <= 4 then
		text = chargen.ability[statIndex].couldbeworse
		statEffect1 = 3
	elseif statValue <= 5 then
		text = chargen.ability[statIndex].farbelowavg
		statEffect1 = 2
	elseif statValue <= 6 then
		text = chargen.ability[statIndex].farbelowavg
		statEffect1 = 1
	elseif statValue <= 8 then
		text = chargen.ability[statIndex].belowavg
	elseif statValue <= 12 then
		text = chargen.ability[statIndex].avg
	elseif statValue <= 14 then
		text = chargen.ability[statIndex].aboveavg
	elseif statValue <= 15 then
		text = chargen.ability[statIndex].exceptional
		statEffect1 = 1
	elseif statValue <= 16 then
		text = chargen.ability[statIndex].exceptional
		statEffect1 = 2
	elseif statValue <= 17 then
		text = chargen.ability[statIndex].heroic
		statEffect1 = 3
	elseif statValue <= 18 then
		text = chargen.ability[statIndex].heroic
		statEffect1 = 4
	elseif statValue <= 20 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 4
	elseif statValue <= 21 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 5
	elseif statValue <= 23 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 5
	elseif statValue <= 24 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 6
	elseif statValue <= 25 then
		text = chargen.ability[statIndex].bestevar
		statEffect1 = 6
	end
	if statEffect1 ~= -1 then
		game:SetToken("STAT_DEXVAL1",statEffect1)
	end
	return text
end
function getConstitutionHelpText(roll)
	local statIndex = 3
	local statEffect1 = -1
	local statValue = tonumber(roll)
	local text =  ""
	
	if statValue <= 3 then
		text = chargen.ability[statIndex].worst
		statEffect1 = 2
	elseif statValue <= 6 then
		text = chargen.ability[statIndex].farbelowavg
		statEffect1 = 1
	elseif statValue <= 8 then
		text = chargen.ability[statIndex].belowavg
	elseif statValue <= 12 then
		text = chargen.ability[statIndex].avg
	elseif statValue <= 14 then
		text = chargen.ability[statIndex].aboveavg
	elseif statValue <= 15 then
		text = chargen.ability[statIndex].exceptional
		statEffect1 = 1
	elseif statValue <= 16 then
		text = chargen.ability[statIndex].exceptional
		statEffect1 = 2
	elseif statValue <= 17 then
		text = chargen.ability[statIndex].heroic
		statEffect1 = 3
	elseif statValue <= 18 then
		text = chargen.ability[statIndex].heroic
		statEffect1 = 4
	elseif statValue <= 20 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 5
	elseif statValue <= 21 then
		text = chargen.ability[statIndex].surpassmortal
		statEffect1 = 6
	elseif statValue <= 23 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 6
	elseif statValue <= 24 then
		text = chargen.ability[statIndex].legendary
		statEffect1 = 7
	elseif statValue <= 25 then
		text = chargen.ability[statIndex].bestevar
		statEffect1 = 7
	end
	if statEffect1 ~= -1 then
		game:SetToken("STAT_CONVAL1",statEffect1)
	end
	return text
end
function getIntelligenceHelpText(roll)
	local statIndex = 4
	local statValue = tonumber(roll)
	local text = ""
	
	if statValue <= 3 then
		text = chargen.ability[statIndex].worst
	elseif statValue <= 6 then
		text = chargen.ability[statIndex].farbelowavg
	elseif statValue <= 8 then
		text = chargen.ability[statIndex].belowavg
	elseif statValue <= 12 then
		text = chargen.ability[statIndex].avg
	elseif statValue <= 14 then
		text = chargen.ability[statIndex].aboveavg
	elseif statValue <= 16 then
		text = chargen.ability[statIndex].exceptional
	elseif statValue <= 18 then
		text = chargen.ability[statIndex].heroic
	elseif statValue <= 21 then
		text = chargen.ability[statIndex].surpassmortal
	elseif statValue <= 24 then
		text = chargen.ability[statIndex].legendary
	elseif statValue <= 25 then
		text = chargen.ability[statIndex].bestevar
	end
	return text
end
function getWisdomHelpText(roll)
	local statIndex = 5
	local statValue = tonumber(roll)
	local text = ""
	
	if statValue <= 3 then
		text = chargen.ability[statIndex].worst
	elseif statValue <= 6 then
		text = chargen.ability[statIndex].farbelowavg
	elseif statValue <= 8 then
		text = chargen.ability[statIndex].belowavg
	elseif statValue <= 12 then
		text = chargen.ability[statIndex].avg
	elseif statValue <= 14 then
		text = chargen.ability[statIndex].aboveavg
	elseif statValue <= 16 then
		text = chargen.ability[statIndex].exceptional
	elseif statValue <= 18 then
		text = chargen.ability[statIndex].heroic
	elseif statValue <= 21 then
		text = chargen.ability[statIndex].surpassmortal
	elseif statValue <= 24 then
		text = chargen.ability[statIndex].legendary
	elseif statValue <= 25 then
		text = chargen.ability[statIndex].bestevar
	end
	return text
end
function getCharismaHelpText(roll)
	local statIndex = 6
	local statValue = tonumber(roll)
	local text = ""

	if statValue <= 3 then
		text = chargen.ability[statIndex].worst
	elseif statValue <= 5 then
		text = chargen.ability[statIndex].farbelowavg
	elseif statValue <= 8 then
		text = chargen.ability[statIndex].belowavg
	elseif statValue <= 12 then
		text = chargen.ability[statIndex].avg
	elseif statValue <= 14 then
		text = chargen.ability[statIndex].aboveavg
	elseif statValue <= 16 then
		text = chargen.ability[statIndex].exceptional
	elseif statValue <= 18 then
		text = chargen.ability[statIndex].heroic
	elseif statValue <= 21 then
		text = chargen.ability[statIndex].surpassmortal
	elseif statValue <= 24 then
		text = chargen.ability[statIndex].legendary
	elseif statValue <= 25 then
		text = chargen.ability[statIndex].bestevar
	end
	return text
end
function updateHelpText()
	local statIndex = -1
	local statValue = -1
	local statExtraValue = -1
	local statEffect1 = -1
	local statEffect2 = -1
	local currentlyShowing = -1
	for i = 1, 6 do
		if helpSummary == chargen.ability[i].activeSummary then
			currentlyShowing = i
		end
	end

	------------
	--STRENGTH--
	------------
	chargen.ability[1].activeSummary = getStrengthHelpText(chargen.ability[1].roll)

	-------------
	--DEXTERITY--
	-------------
	chargen.ability[2].activeSummary = getDexterityHelpText(chargen.ability[2].roll)
	
	----------------
	--CONSTITUTION--
	----------------
	chargen.ability[3].activeSummary = getConstitutionHelpText(chargen.ability[3].roll)

	----------------
	--INTELLIGENCE--
	----------------
	chargen.ability[4].activeSummary = getIntelligenceHelpText(chargen.ability[4].roll)

	----------
	--WISDOM--
	----------
	chargen.ability[5].activeSummary = getWisdomHelpText(chargen.ability[5].roll)

	------------
	--CHARISMA--
	------------
	chargen.ability[6].activeSummary = getCharismaHelpText(chargen.ability[6].roll)

	if currentlyShowing > 0 then
		helpSummary = chargen.ability[currentlyShowing].activeSummary
	else
		helpSummary = -1
	end
end
function resetChargenHelp()
	helpString = 18495
	helpSummary = -1
end
`
menu
{
	name 'CHARGEN'
	align center center
	ignoreesc
	size 1024 768
	popupSound 1
	onopen "
		if chargen.levelingUp == nil or not chargen.levelingUp then
			--Set the gender
			createCharScreen:OnGenderSelectButtonClick(1)
			
			--Set the class
			createCharScreen:SetCurrentStep(4)
			createCharScreen:OnClassSelectButtonClick(2)
			
			ticksPassed = 0
			resetChargenHelp()
			for i = 1,6 do
			  chargen.ability[i].roll = 9
			end
			chargen.extraAbilityPoints = 21
			chargen.AC = 20
			chargen.hitpoints = 20
			
			createCharScreen:SetCurrentStep(8)  --jump into abilities
		end
		helpSummary = nil
		updateHelpText()
		Infinity_SetBackground('BACKGROUND_CHARGEN')
	"
	label
	{
		area 86 28 329 44
		text "NEW_LIFE_TITLE"
		text style "title"
		text font "exocet"
		enabled "chargen.levelingUp == nil or not chargen.levelingUp"
		text shadow 1
		
	}
	label
	{
		area 86 28 329 44
		text "CHARACTER_POINTS_TITLE"
		text style "title"
		text font "exocet"
		enabled "not (chargen.levelingUp == nil or not chargen.levelingUp)"
		text shadow 1
		
	}
	text
	{
		area 605 122 69 35
		bam "cgattr"
		sequence 0
		ignoreFocus 1
		actionEnter "showAbilityHelpText(1)"
		action 		"showAbilityHelpText(1)"
		actionExit	"resetChargenHelp()"
	}
	text
	{
		area 789 201 53 80
		bam "cgattr"
		sequence 1
		ignoreFocus 1
		actionEnter "showAbilityHelpText(5)"
		action 		"showAbilityHelpText(5)"
		actionExit	"resetChargenHelp()"
	}
	text
	{
		area 790 411 53 70
		bam "cgattr"
		sequence 2
		ignoreFocus 1
		actionEnter "showAbilityHelpText(3)"
		action		"showAbilityHelpText(3)"
		actionExit	"resetChargenHelp()"
	}
	text
	{
		area 604 538 69 34
		bam "cgattr"
		sequence 3
		ignoreFocus 1
		actionEnter "showAbilityHelpText(6)"
		action		"showAbilityHelpText(6)"
		actionExit	"resetChargenHelp()"
	}
	text
	{
		area 430 408 57 74
		bam "cgattr"
		sequence 4
		ignoreFocus 1
		actionEnter "showAbilityHelpText(2)"
		action		"showAbilityHelpText(2)"
		actionExit	"resetChargenHelp()"
	}
	text
	{
		area 431 210 53 63
		bam "cgattr"
		sequence 5
		ignoreFocus 1
		actionEnter "showAbilityHelpText(4)"
		action		"showAbilityHelpText(4)"
		actionExit	"resetChargenHelp()"
	}
  text
	{
		area 50 639 213 35
		text 5025
		text style "label"
		ignoreFocus 1
		actionenter
		"
			helpString = 18493 
			helpSummary = 0
		" 
		action
		"
			helpString = 18493 
			helpSummary = 0
		" 
		actionExit	"resetChargenHelp()"
	} 
  text
	{
		area 51 690 213 36
		text 5026
		text style "label"
		ignoreFocus 1
		actionenter
		"
			helpString = 18494 
			helpSummary = 0
		" 
		action
		"
			helpString = 18494 
			helpSummary = 0
		" 
		actionExit	"resetChargenHelp()"
	} 
  text
	{
		area 50 587 213 38
		text 5027
		text style "label"
		ignoreFocus 1
		actionenter
		"
			helpString = 18492 
			helpSummary = 0
		" 
		action
		"
			helpString = 18492 
			helpSummary = 0
		" 
		actionExit	"resetChargenHelp()"
	} 
  label
	{
		area 53 143 222 367
		text lua 
		"
			Infinity_FetchString(helpString) .. '\n\n' .. Infinity_FetchString(helpSummary)
		"
		text style "normal"
	} 
  label
	{
		area 566 686 142 28
		text lua "chargen.name" 
		text style "label_parchment"
		text useFontZoom 0
		text align center center
	} 
	text
	{
		area 274 642 42 28
		text lua "chargen.AC" 
		text style "label"
		text useFontZoom 0
		text align center center
		ignoreFocus 1
		actionEnter
		"
			helpString = 18493
			helpSummary = 0
		" 
		action
		"
			helpString = 18493
			helpSummary = 0
		" 
		actionExit	"resetChargenHelp()"
	} 
	text
	{
		area		274 691 42 28
		text lua	"chargen.hitpoints"
		text style	"label"
		align center center
		ignoreFocus 1
		actionenter
		"
			helpString = 18494 
			helpSummary = 0
		" 
		action
		"
			helpString = 18494 
			helpSummary = 0
		" 
		actionExit	"resetChargenHelp()"
	}
	text
	{
		area 274 591 42 28
		text lua "chargen.extraAbilityPoints" 
		text style "label"
		text align center center
		ignoreFocus 1
		actionenter
		"
			helpString = 18492
			helpSummary = 0
		" 
		action
		"
			helpString = 18492
			helpSummary = 0
		" 
		actionExit	"resetChargenHelp()"
	} 
  text
  {
		area 606 46 60 36
		text style	"label"
		text lua "chargen.ability[1].roll"
		ignoreFocus 1
		actionEnter "showAbilityHelpText(1)"
		action		"showAbilityHelpText(1)"
		actionExit	"resetChargenHelp()"
  }
  text
  {
		area 371 186 61 36
		text style	"label"
		text lua "chargen.ability[4].roll"
		ignoreFocus 1
		actionEnter "showAbilityHelpText(4)"
		action		"showAbilityHelpText(4)"
		actionExit	"resetChargenHelp()"
  }
  text
  {
		area 839 185 61 36
		text style	"label"
		text lua "chargen.ability[5].roll"
		ignoreFocus 1
		actionEnter "showAbilityHelpText(5)"
		action		"showAbilityHelpText(5)"
		actionExit	"resetChargenHelp()"
  }
  text
  {
		area 369 457 59 36
		text style	"label"
		text lua "chargen.ability[2].roll"
		ignoreFocus 1
		actionEnter "showAbilityHelpText(2)"
		action		"showAbilityHelpText(2)"
		actionExit	"resetChargenHelp()"
  }
  text
  {
		area 839 458 61 36
		text style	"label"
		text lua "chargen.ability[3].roll"
		ignoreFocus 1
		actionEnter "showAbilityHelpText(3)"
		action		"showAbilityHelpText(3)"
		actionExit	"resetChargenHelp()"
  }
  text
  {
		area 606 607 59 35
		text style	"label"
		text lua "chargen.ability[6].roll"
		ignoreFocus 1
		actionEnter "showAbilityHelpText(6)"
		action		"showAbilityHelpText(6)"
		actionExit	"resetChargenHelp()"
  }
  --str
  button
  {
		area 680 44 52 42
    bam "cgplus"
	sequence 2
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(1, true)
		showAbilityHelpText(1)
    	updateHelpText()
    "
    actionHold 
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(1, true)
			ticksPassed = 0
		end
    	updateHelpText()
	"   
	actionEnter "showAbilityHelpText(1)"
	actionExit	"resetChargenHelp()"	
  }
  button
  {
		area 545 44 52 42
    bam "cgminus"
	sequence 2
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(1, false)
		showAbilityHelpText(1)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(1, false)
			ticksPassed = 0
		end
		updateHelpText()
	"   
	actionEnter "showAbilityHelpText(1)"  
	actionExit	"resetChargenHelp()"
  }
  --dex
  button
  {
		area 402 507 54 60
    bam "cgplus"
	sequence 1
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(2, true)
		showAbilityHelpText(2)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(2, true)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(2)" 
	actionExit	"resetChargenHelp()"
  }
  button
  {
		area 339 398 52 56
    bam "cgminus"
	sequence 1
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(2, false)
		showAbilityHelpText(2)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(2, false)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(2)" 
	actionExit	"resetChargenHelp()"
  }
  --con
  button
  {
		area 880 398 52 56
    bam "cgplus"
	sequence 0
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(3, true)
		showAbilityHelpText(3)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(3, true)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(3)" 
	actionExit	"resetChargenHelp()"
  }
  button
  {
		area 820 510 52 57
    bam "cgminus"
	sequence 0
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(3, false)
		showAbilityHelpText(3)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(3, false)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(3)" 
	actionExit	"resetChargenHelp()"
  }
  --int
  button
  {
		area 398 119 54 59
    bam "cgplus"
	sequence 0
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(4, true)
		showAbilityHelpText(4)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(4, true)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(4)" 
	actionExit	"resetChargenHelp()"
  }
  button
  {
		area 338 234 52 58
    bam "cgminus"
	sequence 0
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(4, false)
		showAbilityHelpText(4)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(4, false)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(4)" 
	actionExit	"resetChargenHelp()"
  }
  --wis
  button
  {
		area 882 233 52 58
	bam "cgplus"
	sequence 1
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(5, true)
		showAbilityHelpText(5)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(5, true)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(5)" 
	actionExit	"resetChargenHelp()"
  }
  button
  {
		area 817 123 54 58
    bam "cgminus"
	sequence 1
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(5, false)
		showAbilityHelpText(5)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(5, false)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(5)" 
	actionExit	"resetChargenHelp()"
  }
  --cha
  button
  {
		area 679 605 53 42
    bam "cgplus"
	sequence 2
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(6, true)
		showAbilityHelpText(6)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(6, true)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(6)" 
	actionExit	"resetChargenHelp()"
  }
  button
  {
		area 544 607 52 42
    bam "cgminus"
	sequence 2
    action 
    "
    	createCharScreen:OnAbilityPlusMinusButtonClick(6, false)
		showAbilityHelpText(6)
    	updateHelpText()
    "
    actionHold
    "
		ticksPassed = ticksPassed + 1
		if ticksPassed > 2 then
			createCharScreen:OnAbilityPlusMinusButtonClick(6, false)
			ticksPassed = 0
		end
		updateHelpText()
	"    
	actionEnter "showAbilityHelpText(6)" 
	actionExit	"resetChargenHelp()"
  }

	button
	{
		on escape
		area 862 666 100 44
		text 4196
		text style "button"
		text align center top
		pad 0 6 0 0
		bam "CGCANCEL"
		clickable lua "isChargenCancelButtonClickable()"
		action 
		"
			popup2Button(19406, 'YES_BUTTON', cancelChargen, 'NO_BUTTON')
		"
	}
	button
	{
		area 862 614 100 45
		text 4192 
		text style "button"
		text align center bottom
		pad 0 0 0 8
		bam "CGACCEPT"
		clickable lua "createCharScreen:IsDoneButtonClickable()"
		action 
		"
			if chargen.extraAbilityPoints == 0 then

				if chargen.levelingUp == nil or not chargen.levelingUp then
					createCharScreen:SetCurrentStep(18) -- done
					createCharScreen:AcceptCharacter(Infinity_GetOption(12, 8) + 1 + 1) -- +1 to start counting from 1, +1 for story mode
				else
					createCharScreen:SetCurrentStep(28) -- level up
				end
					createCharScreen:OnDoneButtonClick()
			else
				popupInfo(46782)
			end
		"
	}
	label
	{
		area 515 227 236 235
		mosaic lua "chargen.pstPortrait"
	}
}
`
difficulties = 
{
	{icon = "CONTSHLF", name = "DIFFICULTY_LABEL_STORYMODE", 		description = "DIFFICULTY_DESCRIPTION_STORYMODE"},
	{icon = "CONTSACK", name = "DIFFICULTY_LABEL_NORMAL", 			description = "DIFFICULTY_DESCRIPTION_NORMAL"},
	{icon = "CONTGRND", name = "DIFFICULTY_LABEL_CORERULES", 		description = "DIFFICULTY_DESCRIPTION_CORERULES"},
	{icon = "CONTBODY", name = "DIFFICULTY_LABEL_HARD", 			description = "DIFFICULTY_DESCRIPTION_HARD"},
	{icon = "CONTSKL1", name = "DIFFICULTY_LABEL_INSANE", 			description = "DIFFICULTY_DESCRIPTION_INSANE"},
	{icon = "CONTSKL2", name = "DIFFICULTY_LABEL_LEGACYOFBHAAL", 	description = "DIFFICULTY_DESCRIPTION_LEGACYOFBHAAL"},
}
fromSinglePlayer = false
fromMultiPlayer = false
function WhoYouGonnaCall()	
	fromSinglePlayer = createCharScreen:GetEngineState() == 1 and multiplayerScreen:GetEngineState() ~= 1
	fromMultiPlayer = multiplayerScreen:GetEngineState() == 1 and createCharScreen:GetEngineState() ~= 1
end
`
menu
{
	name 'CHARGEN_DIFFICULTY'
	modal
	align center center
	ignoreesc
	onopen 
	"
		currentDifficulty = 3
		WhoYouGonnaCall()
	"
	label
	{
		area 0 0 864 710
		mosaic 'GUIPOPF'
	}
	label
	{
		area 92 28 700 60
		text 13911
		text style "title"
	}
	list
	{
		column 
		{ 
			width 30
			label
			{
				area 0 0 -1 -1
				bam lua "difficulties[rowNumber].icon"
				align center center
			}
		}
		column 
		{ 
			width 70
			label
			{
				area 0 0 -1 -1
				text lua "t( difficulties[rowNumber].name )"
				text align left top
				text highlight 1
				text color	B
			}
			label
			{
				area 0 20 -1 -1
				text lua "t( difficulties[rowNumber].description )"
				text point	7
				text align left top
				text highlight 1
				text color	B
			}
		}
		area 42 106 782 484
		rowheight	80
		table		"difficulties"
		var			"currentDifficulty"
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action
		"
		"
	}
	button
	{
		on escape
		area 74 632 230 44
		bam GENBUT1
		text 15416
		text style "button"
		action 
		"
			Infinity_PopMenu()
		"
	}
	button
	{
		area 586 632 230 44
		bam GENBUT1
		text 10264
		text style "button"
		enabled "fromSinglePlayer"
		action 
		"
			Infinity_PopMenu()
			createCharScreen:AcceptCharacter(currentDifficulty)
		"
	}
	button
	{
		area 586 632 230 44
		bam GENBUT1
		text 11973
		text style "button"
		enabled "fromMultiPlayer"
		action 
		"
			Infinity_PopMenu()
			multiplayerScreen:OnMainDoneButtonClick(currentDifficulty)
		"
	}
}

`
TEXT_popup_big = 0
`
menu
{
	name 'POPUP_BIG'
	align center center
	modal
	popupSound 1
	label
	{
		area 0 0 864 710
		mosaic GUIPOPF
	}
	text
	{
		area 40 98 788 496
		text lua "Infinity_FetchString(TEXT_popup_big)"
		text style	"label"
		text align left top
		scrollbar 'CGSCRL1'
	}
	button
	{
		area 317 634 230 44
		bam GENBUT1
		text "DONE_BUTTON"
		text style	"button"
		action 
		"
			Infinity_PopMenu()
		"
	}
}


`
list_GUIMOVIE_0_0_idx = 0
function playSelectedMovie()
	moviesScreen:OnMovieItemSelect(list_GUIMOVIE_0_0[list_GUIMOVIE_0_0_idx].movieCode)
	moviesScreen:OnPlayButtonClick()
	list_GUIMOVIE_0_0_idx = nil
end
`

menu
{
	name 'MOVIES'
	align center center
	modal
	popupSound 1
	
	button
	{
		on escape
		action
		"
			moviesScreen:OnDoneButtonClick()
		"
	}
	label
	{
		area 0 0 766 593
		mosaic popup4
	}
	label
	{
		area 104 95 162 174
		bam "POPUPIMG"
		sequence 0
	}
	label
	{
		area 296 80 410 46
		text "MOVIES_TITLE"
		text style "title"
		text font "exocet"
		text shadow 1
	}
	list
	{
		column 
		{ 
			width 100
			label
			{
				area 0 0 -1 -1
				text lua "list_GUIMOVIE_0_0[rowNumber].description"
				text style	"list"
				align center center
				text highlight 1
			}
		}
		area 296 138 422 344
		rowheight	18
		table		"list_GUIMOVIE_0_0"
		var		"list_GUIMOVIE_0_0_idx"
		scrollbar	'CGSCRL1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

		action
		"
			playSelectedMovie()
		"
		actionAlt
		"
			playSelectedMovie()
		"
		
	}
	button
	{
		area 426 508 138 56
		bam normbutt
		text "CREDITS_MOVIE_BUTTON"
		text style "button"
		action 
		"
			chapterScreen:StartTextScreen( '25ecredNORM' )
			e:GetActiveEngine():SelectEngine(chapterScreen)
		"
	}
	button
	{
		area 588 508 138 56
		bam normbutt
		text "DONE_BUTTON"
		text style "button"
		action "moviesScreen:OnDoneButtonClick()"
	}

}
menu
{
	name 'BACKGROUND_START'
	align center center
	label
	{
		area 0 0 1366 768 
		mosaic 'STARTBG'
	}
}
menu
{
	name 'BACKGROUND_SPELLS'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'MGBG'
	}
}
menu
{
	name 'BACKGROUND_CHARGEN'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'CGBACK'
	}
}
menu
{
	name 'BACKGROUND_RECORD'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'RECBG'
	}
}

--szef_inventory_menus

menu 
{
	name 'INVENTORY_CLASSIC'
	align center center
	ignoreEsc
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	interactable lua "characters[id].HP.current > 0"
	
	onOpen
	" 
	pushSidebars()
	Infinity_SetBackground('BACKGROUND_INVENTORY')
	"
	onClose
	"
	popSidebars()
	Infinity_SetBackground(nil)
	"
	button
	{
		area 174 94 208 282
		paperdoll 1
		actiondrag "Infinity_SwapWithAppearance()"
	}
	label
	{
		area 403 536 47 50
		bam "contback"
	}
	label
	{
		area 400 514 53 20
		text lua "game:GetSelectedCarried() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align left center
	}
	label
	{
		area 400 590 53 21
		text lua "game:GetSelectedMaxEncumbrance() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align right center
	}
	
	label
	{
		area 158 504 187 30
		text lua "characters[id].name"
		text style "label"
	}
	label
	{
		area 890 453 48 24
		text lua "Infinity_GetCurrentGroundPage()+1 .. '/' .. Infinity_GetMaxGroundPage()+1"
		text style "label"
		align center center
	}
	label
	{
		area 880 102 78 23
		text lua "characters[id].gold"
		text style "gold"
	}
	label
	{
		area 158 553 187 32
		text lua "characters[id].class"
		text style "label"
	}

	text
	{
		area 3 464 60 33
		text "AC_LABEL"
		text style "label_parchment"
		text font "EXOCET"
		text point 26
		text shadow 1
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		area 19 496 31 20
		text lua "characters[id].AC.current"
		text style "label"
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	
	label
	{
		area 68 539 52 75
		mosaic "icHPMan"
	}
	text
	{
		area 63 548 62 27
		text lua "characters[id].HP.current"
		text style "label"
		tooltip "CURRENT_HP_TOOLTIP"
	}
	text
	{
		area 63 575 62 27
		text lua "characters[id].HP.max"
		text style "label"
		tooltip "MAX_HP_TOOLTIP"
	}
	text
	{
		area 446 451 362 32
		text lua "TEXT_inventoryError"
		scrollbar 'CGSCRL1'
		text style normal
		text align left center
	}


	slot {name "slot_inv_1"		area 507 355 43 43	bam "SLOTSWRD"	sequence 0	slotinfo "characters[id].equipment.weapon0"	highlight selected 1		}
	slot {name "slot_inv_2"		area 557 355 43 43	bam "SLOTSWRD"	sequence 1	slotinfo "characters[id].equipment.weapon1"	highlight selected 1		}
	slot {name "slot_inv_3"		area 608 355 43 43	bam "SLOTSWRD"	sequence 2	slotinfo "characters[id].equipment.weapon2"	highlight selected 1		}
	slot {name "slot_inv_4"		area 658 355 43 43	bam "SLOTSWRD"	sequence 3	slotinfo "characters[id].equipment.weapon3"	highlight selected 1		}
	
	slot {name "slot_inv_5"		area 529 112 43 43	bam "SLOTITM"	sequence 0	slotinfo "characters[id].equipment.personal0"	highlight selected 1	}
	slot {name "slot_inv_6"		area 579 112 43 43	bam "SLOTITM"	sequence 1	slotinfo "characters[id].equipment.personal1"	highlight selected 1	}
	slot {name "slot_inv_7"		area 630 112 43 43	bam "SLOTITM"	sequence 2	slotinfo "characters[id].equipment.personal2"	highlight selected 1	}
	slot {name "slot_inv_8"		area 681 112 43 43	bam "SLOTITM"	sequence 3	slotinfo "characters[id].equipment.personal3"	highlight selected 1	}
	slot {name "slot_inv_9"		area 731 112 43 43	bam "SLOTITM"	sequence 4	slotinfo "characters[id].equipment.personal4"	highlight selected 1	}
	
	slot {name "slot_inv_11"	area 416 142 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.chest0"			highlight selected 1}
	slot {name "slot_inv_12"	area 405 318 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.wrist0"			highlight selected 1}
	slot {name "slot_inv_13"	area 386 52 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.earringleft0"	highlight selected 1}
	slot {name "slot_inv_14"	area 121 52 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.earringright0"	highlight selected 1}
	
	slot {name "slot_inv_15"	area 518 233 43 43	bam "SLOTARRW"	sequence 0	slotinfo "characters[id].equipment.quiver0"			highlight selected 1}
	slot {name "slot_inv_16"	area 569 233 43 43	bam "SLOTARRW"	sequence 1	slotinfo "characters[id].equipment.quiver1"			highlight selected 1}
	slot {name "slot_inv_17"	area 620 233 43 43	bam "SLOTARRW"	sequence 2	slotinfo "characters[id].equipment.quiver2"			highlight selected 1}
	slot {name "slot_inv_18"	area 671 233 43 43	bam "SLOTARRW"	sequence 3	slotinfo "characters[id].equipment.quiver3"			highlight selected 1}
	slot {name "slot_inv_19"	area 721 233 43 43	bam "SLOTARRW"	sequence 4	slotinfo "characters[id].equipment.quiver4"			highlight selected 1}
	
	slot {name "slot_inv_21"	area 142 412 48 48	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.tattoo0"			highlight selected 1}
	slot {name "slot_inv_22"	area 426 231 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ring0"			highlight selected 1}
	slot {name "slot_inv_23"	area 77 231 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ring1"			highlight selected 1}
	slot {name "slot_inv_24"	area 84 142 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.tattoo1"			highlight selected 1}
	slot {name "slot_inv_25"	area 99 319 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.hand0"			highlight selected 1}
	slot {name "slot_inv_26"	area 360 411 48 48	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.tattoo2"			highlight selected 1}

	slot {name "slot_inv_30"	area 478 515 43 43	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.group0"			highlight selected 1}
	slot {name "slot_inv_31"	area 478 565 43 43	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.group1"			highlight selected 1}
	slot {name "slot_inv_32"	area 528 515 43 43	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.group2"			highlight selected 1}
	slot {name "slot_inv_33"	area 528 565 43 43	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.group3"			highlight selected 1}
	slot {name "slot_inv_34"	area 578 515 43 43	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.group4"			highlight selected 1}
	slot {name "slot_inv_35"	area 578 565 43 43	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.group5"			highlight selected 1}
	slot {name "slot_inv_36"	area 628 515 43 43	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.group6"			highlight selected 1}
	slot {name "slot_inv_37"	area 628 565 43 43	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.group7"			highlight selected 1}
	slot {name "slot_inv_38"	area 678 515 43 43	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.group8"			highlight selected 1}
	slot {name "slot_inv_39"	area 678 565 43 43	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.group9"			highlight selected 1}
	slot {name "slot_inv_40"	area 729 515 43 43	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.group10"			highlight selected 1}
	slot {name "slot_inv_41"	area 729 565 43 43	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.group11"			highlight selected 1}
	slot {name "slot_inv_42"	area 778 515 43 43	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.group12"			highlight selected 1}
	slot {name "slot_inv_43"	area 778 565 43 43	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.group13"			highlight selected 1}
	slot {name "slot_inv_44"	area 829 515 43 43	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.group14"			highlight selected 1}
	slot {name "slot_inv_45"	area 829 565 43 43	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.group15"			highlight selected 1}
	slot {name "slot_inv_46"	area 879 515 43 43	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.group16"			highlight selected 1}
	slot {name "slot_inv_47"	area 878 565 43 43	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.group17"			highlight selected 1}
	slot {name "slot_inv_48"	area 929 515 43 43	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.group18"			highlight selected 1}
	slot {name "slot_inv_49"	area 929 565 43 43	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.group19"			highlight selected 1}

	slot {name "slot_inv_68"	area 868 197 43 43	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.ground0"			highlight selected 1}
	slot {name "slot_inv_69"	area 868 248 43 43	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.ground1"			highlight selected 1}
	slot {name "slot_inv_70"	area 868 299 43 43	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.ground2"			highlight selected 1}
	slot {name "slot_inv_71"	area 868 350 43 43	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.ground3"			highlight selected 1}
	slot {name "slot_inv_72"	area 868 400 43 43	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.ground4"			highlight selected 1}
	slot {name "slot_inv_73"	area 918 197 43 43	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ground5"			highlight selected 1}
	slot {name "slot_inv_74"	area 918 248 43 43	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ground6"			highlight selected 1}
	slot {name "slot_inv_75"	area 918 299 43 43	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.ground7"			highlight selected 1}
	slot {name "slot_inv_76"	area 918 350 43 43	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.ground8"			highlight selected 1}
	slot {name "slot_inv_77"	area 918 400 43 43	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.ground9"			highlight selected 1}

	button
	{
		area 856 452 29 28
		bam "ARROBUTT"
		sequence 0
		action
		"
			Infinity_OnGroundPage(-1)
		"
	}
	button
	{
		area 946 452 29 28
		bam "ARROBUTT"
		sequence 1
		action
		"
			Infinity_OnGroundPage(1)
		"
	}
	label
	{
		area 860 21 115 96
		mosaic icgold
	}
	label
	{
		area 905 149 19 47
		mosaic icpickup
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
}
menu
{
	name 'INVENTORY_SHARED'
	align center center
	ignoreEsc
	size 1024 768

	onOpen
	"
	pushSidebars()
	Infinity_SetBackground('BACKGROUND_INVENTORY_SHARED')
	"
	onClose
	"
	popSidebars()
	Infinity_SetBackground(nil)
	"
	button
	{
		area 140 278 184 248
		paperdoll 1
		actiondrag "Infinity_SwapWithAppearance()"
	}
	label
	{
		area 1010 614 40 38
		bam "contback"
	}
	label
	{
		area 1010 594 40 20
		text lua "game:GetSelectedCarried() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align left center
	}
	label
	{
		area 1010 652 40 21
		text lua "game:GetSelectedMaxEncumbrance() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align right center
	}

	label
	{
		area 350 6 194 44
		text lua "characters[id].name"
		text style "label"
	}
	label
	{
		area 408 640 65 23
		text lua "characters[id].gold"
		text style "gold"
	}
	text
	{
		area 388 129 50 27
		text "AC_LABEL"
		text style "label_parchment"
		text font "EXOCET"
		text point 26
		text shadow 1
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		area 398 156 31 19
		text lua "characters[id].AC.current"
		text style "label"
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		area 450 202 50 35
		text lua "characters[id].HP.current"
		text style "label"
		tooltip "CURRENT_HP_TOOLTIP"
	}
	text
	{
		area 500 202 52 35
		text lua "characters[id].HP.max"
		text style "label"
		tooltip "MAX_HP_TOOLTIP"
	}
	text
	{
		area 80 634 308 39
		text lua "TEXT_inventoryError"
		scrollbar 'CGSCRL1'
		text style normal
		text align left center
	}

	text
	{
		area		364 83 168 14
		text lua "Infinity_FetchString(39596)"
		text style  'label'
		text color 'D'
	}
	label
	{
		area		364 102 168 14
		text lua "characters[id].Stats.bestenemy.current"
		text style  'label'
	}
	label
	{
		area 350 43 195 25
		text lua "characters[id].class"
		text style "label"
	}


	slot {name "slot_inv_1"		area 84 281 48 48	bam "SLOTSWRD"	sequence 0	slotinfo "characters[id].equipment.weapon0"	highlight selected 1		}
	slot {name "slot_inv_2"		area 84 348 48 48	bam "SLOTSWRD"	sequence 1	slotinfo "characters[id].equipment.weapon1"	highlight selected 1		}
	slot {name "slot_inv_3"		area 84 412 48 48	bam "SLOTSWRD"	sequence 2	slotinfo "characters[id].equipment.weapon2"	highlight selected 1		}
	slot {name "slot_inv_4"		area 84 476 48 48	bam "SLOTSWRD"	sequence 3	slotinfo "characters[id].equipment.weapon3"	highlight selected 1		}



	slot {name "slot_inv_11"	area 140 221 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.chest0"			highlight selected 1}
	slot {name "slot_inv_12"	area 333 348 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.wrist0"			highlight selected 1}
	slot {name "slot_inv_13"	area 276 221 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.earringleft0"		highlight selected 1}
	slot {name "slot_inv_14"	area 208 221 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.earringright0"		highlight selected 1}

	slot {name "slot_inv_15"	area 12 280 40 40	bam "SLOTARRW"	sequence 0	slotinfo "characters[id].equipment.quiver0"			highlight selected 1}
	slot {name "slot_inv_16"	area 12 332 40 40	bam "SLOTARRW"	sequence 1	slotinfo "characters[id].equipment.quiver1"			highlight selected 1}
	slot {name "slot_inv_17"	area 12 384 40 40	bam "SLOTARRW"	sequence 2	slotinfo "characters[id].equipment.quiver2"			highlight selected 1}
	slot {name "slot_inv_18"	area 12 436 40 40	bam "SLOTARRW"	sequence 3	slotinfo "characters[id].equipment.quiver3"			highlight selected 1}
	slot {name "slot_inv_19"	area 12 486 40 40	bam "SLOTARRW"	sequence 4	slotinfo "characters[id].equipment.quiver4"			highlight selected 1}

	slot {name "slot_inv_21"	area 140 536 48 48	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.tattoo0"			highlight selected 1}
	slot {name "slot_inv_22"	area 333 412 49 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ring0"			highlight selected 1}
	slot {name "slot_inv_23"	area 333 476 48 46	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ring1"			highlight selected 1}
	slot {name "slot_inv_24"	area 208 536 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.tattoo1"			highlight selected 1}
	slot {name "slot_inv_25"	area 333 276 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.hand0"			highlight selected 1}
	slot {name "slot_inv_26"	area 276 536 48 48	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.tattoo2"			highlight selected 1}

	slot {name "slot_inv_5"		area 412 276 40 40	bam "SLOTITM"	sequence 0	slotinfo "characters[id].equipment.personal0"	highlight selected 1	}
	slot {name "slot_inv_6"		area 412 330 40 40	bam "SLOTITM"	sequence 1	slotinfo "characters[id].equipment.personal1"	highlight selected 1	}
	slot {name "slot_inv_7"		area 412 382 40 40	bam "SLOTITM"	sequence 2	slotinfo "characters[id].equipment.personal2"	highlight selected 1	}
	slot {name "slot_inv_8"		area 412 432 40 40	bam "SLOTITM"	sequence 3	slotinfo "characters[id].equipment.personal3"	highlight selected 1	}
	slot {name "slot_inv_9"		area 412 482 40 40	bam "SLOTITM"	sequence 4	slotinfo "characters[id].equipment.personal4"	highlight selected 1	}


	slot {name "slot_inv_30"	area 606 43 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[1]].equipment.group0" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_31"	area 646 43 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[1]].equipment.group1" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_32"	area 686 43 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[1]].equipment.group2" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_33"	area 726 43 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[1]].equipment.group3" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_34"	area 766 43 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[1]].equipment.group4" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_35"	area 806 43 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[1]].equipment.group5" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_36"	area 846 43 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[1]].equipment.group6" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_37"	area 886 43 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[1]].equipment.group7" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_38"	area 926 43 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[1]].equipment.group8" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_39"	area 966 43 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[1]].equipment.group9" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_40"	area 606 83 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[1]].equipment.group10" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_41"	area 646 83 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[1]].equipment.group11" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_42"	area 686 83 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[1]].equipment.group12" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_43"	area 726 83 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[1]].equipment.group13" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_44"	area 766 83 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[1]].equipment.group14" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_45"	area 806 83 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[1]].equipment.group15" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_46"	area 846 83 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[1]].equipment.group16" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_47"	area 886 83 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[1]].equipment.group17" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_48"	area 926 83 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[1]].equipment.group18" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}
	slot {name "slot_inv_49"	area 966 83 40 40 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[1]].equipment.group19" enabled "Infinity_GetNumCharacters() > 0" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('1') end" 			highlight selected 1}

	slot {name "slot_inv_30"	area 606 135 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[2]].equipment.group0" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_31"	area 646 135 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[2]].equipment.group1" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_32"	area 686 135 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[2]].equipment.group2" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_33"	area 726 135 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[2]].equipment.group3" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_34"	area 766 135 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[2]].equipment.group4" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_35"	area 806 135 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[2]].equipment.group5" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_36"	area 846 135 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[2]].equipment.group6" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_37"	area 886 135 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[2]].equipment.group7" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_38"	area 926 135 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[2]].equipment.group8" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_39"	area 966 135 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[2]].equipment.group9" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_40"	area 606 175 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[2]].equipment.group10" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_41"	area 646 175 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[2]].equipment.group11" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_42"	area 686 175 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[2]].equipment.group12" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_43"	area 726 175 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[2]].equipment.group13" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_44"	area 766 175 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[2]].equipment.group14" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_45"	area 806 175 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[2]].equipment.group15" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_46"	area 846 175 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[2]].equipment.group16" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_47"	area 886 175 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[2]].equipment.group17" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_48"	area 926 175 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[2]].equipment.group18" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}
	slot {name "slot_inv_49"	area 966 175 40 40 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[2]].equipment.group19" enabled "Infinity_GetNumCharacters() > 1" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('2') end" 			highlight selected 1}

	slot {name "slot_inv_30"	area 606 232 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[3]].equipment.group0" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_31"	area 646 232 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[3]].equipment.group1" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_32"	area 686 232 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[3]].equipment.group2" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_33"	area 726 232 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[3]].equipment.group3" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_34"	area 766 232 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[3]].equipment.group4" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_35"	area 806 232 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[3]].equipment.group5" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_36"	area 846 232 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[3]].equipment.group6" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_37"	area 886 232 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[3]].equipment.group7" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_38"	area 926 232 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[3]].equipment.group8" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_39"	area 966 232 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[3]].equipment.group9" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_40"	area 606 272 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[3]].equipment.group10" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_41"	area 646 272 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[3]].equipment.group11" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_42"	area 686 272 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[3]].equipment.group12" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_43"	area 726 272 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[3]].equipment.group13" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_44"	area 766 272 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[3]].equipment.group14" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_45"	area 806 272 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[3]].equipment.group15" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_46"	area 846 272 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[3]].equipment.group16" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_47"	area 886 272 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[3]].equipment.group17" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_48"	area 926 272 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[3]].equipment.group18" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}
	slot {name "slot_inv_49"	area 966 272 40 40 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[3]].equipment.group19" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			highlight selected 1}

	slot {name "slot_inv_30"	area 606 324 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[4]].equipment.group0" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_31"	area 646 324 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[4]].equipment.group1" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_32"	area 686 324 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[4]].equipment.group2" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_33"	area 726 324 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[4]].equipment.group3" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_34"	area 766 324 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[4]].equipment.group4" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_35"	area 806 324 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[4]].equipment.group5" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_36"	area 846 324 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[4]].equipment.group6" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_37"	area 886 324 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[4]].equipment.group7" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_38"	area 926 324 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[4]].equipment.group8" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_39"	area 966 324 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[4]].equipment.group9" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_40"	area 606 364 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[4]].equipment.group10" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_41"	area 646 364 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[4]].equipment.group11" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_42"	area 686 364 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[4]].equipment.group12" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_43"	area 726 364 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[4]].equipment.group13" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_44"	area 766 364 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[4]].equipment.group14" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_45"	area 806 364 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[4]].equipment.group15" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_46"	area 846 364 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[4]].equipment.group16" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_47"	area 886 364 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[4]].equipment.group17" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_48"	area 926 364 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[4]].equipment.group18" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}
	slot {name "slot_inv_49"	area 966 364 40 40 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[4]].equipment.group19" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			highlight selected 1}

	slot {name "slot_inv_30"	area 606 420 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[5]].equipment.group0" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_31"	area 646 420 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[5]].equipment.group1" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_32"	area 686 420 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[5]].equipment.group2" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_33"	area 726 420 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[5]].equipment.group3" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_34"	area 766 420 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[5]].equipment.group4" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_35"	area 806 420 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[5]].equipment.group5" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_36"	area 846 420 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[5]].equipment.group6" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_37"	area 886 420 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[5]].equipment.group7" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_38"	area 926 420 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[5]].equipment.group8" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_39"	area 966 420 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[5]].equipment.group9" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_40"	area 606 460 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[5]].equipment.group10" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_41"	area 646 460 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[5]].equipment.group11" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_42"	area 686 460 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[5]].equipment.group12" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_43"	area 726 460 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[5]].equipment.group13" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_44"	area 766 460 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[5]].equipment.group14" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_45"	area 806 460 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[5]].equipment.group15" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_46"	area 846 460 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[5]].equipment.group16" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_47"	area 886 460 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[5]].equipment.group17" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_48"	area 926 460 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[5]].equipment.group18" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}
	slot {name "slot_inv_49"	area 966 460 40 40 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[5]].equipment.group19" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			highlight selected 1}

	slot {name "slot_inv_30"	area 606 511 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[6]].equipment.group0" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_31"	area 646 511 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[6]].equipment.group1" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_32"	area 686 511 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[6]].equipment.group2" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_33"	area 726 511 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[6]].equipment.group3" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_34"	area 766 511 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[6]].equipment.group4" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_35"	area 806 511 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[6]].equipment.group5" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_36"	area 846 511 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[6]].equipment.group6" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_37"	area 886 511 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[6]].equipment.group7" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_38"	area 926 511 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[6]].equipment.group8" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_39"	area 966 511 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[6]].equipment.group9" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_40"	area 606 551 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[6]].equipment.group10" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_41"	area 646 551 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[6]].equipment.group11" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_42"	area 686 551 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[6]].equipment.group12" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_43"	area 726 551 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[6]].equipment.group13" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_44"	area 766 551 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[6]].equipment.group14" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_45"	area 806 551 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[6]].equipment.group15" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_46"	area 846 551 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[6]].equipment.group16" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_47"	area 886 551 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[6]].equipment.group17" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_48"	area 926 551 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[6]].equipment.group18" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}
	slot {name "slot_inv_49"	area 966 551 40 40 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[6]].equipment.group19" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			highlight selected 1}

	slot {name "slot_inv_68"	area 588 614 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.ground0"			highlight selected 1}
	slot {name "slot_inv_69"	area 628 614 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.ground1"			highlight selected 1}
	slot {name "slot_inv_70"	area 668 614 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.ground2"			highlight selected 1}
	slot {name "slot_inv_71"	area 708 614 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.ground3"			highlight selected 1}
	slot {name "slot_inv_72"	area 748 614 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.ground4"			highlight selected 1}
	slot {name "slot_inv_73"	area 788 614 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ground5"			highlight selected 1}
	slot {name "slot_inv_74"	area 828 614 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ground6"			highlight selected 1}
	slot {name "slot_inv_75"	area 868 614 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.ground7"			highlight selected 1}
	slot {name "slot_inv_76"	area 908 614 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.ground8"			highlight selected 1}
	slot {name "slot_inv_77"	area 948 614 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.ground9"			highlight selected 1}

	button
	{
		area 491 621 22 42
		mosaic icpickup
		sequence 5
	}

	label
	{
		area 512 618 48 16
		text lua "Infinity_GetCurrentGroundPage()+1 .. '/' .. Infinity_GetMaxGroundPage()+1"
		text style "label"
		align center center
	}
	button
	{
		area 512 630 24 24
		bam "ARROBUTT"
		sequence 0
		action
		"
			Infinity_OnGroundPage(-1)
		"
	}
	button
	{
		area 536 630 24 24
		bam "ARROBUTT"
		sequence 1
		action
		"
			Infinity_OnGroundPage(1)
		"
	}

	button
	{
		area 1032 30 48 48
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
	button
	{
		area 12 30 84 30
		bam "jrnbutt"
		sequence 1
		text "MAP_TOOLTIP"
		text style "button"
		pad 16 16 16 16
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(1)
		"
	}
}
menu
{
	name 'INVENTORY_SHARED2'
	align center center
	ignoreEsc
	size 1024 768
	
	onOpen
	" 
	popSidebars()
	rgInvId = id
	checkForKnownBestiaryNPC()
	--selectedBestiaryCreature = nil
	Infinity_SetBackground('BACKGROUND_INVENTORY_SHARED2')
	--resetRecordHelpString()
				--pstFoundKnownNPC = 1
						--buildJournalDisplay()


	"
	onClose
	"
	pushSidebars()
	Infinity_SetBackground(nil)
	"

	button
	{
		--enabled "rgInventoryMode == 1 or rgPaperdollSwap == 1"
		area 306 151 196 282
		--paperdoll 1
		actiondrag "Infinity_SwapWithAppearance()"
	}

	button
	{

		enabled "const.JOURNAL_MODE_BESTIARY"
		mosaic lua "getBestiaryImage()"
		--enabled "rgInventoryMode == 0 and RgInvPartyModeHover == 1 and rgPaperdollSwap == 0"
		area 308 151 194 282
		--mosaic lua "characters[currentID].pstPortrait"
		--bitmap lua "worldNPCDialogPortrait"
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_PC
			selectedBestiaryCreature = nil
		"
	}
	label
	{
		area 966 569 52 48
		bam "contback"
	}
	label
	{
		area 966 554 36 16
		text lua "game:GetSelectedCarried() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align left center
	}
	label
	{
		area 978 617 40 16
		text lua "game:GetSelectedMaxEncumbrance() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align right center
	}
	
	label
	{
		area 342 27 142 46
		text lua "characters[id].name"
		text style "label"
	}
	label
	{
		area 880 584 64 23
		text lua "characters[id].gold"
		text style "gold"
	}
	--label
	--{
	--	area 323 62 187 32
	--	text lua "characters[id].class"
	--	text style "label"
	--}

	text
	{
		area 484 32 29 20
		text "AC_LABEL"
		text style "label_parchment"
		text font "EXOCET"
		text point 26
		text shadow 1
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		area 484 52 29 16
		text lua "characters[id].AC.current"
		text style "label"
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	
	label
	{
		area 296 27 42 51
		mosaic "icHPMan"
	}
	text
	{
		area 290 32 52 16
		text lua "characters[id].HP.current"
		text style "label"
		tooltip "CURRENT_HP_TOOLTIP"
	}
	text
	{
		area 290 52 52 16
		text lua "characters[id].HP.max"
		text style "label"
		tooltip "MAX_HP_TOOLTIP"
	}
	text
	{
		area 740 42 222 68
		text lua "TEXT_inventoryError"
		scrollbar 'CGSCRL1'
		text style normal
		text align left center
	}
	text
	{
		area 12 148 222 459
		name "IWProfinciencies"
		text lua "characters[id].proficiencies.pstDetails"
		text style "normal_parchment"
		text color 'D'
		text align left top
		scrollbar 'g-btsl1'
	}
	--label
	--{
	--area 838 62 16 64
	--enabled "Infinity_GetNumCharacters() > 0"
	--mosaic ""
	--}

	button --proba
	{
		area 944 161 80 64
		--some of these may be unneeded TODO
		portrait 0
		enabled "Infinity_GetNumCharacters() > 0"
		glow lua "draggedPortrait and draggedPortrait ~= 0"
		action "Infinity_OnPortraitLClick(0); rgInvId = id; rgInvChar = '1'; selectedBestiaryCreature = 0"
		actionAlt "Infinity_OnPortraitRClick(0)"
		actionDbl "Infinity_OnPortraitDblClick(0)"
		actiondrag "Infinity_SwapWithPortrait(0)"
		actionEnter "mouseOverPortrait = 0"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(0)"
		actionSimpleDrop "swapPortraits(0)"
		clickable lua "sidebarsGreyed ~= 1"
	}
	button
	{
		area 944 225 80 64
		portrait 1
		enabled "Infinity_GetNumCharacters() > 1"
		glow lua "draggedPortrait and draggedPortrait ~= 1"
		action "Infinity_OnPortraitLClick(1);  rgInvId = id; rgInvChar = '2'"
		actionAlt "Infinity_OnPortraitRClick(1)"
		actionDbl "Infinity_OnPortraitDblClick(1);"
		actiondrag "Infinity_SwapWithPortrait(1)"
		actionEnter "mouseOverPortrait = 1"
		actionExit "mouseOverPortrait = -1;"
		actionSimpleDrag "startDraggingPortrait(1)"
		actionSimpleDrop "swapPortraits(1)"
		clickable lua "sidebarsGreyed ~= 1"
	}
		button
	{
		area 944 289 80 66
		portrait 2
		enabled "Infinity_GetNumCharacters() > 2"
		glow lua "draggedPortrait and draggedPortrait ~= 2"
		action "Infinity_OnPortraitLClick(2); rgInvId = id; rgInvChar = '3'"
		actionAlt "Infinity_OnPortraitRClick(2)"
		actionDbl "Infinity_OnPortraitDblClick(2)"
		actiondrag "Infinity_SwapWithPortrait(2)"
		actionEnter "mouseOverPortrait = 2"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(2)"
		actionSimpleDrop "swapPortraits(2)"
		clickable lua "sidebarsGreyed ~= 1"

	}
	button
	{
		area 944 353 80 65
		portrait 3
		enabled "Infinity_GetNumCharacters() > 3"
		glow lua "draggedPortrait and draggedPortrait ~= 3"
		action "Infinity_OnPortraitLClick(3); rgInvId = id; rgInvChar = '4'"
		actionAlt "Infinity_OnPortraitRClick(3)"
		actionDbl "Infinity_OnPortraitDblClick(3)"
		actiondrag "Infinity_SwapWithPortrait(3)"
		actionEnter "mouseOverPortrait = 3"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(3)"
		actionSimpleDrop "swapPortraits(3)"
		clickable lua "sidebarsGreyed ~= 1"

	}
		button
	{
		area 944 418 80 64
		portrait 4
		enabled "Infinity_GetNumCharacters() > 4"
		glow lua "draggedPortrait and draggedPortrait ~= 4"
		action "Infinity_OnPortraitLClick(4); rgInvId = id; rgInvChar = '5'"
		actionAlt "Infinity_OnPortraitRClick(4)"
		actionDbl "Infinity_OnPortraitDblClick(4)"
		actiondrag "Infinity_SwapWithPortrait(4)"
		actionEnter "mouseOverPortrait = 4"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(4)"
		actionSimpleDrop "swapPortraits(4)"
		clickable lua "sidebarsGreyed ~= 1"

	}
	button
	{
		area 944 482 80 63
		portrait 5
		enabled "Infinity_GetNumCharacters() > 5"
		glow lua "draggedPortrait and draggedPortrait ~= 5"
		action "Infinity_OnPortraitLClick(5); rgInvId = id; rgInvChar = '6'"
		actionAlt "Infinity_OnPortraitRClick(5)"
		actionDbl "Infinity_OnPortraitDblClick(5)"
		actiondrag "Infinity_SwapWithPortrait(5)"
		actionEnter "mouseOverPortrait = 5"
		actionExit "mouseOverPortrait = -1"
		actionSimpleDrag "startDraggingPortrait(5)"
		actionSimpleDrop "swapPortraits(5)"
		clickable lua "sidebarsGreyed ~= 1"

	}



	slot {name "slot_inv_1"		area 316 454 36 36	bam "SLOTSWRD"	sequence 0	slotinfo "characters[id].equipment.weapon0"	highlight selected 1		}
	slot {name "slot_inv_2"		area 366 454 36 36	bam "SLOTSWRD"	sequence 1	slotinfo "characters[id].equipment.weapon1"	highlight selected 1		}
	slot {name "slot_inv_3"		area 420 454 36 36	bam "SLOTSWRD"	sequence 2	slotinfo "characters[id].equipment.weapon2"	highlight selected 1		}
	slot {name "slot_inv_4"		area 470 454 36 36	bam "SLOTSWRD"	sequence 3	slotinfo "characters[id].equipment.weapon3"	highlight selected 1		}

	slot {name "slot_inv_11"	area 506 209 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.chest0"			highlight selected 1}
	slot {name "slot_inv_12"	area 506 321 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.wrist0"			highlight selected 1}
	slot {name "slot_inv_13"	area 506 154 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.earringleft0"	highlight selected 1}
	slot {name "slot_inv_14"	area 256 154 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.earringright0"	highlight selected 1}

	slot {name "slot_inv_15"	area 296 569 32 32	bam "SLOTARRW"	sequence 0	slotinfo "characters[id].equipment.quiver0"			highlight selected 1}
	slot {name "slot_inv_16"	area 342 569 32 32	bam "SLOTARRW"	sequence 1	slotinfo "characters[id].equipment.quiver1"			highlight selected 1}
	slot {name "slot_inv_17"	area 388 569 32 32	bam "SLOTARRW"	sequence 2	slotinfo "characters[id].equipment.quiver2"			highlight selected 1}
	slot {name "slot_inv_18"	area 434 569 32 32	bam "SLOTARRW"	sequence 3	slotinfo "characters[id].equipment.quiver3"			highlight selected 1}
	slot {name "slot_inv_19"	area 484 569 32 32	bam "SLOTARRW"	sequence 4	slotinfo "characters[id].equipment.quiver4"			highlight selected 1}

	slot {name "slot_inv_21"	area 256 385 48 48	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.tattoo0"			highlight selected 1}
	slot {name "slot_inv_22"	area 506 266 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ring0"			highlight selected 1}
	slot {name "slot_inv_23"	area 256 266 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ring1"			highlight selected 1}
	slot {name "slot_inv_24"	area 256 209 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.tattoo1"			highlight selected 1}
	slot {name "slot_inv_25"	area 256 321 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.hand0"			highlight selected 1}
	slot {name "slot_inv_26"	area 506 385 48 48	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.tattoo2"			highlight selected 1}

	slot {name "slot_inv_5"		area 296 518 32 32	bam "SLOTITM"	sequence 0	slotinfo "characters[id].equipment.personal0"	highlight selected 1	}
	slot {name "slot_inv_6"		area 342 518 32 32	bam "SLOTITM"	sequence 1	slotinfo "characters[id].equipment.personal1"	highlight selected 1	}
	slot {name "slot_inv_7"		area 388 518 32 32	bam "SLOTITM"	sequence 2	slotinfo "characters[id].equipment.personal2"	highlight selected 1	}
	slot {name "slot_inv_8"		area 434 518 32 32	bam "SLOTITM"	sequence 3	slotinfo "characters[id].equipment.personal3"	highlight selected 1	}
	slot {name "slot_inv_9"		area 484 518 32 32	bam "SLOTITM"	sequence 4	slotinfo "characters[id].equipment.personal4"	highlight selected 1	}

	slot {name "slot_inv_30"	area 624 161 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[1]].equipment.group0" 	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_31"	area 656 161 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[1]].equipment.group1"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_32"	area 688 161 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[1]].equipment.group2"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_33"	area 720 161 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[1]].equipment.group3"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_34"	area 752 161 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[1]].equipment.group4"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_35"	area 784 161 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[1]].equipment.group5"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_36"	area 816 161 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[1]].equipment.group6"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_37"	area 848 161 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[1]].equipment.group7"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_38"	area 880 161 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[1]].equipment.group8"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_39"	area 912 161 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[1]].equipment.group9"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_40"	area 624 193 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[1]].equipment.group10" 	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_41"	area 656 193 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[1]].equipment.group11" 	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_42"	area 688 193 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[1]].equipment.group12"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_43"	area 720 193 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[1]].equipment.group13"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_44"	area 752 193 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[1]].equipment.group14"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_45"	area 784 193 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[1]].equipment.group15"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_46"	area 816 193 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[1]].equipment.group16"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_47"	area 848 193 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[1]].equipment.group17"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_48"	area 880 193 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[1]].equipment.group18"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}
	slot {name "slot_inv_49"	area 912 193 32 32 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[1]].equipment.group19"  	enabled "Infinity_GetNumCharacters() > 0" actionEnter "Infinity_PressKeyboardButton('1')" bam "g-iw2_s"			highlight selected 1}

	slot {name "slot_inv_30"	area 624 225 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[2]].equipment.group0" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')"		    bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_31"	area 656 225 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[2]].equipment.group1" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_32"	area 688 225 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[2]].equipment.group2" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_33"	area 720 225 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[2]].equipment.group3" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_34"	area 752 225 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[2]].equipment.group4" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_35"	area 784 225 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[2]].equipment.group5" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_36"	area 816 225 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[2]].equipment.group6" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_37"	area 848 225 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[2]].equipment.group7" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_38"	area 880 225 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[2]].equipment.group8" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_39"	area 912 225 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[2]].equipment.group9" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_40"	area 624 257 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[2]].equipment.group10" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_41"	area 656 257 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[2]].equipment.group11" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_42"	area 688 257 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[2]].equipment.group12" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_43"	area 720 257 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[2]].equipment.group13" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_44"	area 752 257 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[2]].equipment.group14" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_45"	area 784 257 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[2]].equipment.group15" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_46"	area 816 257 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[2]].equipment.group16" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_47"	area 848 257 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[2]].equipment.group17" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_48"	area 880 257 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[2]].equipment.group18" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_49"	area 912 257 32 32 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[2]].equipment.group19" enabled "Infinity_GetNumCharacters() > 1" actionEnter "Infinity_PressKeyboardButton('2')" 			bam "g-iw2_s" highlight selected 1}

	slot {name "slot_inv_30"	area 624 289 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[3]].equipment.group0" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_31"	area 656 289 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[3]].equipment.group1" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_32"	area 688 289 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[3]].equipment.group2" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_33"	area 720 289 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[3]].equipment.group3" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_34"	area 752 289 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[3]].equipment.group4" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_35"	area 784 289 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[3]].equipment.group5" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_36"	area 816 289 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[3]].equipment.group6" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_37"	area 848 289 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[3]].equipment.group7" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_38"	area 880 289 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[3]].equipment.group8" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_39"	area 912 289 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[3]].equipment.group9" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_40"	area 624 321 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[3]].equipment.group10" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_41"	area 656 321 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[3]].equipment.group11" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_42"	area 688 321 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[3]].equipment.group12" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_43"	area 720 321 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[3]].equipment.group13" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_44"	area 752 321 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[3]].equipment.group14" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_45"	area 784 321 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[3]].equipment.group15" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_46"	area 816 321 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[3]].equipment.group16" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_47"	area 848 321 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[3]].equipment.group17" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_48"	area 880 321 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[3]].equipment.group18" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_49"	area 912 321 32 32 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[3]].equipment.group19" enabled "Infinity_GetNumCharacters() > 2" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('3') end" 			bam "g-iw2_s" highlight selected 1}

	slot {name "slot_inv_30"	area 624 353 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[4]].equipment.group0" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_31"	area 656 353 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[4]].equipment.group1" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_32"	area 688 353 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[4]].equipment.group2" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_33"	area 720 353 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[4]].equipment.group3" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_34"	area 752 353 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[4]].equipment.group4" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_35"	area 784 353 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[4]].equipment.group5" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_36"	area 816 353 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[4]].equipment.group6" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_37"	area 848 353 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[4]].equipment.group7" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_38"	area 880 353 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[4]].equipment.group8" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_39"	area 912 353 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[4]].equipment.group9" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_40"	area 624 385 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[4]].equipment.group10" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_41"	area 656 385 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[4]].equipment.group11" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_42"	area 688 385 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[4]].equipment.group12" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_43"	area 720 385 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[4]].equipment.group13" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_44"	area 752 385 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[4]].equipment.group14" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_45"	area 784 385 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[4]].equipment.group15" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_46"	area 816 385 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[4]].equipment.group16" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_47"	area 848 385 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[4]].equipment.group17" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_48"	area 880 385 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[4]].equipment.group18" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_49"	area 912 385 32 32 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[4]].equipment.group19" enabled "Infinity_GetNumCharacters() > 3" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('4') end" 			bam "g-iw2_s" highlight selected 1}

	slot {name "slot_inv_30"	area 624 417 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[5]].equipment.group0" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_31"	area 656 417 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[5]].equipment.group1" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_32"	area 688 417 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[5]].equipment.group2" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_33"	area 720 417 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[5]].equipment.group3" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_34"	area 752 417 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[5]].equipment.group4" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_35"	area 784 417 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[5]].equipment.group5" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_36"	area 816 417 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[5]].equipment.group6" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_37"	area 848 417 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[5]].equipment.group7" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_38"	area 880 417 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[5]].equipment.group8" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_39"	area 912 417 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[5]].equipment.group9" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_40"	area 624 449 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[5]].equipment.group10" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_41"	area 656 449 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[5]].equipment.group11" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_42"	area 688 449 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[5]].equipment.group12" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_43"	area 720 449 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[5]].equipment.group13" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_44"	area 752 449 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[5]].equipment.group14" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_45"	area 784 449 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[5]].equipment.group15" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_46"	area 816 449 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[5]].equipment.group16" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_47"	area 848 449 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[5]].equipment.group17" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_48"	area 880 449 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[5]].equipment.group18" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_49"	area 912 449 32 32 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[5]].equipment.group19" enabled "Infinity_GetNumCharacters() > 4" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('5') end" 			bam "g-iw2_s" highlight selected 1}

	slot {name "slot_inv_30"	area 624 481 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[6]].equipment.group0" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_31"	area 656 481 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[6]].equipment.group1" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_32"	area 688 481 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[6]].equipment.group2" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_33"	area 720 481 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[6]].equipment.group3" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_34"	area 752 481 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[6]].equipment.group4" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_35"	area 784 481 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[6]].equipment.group5" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_36"	area 816 481 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[6]].equipment.group6" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_37"	area 848 481 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[6]].equipment.group7" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_38"	area 880 481 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[6]].equipment.group8" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_39"	area 912 481 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[6]].equipment.group9" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_40"	area 624 513 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[charTable[6]].equipment.group10" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_41"	area 656 513 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[charTable[6]].equipment.group11" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_42"	area 688 513 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[charTable[6]].equipment.group12" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_43"	area 720 513 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[charTable[6]].equipment.group13" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_44"	area 752 513 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[charTable[6]].equipment.group14" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_45"	area 784 513 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[charTable[6]].equipment.group15" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_46"	area 816 513 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[charTable[6]].equipment.group16" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_47"	area 848 513 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[charTable[6]].equipment.group17" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_48"	area 880 513 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[charTable[6]].equipment.group18" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}
	slot {name "slot_inv_49"	area 912 513 32 32 	bam "IVSLOT"	sequence 3	slotinfo "characters[charTable[6]].equipment.group19" enabled "Infinity_GetNumCharacters() > 5" actionEnter "if RgInvPartyModeHover == 1 then Infinity_PressKeyboardButton('6') end" 			bam "g-iw2_s" highlight selected 1}

	slot {name "slot_inv_68"	area 648 601 32 32	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.ground0"			highlight selected 1}
	slot {name "slot_inv_69"	area 680 601 32 32	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.ground1"			highlight selected 1}
	slot {name "slot_inv_70"	area 712 601 32 32	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.ground2"			highlight selected 1}
	slot {name "slot_inv_71"	area 744 601 32 32	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.ground3"			highlight selected 1}
	slot {name "slot_inv_72"	area 776 601 32 32	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.ground4"			highlight selected 1}
	slot {name "slot_inv_73"	area 808 601 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ground5"			highlight selected 1}
	slot {name "slot_inv_74"	area 840 601 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ground6"			highlight selected 1}
	slot {name "slot_inv_75"	area 872 601 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.ground7"			highlight selected 1}
	slot {name "slot_inv_76"	area 904 601 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.ground8"			highlight selected 1}
	slot {name "slot_inv_77"	area 936 601 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.ground9"			highlight selected 1}

	label
	{
		area 648 577 48 24
		text lua "Infinity_GetCurrentGroundPage()+1 .. '/' .. Infinity_GetMaxGroundPage()+1"
		text style "label"
		align center center
	}
	button
	{
		area 696 577 24 24
		bam "ARROBUTT"
		sequence 0
		action
		"
			Infinity_OnGroundPage(-1)
		"
	}
	button
	{
		area 716 577 24 24
		bam "ARROBUTT"
		sequence 1
		action
		"
			Infinity_OnGroundPage(1)
		"
	}
	label
	{
		area 890 555 46 35
		mosaic icgold
	}
	label
	{
		area 632 590 16 43
		mosaic icpickup
	}
	button
	{
		area 166 680 84 30
		bam "jrnbutt"
		sequence 1
		text "MAP_TOOLTIP"
		text style "button"
		pad 16 16 16 16
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(1)
		"
	}
	button
	{
		area 58 680 84 30
		bam "jrnbutt"
		sequence 1
		text "JOURNAL_TOOLTIP"
		text style "button"
		pad 16 16 16 16
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
	button
	{
		area 272 680 84 30
		bam "jrnbutt"
		sequence 1
		text "CHARACTER_RECORD_TOOLTIP"
		text style "button"
		pad 16 16 16 16
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(4)
		"
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
}


menu
{
	name 'INVENTORY_WORLD'
	align center center
	ignoreEsc
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	interactable lua "characters[id].HP.current > 0"
	 
	onOpen 
	"	--restoreIWPosition()
		pushSidebars()
	"
	onClose 
	"	--saveIWPosition()
		popSidebars()
		Infinity_SetBackground(nil)
	"
	handle
	{
		name "IWHandleDrag"
		area 498 -14 92 92
		mosaic "han2"
		actionDrag "dragIWX(motionX), dragIWY(motionY)"
	}
	label
	{
		name "IWBackground"
		area -36 42 592 620
		mosaic "iiw"
	}
	label
	{	
		name "IWSwapWithAppearance"
		area 264 164 161 212
		paperdoll 1
		actiondrag "Infinity_SwapWithAppearance()"
	}

	label
	{
		name "IWContback"
		area 264 550 44 42
		bam "contback"
	}
	label
	{	
		name "IWGetSelCarried"
		area 254 533 53 21
		text lua "game:GetSelectedCarried() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align left center
	}
	label
	{	
		name "IWGetMaxEncumb"
		area 254 592 53 18
		text lua "game:GetSelectedMaxEncumbrance() .. 'LB'"
		text style "normal"
		text color lua "getEncumbranceColor()"
		align right center
	}
	
	label
	{
		name "IWcharId"
		area 14 74 166 30
		text lua "characters[id].name"
		text style "label"
	}
	label
	{
		name "IWGroundP"
		area 190 419 45 24
		text lua "Infinity_GetCurrentGroundPage()+1 .. '/' .. Infinity_GetMaxGroundPage()+1"
		text style "label"
		align center center
	}
	label
	{
		name "IWGold"
		area 252 500 60 23
		text lua "characters[id].gold"
		text style "gold"
	}
	text
	{
		name "IWACLabel"
		area 84 137 50 27
		text "AC_LABEL"
		text style "label_parchment"
		text font "EXOCET"
		text point 26
		text shadow 1
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		name "IWACCurr"
		area 94 164 36 22
		text lua "characters[id].AC.current"
		text style "label"
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		name "IWCurrHP"
		area 74 236 44 22
		text lua "characters[id].HP.current"
		text style "label"
		tooltip "CURRENT_HP_TOOLTIP"
	}
	text
	{	
		name "IWMaxHP"
		area 118 236 43 22
		text lua "characters[id].HP.max"
		text style "label"
		tooltip "MAX_HP_TOOLTIP"
	}
	text
	{
		area -18 264 174 342
		name "IWProfinciencies"
		text lua "characters[id].proficiencies.pstDetails"
		text style "normal_parchment"
		text color 'D'
		text align left top
		scrollbar 'g-btsl1'
	}
	text
	{
		name "IWError"
		area -23 616 300 46
		text lua "TEXT_inventoryError"
		scrollbar 'CGSCRL1'
		text style normal
		text align left center
	}


	slot {name "slot_inv_w_1"	area 214 158 40 40	bam "SLOTSWRD"	sequence 0	slotinfo "characters[id].equipment.weapon0"	 highlight selected 1		}
	slot {name "slot_inv_w_2"	area 214 228 40 40	bam "SLOTSWRD"	sequence 1	slotinfo "characters[id].equipment.weapon1"	 highlight selected 1		}
	slot {name "slot_inv_w_3"	area 214 288 40 40	bam "SLOTSWRD"	sequence 2	slotinfo "characters[id].equipment.weapon2"	 highlight selected 1		}
	slot {name "slot_inv_w_4"	area 214 348 40 40	bam "SLOTSWRD"	sequence 3	slotinfo "characters[id].equipment.weapon3"	 highlight selected 1		}
	
	slot {name "slot_inv_w_5"	area 161 148 40 40	bam "SLOTITM"	sequence 0	slotinfo "characters[id].equipment.personal0"	 highlight selected 1	}
	slot {name "slot_inv_w_6"	area 161 198 40 40	bam "SLOTITM"	sequence 1	slotinfo "characters[id].equipment.personal1"	 highlight selected 1	}
	slot {name "slot_inv_w_7"	area 161 248 40 40	bam "SLOTITM"	sequence 2	slotinfo "characters[id].equipment.personal2"	 highlight selected 1	}
	slot {name "slot_inv_w_8"	area 161 296 40 40	bam "SLOTITM"	sequence 3	slotinfo "characters[id].equipment.personal3"	 highlight selected 1	}
	slot {name "slot_inv_w_9"	area 161 344 40 40	bam "SLOTITM"	sequence 4	slotinfo "characters[id].equipment.personal4"	 highlight selected 1	}
	
	slot {name "slot_inv_w_11"	area 235 100 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.chest0"			 highlight selected 1}
	slot {name "slot_inv_w_12"	area 437 164 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.wrist0"			 highlight selected 1}
	slot {name "slot_inv_w_13"	area 357 100 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.earringleft0"	 highlight selected 1}
	slot {name "slot_inv_w_14"	area 295 100 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.earringright0"	 highlight selected 1}
	
	slot {name "slot_inv_w_15"	area 493 111 40 40	bam "SLOTARRW"	sequence 0	slotinfo "characters[id].equipment.quiver0"			highlight selected 1}
	slot {name "slot_inv_w_16"	area 493 164 40 40	bam "SLOTARRW"	sequence 1	slotinfo "characters[id].equipment.quiver1"			highlight selected 1}
	slot {name "slot_inv_w_17"	area 493 220 40 40	bam "SLOTARRW"	sequence 2	slotinfo "characters[id].equipment.quiver2"			highlight selected 1}
	slot {name "slot_inv_w_18"	area 493 270 40 40	bam "SLOTARRW"	sequence 3	slotinfo "characters[id].equipment.quiver3"			highlight selected 1}
	slot {name "slot_inv_w_19"	area 493 322 40 40	bam "SLOTARRW"	sequence 4	slotinfo "characters[id].equipment.quiver4"			highlight selected 1}
	
	slot {name "slot_inv_w_21"	area 277 384 48 48	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.tattoo0"			 highlight selected 1}
	slot {name "slot_inv_w_22"	area 437 228 48 48	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ring0"			 highlight selected 1}
	slot {name "slot_inv_w_23"	area 437 292 48 48	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ring1"			 highlight selected 1}
	slot {name "slot_inv_w_24"	area 343 384 48 48	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.tattoo1"			 highlight selected 1}
	slot {name "slot_inv_w_25"	area 417 100 48 48	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.hand0"			highlight selected 1}
	slot {name "slot_inv_w_26"	area 409 384 48 48	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.tattoo2"			 highlight selected 1}

	slot {name "slot_inv_w_30"	area 317 443 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.group0"			 highlight selected 1}
	slot {name "slot_inv_w_31"	area 357 443 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.group1"			 highlight selected 1}
	slot {name "slot_inv_w_32"	area 397 443 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.group2"			 highlight selected 1}
	slot {name "slot_inv_w_33"	area 437 443 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.group3"			 highlight selected 1}
	slot {name "slot_inv_w_34"	area 477 443 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.group4"			 highlight selected 1}
	slot {name "slot_inv_w_35"	area 317 483 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.group5"			 highlight selected 1}
	slot {name "slot_inv_w_36"	area 357 483 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.group6"			 highlight selected 1}
	slot {name "slot_inv_w_37"	area 397 483 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.group7"			 highlight selected 1}
	slot {name "slot_inv_w_38"	area 437 483 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.group8"			 highlight selected 1}
	slot {name "slot_inv_w_39"	area 477 483 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.group9"			 highlight selected 1}
	slot {name "slot_inv_w_40"	area 317 523 40 40	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.group10"			 highlight selected 1}
	slot {name "slot_inv_w_41"	area 357 523 40 40	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.group11"			 highlight selected 1}
	slot {name "slot_inv_w_42"	area 397 523 40 40	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.group12"			 highlight selected 1}
	slot {name "slot_inv_w_43"	area 437 523 40 40	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.group13"			 highlight selected 1}
	slot {name "slot_inv_w_44"	area 477 523 40 40	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.group14"			 highlight selected 1}
	slot {name "slot_inv_w_45"	area 317 563 40 40	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.group15"			 highlight selected 1}
	slot {name "slot_inv_w_46"	area 357 563 40 40	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.group16"			 highlight selected 1}
	slot {name "slot_inv_w_47"	area 397 563 40 40	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.group17"			 highlight selected 1}
	slot {name "slot_inv_w_48"	area 437 563 40 40	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.group18"			 highlight selected 1}
	slot {name "slot_inv_w_49"	area 477 563 40 40	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.group19"			 highlight selected 1}

	slot {name "slot_inv_w_68"	area 180 443 34 32	bam "IVSLOT"	sequence 4	slotinfo "characters[id].equipment.ground0"			 highlight selected 1}
	slot {name "slot_inv_w_69"	area 180 475 34 32	bam "IVSLOT"	sequence 5	slotinfo "characters[id].equipment.ground1"			 highlight selected 1}
	slot {name "slot_inv_w_70"	area 180 507 34 32	bam "IVSLOT"	sequence 6	slotinfo "characters[id].equipment.ground2"			 highlight selected 1}
	slot {name "slot_inv_w_71"	area 180 539 34 32	bam "IVSLOT"	sequence 7	slotinfo "characters[id].equipment.ground3"			 highlight selected 1}
	slot {name "slot_inv_w_72"	area 180 571 34 32	bam "IVSLOT"	sequence 8	slotinfo "characters[id].equipment.ground4"			 highlight selected 1}
	slot {name "slot_inv_w_73"	area 214 443 32 32	bam "IVSLOT"	sequence 9	slotinfo "characters[id].equipment.ground5"			 highlight selected 1}
	slot {name "slot_inv_w_74"	area 214 475 32 32	bam "IVSLOT"	sequence 0	slotinfo "characters[id].equipment.ground6"			 highlight selected 1}
	slot {name "slot_inv_w_75"	area 214 507 32 32	bam "IVSLOT"	sequence 1	slotinfo "characters[id].equipment.ground7"			 highlight selected 1}
	slot {name "slot_inv_w_76"	area 214 539 32 32	bam "IVSLOT"	sequence 2	slotinfo "characters[id].equipment.ground8"			 highlight selected 1}
	slot {name "slot_inv_w_77"	area 214 571 32 32	bam "IVSLOT"	sequence 3	slotinfo "characters[id].equipment.ground9"			 highlight selected 1}
	
	button
	{
		name "IWGP-1"
		area 161 415 29 28
		bam "ARROBUTT"
		sequence 0
		action
		"
			Infinity_OnGroundPage(-1)
		"
	}
	button
	{
		name "IWGP1"
		area 235 415 29 28
		bam "ARROBUTT"
		sequence 1
		action
		"
			Infinity_OnGroundPage(1)
		"
	}
	label
	{
		name "IWpickup"
		area 156 544 24 48
		mosaic icpickup	
	}
	--button
	--{
		--area 284 153 31 31
		--bam "sfcbbut"
		--sequence 1
		--tooltip lua "Infinity_FetchString(4262)"
		--action 
		--"
			--if Infinity_IsMenuOnStack('QUIVER_IN_WORLD') then
			--Infinity_PopMenu('QUIVER_IN_WORLD')
			--else
				--Infinity_PushMenu('QUIVER_IN_WORLD')
			--end 
		--"	
	--}
	--button
	--{	
		--name "SW"
		--area 490 303 53 53
		--bam 'II093'
		--sequence 0
		--tooltip "Stats"
		--action 
		--"
			--if Infinity_IsMenuOnStack('STATS') then
			--Infinity_PopMenu('STATS')
			--else
			--Infinity_PushMenu('STATS')
			--end				
	--	"
	--}
	button
	{	
		name "JW"
		area 469 371 48 62
		bam 'g-btsym'
		sequence 0
		tooltip "JOURNAL_TOOLTIP"
		action 
		"
			if Infinity_IsMenuOnStack('JOURNAL_IW') then
			Infinity_PopMenu('JOURNAL_IW')
			Infinity_PopMenu('JOURNAL_IW_MODE')
			Infinity_PopMenu('JOURNAL_IW_BESTIARY')
			else
			Infinity_PushMenu('JOURNAL_IW')
		
			end 
			
			
		"
	}
	text
	{	name "st01"
		area -18 126 59 22
		text lua "Infinity_FetchString(4718)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
		text align	left left
	}
	label
	{	name "st02"
		area 		39 126 35 22
		text lua "characters[id].attr.str.current"
		text style  'label'
		text align	left left
	}
	text
	{	name "st03"
		area -18 148 59 22
		text lua "Infinity_FetchString(5020)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
		text align	left left
	}
	label
	{	name "st04"
		area		39 148 35 22
		text lua "characters[id].attr.int.current"
		text style  'label'
		text align	left left
	}
	text
	{	name "st05"
		area -18 170 59 22
		text lua "Infinity_FetchString(5021)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
		text align	left left
	}
	label
	{	name "st06"
		area		39 170 35 22
		text lua "characters[id].attr.wis.current"
		text style  'label'
		text align	left left
	}
	text
	{	name "st07"
		area -18 192 59 22
		text lua "Infinity_FetchString(5022)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
		text align	left left
	}
	label
	{	name "st08"
		area		39 192 35 22
		text lua "characters[id].attr.dex.current"
		text style  'label'
		text align	left left
	}
	text
	{	name "st09"
		area -18 214 59 22
		text lua "Infinity_FetchString(5023)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
		text align	left left
	}
	label
	{	name "st10"
		area		39 214 35 22
		text lua "characters[id].attr.con.current"
		text style  'label'
		text align	left left
	}
	text
	{	name "st11"
		area -18 236 59 22
		text lua "Infinity_FetchString(5024)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
		text align	left left
	}
	label
	{	name "st12"
		area		39 236 35 22
		text lua "characters[id].attr.cha.current"
		text style  'label'
		text align	left left
	}
	
	button
	{
		name "IWEXITBTN"
		area -36 42 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():SelectEngine(worldScreen)
		"
	}
}

menu 
{
	name 'QUIVER_IN_WORLD'
	align center center
	ignoreEsc
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	onOpen
	"
	showButton = false
	"
	onClose
	"
	pushSidebars()
	showButton = false
	"
	
	slot {name "slot_inv_15"	area 555 110 40 40	bam "SLOTARRW"	sequence 0	slotinfo "characters[id].equipment.quiver0"			highlight selected 1}
	slot {name "slot_inv_16"	area 555 164 40 40	bam "SLOTARRW"	sequence 1	slotinfo "characters[id].equipment.quiver1"			highlight selected 1}
	slot {name "slot_inv_17"	area 555 218 40 40	bam "SLOTARRW"	sequence 2	slotinfo "characters[id].equipment.quiver2"			highlight selected 1}
	slot {name "slot_inv_18"	area 555 272 40 40	bam "SLOTARRW"	sequence 3	slotinfo "characters[id].equipment.quiver3"			highlight selected 1}
	slot {name "slot_inv_19"	area 555 324 40 40	bam "SLOTARRW"	sequence 4	slotinfo "characters[id].equipment.quiver4"			highlight selected 1}
	
}

--szef_backgrounds_invs

menu
{
	name 'BACKGROUND_INVENTORY'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic "INVBG"
	}
}
menu
{
	name 'BACKGROUND_INVENTORY_SHARED'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic "g-btshd"
	}
}
menu
{
	name 'BACKGROUND_INVENTORY_SHARED2'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic "sh3"
	}
}
--szef_journals

menu 
{
	name 'JOURNAL_IW'
	align center center
	ignoreEsc
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	interactable lua "characters[id].HP.current > 0"
	onOpen "pushSidebars()"
	onClose "pushSidebars()"
	handle
	{
		name "JIWHandleDrag"
		area 1034 292 70 70
		mosaic "han2"
		actionDrag "dragJIWX(motionX), dragJIWY(motionY)"
	}
	label
	{
		area 570 334 498 339
		name "JIW1"
		mosaic 'g-btque'
	}
	list
	{
		column { 
			width 100
			label
			{	
			enabled "questEnabled(rowNumber)"
				area 0 0 -1 -1
				name "JIW2"
				text lua "getQuestText(rowNumber)"
				text style "jiw"
				text color lua "getQuestColor2(rowNumber)"
				align left center
				text highlight 1
				indent 1
				pad 0 0 0 0
			}
		}
		enabled "const.JOURNAL_MODE_QUESTS"
		rowheight	dynamic
		table		"quests"
		var			selectedQuest
		scrollbar	'g-btsl1'
		area		589 380 223 226
		hidehighlight
		highlight color "G"
		focus color "Y"

		action
		"
			setQuestViewed(selectedQuest)
		"
	}
	button
	{
		area 589 634 89 30	
		name "JIW4"	
		bam	"g-btcza"
		sequence 0
		enabled "const.JOURNAL_MODE_QUESTS"
		text "BUTTON_ASSIGNED"
		text style "buttonczacha"
		glow lua "currentQuestType == const.ENTRY_TYPE_INPROGRESS"
		action
		"
			currentQuestType = const.ENTRY_TYPE_INPROGRESS
			selectedQuest = nil
		"
	}
	button
	{
		area 724 634 88 30
		name "JIW5"		
		bam	"g-btcza"
		sequence 1
		enabled "const.JOURNAL_MODE_QUESTS"
		text "BUTTON_COMPLETED"
		text style "buttonczacha"
		glow lua "currentQuestType == const.ENTRY_TYPE_COMPLETE"
		action
		"
			currentQuestType = const.ENTRY_TYPE_COMPLETE
			selectedQuest = nil
		"
	}
	text
	{
		enabled "const.JOURNAL_MODE_QUESTS and quests[selectedQuest] ~= nil"
		area 830 364 208 276
		name "JIW6"
		text style "white_parchment"
		text lua "getEntryText(selectedQuest)"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	label
	{
		enabled "const.JOURNAL_MODE_QUESTS"
		area 598 606 185 14
		name "JIW7"
		text "ENTER_SEARCH_TERM_NORMAL"
		text style "label"
		text font "exocet"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	label
	{
		enabled "const.JOURNAL_MODE_QUESTS"
		name "JIW8"
		area 612 620 165 13
		fill 0 0 0 200
		
	}
	edit
	{
		enabled "const.JOURNAL_MODE_QUESTS"
		area 612 620 165 13
		name "JIW9"
		var journalSearchString
		text style "edit"
		maxlines 1
		action
		"
			selectedQuest = nil
			journalCheckScroll = 1
			return 1 --need to return 1 since this action is technically a filter.
		"
	}
	label
	{	
		area 644 350 174 24
		name "JIW10"
		text lua "Infinity_FetchString(69053)"
		text style "label"
		text font "exocet"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	button
	{
		area 598 276 60 88
		name "JIW11"
		bam 'g-btzak'
		sequence 4
		tooltip lua ""
		action 
		"
			Infinity_PushMenu('JOURNAL_IW')
			Infinity_PopMenu('JOURNAL_IW_MODE')
			Infinity_PopMenu('JOURNAL_IW_BESTIARY')
		"
	}
	button
	{
		area 846 268 52 100
		name "JIW12"
		bam 'g-btzak'
		sequence 2
		tooltip lua ""
		action 
		"
			
				Infinity_PushMenu('JOURNAL_IW_MODE')
				Infinity_PopMenu('JOURNAL_IW_BESTIARY')
			
		"
	}
	button
	{
		area 734 292 49 72
		name "JIW13"
		bam 'g-btzak'
		sequence 1
		tooltip lua ""
		action 
		"
			
				Infinity_PushMenu('JOURNAL_IW_BESTIARY')
			
		"
	}
	--button
	--{
	--	area 512 476 72 36
		--name "JIW14"
		--bam 'g-btzak'
		--sequence 3
		--tooltip lua ""
		--action 
		--"
		--	Infinity_PopMenu('JOURNAL_IW')
		--	Infinity_PopMenu('JOURNAL_IW_MODE')
		--	Infinity_PopMenu('JOURNAL_IW_BESTIARY')
		--"
	--}
	button
	{
		area 998 298 36 36
		bam "XBUTT"
		sequence 3
		action 
		"
			Infinity_PopMenu('JOURNAL_IW')
			Infinity_PopMenu('JOURNAL_IW_MODE')
			Infinity_PopMenu('JOURNAL_IW_BESTIARY')
		"
	}
}
menu
{
	name 'JOURNAL_IW_MODE'
	align center center
	ignoreEsc
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	interactable lua "characters[id].HP.current > 0"
	
	onOpen 
	"	
	journalScrollToBottom = 1	
	"
	onClose 
	"	Infinity_PopMenu( );
		pushSidebars()
	"
	handle
	{
		name "JIWHandleDrag"
		area 1154 -391 58 52
		actionDrag "dragJIWX(motionX), dragJIWY(motionY)"
	}
	label
	{
		area 570 332 498 342
		name "JIW15"
		mosaic "g-btpos"
	}
	list --journal2
	{
		column
		{
			width 100
			label
			{
				enabled "getJournalEntryEnabled(rowNumber)"
				name "JIW16"
				area 0 0 -1 -1
				pad 8 16 16 16
				text lua "getJournalEntryText(rowNumber)"
				text style "jiw"
				text color lua "getBLACKCOLOR(rowNumber)"
				text highlight 1
			}
		}
		enabled "const.JOURNAL_MODE_JOURNAL"
		rowheight	dynamic
		hidehighlight
		scrollbar func "journalScroll"
		

		table		"journalDisplay"
		var			selectedJournal
		scrollbar	'g-btsl1'
		area		588 362 224 258
	}
	label
	{
		enabled "const.JOURNAL_MODE_QUESTS"
		area 598 626 185 14
		text "ENTER_SEARCH_TERM_NORMAL"
		text style "label"
		text font "exocet"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	label
	{
		enabled "const.JOURNAL_MODE_JOURNAL"
		area 612 640 165 13
		fill 0 0 0 200
		
	}
	edit
	{
		enabled "const.JOURNAL_MODE_JOURNAL"
		area 612 640 165 13
		var journalSearchString
		text style "edit"
		maxlines 1
		action
		"
			selectedQuest = nil
			journalCheckScroll = 1
			return 1 --need to return 1 since this action is technically a filter.
		"
	}
}
menu
{
	name 'JOURNAL_IW_BESTIARY'
	align center center
	ignoreEsc
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	interactable lua "characters[id].HP.current > 0"
	
	onOpen
	"
	selectedBestiaryCreature = nil
	checkForKnownBestiaryNPC()
	pushSidebars()
	"
	onClose "pushSidebars()"
	handle
	{
		name "JIWHandleDrag"
		area 1008 268 58 52
		actionDrag "dragJIWX(motionX), dragJIWY(motionY)"
	}
	label
	{
		area 478 334 588 336
		name "JIW17"
		mosaic "g-btbs2"
	}
	list
	{
		column
		{
			width 100
			label
			{
				area 0 0 -1 -1
				enabled "getBestiaryEnabled(rowNumber)"
				name "JIW18"
				text lua "Infinity_FetchString(bestiary[rowNumber].name)"
				text style "normal_parchment"
				text color lua "getBLACKCOLOR(rowNumber)"
				text highlight 1
			}
		}
		enabled "const.JOURNAL_MODE_BESTIARY"
		rowheight dynamic
		area 496 366 78 284
		table "bestiary"
		var	selectedBestiaryCreature
		scrollbar 'g-btsl1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}
	
	label
	{
		area 600 360 202 298
		name "JIW20"
		enabled "const.JOURNAL_MODE_BESTIARY"
		bam lua "getBestiaryImage2()"
	}
	text
	{
		area 832 360 216 244
		enabled "const.JOURNAL_MODE_BESTIARY"
		name "JIW21"
		text lua "getBestiaryDesc()"
		text style "normal_parchment"
		text color lua "getBLACKCOLOR(rowNumber)"
		scrollbar	'g-btsl1'
	}
	button
	{
		area 964 616 68 38
		enabled "const.JOURNAL_MODE_BESTIARY"
		name "JIW22"
		text "BUTTON_NPC"
		text style "button"
		bam "g-btbn"
		sequence 1
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_NPC
			selectedBestiaryCreature = nil
		"
	}
	button
	{
		area 840 616 74 38
		enabled "const.JOURNAL_MODE_BESTIARY"
		name "JIW23"
		text "BUTTON_PC"
		text style "button"
		bam "g-btbn"
		sequence 2
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_PC
			selectedBestiaryCreature = nil
		"
	}
	--button
	--{
		--area 422 474 74 42
		--bam 'g-btzak'
		--name "JIW24"
		--sequence 3
		--tooltip lua ""
		--action 
		--"
			--Infinity_PopMenu('JOURNAL_IW')
			--Infinity_PopMenu('JOURNAL_IW_MODE')
			--Infinity_PopMenu('JOURNAL_IW_BESTIARY')
		--"
	--}
}






menu
{
	name 'JOURNAL_NEW'
	align center center
	ignoreEsc
	size 1024 768
	onOpen
	" 	
		popSidebars()
		Infinity_SetBackground('BACKGROUND_JOURNAL_NEW')
		Infinity_PopMenu('JOURNAL_NEW_ORIGINAL')
		
	"
	onClose
	"
		pushSidebars()
	"
	label
	{
		area 128 138 750 499
		mosaic "g-btque"
	}
	list
	{
		column { 
			width 100
			label
			{	
			enabled "questEnabled(rowNumber)"
				area 0 0 -1 -1
				text lua "getQuestText(rowNumber)"
				text style "jshared"
				text color lua "getQuestColor2(rowNumber)"
				align left center
				text highlight 1
				indent 1
				pad 0 0 0 0
			}
		}
		enabled "const.JOURNAL_MODE_QUESTS"
		rowheight	dynamic
		table		"quests"
		var			selectedQuest
		scrollbar	'g-btsl1'
		area		158 224 329 332
		hidehighlight
		highlight color "Y"
		focus color "Y"

		action
		"
			setQuestViewed(selectedQuest)
		"
	}
	button
	{
		area 154 578 95 34		
		bam	"g-btcza"
		sequence 0
		enabled "const.JOURNAL_MODE_QUESTS"
		text "BUTTON_ASSIGNED"
		text style "buttonczacha"
		glow lua "currentQuestType == const.ENTRY_TYPE_INPROGRESS"
		action
		"
			currentQuestType = const.ENTRY_TYPE_INPROGRESS
			selectedQuest = nil
		"
	}
	button
	{
		area 384 578 95 34		
		bam	"g-btcza"
		sequence 1
		enabled "const.JOURNAL_MODE_QUESTS"
		text "BUTTON_COMPLETED"
		text style "buttonczacha"
		glow lua "currentQuestType == const.ENTRY_TYPE_COMPLETE"
		action
		"
			currentQuestType = const.ENTRY_TYPE_COMPLETE
			selectedQuest = nil
		"
	}
	text
	{
		enabled "const.JOURNAL_MODE_QUESTS and quests[selectedQuest] ~= nil"
		area 530 201 302 404
		text style "jshared"
		text lua "getEntryText(selectedQuest)"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 222 560 185 14
		text "ENTER_SEARCH_TERM_NORMAL"
		text style "label"
		text font "exocet"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 258 590 114 15
		fill 0 0 0 200
		
	}
	edit
	{
		enabled "searchBoxEnabled()"
		area 258 590 114 15
		var journalSearchString
		text style "edit"
		maxlines 1
		action
		"
			selectedQuest = nil
			journalCheckScroll = 1
			return 1 --need to return 1 since this action is technically a filter.
		"
	}
	label
	{	
		area 258 172 232 36
		text lua "Infinity_FetchString(69053)"
		text style "label"
		text font "exocet"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	button
	{
		area 172 62 94 120
		bam "g-btzak"
		sequence 0
		tooltip lua "Quests"
		action 
		"
			
			Infinity_PushMenu('JOURNAL_NEW')
			Infinity_PopMenu('JOURNAL_NEW_BESTIARY')
			
		"
	}
	button
	{
		area 548 74 72 103
		bam "g-btzak"
		sequence 2
		tooltip lua "Time"
		action 
		"
			
			Infinity_PushMenu('JOURNAL_NEW_MODE')
			Infinity_PopMenu('JOURNAL_NEW_BESTIARY')
			
		"
	}
	button
	{
		area 376 69 82 108
		bam "g-btzak"
		sequence 1
		tooltip lua "Bestiary"
		action 
		"
			Infinity_PushMenu('JOURNAL_NEW_BESTIARY')
			
		"
	}
	button
	{
		area 1034 18 84 32
		text "JOURNAL_BUTTON"
		text style "button"
		tooltip "JOURNAL_TOOLTIP"
		bam "jrnbutt"
		sequence 5
		action 
		"
			Infinity_PushMenu('JOURNAL_NEW_ORIGINAL')
	
			
		"
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
}
menu
{
	name 'JOURNAL_NEW_MODE'
	align center center
	ignoreEsc
	size 1024 768
	
	onOpen 
	"
		popSidebars()
		
	journalScrollToBottom = 1
	"
	onClose 
	"	
		pushSidebars()
	"
	label
	{
		area 128 138 750 499
		mosaic "g-btpos"
	}
	label
	{
		enabled "const.JOURNAL_MODE_JOURNAL"
		area 176 602 284 15
		fill 0 0 0 200
		
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 224 586 185 16
		text "ENTER_SEARCH_TERM_NORMAL"
		text style "label"
		text font "exocet"
		text color lua "getBLACKCOLOR(rowNumber)"
	}
	edit
	{
		enabled "const.JOURNAL_MODE_JOURNAL"
		area 176 602 284 15
		var journalSearchString
		text style "edit"
		maxlines 1
		action
		"
			selectedQuest = nil
			journalCheckScroll = 1
			return 1 --need to return 1 since this action is technically a filter.
		"
	}
	list --journal3
	{
		column
		{
			width 100
			label
			{
				enabled "getJournalEntryEnabled(rowNumber)"
				area 0 0 -1 -1
				pad 8 16 16 16
				text lua "getJournalEntryText(rowNumber)"
				text style "jshared"
				text color lua "getBLACKCOLOR(rowNumber)"
				text highlight 1
			}
		}
		enabled "const.JOURNAL_MODE_JOURNAL"
		rowheight	dynamic
		hidehighlight
		scrollbar func "journalScroll"
		

		table		"journalDisplay"
		var			selectedJournal
		scrollbar	'g-btsl1'
		area		150 188 346 402
	}
}
menu
{
	name 'JOURNAL_NEW_BESTIARY'
	align center center
	ignoreEsc
	size 1024 768
	
	onOpen
	"
	popSidebars()
		
	journalScrollToBottom = 1
	selectedBestiaryCreature = nil
	checkForKnownBestiaryNPC()
	showButton = false
	"
	
	label
	{
		area -14 138 893 499
		mosaic 'g-btbs2'
	}
	list
	{
		column
		{
			width 100
			label
			{
				area 0 0 -1 -1
				enabled "getBestiaryEnabled(rowNumber)"
				text lua "Infinity_FetchString(bestiary[rowNumber].name)"
				text style "normal_parchment"
				text color lua "getBLACKCOLOR(rowNumber)"
				text highlight 1
			}
		}
		enabled "const.JOURNAL_MODE_BESTIARY"
		rowheight dynamic
		area 14 186 114 433
		table "bestiary"
		var	selectedBestiaryCreature
		scrollbar 'g-btsl1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}
	
	label
	{
		area 186 194 255 400
		enabled "const.JOURNAL_MODE_BESTIARY"
		bam lua "getBestiaryImage2()"
	}
	text
	{
		area 532 190 304 380
		enabled "const.JOURNAL_MODE_BESTIARY"
		text lua "getBestiaryDesc()"
		text style "jshared"
		text color lua "getBLACKCOLOR(rowNumber)"
		scrollbar	'g-btsl1'
	}
	button
	{
		area 716 570 88 49
		enabled "const.JOURNAL_MODE_BESTIARY"
		text "BUTTON_NPC"
		text style "button"
		bam "g-btbn"
		sequence 1
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_NPC
			selectedBestiaryCreature = nil
		"
	}
	button
	{
		area 566 570 87 49
		enabled "const.JOURNAL_MODE_BESTIARY"
		text "BUTTON_PC"
		text style "button"
		bam "g-btbn"
		sequence 2
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_PC
			selectedBestiaryCreature = nil
		"
	}
}
menu
{ 
	name 'JOURNAL_NEW_ORIGINAL'
	align center center
	ignoreEsc
	size 1024 768
	onopen "
		buildJournalDisplay()
		chapter = 0
		selectedBestiaryCreature = nil
		Infinity_SetBackground('BACKGROUND_JOURNAL')
		popSidebars()
		selectedQuest = nil
		journalScrollToBottom = 1
		checkForKnownBestiaryNPC()
		Infinity_PopMenu('JOURNAL_NEW')
		Infinity_PopMenu('JOURNAL_NEW_MODE')
		Infinity_PopMenu('JOURNAL_NEW_BESTIARY')
		popSidebars()
		"
	onclose
	"	
		Infinity_SetBackground('BACKGROUND_JOURNAL_NEW')
		
		
	"
	button
	{
		area 680 21 103 63
		text "JOURNAL_BUTTON"
		text style "button"
		action "journalMode = const.JOURNAL_MODE_JOURNAL"
		glow lua "journalMode == const.JOURNAL_MODE_JOURNAL"
		bam "jrnbutt"
	}
	button
	{
		area 565 22 103 63
		text "QUESTS_BUTTON"
		text style "button"
		action "journalMode = const.JOURNAL_MODE_QUESTS"
		glow lua "journalMode == const.JOURNAL_MODE_QUESTS"
		bam "jrnbutt"
	}
	button
	{
		area 796 21 103 63
		text "BESTIARY_BUTTON"
		text style "button"
		action "journalMode = const.JOURNAL_MODE_BESTIARY"
		glow lua "journalMode == const.JOURNAL_MODE_BESTIARY"
		bam "jrnbutt"
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
	button
	{
		area 820 568 163 163
		text "DONE_BUTTON"
		text style "button"
		bam "jrndone"
		on escape
		action 
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
	button
	{
		area 1042 12 84 32
		text "JOURNAL_BUTTON"
		text style "button"
		tooltip "JOURNAL_TOOLTIP"
		bam "jrnbutt"
		sequence 5
		action 
		"
			Infinity_PushMenu('JOURNAL_NEW')
		"
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 107 629 316 18
		text "ENTER_SEARCH_TERM_NORMAL"
		text style "label"
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 107 659 316 25
		fill 0 0 0 200
		
	}
	edit
	{
		enabled "searchBoxEnabled()"
		area 110 662 309 18
		var journalSearchString
		text style "edit"
		maxlines 1
		action
		"
			selectedQuest = nil
			journalCheckScroll = 1
			return 1 --need to return 1 since this action is technically a filter.
		"
	}
	list
	{
		column { 
			width 100
			label
			{	
				enabled "questEnabled(rowNumber)"
				area 8 0 -1 -1
				text lua "getQuestText(rowNumber)"
				text style "label"
				text color lua "getQuestColor(rowNumber)"
				align left center
				text highlight 1
				indent 1
				pad 0 0 32 0
			}
		}
		enabled "journalMode == const.JOURNAL_MODE_QUESTS"
		rowheight	dynamic
		table		"quests"
		var			selectedQuest
		scrollbar	'cgscrl1'
		area		84 54 411 504
		hidehighlight
		highlight color "Y"
		focus color "Y"

		action
		"
			setQuestViewed(selectedQuest)
		"
		
	}
	button
	{
		area 527 526 138 56		
		bam	NORMBUTT
		enabled "journalMode == const.JOURNAL_MODE_QUESTS"
		text "BUTTON_ASSIGNED"
		text style "button"
		glow lua "currentQuestType == const.ENTRY_TYPE_INPROGRESS"
		action
		"
			currentQuestType = const.ENTRY_TYPE_INPROGRESS
			selectedQuest = nil
		"
	}
	button
	{
		area 683 526 138 56		
		bam	NORMBUTT
		enabled "journalMode == const.JOURNAL_MODE_QUESTS"
		text "BUTTON_COMPLETED"
		text style "button"
		glow lua "currentQuestType == const.ENTRY_TYPE_COMPLETE"
		action
		"
			currentQuestType = const.ENTRY_TYPE_COMPLETE
			selectedQuest = nil
		"
	}
	text
	{
		enabled "journalMode == const.JOURNAL_MODE_QUESTS and quests[selectedQuest] ~= nil"
		area 536 108 406 366
		text style "white_parchment"
		text lua "getEntryText(selectedQuest)"
	}
	
	list --journal
	{
		column
		{
			width 100
			label
			{
				enabled "getJournalEntryEnabled(rowNumber)"
				area 0 0 -1 -1
				pad 8 16 16 16
				text lua "getJournalEntryText(rowNumber)"
				text style "normal"
				text color 'B'
				text highlight 1
			}
		}
		enabled "journalMode == const.JOURNAL_MODE_JOURNAL"
		seperator "getJournalEntryEnabled(rowNumber)"
		rowheight	dynamic
		hidehighlight
		scrollbar func "journalScroll"

		table		"journalDisplay"
		var			selectedJournal
		scrollbar	'cgscrl1'
		area		78 54 417 504
	}
	label
	{
		enabled "journalMode == const.JOURNAL_MODE_JOURNAL"
		area 588 126 299 328
		mosaic "JRNLOP"
	}
	list
	{
		column
		{
			width 100
			label
			{
				area 0 0 -1 -1
				enabled "getBestiaryEnabled(rowNumber)"
				text lua "Infinity_FetchString(bestiary[rowNumber].name)"
				text style "label_parchment"
				text highlight 1
			}
		}
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		rowheight dynamic
		area 522 97 430 188
		table "bestiary"
		var	selectedBestiaryCreature
		scrollbar 'cgscrl1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}

	label
	{
		area 107 79 316 492
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		mosaic lua "getBestiaryImage()"
		align center center
	}
	text
	{
		area 532 306 420 174
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		text lua "getBestiaryDesc()"
		text style "normal_parchment"
		scrollbar	'cgscrl1'
	}
	button
	{
		area 683 526 103 63
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		glow lua "currentBestiaryClass == const.BESTIARY_CLASS_NPC"
		text "BUTTON_NPC"
		text style "button"
		bam "jrnbutt"
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_NPC
			selectedBestiaryCreature = nil
		"
	}
	button
	{
		area 562 526 103 63
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		glow lua "currentBestiaryClass == const.BESTIARY_CLASS_PC"
		text "BUTTON_PC"
		text style "button"
		bam "jrnbutt"
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_PC
			selectedBestiaryCreature = nil
		"
	}
}

menu
{
	name 'BACKGROUND_STORE'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'STRBG'
	}
}
menu
{
	name 'BACKGROUND_STORE_2'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'STRBG2'
	}
}
menu
{
	name 'BACKGROUND_WIRES'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'WIRESBG'
	}
}menu
{
	name 'BACKGROUND_OPTIONS'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'optbg'
	}
}
menu
{
	name 'BACKGROUND_SAVELOAD'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'LOADBG'
	}
}
`
	function journalBackground()
		if(journalMode == const.JOURNAL_MODE_BESTIARY) then
			return "BEASTBG"
		else
			return "JRNBG"
		end
	end
`
--szef_journals_back

menu
{
	name 'BACKGROUND_JOURNAL'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic lua "journalBackground()"
	}
}
menu 
{
	name 'BACKGROUND_JOURNAL_NEW'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic "g-btlaw"
	}
}
menu
{
	name 'BACKGROUND_MAP'
	align center center
	size 1366 768
	onOpen
	"showButton = false"
	label
	{
		area 1366 0 3000 768
		fill 0 0 0 255
	}
	label
	{
		area -3000 0 3000 768
		fill 0 0 0 255
	}
	label
	{
		area 0 0 1366 768
		mosaic 'MAPBG'
	}
}

--szef_back_dialogs

menu
{
	name 'BACKGROUND_DIALOG'
	offset 0 0
	align center bottom
	exclusiveFocus
	ignoreEsc
	size 1366 298
	
	label
	{
		area 988 26 1497 297
		mosaic "convwing"
	}
	label
	{
		area -1050 26 1497 297
		mosaic "convwing"
	}
	label
	{
		name "worldDialogBackground"
		area 0 0 1366 298
		mosaic "DIABG"
	}
	button
	{
		area 612 245 136 43
		bam		widebutt
		text lua "getDialogButtonText()"
		enabled "getDialogButtonEnabled()"
		clickable lua "getDialogButtonClickable()"		
		text style "button"
		text point 16
		action 
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on return
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on escape
		action
		"
			onDialogButtonClick()
		"
	}
	label
	{
		area 879 244 42 44
		text lua "game:GetPartyGold()"
		text style "gold"
	}
	label
	{
		area 923 244 54 44
		mosaic icgoldf
	}
	
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getDialogEntryText(rowNumber)"
				text style "normal"
				text highlight 1
				indent 1
			}
		}
		name "worldPlayerDialogChoicesList"
		area 397 24 580 204
		rowheight dynamic
		table "dialogTable"
		var "worldPlayerDialogSelection"
		scrollbar	'CGSCRL1'
		scrollbar func "chatboxScroll"
		hideHighlight
		scrollbar force 1
		ignoreFocus 1

		actionEnter
		"
			if(gameOptions.m_bConfirmDialog == true) then return end
			if(not dialogTable[mouseoverRow] or not getDialogRowClickable(mouseoverRow)) then 
				--non-interactive row.
				glowTest = nil
				worldPlayerDialogSelection = nil
				return
			end
			glowTest = mouseoverRow
			worldPlayerDialogSelection = mouseoverRow
		"
		actionExit
		"	
			if(gameOptions.m_bConfirmDialog == true) then return end
			glowTest = nil
			worldPlayerDialogSelection = 0
		"
		action
		"
			chatboxScrollToBottom = 0
			--In confirm mode, just highlight the choice.
			if(gameOptions.m_bConfirmDialog == true) then 
				if (not getDialogRowClickable(worldPlayerDialogSelection)) then
					--clear the selection
					worldPlayerDialogSelection = 0
				end
				return 
			end
			if(not getDialogRowClickable(worldPlayerDialogSelection)) then return end
			worldScreen:OnDialogReplyClick(dialogTable[worldPlayerDialogSelection].marker)
			worldPlayerDialogSelection = 0
		"
		actiondbl
		"
			--consume the second click. we want to avoid double clicking accidently stopping the scroll.
		"
	}

}
menu 
{
	name 'PORTRAITS_BACKGROUND_DIALOG'
	offset 0 0
	align center bottom
	exclusiveFocus
	ignoreEsc
	size 1366 298
	
	label
	{
		area 988 26 1497 297
		mosaic "convwing"
	}
	label
	{
		area -1050 26 1497 297
		mosaic "convwing"
	}
	label
	{
		name "worldDialogBackground"
		area 0 0 1366 298
		mosaic "DIABG"
	}
	button
	{
		area 612 245 136 43
		bam		widebutt
		text lua "getDialogButtonText()"
		enabled "getDialogButtonEnabled()"
		clickable lua "getDialogButtonClickable()"		
		text style "button"
		text point 16
		action 
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on return
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on escape
		action
		"
			onDialogButtonClick()
		"
	}
	label
	{
		area 879 244 42 44
		text lua "game:GetPartyGold()"
		text style "gold"
	}
	label
	{
		area 923 244 54 44
		mosaic icgoldf
	}
	
	-- SMEAGOL	
	label
	{
		area 217 28 158 246
		mosaic default
		align center bottom
	}
	label
	{
		name "worldDialogPortraitArea"
		area 217 28 158 246
		bitmap lua "worldNPCDialogPortrait"
		align center bottom
	}	
	label
	{
		area 207 18 182 270
		mosaic S9frame
		align center top
	}
	-- SMEAGOL
	
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getDialogEntryText(rowNumber)"
				text style "normal"
				text highlight 1
				indent 1
			}
		}
		name "worldPlayerDialogChoicesList"
		area 397 24 580 204
		rowheight dynamic
		table "dialogTable"
		var "worldPlayerDialogSelection"
		scrollbar	'CGSCRL1'
		scrollbar func "chatboxScroll"
		hideHighlight
		scrollbar force 1
		ignoreFocus 1

		actionEnter
		"
			if(gameOptions.m_bConfirmDialog == true) then return end
			if(not dialogTable[mouseoverRow] or not getDialogRowClickable(mouseoverRow)) then 
				--non-interactive row.
				glowTest = nil
				worldPlayerDialogSelection = nil
				return
			end
			glowTest = mouseoverRow
			worldPlayerDialogSelection = mouseoverRow
		"
		actionExit
		"	
			if(gameOptions.m_bConfirmDialog == true) then return end
			glowTest = nil
			worldPlayerDialogSelection = 0
		"
		action
		"
			chatboxScrollToBottom = 0
			--In confirm mode, just highlight the choice.
			if(gameOptions.m_bConfirmDialog == true) then 
				if (not getDialogRowClickable(worldPlayerDialogSelection)) then
					--clear the selection
					worldPlayerDialogSelection = 0
				end
				return 
			end
			if(not getDialogRowClickable(worldPlayerDialogSelection)) then return end
			worldScreen:OnDialogReplyClick(dialogTable[worldPlayerDialogSelection].marker)
			worldPlayerDialogSelection = 0
		"
		actiondbl
		"
			--consume the second click. we want to avoid double clicking accidently stopping the scroll.
		"
	}
}
menu
{
	name 'SDB_BACKGROUND_DIALOG'
	offset 0 0
	align center center
	exclusiveFocus
	ignoreEsc
	size 1366 768
	--SMEAGOL
	label
    {
        area 769 150 122 190
        mosaic default
        align center bottom
    }
    label
    {
        name "worldDialogPortraitArea"
        area 769 150 122 190
        bitmap lua "worldNPCDialogPortrait"
        align center bottom
    }
	--SMEAGOL
	 label
    {
        name "worldDialogBackground"
        area 745 0 570 762
        mosaic "g-btsdb"
    }
	button
	{
		area 906 710 136 46
		text lua "getDialogButtonText()"
		enabled "getDialogButtonEnabled()"
		clickable lua "getDialogButtonClickable()"		
		text style "button"
		text point 16
		action 
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on return
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on escape
		action
		"
			onDialogButtonClick()
		"
	}
	label
	{
		align center center
		area 125 620 80 80
		mosaic "g-btmed"
	}
	label
	{
		area 100 650 133 133
		text lua "game:GetPartyGold()"
		text style	title
		text font "exocet"
	}
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getDialogEntryText2(rowNumber)"
				text style "normal2"
				text highlight 1
				indent 1
			}
		}
		name "worldPlayerDialogChoicesList"
		area 920 92 326 602
		rowheight dynamic
		table "dialogTable"
		var "worldPlayerDialogSelection"
		scrollbar	"g-btsl1"
		scrollbar func "chatboxScroll2"
		hideHighlight
		scrollbar force 1
		ignoreFocus 1
	

		actionEnter
		"	
			if(gameOptions.m_bConfirmDialog == true) then return end
			if(not dialogTable[mouseoverRow] or not getDialogRowClickable(mouseoverRow)) then
				--non-interactive row.
				glowTest = nil
				worldPlayerDialogSelection = nil
				return
			end
			glowTest = mouseoverRow
			worldPlayerDialogSelection = mouseoverRow
			
		"
		actionExit
		"	
			if(gameOptions.m_bConfirmDialog == true) then return end
			glowTest = nil
			worldPlayerDialogSelection = 0
		"
		action --proba
		"
			chatboxScrollToBottom = 0
			-- setDlgResponsesColor(worldPlayerDialogSelection)
			--In confirm mode, just highlight the choice.
			if(gameOptions.m_bConfirmDialog == true) then
				if (not getDialogRowClickable) then
					--clear the selection
					worldPlayerDialogSelection = 0

				end
				return 
			end
			if(not getDialogRowClickable(worldPlayerDialogSelection)) then return end
			worldScreen:OnDialogReplyClick(dialogTable[worldPlayerDialogSelection].marker)
			worldPlayerDialogSelection = 0
		"
		actiondbl
		"
			--consume the second click. we want to avoid double clicking accidently stopping the scroll.
		"
	}
}

menu
{
	name 'ALT_BOTTOM_BACKGROUND_DIALOG'
	offset 0 0
	align center center
	exclusiveFocus
	ignoreEsc
	size 1366 768
	--SMEAGOL
	label
    {
        area 284 464 86 122
        mosaic default
        align center bottom
    }
    label
    {
        name "worldDialogPortraitArea"
        area 284 464 86 122
        bitmap lua "worldNPCDialogPortrait"
        align center bottom
    }
	--SMEAGOL
	 label
    {
        name "worldDialogBackground"
        area 284 464 728 292
        mosaic "test0"
    }
	button
	{
		area 906 710 136 46
		text lua "getDialogButtonText()"
		enabled "getDialogButtonEnabled()"
		clickable lua "getDialogButtonClickable()"
		text style "button"
		text point 16
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on return
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on escape
		action
		"
			onDialogButtonClick()
		"
	}
	label
	{
		align center center
		area 125 620 80 80
		mosaic "g-btmed"
	}
	label
	{
		area 100 650 133 133
		text lua "game:GetPartyGold()"
		text style	title
		text font "exocet"
	}
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getDialogEntryText3(rowNumber)"
				text style "normal3"
				text highlight 1
				indent 1
			}
		}
		name "worldPlayerDialogChoicesList"
		area 370 474 544 240
		rowheight dynamic
		table "dialogTable"
		var "worldPlayerDialogSelection"
		scrollbar	"g-btsl1"
		scrollbar func "chatboxScroll"
		hideHighlight
		scrollbar force 1
		ignoreFocus 1


		actionEnter
		"
			if(gameOptions.m_bConfirmDialog == true) then return end
			if(not dialogTable[mouseoverRow] or not getDialogRowClickable(mouseoverRow)) then
				--non-interactive row.
				glowTest = nil
				worldPlayerDialogSelection = nil
				return
			end
			glowTest = mouseoverRow
			worldPlayerDialogSelection = mouseoverRow

		"
		actionExit
		"
			if(gameOptions.m_bConfirmDialog == true) then return end
			glowTest = nil
			worldPlayerDialogSelection = 0
		"
		action -- proba
		"
			chatboxScrollToBottom = 0
			--In confirm mode, just highlight the choice.
			if(gameOptions.m_bConfirmDialog == true) then
				if (not getDialogRowClickable) then
					--clear the selection
					worldPlayerDialogSelection = 0

				end
				return
			end
			if(not getDialogRowClickable(worldPlayerDialogSelection)) then return end
			worldScreen:OnDialogReplyClick(dialogTable[worldPlayerDialogSelection].marker)
			worldPlayerDialogSelection = 0
		"
		actiondbl
		"
			--consume the second click. we want to avoid double clicking accidently stopping the scroll.
		"
	}
}


menu
{
	name 'TTON_BACKGROUND_DIALOG'
	offset 0 0
	align center bottom
	exclusiveFocus
	ignoreEsc
	size 1366 768
	--SMEAGOL
	label
    {
        area 217 511 155 214
        mosaic default
        align center bottom
    }
    label
    {
        name "worldDialogPortraitArea"
        area 217 532 155 214
        bitmap lua "worldNPCDialogPortrait"
        align center bottom
    }
	--SMEAGOL
	 label
    {
        name "worldDialogBackground"
        area 153 463 1060 305
        mosaic "g-btton"
    }
	button
	{
		area 474 726 98 38
		text lua "getDialogButtonText()"
		enabled "getDialogButtonEnabled()"
		clickable lua "getDialogButtonClickable()"
		text style "button"
		text point 15
		bam "g-btbut"
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on return
		action
		"
			onDialogButtonClick()
		"
	}
	button
	{
		area 0 0 0 0
		enabled "getDialogButtonEnabled() and getDialogButtonClickable()"
		on escape
	action
		"
			onDialogButtonClick()
		"
	}
	label
	{
		area 252 717 78 25
		text lua "game:GetPartyGold()"
		text style	"gold"
		text font "exocet"
	}
	list
	{
		column
		{
			width 100
			text
			{
				area 0 0 -1 -1
				text lua "getDialogEntryText3(rowNumber)"
				text style "normal2"
				text highlight 1
				indent 1
			}
		}
		name "worldPlayerDialogChoicesList"
		area 460 500 712 217
		rowheight dynamic
		table "dialogTable"
		var "worldPlayerDialogSelection"
		scrollbar	"g-btsl1"
		scrollbar func "chatboxScroll2"
		hideHighlight
		scrollbar force 1
		ignoreFocus 1
	

		actionEnter
		"
			if(gameOptions.m_bConfirmDialog == true) then return end
			if(not dialogTable[mouseoverRow] or not getDialogRowClickable(mouseoverRow)) then
				--non-interactive row.
				glowTest = nil
				worldPlayerDialogSelection = nil
				return
			end
			glowTest = mouseoverRow
			worldPlayerDialogSelection = mouseoverRow
		"
		actionExit
		"
			if(gameOptions.m_bConfirmDialog == true) then return end
			glowTest = nil
			worldPlayerDialogSelection = 0
		"
		action
		"
			chatboxScrollToBottom = 0
			 --In confirm mode, just highlight the choice.
			if(gameOptions.m_bConfirmDialog == true) then
				if (not getDialogRowClickable(worldPlayerDialogSelection)) then
					--clear the selection
					worldPlayerDialogSelection = 0
				end
				return
			end
			if(not getDialogRowClickable(worldPlayerDialogSelection)) then return end
			worldScreen:OnDialogReplyClick(dialogTable[worldPlayerDialogSelection].marker)
			worldPlayerDialogSelection = 0
		"
		actiondbl
		"
			consume the second click. we want to avoid double clicking accidently stopping the scroll.
		"
	}
}


menu
{
	name 'BACKGROUND_CONTAINER'
	align center bottom
	label
	{
		area 0 0 1366 80
		mosaic CONBG
	}
}
menu
{
	name 'BACKGROUND_PICKPARTY'
	align center bottom
	size 1366 87
	label
	{
		area 0 0 1366 87
		mosaic REFBG
	}
	label
	{
		area 994 0 1404 87
		mosaic "mainwing"
	}
	label
	{
		area -1045 0 1404 87
		mosaic "mainwing"
	}
}
menu
{
	name 'BACKGROUND_WELCOME'
	align center center
	label
	{
		area 0 0 1366 768
		mosaic 'WELCSCRN'
	}
}

`
function proficiencyOrGeneralHelp()
	local prof = chargen.proficiency[currentChargenProficiency]
	local skill = chargen.thief_skill[currentChargenThiefSkill]
	if prof and prof.desc ~= -1 then
		return Infinity_FetchString(prof.desc)
	elseif skill and skill.desc ~= -1 then
		return Infinity_FetchString(skill.description)
	else
		if(chargen.levelingUp) then
			if(levelUpInfoToggle == 1) then
				return chargen.charInfo
			else
				return chargen.levelInfo
			end
		else
		return Infinity_FetchString(24315)
	end
	end
end

function getProficienciesTitle()
	if(chargen.levelingUp) then
		return t("LEVEL_UP_TITLE")
	else
		return t("CHARGEN_TITLE")
	end
end

function isChargenProficienciesBackButtonClickable()
	return ((not chargen.levelingUp) and createCharScreen:GetCurrentStep() ~= const.STEP_DUALCLASS_PROFICIENCIES)
end

function shouldShowSkillButtons()
	return chargen.thief_skill[1] ~= nil
end
`

menu
{
	name 'CHARGEN_PROFICIENCIES'
	modal
	align center center
	ignoreesc
	popupSound 1
	onopen "currentChargenProficiency = nil; currentChargenThiefSkill = nil; ticksPassed = 0; ticksStarting = 0"
	label
	{
		area 0 0 862 630
		mosaic "lvlbg"
		
	}
	label
	{
		area 338 54 457 47
		text style "title"
		text font "exocet"
		text "LEVEL_UP_TITLE"
	}
	label
	{
		area 572 308 220 24
		text "SKILLS_LABEL"
		text style "label"
		text align center center
	}
	label
	{
		area 334 308 224 24
		text "SAVING_THROWS_LABEL"
		text style "label"
		text align center center
	}
	label
	{
		area 591 332 116 20
		text "POINTS_REMAINING_LABEL"
		text style "normal"
		text align center center
		text useFontZoom 0
	}
	label
	{
		area 707 332 52 20
		text lua "chargen.extraSkillPoints"
		text style "edit"
		text align center center
	}
	
	text
	{
		area 334 344 214 168
		text lua "characters[currentID].proficiencies.savingThrows"
		text style "normal_parchment"
		text useFontZoom 0
		text align right top
	}
	
	label
	{
		area 338 112 457 24
		text lua "string.upper(characters[currentID].name)"
		text style "label"
		text align center center
		text color 'B'
		text useFontZoom 0
	}
	label
	{
		area 338 136 457 22
		text lua "characters[currentID].class"
		text style "normal_parchment"
		text align center center
		text useFontZoom 0
	}

	--Stealth
	label
	{
		area 576 360 86 30
		text lua "Infinity_FetchString(chargen.thief_skill[1].name)"
		text style "normal_parchment"
		text useFontZoom 0
		text align right center
		text highlight 1
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 671 361 36 28
	    bam "SKLMINUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[1].id, false)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[1].id, false)
						ticksPassed = 0
					end
				end
			end
		"
	}
	label
	{
		area 706 357 52 36
		bam "STATBOX"
	    enabled "shouldShowSkillButtons()"
	}
	label
	{
		area 707 357 52 36
		text lua "chargen.thief_skill[1].value"
		text style "edit"
		text useFontZoom 0
		text align center center
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 757 361 36 28
	    bam "SKLPLUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[1].id, true)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[1].id, true)
						ticksPassed = 0
					end
				end
			end
		"
	}

	--Detect Traps
	label
	{
		area 576 402 86 30
		text lua "Infinity_FetchString(chargen.thief_skill[2].name)"
		text style "normal_parchment"
		text useFontZoom 0
		text align right center
		text highlight 1
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 671 403 36 28
	    bam "SKLMINUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[2].id, false)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[2].id, false)
						ticksPassed = 0
					end
				end
			end
		"
	}
	label
	{
		area 706 399 52 36
		bam "STATBOX"
	    enabled "shouldShowSkillButtons()"
	}
	label
	{
		area 707 399 52 36
		text lua "chargen.thief_skill[2].value"
		text style "edit"
		text useFontZoom 0
		text align center center
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 757 403 36 28
	    bam "SKLPLUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[2].id, true)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[2].id, true)
						ticksPassed = 0
					end
				end
			end
		"
	}

	--Pick Pockets
	label
	{
		area 576 444 86 30
		text lua "Infinity_FetchString(chargen.thief_skill[3].name)"
		text style "normal_parchment"
		text useFontZoom 0
		text align right center
		text highlight 1
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 671 445 36 28
	    bam "SKLMINUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[3].id, false)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[3].id, false)
						ticksPassed = 0
					end
				end
			end
		"
	}
	label
	{
		area 706 440 52 36
		bam "STATBOX"
	    enabled "shouldShowSkillButtons()"
	}
	label
	{
		area 707 440 52 36
		text lua "chargen.thief_skill[3].value"
		text style "edit"
		text useFontZoom 0
		text align center center
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 757 444 36 28
	    bam "SKLPLUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[3].id, true)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[3].id, true)
						ticksPassed = 0
					end
				end
			end
		"
	}

	--Open Doors
	label
	{
		area 576 483 86 30
		text lua "Infinity_FetchString(chargen.thief_skill[4].name)"
		text style "normal_parchment"
		text useFontZoom 0
		text align right center
		text highlight 1
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 671 484 36 28
	    bam "SKLMINUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[4].id, false)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[4].id, false)
						ticksPassed = 0
					end
				end
			end
		"
	}
	label
	{
		area 706 480 52 36
		bam "STATBOX"
	    enabled "shouldShowSkillButtons()"
	}
	label
	{
		area 707 480 52 36
		text lua "chargen.thief_skill[4].value"
		text style "edit"
		text useFontZoom 0
		text align center center
	    enabled "shouldShowSkillButtons()"
	}
	button
	{
		area 757 483 36 28
	    bam "SKLPLUS"
	    enabled "shouldShowSkillButtons()"
		action 
		"
			currentChargenProficiency = nil
			if ticksStarting < 10 then
				if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
					createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[4].id, true)
				end
			end
			cellNumber = nil
			ticksPassed = 0
			ticksStarting = 0
		"
		actionHold 
		"
			currentChargenProficiency = nil
			if createCharScreen:IsThiefSkillPlusMinusButtonClickable() then
				ticksStarting = ticksStarting + 1
				if ticksStarting > 10 then
					ticksPassed = ticksPassed + 1
					if ticksPassed > 2 then
						createCharScreen:OnThiefSkillPlusMinusButtonClick(chargen.thief_skill[4].id, true)
						ticksPassed = 0
					end
				end
			end
		"
	}

	text
	{
		area 350 162 445 126
		text lua "chargen.levelInfo"
		text style "normal_parchment"
		scrollbar	'cgscrl1'
	}
	label
	{
		area 233 423 87 96
		mosaic "icHPBG"
	}
	label
	{
		area 231 324 92 92
		mosaic "icAC"
	}
	label
	{
		area 250 437 52 75
		mosaic "icHPMan"
	}
	text
	{
		area 246 448 60 27
		text lua "characters[currentID].HP.current"
		text style "label"
		tooltip "CURRENT_HP_TOOLTIP"
	}
	text
	{
		area 246 474 60 27
		text lua "characters[currentID].HP.max"
		text style "label"
		tooltip "MAX_HP_TOOLTIP"
	}
	text
	{
		area 245 339 60 33
		text "AC_LABEL"
		text style "label_parchment"
		text font "EXOCET"
		text point 26
		text shadow 1
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	text
	{
		area 261 370 30 28
		text lua "characters[currentID].AC.current"
		text style "label"
		tooltip "ARMOR_CLASS_TOOLTIP"
	}
	button
	{
		on return
		area 657 536 138 56
		bam NORMBUTT
		text "ACCEPT_BUTTON"
		text style "button"
		clickable lua "createCharScreen:IsDoneButtonClickable()"
		action "createCharScreen:OnDoneButtonClick();"
	}
}

`
function questContainsSearchString(row)
	if(journalSearchString == nil or journalSearchString == "") then return 1 end --no search string, do nothing
	local text = Infinity_FetchString(quests[row].text)
	if(string.find(string.lower(text),string.lower(journalSearchString))) then return 1 end -- title contains search string.
	text = quests[row].entries[1].text
	if(string.find(string.lower(text),string.lower(journalSearchString))) then return 1 end -- entry contains search string.
	return nil --does not contain search string
end
function containsChapter(tab, chapter)
	return true --no chapters in planescape.
end
function getEntryText(questIdx)
	local quest = quests[questIdx]
	if(not quest) then return end
	--return most recent entry
	local text = quest.entries[#quest.entries].text
	if(journalSearchString and journalSearchString ~= "") then
		text = highlightString(text, journalSearchString, "^0xFF0000FF")
	end
	return text
end

function questEnabled(row)
	local quest = quests[row]
	return (quest and (quest.stateType == currentQuestType) and questContainsSearchString(row))
end
function getQuestText(row)
	local text = Infinity_FetchString(quests[row].text)
	if(journalSearchString and journalSearchString ~= "") then
		text = highlightString(text, journalSearchString, "^0xFF0000FF")
	end
	return "- " .. text
end

function getQuestColor(row)
	local color = 0
	local viewed = getSaveOption("Viewed Quest", tostring(quests[row].text), 0)
	if(tonumber(viewed) == 1) then color = fontcolors['B'] else color = fontcolors['P'] end
	color = tonumber(color,16)return bit32.band(color,0x00FFFFFF)
end

--szef_getcolor

function getQuestColor2(row)
	local color = 0
	local viewed = getSaveOption("Viewed Quest", tostring(quests[row].text), 0)
	if(tonumber(viewed) == 1) then color = fontcolors['Z'] else color = fontcolors['R'] end
	color = tonumber(color,16)return bit32.band(color,0x00FFFFFF)
end

function getBLACKCOLOR(row)
    local color = 0
    local viewed = getSaveOption("Viewed Quest", tostring(quests[row].text), 0)
    if(tonumber(viewed) == 1) then color = fontcolors['P'] else color = fontcolors['B'] end
    color = tonumber(color,16)return bit32.band(color,0x00000000)
end

function setQuestViewed(row)
	--Infinity_SetINIValue("Viewed Quest", quests[row].text, 1)
	setSaveOption("Viewed Quest", tostring(quests[row].text), 1)
	Infinity_Log(getSaveOptionsAsString())
end

function getFinished(row)
	if(questDisplay[row].stateType == const.ENTRY_TYPE_COMPLETE) then return 1 else return nil end
end

function getJournalEntryEnabled(row)
	return journalDisplay[row].entry and containsChapter(journalDisplay[row].chapters,chapter) and journalContainsSearchString(row)
end
function getJournalEntryText(row)
	local entry = journalDisplay[row]
	local text = Infinity_FetchString(entry.text)
	text = entry.timeStamp .. ": " .. text .. "\n"
	
	if(journalSearchString and journalSearchString ~= "") then
		--do the search string highlight
		text = highlightString(text, journalSearchString, "^0xFF0000FF")
	end
	
	return text
end
function journalContainsSearchString(row)
	if(journalSearchString == nil or journalSearchString == "") then return 1 end --no search string, do nothing
	local text = Infinity_FetchString(journalDisplay[row].text)
	if(text == "") then text = journalDisplay[row].text end --no stringref, use the text.
	if(string.find(string.lower(text),string.lower(journalSearchString))) then return 1 end -- string contains search string.
	
	text = journalDisplay[row].timeStamp -- check the timestamp
	if(string.find(string.lower(text),string.lower(journalSearchString))) then return 1 end -- string contains search string.
	
	return nil --does not contain search string
end
function dragJournal()
	local offsetX,offsetY,menuWidth,menuHeight = Infinity_GetMenuArea('JOURNAL')
	offsetX = offsetX + motionX
	offsetY = offsetY + motionY
	
	--clamping
	if(offsetX < 80) then
		offsetX = 80
	end
	if(offsetY < 0) then
		offsetY = 0
	end
	
	local screenWidth, screenHeight = Infinity_GetScreenSize()
	if(offsetX > screenWidth - 80 - menuWidth) then
		offsetX = screenWidth - 80 - menuWidth
	end
	if(offsetY > screenHeight - menuHeight) then
		offsetY = screenHeight - menuHeight
	end
	
	Infinity_SetOffset('JOURNAL', offsetX, offsetY)
end
function journalEntryClickable(selectedJournal)
	local entry = journalDisplay[selectedJournal]
	if(entry) then return true end
end
function getJournalEntryRef(selectedJournal)
	local entry = journalDisplay[selectedJournal]
	if(not entry) then return end
	if(entry.title) then
		return journalDisplay[selectedJournal + 1].text
	else
		return entry.text
	end
end
function getJournalBackgroundFrame()
	if(journalMode == const.JOURNAL_MODE_QUESTS) then
		return 0
	else
		return 1
	end
end
function getBestiaryEnabled(num)
	if(bestiary[num].placeholder) then
		if(not pstFoundKnownNPC and currentBestiaryClass == bestiary[num].class) then
			--no known npcs, display the placeholder
			return true
		else
			return false
		end
	end
	
	if(pst:GetBestiaryKnown(bestiary[num].index) and currentBestiaryClass == bestiary[num].class) then
		return true
	end
	if(not pstFoundKnownNPC and bestiary[num].placeholder and currentBestiaryClass == bestiary[num].class) then
		--no known npcs, display the placeholder
		return true
	end
	return false
end

--szef_bestia2_func

function getBestiaryImage2()
	if(bestiary[selectedBestiaryCreature] and bestiary[selectedBestiaryCreature].imageKnown) then
		return bestiary[selectedBestiaryCreature].imageKnown
	else
		return "default" --bmp named "default"
	end
end

function getBestiaryImage3()
	if(bestiary[selectedBestiaryCreature] and bestiary[selectedBestiaryCreature].imageKnown) then
		return bestiary[selectedBestiaryCreature].imageKnown
	else
		return "default" --bmp named "default"
	end
end

function getBestiaryImage()
	if(bestiary[selectedBestiaryCreature] and bestiary[selectedBestiaryCreature].imageKnown) then
		return bestiary[selectedBestiaryCreature].imageKnown
	else
		return "default" --bmp named "default"
	end
end
function getBestiaryDesc()
	local creature = bestiary[selectedBestiaryCreature]
	if(creature) then
		if(creature.global) then
			--Description from global
			local val = Infinity_GetScriptVarInt(creature.global)
			return Infinity_FetchString(creature["desc"..val])
		else
			--Default description
			return Infinity_FetchString(creature.desc0)
		end
	end
end
function searchBoxEnabled()
	return (journalMode == const.JOURNAL_MODE_JOURNAL or journalMode == const.JOURNAL_MODE_QUESTS)
end
function checkForKnownBestiaryNPC()
	--Checks to see if we need to display placeholder entry.
	pstFoundKnownNPC = nil
	for k,v in pairs(bestiary) do
		if(v.class == const.BESTIARY_CLASS_NPC and not v.placeholder and pst:GetBestiaryKnown(v.index)) then
			pstFoundKnownNPC = 1
		end
	end
end
function journalScroll(top, height, contentHeight)
	if(journalScrollToBottom and contentHeight > height) then
		journalScrollToBottom = nil
		return height-contentHeight
	else
		if(journalCheckScroll) then
			journalCheckScroll = nil
			if(-top > contentHeight) then
				return height-contentHeight
			end
			if(top > 0) then
				return 0
			end
		end
		--defer to default
		return nil
	end
end

currentQuestType = const.ENTRY_TYPE_INPROGRESS
currentBestiaryClass = const.BESTIARY_CLASS_PC
journalMode = const.JOURNAL_MODE_QUESTS
journalSearchString = ""
`
menu
{
	name 'JOURNAL'
	align center center
	ignoreEsc
	size 1024 768
	onopen "
		
		if SkinsOptionsSliders[3][6] == 0 then
		Infinity_PushMenu('JOURNAL_ORIGINAL')
		else
		Infinity_PushMenu('JOURNAL_NEW')
		end
	"
	onclose
	"	
		Infinity_PopMenu('JOURNAL_ORIGINAL')
		Infinity_PopMenu('JOURNAL_NEW_ORIGINAL')
		Infinity_PopMenu('JOURNAL_NEW')
		Infinity_PopMenu('JOURNAL_NEW_MODE')
		Infinity_PopMenu('JOURNAL_NEW_BESTIARY')
		
		Infinity_SetBackground(nil)
		pushSidebars()
	"
	button
	{
	area 0 0 0 0
	}
}
menu
{	
	name 'JOURNAL_ORIGINAL'
	align center center
	ignoreEsc
	size 1024 768
	onopen "
		buildJournalDisplay()
		chapter = 0
		selectedBestiaryCreature = nil
		Infinity_SetBackground('BACKGROUND_JOURNAL')
		popSidebars()
		selectedQuest = nil
		journalScrollToBottom = 1
		
		checkForKnownBestiaryNPC()
		"
	onclose
	"	
		Infinity_SetBackground(nil)
		pushSidebars()
	"
	button
	{
		area 680 21 103 63
		text "JOURNAL_BUTTON"
		text style "button"
		action "journalMode = const.JOURNAL_MODE_JOURNAL"
		glow lua "journalMode == const.JOURNAL_MODE_JOURNAL"
		bam "jrnbutt"
	}
	button
	{
		area 565 22 103 63
		text "QUESTS_BUTTON"
		text style "button"
		action "journalMode = const.JOURNAL_MODE_QUESTS"
		glow lua "journalMode == const.JOURNAL_MODE_QUESTS"
		bam "jrnbutt"
	}
	button
	{
		area 796 21 103 63
		text "BESTIARY_BUTTON"
		text style "button"
		action "journalMode = const.JOURNAL_MODE_BESTIARY"
		glow lua "journalMode == const.JOURNAL_MODE_BESTIARY"
		bam "jrnbutt"
	}
	button
	{
		area 974 12 50 50
		bam "XBUTT"
		action
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
	button
	{
		area 820 568 163 163
		text "DONE_BUTTON"
		text style "button"
		bam "jrndone"
		on escape
		action 
		"
			e:GetActiveEngine():OnLeftPanelButtonClick(2)
		"
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 107 629 316 18
		text "ENTER_SEARCH_TERM_NORMAL"
		text style "label"
	}
	label
	{
		enabled "searchBoxEnabled()"
		area 107 659 316 25
		fill 0 0 0 200
		
	}
	edit
	{
		enabled "searchBoxEnabled()"
		area 110 662 309 18
		var journalSearchString
		text style "edit"
		maxlines 1
		action
		"
			selectedQuest = nil
			journalCheckScroll = 1
			return 1 --need to return 1 since this action is technically a filter.
		"
	}
	list
	{
		column { 
			width 100
			label
			{	
				enabled "questEnabled(rowNumber)"
				area 8 0 -1 -1
				text lua "getQuestText(rowNumber)"
				text style "label"
				text color lua "getQuestColor(rowNumber)"
				align left center
				text highlight 1
				indent 1
				pad 0 0 32 0
			}
		}
		enabled "journalMode == const.JOURNAL_MODE_QUESTS"
		rowheight	dynamic
		table		"quests"
		var			selectedQuest
		scrollbar	'cgscrl1'
		area		84 54 411 504
		hidehighlight
		highlight color "Y"
		focus color "Y"

		action
		"
			setQuestViewed(selectedQuest)
		"
		
	}
	button
	{
		area 527 526 138 56		
		bam	NORMBUTT
		enabled "journalMode == const.JOURNAL_MODE_QUESTS"
		text "BUTTON_ASSIGNED"
		text style "button"
		glow lua "currentQuestType == const.ENTRY_TYPE_INPROGRESS"
		action
		"
			currentQuestType = const.ENTRY_TYPE_INPROGRESS
			selectedQuest = nil
		"
	}
	button
	{
		area 683 526 138 56		
		bam	NORMBUTT
		enabled "journalMode == const.JOURNAL_MODE_QUESTS"
		text "BUTTON_COMPLETED"
		text style "button"
		glow lua "currentQuestType == const.ENTRY_TYPE_COMPLETE"
		action
		"
			currentQuestType = const.ENTRY_TYPE_COMPLETE
			selectedQuest = nil
		"
	}
	text
	{
		enabled "journalMode == const.JOURNAL_MODE_QUESTS and quests[selectedQuest] ~= nil"
		area 536 108 406 366
		text style "white_parchment"
		text lua "getEntryText(selectedQuest)"
	}
	
	list --journal
	{
		column
		{
			width 100
			label
			{
				enabled "getJournalEntryEnabled(rowNumber)"
				area 0 0 -1 -1
				pad 8 16 16 16
				text lua "getJournalEntryText(rowNumber)"
				text style "normal"
				text color 'B'
				text highlight 1
			}
		}
		enabled "journalMode == const.JOURNAL_MODE_JOURNAL"
		seperator "getJournalEntryEnabled(rowNumber)"
		rowheight	dynamic
		hidehighlight
		scrollbar func "journalScroll"

		table		"journalDisplay"
		var			selectedJournal
		scrollbar	'cgscrl1'
		area		78 54 417 504
	}
	label
	{
		enabled "journalMode == const.JOURNAL_MODE_JOURNAL"
		area 588 126 299 328
		mosaic "JRNLOP"
	}
	list
	{
		column
		{
			width 100
			label
			{
				area 0 0 -1 -1
				enabled "getBestiaryEnabled(rowNumber)"
				text lua "Infinity_FetchString(bestiary[rowNumber].name)"
				text style "label_parchment"
				text highlight 1
			}
		}
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		rowheight dynamic
		area 522 97 430 188
		table "bestiary"
		var	selectedBestiaryCreature
		scrollbar 'cgscrl1'
		hidehighlight
		highlight color 255 255 255 255
		focus color 255 255 255 255

	}

	label
	{
		area 107 79 316 492
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		mosaic lua "getBestiaryImage()"
		align center center
	}
	text
	{
		area 532 306 420 174
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		text lua "getBestiaryDesc()"
		text style "normal_parchment"
		scrollbar	'cgscrl1'
	}
	button
	{
		area 683 526 103 63
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		glow lua "currentBestiaryClass == const.BESTIARY_CLASS_NPC"
		text "BUTTON_NPC"
		text style "button"
		bam "jrnbutt"
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_NPC
			selectedBestiaryCreature = nil
		"
	}
	button
	{
		area 562 526 103 63
		enabled "journalMode == const.JOURNAL_MODE_BESTIARY"
		glow lua "currentBestiaryClass == const.BESTIARY_CLASS_PC"
		text "BUTTON_PC"
		text style "button"
		bam "jrnbutt"
		action
		"
			currentBestiaryClass = const.BESTIARY_CLASS_PC
			selectedBestiaryCreature = nil
		"
	}
}

menu
{ 
	name 'STATS'
	align center center
	size 1024 768
	greyscale lua "characters[id].HP.current <= 0"
	interactable lua "characters[id].HP.current > 0"
	onOpen "pushSidebars()"
	onClose "pushSidebars()"
	label 
	{ 	area 512 140 430 510
		mosaic "invbg4"
		
	}
	handle
	{
		area 942 84 50 50
		name "SIWHandleDrag"
		mosaic "han2"
		actionDrag "dragSIWX(motionX), dragSIWY(motionY)"
	}
	label
	{
		area		520 162 188 478
		text lua	"characters[id].proficiencies.pstDetails"
		text style "normal_parchment"
		text color 'D'
		text align right top
		scrollbar 'cgscrl1'
		scrollbar hide lua "1"
	} 
	text
	{
		area 728 162 64 22
		text lua "Infinity_FetchString(4718)..':'"
		text style "label"
		text color 'D'
	}
	label
	{
		area		800 162 52 22
		text lua "characters[id].attr.str.current"
		text style  'label'
		text align	center center
	}
	text
	{
		area 728 188 64 22
		text lua "Infinity_FetchString(5020)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
	}
	label
	{
		area		800 188 52 22
		text lua "characters[id].attr.int.current"
		text style  'label'
		text align	center center
	}
	text
	{
		area 728 214 64 22
		text lua "Infinity_FetchString(5021)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
	}
	label
	{
		area		800 214 52 22
		text lua "characters[id].attr.wis.current"
		text style  'label'
		text align	center center
	}
	text
	{
		area 728 240 64 22
		text lua "Infinity_FetchString(5022)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
	}
	label
	{
		area		800 240 52 22
		text lua "characters[id].attr.dex.current"
		text style  'label'
		text align	center center
	}
	text
	{
		area 728 268 64 22
		text lua "Infinity_FetchString(5023)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
	}
	label
	{
		area		800 268 52 22
		text lua "characters[id].attr.con.current"
		text style  'label'
		text align	center center
	}
	text
	{
		area 728 296 64 22
		text lua "Infinity_FetchString(5024)..':'"
		text style "label"
		text color 'D'
		ignoreFocus 1
	}
	label
	{
		area		800 296 52 22
		text lua "characters[id].attr.cha.current"
		text style  'label'
		text align	center center
	}
	text
	{
		area		728 334 192 14
		text lua "Infinity_FetchString(39596)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		728 348 192 14
		text lua "characters[id].Stats.bestenemy.current"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 374 192 14
		text lua "Infinity_FetchString(41278)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		728 388 192 14
		text lua "characters[id].Stats.timespent.current"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 410 192 14
		text lua "Infinity_FetchString(41279)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		728 420 192 14
		text lua "characters[id].Stats.favspell.current"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 444 192 14
		text lua "Infinity_FetchString(41280)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		728 458 192 14
		text lua "characters[id].Stats.favweapon.current"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 490 192 14
		text lua "Infinity_FetchString(41308)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		866 490 68 14
		text lua "characters[id].Stats.partygamexp.current ..'%'"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 510 192 14
		text lua "Infinity_FetchString(41307)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		866 510 68 14
		text lua "characters[id].Stats.partygamekills.current ..'%'"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 532 192 14
		text lua "Infinity_FetchString(825)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		866 532 68 14
		text lua "characters[id].Stats.gamexpvalue.current"
		text style  'label'
		text align	left center
	}
	text
	{
		area		728 554 192 14
		text lua "Infinity_FetchString(41281)"
		text style  'label'
		text color 'D'
		text align	left center
	}
	label
	{
		area		866 554 68 14
		text lua "characters[id].Stats.gamekills.current"
		text style  'label'
		text align	left center
	}
	button
	{
		area 920 112 50 50
		bam "XBUTT"
		sequence 3
		tooltip lua "Stats"
		action 
		"
			Infinity_PopMenu('STATS')
		"
	}
}

`
megacredits = ''
epilogue =
{
	counters = {1,2,3},
	images  =
	{
		{image = "CREDIT1",  subtitle = 0},
		{image = "CREDIT2",  subtitle = 0},
		{image = "CREDIT3",  subtitle = 0},
		{image = "CREDIT4",  subtitle = 0},
		{image = "CREDIT5",  subtitle = 0},
		{image = "CREDIT6",  subtitle = 0},
		{image = "CREDIT7",  subtitle = 0},
		{image = "CREDIT8",  subtitle = 0},
		{image = "CREDIT9",  subtitle = 0},
		{image = "CREDIT10", subtitle = 0},
		{image = "CREDIT11", subtitle = 0},
		{image = "CREDIT12", subtitle = 0},
		{image = "CREDIT13", subtitle = 0},
		{image = "CREDIT14", subtitle = 0},
		{image = "CREDIT15", subtitle = 0},
		{image = "CREDIT16", subtitle = 0},
		{image = "CREDIT17", subtitle = 0},
		{image = "CREDIT28", subtitle = 0},
		{image = "CREDIT29", subtitle = 0},
		{image = "CREDIT30", subtitle = 0},
	},
}

function generateMegaCredits()
	megacredits = ''
	for k,v in pairs(credits) do
		megacredits = megacredits .. Infinity_FetchString(v)..'\n'
	end
end
function setChapterBackground(chapter)
	-- empty function to avoid a crash
end
function incrementEpilogueImages()
	local length = #(epilogue.images)
	for k,v in pairs(epilogue.counters) do
		epilogue.counters[k] = (v + 3) % (length)
	end
end

text_CHAPTERSCROLL = ""
text_CHAPTERSCROLL_timeStart = 0
text_CHAPTERSCROLL_auto = 1
function UpdateChapterScroll(top, height, contentHeight)
	if(text_CHAPTERSCROLL_auto == 0) then
		--defer to default scrolling
		return nil
	end
	local dT = Infinity_GetClockTicks() - text_CHAPTERSCROLL_timeStart
	local timerCrawl = dT * -0.006
	if megacredits ~= '' then
		timerCrawl = dT * -0.06
	end
	local newTop = timerCrawl + height
	if(newTop + contentHeight + height < height) then
		return top
	end
	return newTop
end
`
menu
{
	name 'EPILOGUE'
	align center center
	ignoreEsc
	modal
	popupSound 1
	onOpen 
	"
		generateMegaCredits()
		epilogue.counters[1] = 0
		epilogue.counters[2] = 1
		epilogue.counters[3] = 2
	"
	label
	{
		area 0 0 1024 644
		mosaic "CREDITBG"
	}
	label
	{
		area 79 38 290 142
		mosaic lua "epilogue.images[epilogue.counters[1]+1].image"
	}
	label
	{
		area 220 224 290 142
		mosaic lua "epilogue.images[epilogue.counters[2]+1].image"
	}
		label
	{
		area 148 398 290 142
		mosaic lua "epilogue.images[epilogue.counters[3]+1].image"
	}
	label
	{
		area 70 28 450 522
		mosaic "CREDITFR"
		ignoreEvents
	}
	
	text
	{
		name "text_CHAPTERSCROLL_item"
		area 562 60 376 520
		text lua "megacredits"
		text style normal
		text align center top
		scrollbar	'cgscrl1'
		scrollbar func 'UpdateChapterScroll'
		scrollbar hide lua 'text_CHAPTERSCROLL_auto == 1'
		action
		"
			text_CHAPTERSCROLL_auto = 0
		"
	}
	button
	{
		area 386 560 138 56		
		bam	NORMBUTT
		text "DONE_BUTTON"
		text style "button"
		clickable lua "chapterScreen:IsDoneButtonClickable()"
		action
		"
			megacredits = ''
			chapterScreen:OnDoneButtonClick()
		"
	}
	button
	{
		area 210 560 138 56		
		bam	NORMBUTT
		text "REPLAY_BUTTON"
		text style "button"
		clickable lua "chapterScreen:IsReplayButtonClickable()"
		action
		"
			chapterScreen:OnReplayButtonClick()
		"
	}
}
`
function areaTitleAnimationEnabled()
	return e:GetActiveEngine() == worldScreen and not Infinity_IsMenuOnStack('WORLD_DIALOG')
end


fadeStartDelay = 1000
fadeLength = 700
function getAndUpdateAreaTitleOpacity()
	if(not areaTitleAnimationEnabled()) then
		return 1
	end
	local now = Infinity_GetClockTicks()
	if (now > fadeEndTime) then
		return 0
	end
	-- fade transitioning
	if (now > fadeStartTime) then
		return 1.0 - ((now - fadeStartTime) / fadeLength)
	end
	-- fully opaque
	return 1
end
function checkAreaTitlePop()
	local now = Infinity_GetClockTicks()
	if (fadeEndTime ~= nil and now > fadeEndTime) then
		Infinity_PopMenu('AREA_TITLE')
	end
end
`
menu
{
	name "AREA_TITLE"
	align center center
	size 1024 768
	interactable 0
	opacity lua "getAndUpdateAreaTitleOpacity()"
	onOpen
	"
		fadeStartTime = Infinity_GetClockTicks() + fadeStartDelay
		fadeEndTime = Infinity_GetClockTicks() + fadeStartDelay + fadeLength
	"
	label
	{
		enabled "areaTitleAnimationEnabled()"
		area 0 0 1024 768
		text lua "Infinity_FetchString(mapScreen:GetMapName())"
		text style "title"
		text font "exocet"
		align center top
		pad 0 120 0 0
		text shadow 1
	}
}
`
	selectedRenderOption = true
	welcomePageFrom = ""

	function GetWelcomeDescriptionText()
		local ret = t("WELCOME_ENHANCED_DESCRIPTION")
		if selectedRenderOption == false then
			ret = t("WELCOME_ORIGINAL_DESCRIPTION")
		end
		return ret
	end

	function GetWelcomeButtonFrame(enhancedButton)
		local ret = 0

		if enhancedButton and (overEnhanced or selectedRenderOption) then
			ret = 2
		end
		if not enhancedButton and (overOriginal or not selectedRenderOption) then
			ret = 2
		end

		return ret
	end
	
--szef_sldr_strings

	function GetdboxString()
		if SkinsOptionsSliders[1][6] == 0 then
		return t('This slider allows to change dialogue box skin.^N\n\nO r i g i n a l\n^-')
		elseif SkinsOptionsSliders[1][6] == 1 then
		return t('This slider allows to change dialogue box skin.^N\n\nJ o u r n a l \tP o r t r a i t \tC o n v e r s a t i o n s\n\t(by Smeagolheart)^-')
		elseif	SkinsOptionsSliders[1][6] == 2 then
		return t('This slider allows to change dialogue box skin.^N\n\nS i d e \tD i a l o g u e \tB o x\n^-')
		else
		return t('This slider allows to change dialogue box skin.^N\n\nA \tl a \tN u m e n e r a \tD i a l o g u e \tB o x\n^-')
		end
	end
	
	function GetdboxDescString()
		if SkinsOptionsSliders[1][6] == 0 then
		return t('This slider allows to change dialogue box skin.\n')
		elseif SkinsOptionsSliders[1][6] == 1 then
		return t('This slider allows to change dialogue box skin.\n')
		elseif SkinsOptionsSliders[1][6] == 2 then
		return t('This slider allows to change dialogue box skin.\n')
		else
		return t('This slider allows to change dialogue box skin.\n')
		end
	end

	function GetdboxSliderString()
		if SkinsOptionsSliders[1][6] == 0 then
		return t('^0xffd5c885Original')
		elseif SkinsOptionsSliders[1][6] == 1 then
		return t('^0xffd5c885w/Portraits')
		elseif SkinsOptionsSliders[1][6] == 2 then
		return t('^0xffd5c885Side')
		else
		return t('^0xffd5c885TTON')
		end
	end
	
	function GetInvString()
		if SkinsOptionsSliders[2][6] == 0 then
		return t('This slider allows to change inventory skin, and slots arrangement.^N\n\nC l a s s i c \tI n v e n t o r y\n^-')
		elseif SkinsOptionsSliders[2][6] then
		return t('This slider allows to change inventory skin, and slots arrangement.^N\n\nS h a r e d \tI n v e n t o r y\n^-')
		--else
		--return t('This slider allows to change inventory skin, and slots arrangement.^N\n\nI n \tG a m e \tW o r l d \tS c r e e n \tI n v e n t o r y\n^-')
		end
	end

	function GetInvDescString()
		if SkinsOptionsSliders[2][6] == 0 then
		return t('This slider allows to change inventory skin, and slots arrangement.\n')
		elseif SkinsOptionsSliders[2][6] then
		return t('This slider allows to change inventory skin, and slots arrangement.\n')
		--else
		--return t('This slider allows to change inventory skin, and slots arrangement.\n')
		end
	end

	function GetInvSliderString()
		if SkinsOptionsSliders[2][6] == 0 then
		return t('^0xff78b570Classic')
		elseif SkinsOptionsSliders[2][6] then
		return t('^0xff78b570Shared')
		--else
		--return t('^0xff78b570In World')
		end
	end
	
	
	function GetJournalString()
		if SkinsOptionsSliders[3][6] == 0 then
		return t('This slider allows to change journal screen.^N\n\nD e f a u l t \tJ o u r n a l\n^-')
		else
		return t('This slider allows to change journal screen.^N\n\nN e w \tJ o u r n a l\n^-')
		end
	end

	function GetJournalDescString()
		if SkinsOptionsSliders[3][6] == 0 then
		return t('This slider allows to change journal screen.\n')
		else
		return t('This slider allows to change journal screen.\n')
		end
	end

	function GetJournalSliderString()
		if SkinsOptionsSliders[3][6] == 0 then
		return t('^0xff7f00ffDefault')
		else
		return t('^0xff7f00ffNew')
		end
	end
	
	--function GetImgStrin(index)
	--if index == 1 then
   -- if SkinsOptionsSliders[1][6] == 0 then
    --  return "g-btdef"
   -- elseif SkinsOptionsSliders[1][6] == 1 then
   --   return "g-btpor"
  -- elseif SkinsOptionsSliders[1][6] == 2 then
   --   return "g-btsdb"
   -- else
   --   return "g-btttn"
  --  end
	--elseif index == 2 then
   -- if SkinsOptionsSliders[2][6] == 0 then
   --   return "g-btcla"
  --  elseif SkinsOptionsSliders[2][6] == 1 then
   --  return "inv-sh"
   -- else
  --    return "inv-sh"
   -- end
--	elseif index == 3 then
   -- if SkinsOptionsSliders[3][6] == 0 then
   --   return "j-old"
  --  else
   --   return "j-new"
  --  end
	--else
   -- return nil  -- should never be reached if coded correctly
--	end
	--end
	
	function GetDboxImgString()
	 if SkinsOptionsSliders[1][6] == 0 then
      return "g-btcla"
    elseif SkinsOptionsSliders[1][6] == 1 then
      return "g-btpor"
    elseif SkinsOptionsSliders[1][6] == 2 then
      return "g-btsd1"
    else
      return "g-btttn"
    end
	end
	
	function GetInvImgString()
	 if SkinsOptionsSliders[2][6] == 0 then
      return "g-btdef"
    elseif SkinsOptionsSliders[2][6] == 1 then
      return "g-btsh1"
    else
      return "inv-iw"
    end
	end
	
	function GetJournalImgString()
	if SkinsOptionsSliders[3][6] == 0 then
      return "g-btjol"
    else
      return "g-btjnw"
    end
	end
`
menu
{
	name "WELCOME_MENU"
	align center center
	size 1024 768
	ignoreEsc
	onOpen
	"
		selectedRenderOption = true
		Infinity_SetBackground('BACKGROUND_WELCOME')
	"
	onClose
	"
		Infinity_SetBackground(nil)
	"	
	label
	{
		area 392 78 232 34
		text "WELCOME_TITLE"
		text style "label_parchment"
		text font "EXOCET"
		text align center center
	}
	text
	{
		area 290 182 236 290
		text "WELCOME_CHRIS_TEXT"
		text style normal
		text point 12
		text align left top
		text useFontZoom 0
		scrollbar	'cgscrl1'
	}
	text
	{
		area 596 190 86 32		
		text "WELCOME_ENHANCED_BUTTON"
		text style "label_parchment"
		text font "EXOCET"
		text align center center
	}
	button
	{
		area 698 194 24 24		
		bam	checkbut
		frame lua "GetWelcomeButtonFrame(true)"
		action
		"
			Infinity_PlaySound('GAM_09')
			selectedRenderOption = true
		"
		ignoreFocus 1
	}
	text
	{
		area 596 252 86 32		
		text "WELCOME_ORIGINAL_BUTTON"
		text style "label_parchment"
		text font "EXOCET"
		text align center center
	}
	button
	{
		area 698 256 24 24		
		bam	checkbut
		frame lua "GetWelcomeButtonFrame(false)"
		action
		"
			Infinity_PlaySound('GAM_09')
			selectedRenderOption = false
		"
		ignoreFocus 1
	}
	text
	{
		area 582 324 144 126
		text lua "GetWelcomeDescriptionText()"
		text style normal
		text point 10
		text align left top
		text useFontZoom 0
		scrollbar	'cgscrl1'
	}
	button
	{
		area 568 478 170 54		
		bam	WIDEBUT
		text "DONE_BUTTON"
		text style "button"
		action
		"
			Infinity_PopMenu('WELCOME_MENU')
			startEngine:SelectRenderOptions(selectedRenderOption)
			if welcomePageFrom == 'newgame' then
				Infinity_Log('newgame')
				startEngine:OnNewGameButtonClick()
			else
				Infinity_Log('options')
				Infinity_PushMenu('ESC_MENU')
				optionsScreen:SetEngineState(1)
				startEngine:OnOptionsButtonClick()
			end
		"
	}
}
